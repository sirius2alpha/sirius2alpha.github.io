<!doctype html><html lang=en dir=auto><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>点击排行榜scoreboard | Sirius' Blog</title>
<meta name=keywords content="redis,websocket,nginx,gin,vue,go"><meta name=description content="本文记录使用vue+gin+redis搭建了一个简单的点击排行榜，虽然有点无聊，但是两个幼稚鬼玩好好笑hhh"><meta name=author content="sirius1y"><link rel=canonical href=//localhost:1313/posts/notes/dev/dev-%E7%82%B9%E5%87%BB%E6%8E%92%E8%A1%8C%E6%A6%9C/><link crossorigin=anonymous href=/assets/css/stylesheet.3551607c8eb1ef998f0b6c81d22f9f03dd2c3b8ecaf983e42c023e8d41e39f66.css integrity="sha256-NVFgfI6x75mPC2yB0i+fA90sO47K+YPkLAI+jUHjn2Y=" rel="preload stylesheet" as=style><link rel=icon href=//localhost:1313/images/icon.png><link rel=icon type=image/png sizes=16x16 href=//localhost:1313/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=//localhost:1313/favicon-32x32.png><link rel=apple-touch-icon href=//localhost:1313/apple-touch-icon.png><link rel=mask-icon href=//localhost:1313/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=//localhost:1313/posts/notes/dev/dev-%E7%82%B9%E5%87%BB%E6%8E%92%E8%A1%8C%E6%A6%9C/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="点击排行榜scoreboard"><meta property="og:description" content="本文记录使用vue+gin+redis搭建了一个简单的点击排行榜，虽然有点无聊，但是两个幼稚鬼玩好好笑hhh"><meta property="og:type" content="article"><meta property="og:url" content="//localhost:1313/posts/notes/dev/dev-%E7%82%B9%E5%87%BB%E6%8E%92%E8%A1%8C%E6%A6%9C/"><meta property="og:image" content="//localhost:1313/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-21T00:00:00+00:00"><meta property="article:modified_time" content="2024-01-21T00:00:00+00:00"><meta property="og:site_name" content="Sirius' Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="//localhost:1313/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="点击排行榜scoreboard"><meta name=twitter:description content="本文记录使用vue+gin+redis搭建了一个简单的点击排行榜，虽然有点无聊，但是两个幼稚鬼玩好好笑hhh"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"//localhost:1313/posts/"},{"@type":"ListItem","position":2,"name":"点击排行榜scoreboard","item":"//localhost:1313/posts/notes/dev/dev-%E7%82%B9%E5%87%BB%E6%8E%92%E8%A1%8C%E6%A6%9C/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"点击排行榜scoreboard","name":"点击排行榜scoreboard","description":"本文记录使用vue+gin+redis搭建了一个简单的点击排行榜，虽然有点无聊，但是两个幼稚鬼玩好好笑hhh","keywords":["redis","websocket","nginx","gin","vue","go"],"articleBody":"项目概述 项目地址：https://github.com/sirius2alpha/scoreboard\n使用Redis在服务器上对用户的点击数排序，并返回点击次数排行榜。 技术栈 整体设计 用户界面 排行榜展示区: 显示当前排行榜的状态。 点击按钮: 用户点击来增加他们的计分。 昵称输入和提交: 允许新用户输入昵称并参与排行榜。 实时更新监听: 不需要用户交互，自动更新排行榜。 WebSocket客户端逻辑 建立连接: 当用户访问网站时，建立WebSocket连接。 发送点击事件: 当用户点击按钮时，发送消息到服务器。 接收排行榜更新: 监听来自服务器的排行榜更新，并更新界面。 用户注册: 发送新用户的昵称到服务器。 处理断开连接: 如果用户20秒未操作，发送断开消息到服务器。 后端设计（Gin + Redis） WebSocket服务器 处理WebSocket连接: 接受和管理WebSocket连接。 接收消息: 解析从客户端接收到的消息（点击事件，新用户注册）。 Redis交互: 更新用户的分数并重新排序排行榜。 广播排行榜更新: 将更新后的排行榜发送给所有连接的客户端。 处理断开: 移除30秒未操作的用户。 Redis逻辑 用户分数管理: 存储和更新用户分数。 排行榜排序: 实时更新排行榜。 数据持久化: 保证数据在服务重启后仍然可用。 API设计 本项目API设计采用的是websocket实现。\n由于考虑到用户在点击比较频繁，如果采用HTTP会造成头部开销较大，而websocket的头部开销会相对小一些。\n消息类型 UserClick: { type: “UserClick”, nickname: “用户昵称” }\nNewUser: { type: “NewUser”, nickname: “用户昵称” }\nUserInactive: { type: “UserInactive”, nickname: “用户昵称” }\nRankUpdate: { type: “RankUpdate”, ranks: [{nickname: “用户昵称”, score: 分数,ClickTime: 上次点击时间, ClickInterval: 上次点击间隔时间}, …] }\nAPI流程 用户点击: 前端发送UserClick消息到服务器。 新用户加入: 前端发送NewUser消息到服务器。 服务器处理: 接收消息，更新Redis数据，并重新排序排行榜。 排行榜更新: 服务器广播RankUpdate消息到所有客户端。 前端更新界面: 客户端接收RankUpdate消息，更新排行榜显示。\n前端设计 前端采用vue框架编写完成，UI组件采用elementplus\n后端设计 项目后端使用 github.com/gorilla/websocket 和 github.com/gin-gonic/gin 实现一个基于 WebSocket 的实时通信服务。通过 WebSocket，服务能够实时接收和处理客户端发送的各种类型的消息，并根据消息类型执行相应的逻辑。此外，通过后台定时任务，服务还能够定期更新和广播用户的排名信息。这种实现方式对于需要实时通信和快速响应的应用场景非常合适。\nbackend ├── controllers │ └── websocket.go ├── go.mod ├── go.sum ├── main.go ├── routers │ └── router.go └── services └── redis-server.go 后端采用Gin框架完成，大致流程：\n在main.go中启动路由，并且启动端口监听 在routers/router.go中定义/ws路由，用于接收websocket的连接 对于ws的处理，函数定于在controllers/websocket.go中，包括针对不同任务类型使用redis数据库的函数调用 在services/redis-server.go中，对各个任务如何具体操作redis进行定义 使用到的redis数据结构 a. Sorted Set 用途: 存储用户的点击次数，用于排名。 操作: ZAdd: 添加新用户或初始用户，并设置点击次数。 ZIncrBy: 增加用户的点击次数。 ZRemRangeByRank: 清空sorted set。 ZRevRangeWithScores: 获取点击次数最多的前10个用户。 ZRem: 删除不活跃的用户。 b. Hash 用途: 存储用户的最后点击时间和点击间隔。 操作: HSet: 初始化或更新用户的点击时间和点击间隔。 HGet: 获取特定用户的点击时间和点击间隔。 Del: 清空点击时间和间隔的记录。 用户行为处理逻辑 a. 用户添加与更新 新用户处理: 当有新用户加入时，通过AddNewUser函数将用户添加到sorted set中，并初始化点击次数为0。 用户点击处理: 在HandleUserClick函数中，每当用户点击，使用ZIncrBy来增加其在sorted set中的得分（即点击次数），并记录点击时间。 b. 点击间隔更新 定时更新: UpdateClickInterval函数定期更新每个用户自上次点击以来的时间间隔。 时区处理: 代码中特别考虑了时区问题，将时间转换为中国标准时间（Asia/Shanghai）。 c. 用户排名获取 排名展示: GetRanking函数用于获取并返回用户的点击排名，包括用户ID、点击次数、上次点击时间和点击间隔。 d. 活跃状态检查 用户活跃度监测: CheckAllUsers和HandleUserInactive函数用于检查所有用户的活跃状态。若用户的点击间隔超过20秒，则视为不活跃并从sorted set中移除。 WebSocket 通信与处理 a. WebSocket 升级器 配置: 设置了读写缓冲区大小为 1024 字节，并允许所有跨域请求。 功能: 用于将 HTTP GET 请求升级为 WebSocket 连接。 b. WebSocket 连接管理 连接记录: 通过全局变量 connections 记录所有打开的 WebSocket 连接。 消息处理: 在无限循环中监听并读取来自 WebSocket 连接的消息。 c. 消息解析与路由 JSON 检查: 使用 isJSON 函数检查接收到的消息是否为 JSON 格式。 类型判断: 根据消息中的 “type” 字段，决定执行对应的处理逻辑。 消息处理逻辑 新用户处理: 当收到类型为 “NewUser” 的消息时，调用 services.AddNewUser 添加新用户。 用户点击处理: 收到 “UserClick” 类型的消息时，调用 services.HandleUserClick 处理用户点击事件。 用户不活跃处理: 对于 “UserInactive” 类型的消息，执行 services.HandleUserInactive 以处理不活跃用户。 定时任务处理 后台定时任务: 使用 goroutine 定期执行用户点击间隔的更新、用户活跃状态检查和用户排名获取。 间隔设置: 目前设置为每 200 毫秒执行一次循环中的任务。 用户排名的 WebSocket 广播 排名信息广播: 定期将用户排名信息通过所有打开的 WebSocket 连接广播给客户端。 需要注意的改进点 错误处理: 在一些关键操作后，需要更全面地处理可能的错误返回值。 性能优化: 随着 WebSocket 连接数的增加，消息广播可能成为性能瓶颈。 可以修改的一些bug 1、用户在登录的时候遇到相同用户名，会把他直接刷新\n2、手机端自适应功能差，体验不好\n手机在点击按钮的时候。会触发双击浏览器双击放大的功能，影响体验 手机端的网页有时候滑动不了 有时候手机端最上面的两个按钮会被浏览器的头部遮挡，但是又滑动不上去 3、对于只登录而没有点击的用户，排行榜中会保留下来，但不会清理\n上一次的点击间隔和上次点击时间都不会刷新，后端是根据间隔时间清理用户，虽然可以保留，但是一直保存着也不是办法，可以设置一个单独的时长进行清理。\n部署到服务器上 现在云服务商的域名管理处新建了一个子域名，然后在服务器上使用了nginx给子域名提供对应的服务。\n服务器上保持资源最简单就行，不用把源码都放到服务器上，对于前端的vue框架这边，只用把npm build生成的/dist目录上传就行；对与gin来说，也只需要把go build main.go生成的main可执行文件上传到服务器就行，这样也更加安全。\n遇到的一些问题：\n打开网站显示500，先去检查nginx的日志，然后发现我把/dashboard整个文件夹放在了/root/下面，导致nginx没有权限进行访问，然后就把它转移到了/var/www/下去了。\n然后就是需要注意api的地址要写对，比如这个项目中是/ws，需要在/etc/nginx/sites-avilable/scoreboard中写正确。\n","wordCount":"287","inLanguage":"en","image":"//localhost:1313/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2024-01-21T00:00:00Z","dateModified":"2024-01-21T00:00:00Z","author":{"@type":"Person","name":"sirius1y"},"mainEntityOfPage":{"@type":"WebPage","@id":"//localhost:1313/posts/notes/dev/dev-%E7%82%B9%E5%87%BB%E6%8E%92%E8%A1%8C%E6%A6%9C/"},"publisher":{"@type":"Organization","name":"Sirius' Blog","logo":{"@type":"ImageObject","url":"//localhost:1313/images/icon.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=//localhost:1313/ accesskey=h title="Home (Alt + H)"><img src=//localhost:1313/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=//localhost:1313/archives/ title=Archives><span>Archives</span></a></li><li><a href=//localhost:1313/categories/ title=Categories><span>Categories</span></a></li><li><a href=//localhost:1313/posts/ title=Posts><span>Posts</span></a></li><li><a href=//localhost:1313/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=//localhost:1313/>Home</a>&nbsp;»&nbsp;<a href=//localhost:1313/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">点击排行榜scoreboard</h1><div class=post-description>本文记录使用vue+gin+redis搭建了一个简单的点击排行榜，虽然有点无聊，但是两个幼稚鬼玩好好笑hhh</div><div class=post-meta><span title='2024-01-21 00:00:00 +0000 UTC'>January 21, 2024</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;287 words&nbsp;·&nbsp;sirius1y</div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e9%a1%b9%e7%9b%ae%e6%a6%82%e8%bf%b0 aria-label=项目概述>项目概述</a><ul><li><a href=#%e6%8a%80%e6%9c%af%e6%a0%88 aria-label=技术栈>技术栈</a></li><li><a href=#%e6%95%b4%e4%bd%93%e8%ae%be%e8%ae%a1 aria-label=整体设计>整体设计</a></li><li><a href=#api%e8%ae%be%e8%ae%a1 aria-label=API设计>API设计</a><ul><ul><li><a href=#%e6%b6%88%e6%81%af%e7%b1%bb%e5%9e%8b aria-label=消息类型>消息类型</a></li><li><a href=#api%e6%b5%81%e7%a8%8b aria-label=API流程>API流程</a></li></ul></ul></li><li><a href=#%e5%89%8d%e7%ab%af%e8%ae%be%e8%ae%a1 aria-label=前端设计>前端设计</a></li><li><a href=#%e5%90%8e%e7%ab%af%e8%ae%be%e8%ae%a1 aria-label=后端设计>后端设计</a><ul><li><a href=#%e4%bd%bf%e7%94%a8%e5%88%b0%e7%9a%84redis%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84 aria-label=使用到的redis数据结构>使用到的redis数据结构</a><ul><li><a href=#a-sorted-set aria-label="a. Sorted Set">a. Sorted Set</a></li><li><a href=#b-hash aria-label="b. Hash">b. Hash</a></li></ul></li><li><a href=#%e7%94%a8%e6%88%b7%e8%a1%8c%e4%b8%ba%e5%a4%84%e7%90%86%e9%80%bb%e8%be%91 aria-label=用户行为处理逻辑>用户行为处理逻辑</a><ul><li><a href=#a-%e7%94%a8%e6%88%b7%e6%b7%bb%e5%8a%a0%e4%b8%8e%e6%9b%b4%e6%96%b0 aria-label="a. 用户添加与更新">a. 用户添加与更新</a></li><li><a href=#b-%e7%82%b9%e5%87%bb%e9%97%b4%e9%9a%94%e6%9b%b4%e6%96%b0 aria-label="b. 点击间隔更新">b. 点击间隔更新</a></li><li><a href=#c-%e7%94%a8%e6%88%b7%e6%8e%92%e5%90%8d%e8%8e%b7%e5%8f%96 aria-label="c. 用户排名获取">c. 用户排名获取</a></li><li><a href=#d-%e6%b4%bb%e8%b7%83%e7%8a%b6%e6%80%81%e6%a3%80%e6%9f%a5 aria-label="d. 活跃状态检查">d. 活跃状态检查</a></li></ul></li><li><a href=#websocket-%e9%80%9a%e4%bf%a1%e4%b8%8e%e5%a4%84%e7%90%86 aria-label="WebSocket 通信与处理">WebSocket 通信与处理</a><ul><li><a href=#a-websocket-%e5%8d%87%e7%ba%a7%e5%99%a8 aria-label="a. WebSocket 升级器">a. WebSocket 升级器</a></li><li><a href=#b-websocket-%e8%bf%9e%e6%8e%a5%e7%ae%a1%e7%90%86 aria-label="b. WebSocket 连接管理">b. WebSocket 连接管理</a></li><li><a href=#c-%e6%b6%88%e6%81%af%e8%a7%a3%e6%9e%90%e4%b8%8e%e8%b7%af%e7%94%b1 aria-label="c. 消息解析与路由">c. 消息解析与路由</a></li></ul></li><li><a href=#%e6%b6%88%e6%81%af%e5%a4%84%e7%90%86%e9%80%bb%e8%be%91 aria-label=消息处理逻辑>消息处理逻辑</a></li><li><a href=#%e5%ae%9a%e6%97%b6%e4%bb%bb%e5%8a%a1%e5%a4%84%e7%90%86 aria-label=定时任务处理>定时任务处理</a></li><li><a href=#%e7%94%a8%e6%88%b7%e6%8e%92%e5%90%8d%e7%9a%84-websocket-%e5%b9%bf%e6%92%ad aria-label="用户排名的 WebSocket 广播">用户排名的 WebSocket 广播</a></li><li><a href=#%e9%9c%80%e8%a6%81%e6%b3%a8%e6%84%8f%e7%9a%84%e6%94%b9%e8%bf%9b%e7%82%b9 aria-label=需要注意的改进点>需要注意的改进点</a></li></ul></li><li><a href=#%e5%8f%af%e4%bb%a5%e4%bf%ae%e6%94%b9%e7%9a%84%e4%b8%80%e4%ba%9bbug aria-label=可以修改的一些bug>可以修改的一些bug</a></li><li><a href=#%e9%83%a8%e7%bd%b2%e5%88%b0%e6%9c%8d%e5%8a%a1%e5%99%a8%e4%b8%8a aria-label=部署到服务器上>部署到服务器上</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h1 id=项目概述>项目概述<a hidden class=anchor aria-hidden=true href=#项目概述>#</a></h1><p>项目地址：https://github.com/sirius2alpha/scoreboard</p><p>使用Redis在服务器上对用户的点击数排序，并返回点击次数排行榜。
<img loading=lazy src=https://s2.loli.net/2024/01/21/lOkfYT3c2FNM9wm.png alt=首页></p><p><img loading=lazy src=https://s2.loli.net/2024/01/21/jNbExm53cVQUIhO.png alt=排行榜></p><h2 id=技术栈>技术栈<a hidden class=anchor aria-hidden=true href=#技术栈>#</a></h2><p><img loading=lazy src=https://s2.loli.net/2024/01/21/X5aFqSHskQPR1up.png alt=scoreboard技术栈></p><h2 id=整体设计>整体设计<a hidden class=anchor aria-hidden=true href=#整体设计>#</a></h2><ol><li><strong>用户界面</strong>
排行榜展示区: 显示当前排行榜的状态。
点击按钮: 用户点击来增加他们的计分。
昵称输入和提交: 允许新用户输入昵称并参与排行榜。
实时更新监听: 不需要用户交互，自动更新排行榜。</li><li><strong>WebSocket客户端逻辑</strong>
建立连接: 当用户访问网站时，建立WebSocket连接。
发送点击事件: 当用户点击按钮时，发送消息到服务器。
接收排行榜更新: 监听来自服务器的排行榜更新，并更新界面。
用户注册: 发送新用户的昵称到服务器。
处理断开连接: 如果用户20秒未操作，发送断开消息到服务器。
后端设计（Gin + Redis）</li><li><strong>WebSocket服务器</strong>
处理WebSocket连接: 接受和管理WebSocket连接。
接收消息: 解析从客户端接收到的消息（点击事件，新用户注册）。
Redis交互: 更新用户的分数并重新排序排行榜。
广播排行榜更新: 将更新后的排行榜发送给所有连接的客户端。
处理断开: 移除30秒未操作的用户。</li><li><strong>Redis逻辑</strong>
用户分数管理: 存储和更新用户分数。
排行榜排序: 实时更新排行榜。
数据持久化: 保证数据在服务重启后仍然可用。</li></ol><h2 id=api设计>API设计<a hidden class=anchor aria-hidden=true href=#api设计>#</a></h2><p>本项目API设计采用的是websocket实现。</p><p>由于考虑到用户在点击比较频繁，如果采用HTTP会造成头部开销较大，而websocket的头部开销会相对小一些。</p><h4 id=消息类型>消息类型<a hidden class=anchor aria-hidden=true href=#消息类型>#</a></h4><ul><li><p>UserClick: { type: &ldquo;UserClick&rdquo;, nickname: &ldquo;用户昵称&rdquo; }</p></li><li><p>NewUser: { type: &ldquo;NewUser&rdquo;, nickname: &ldquo;用户昵称&rdquo; }</p></li><li><p>UserInactive: { type: &ldquo;UserInactive&rdquo;, nickname: &ldquo;用户昵称&rdquo; }</p></li><li><p>RankUpdate: { type: &ldquo;RankUpdate&rdquo;, ranks: [{nickname: &ldquo;用户昵称&rdquo;, score: 分数,ClickTime: 上次点击时间, ClickInterval: 上次点击间隔时间}, &mldr;] }</p></li></ul><h4 id=api流程>API流程<a hidden class=anchor aria-hidden=true href=#api流程>#</a></h4><p>用户点击: 前端发送UserClick消息到服务器。
新用户加入: 前端发送NewUser消息到服务器。
服务器处理: 接收消息，更新Redis数据，并重新排序排行榜。
排行榜更新: 服务器广播RankUpdate消息到所有客户端。
前端更新界面: 客户端接收RankUpdate消息，更新排行榜显示。</p><h2 id=前端设计>前端设计<a hidden class=anchor aria-hidden=true href=#前端设计>#</a></h2><p>前端采用vue框架编写完成，UI组件采用elementplus</p><h2 id=后端设计>后端设计<a hidden class=anchor aria-hidden=true href=#后端设计>#</a></h2><p>项目后端使用 <code>github.com/gorilla/websocket</code> 和 <code>github.com/gin-gonic/gin</code> 实现一个基于 WebSocket 的实时通信服务。通过 WebSocket，服务能够实时接收和处理客户端发送的各种类型的消息，并根据消息类型执行相应的逻辑。此外，通过后台定时任务，服务还能够定期更新和广播用户的排名信息。这种实现方式对于需要实时通信和快速响应的应用场景非常合适。</p><pre tabindex=0><code>backend
├── controllers
│   └── websocket.go
├── go.mod
├── go.sum
├── main.go
├── routers
│   └── router.go
└── services
    └── redis-server.go
</code></pre><p>后端采用Gin框架完成，大致流程：</p><ul><li>在main.go中启动路由，并且启动端口监听</li><li>在routers/router.go中定义/ws路由，用于接收websocket的连接</li><li>对于ws的处理，函数定于在controllers/websocket.go中，包括针对不同任务类型使用redis数据库的函数调用</li><li>在services/redis-server.go中，对各个任务如何具体操作redis进行定义</li></ul><h3 id=使用到的redis数据结构>使用到的redis数据结构<a hidden class=anchor aria-hidden=true href=#使用到的redis数据结构>#</a></h3><h4 id=a-sorted-set>a. Sorted Set<a hidden class=anchor aria-hidden=true href=#a-sorted-set>#</a></h4><ul><li><strong>用途</strong>: 存储用户的点击次数，用于排名。</li><li><strong>操作</strong>:<ul><li><code>ZAdd</code>: 添加新用户或初始用户，并设置点击次数。</li><li><code>ZIncrBy</code>: 增加用户的点击次数。</li><li><code>ZRemRangeByRank</code>: 清空sorted set。</li><li><code>ZRevRangeWithScores</code>: 获取点击次数最多的前10个用户。</li><li><code>ZRem</code>: 删除不活跃的用户。</li></ul></li></ul><h4 id=b-hash>b. Hash<a hidden class=anchor aria-hidden=true href=#b-hash>#</a></h4><ul><li><strong>用途</strong>: 存储用户的最后点击时间和点击间隔。</li><li><strong>操作</strong>:<ul><li><code>HSet</code>: 初始化或更新用户的点击时间和点击间隔。</li><li><code>HGet</code>: 获取特定用户的点击时间和点击间隔。</li><li><code>Del</code>: 清空点击时间和间隔的记录。</li></ul></li></ul><h3 id=用户行为处理逻辑>用户行为处理逻辑<a hidden class=anchor aria-hidden=true href=#用户行为处理逻辑>#</a></h3><h4 id=a-用户添加与更新>a. 用户添加与更新<a hidden class=anchor aria-hidden=true href=#a-用户添加与更新>#</a></h4><ul><li><strong>新用户处理</strong>: 当有新用户加入时，通过<code>AddNewUser</code>函数将用户添加到sorted set中，并初始化点击次数为0。</li><li><strong>用户点击处理</strong>: 在<code>HandleUserClick</code>函数中，每当用户点击，使用<code>ZIncrBy</code>来增加其在sorted set中的得分（即点击次数），并记录点击时间。</li></ul><h4 id=b-点击间隔更新>b. 点击间隔更新<a hidden class=anchor aria-hidden=true href=#b-点击间隔更新>#</a></h4><ul><li><strong>定时更新</strong>: <code>UpdateClickInterval</code>函数定期更新每个用户自上次点击以来的时间间隔。</li><li><strong>时区处理</strong>: 代码中特别考虑了时区问题，将时间转换为中国标准时间（Asia/Shanghai）。</li></ul><h4 id=c-用户排名获取>c. 用户排名获取<a hidden class=anchor aria-hidden=true href=#c-用户排名获取>#</a></h4><ul><li><strong>排名展示</strong>: <code>GetRanking</code>函数用于获取并返回用户的点击排名，包括用户ID、点击次数、上次点击时间和点击间隔。</li></ul><h4 id=d-活跃状态检查>d. 活跃状态检查<a hidden class=anchor aria-hidden=true href=#d-活跃状态检查>#</a></h4><ul><li><strong>用户活跃度监测</strong>: <code>CheckAllUsers</code>和<code>HandleUserInactive</code>函数用于检查所有用户的活跃状态。若用户的点击间隔超过20秒，则视为不活跃并从sorted set中移除。</li></ul><h3 id=websocket-通信与处理>WebSocket 通信与处理<a hidden class=anchor aria-hidden=true href=#websocket-通信与处理>#</a></h3><h4 id=a-websocket-升级器>a. WebSocket 升级器<a hidden class=anchor aria-hidden=true href=#a-websocket-升级器>#</a></h4><ul><li><strong>配置</strong>: 设置了读写缓冲区大小为 1024 字节，并允许所有跨域请求。</li><li><strong>功能</strong>: 用于将 HTTP GET 请求升级为 WebSocket 连接。</li></ul><h4 id=b-websocket-连接管理>b. WebSocket 连接管理<a hidden class=anchor aria-hidden=true href=#b-websocket-连接管理>#</a></h4><ul><li><strong>连接记录</strong>: 通过全局变量 <code>connections</code> 记录所有打开的 WebSocket 连接。</li><li><strong>消息处理</strong>: 在无限循环中监听并读取来自 WebSocket 连接的消息。</li></ul><h4 id=c-消息解析与路由>c. 消息解析与路由<a hidden class=anchor aria-hidden=true href=#c-消息解析与路由>#</a></h4><ul><li><strong>JSON 检查</strong>: 使用 <code>isJSON</code> 函数检查接收到的消息是否为 JSON 格式。</li><li><strong>类型判断</strong>: 根据消息中的 &ldquo;type&rdquo; 字段，决定执行对应的处理逻辑。</li></ul><h3 id=消息处理逻辑>消息处理逻辑<a hidden class=anchor aria-hidden=true href=#消息处理逻辑>#</a></h3><ul><li><strong>新用户处理</strong>: 当收到类型为 &ldquo;NewUser&rdquo; 的消息时，调用 <code>services.AddNewUser</code> 添加新用户。</li><li><strong>用户点击处理</strong>: 收到 &ldquo;UserClick&rdquo; 类型的消息时，调用 <code>services.HandleUserClick</code> 处理用户点击事件。</li><li><strong>用户不活跃处理</strong>: 对于 &ldquo;UserInactive&rdquo; 类型的消息，执行 <code>services.HandleUserInactive</code> 以处理不活跃用户。</li></ul><h3 id=定时任务处理>定时任务处理<a hidden class=anchor aria-hidden=true href=#定时任务处理>#</a></h3><ul><li><strong>后台定时任务</strong>: 使用 goroutine 定期执行用户点击间隔的更新、用户活跃状态检查和用户排名获取。</li><li><strong>间隔设置</strong>: 目前设置为每 200 毫秒执行一次循环中的任务。</li></ul><h3 id=用户排名的-websocket-广播>用户排名的 WebSocket 广播<a hidden class=anchor aria-hidden=true href=#用户排名的-websocket-广播>#</a></h3><ul><li><strong>排名信息广播</strong>: 定期将用户排名信息通过所有打开的 WebSocket 连接广播给客户端。</li></ul><h3 id=需要注意的改进点>需要注意的改进点<a hidden class=anchor aria-hidden=true href=#需要注意的改进点>#</a></h3><ul><li><strong>错误处理</strong>: 在一些关键操作后，需要更全面地处理可能的错误返回值。</li><li><strong>性能优化</strong>: 随着 WebSocket 连接数的增加，消息广播可能成为性能瓶颈。</li></ul><h2 id=可以修改的一些bug>可以修改的一些bug<a hidden class=anchor aria-hidden=true href=#可以修改的一些bug>#</a></h2><p>1、用户在登录的时候遇到相同用户名，会把他直接刷新</p><p>2、手机端自适应功能差，体验不好</p><ul><li>手机在点击按钮的时候。会触发双击浏览器双击放大的功能，影响体验</li><li>手机端的网页有时候滑动不了</li><li>有时候手机端最上面的两个按钮会被浏览器的头部遮挡，但是又滑动不上去</li></ul><p>3、对于只登录而没有点击的用户，排行榜中会保留下来，但不会清理</p><p>上一次的点击间隔和上次点击时间都不会刷新，后端是根据间隔时间清理用户，虽然可以保留，但是一直保存着也不是办法，可以设置一个单独的时长进行清理。</p><h2 id=部署到服务器上>部署到服务器上<a hidden class=anchor aria-hidden=true href=#部署到服务器上>#</a></h2><p>现在云服务商的域名管理处新建了一个子域名，然后在服务器上使用了nginx给子域名提供对应的服务。</p><p>服务器上保持资源最简单就行，不用把源码都放到服务器上，对于前端的vue框架这边，只用把<code>npm build</code>生成的/dist目录上传就行；对与gin来说，也只需要把<code>go build main.go</code>生成的main可执行文件上传到服务器就行，这样也更加安全。</p><p><strong>遇到的一些问题</strong>：</p><p>打开网站显示500，先去检查nginx的日志，然后发现我把/dashboard整个文件夹放在了/root/下面，导致nginx没有权限进行访问，然后就把它转移到了/var/www/下去了。</p><p>然后就是需要注意api的地址要写对，比如这个项目中是/ws，需要在<code>/etc/nginx/sites-avilable/scoreboard</code>中写正确。</p></div><footer class=post-footer><ul class=post-tags><li><a href=//localhost:1313/tags/redis/>Redis</a></li><li><a href=//localhost:1313/tags/websocket/>Websocket</a></li><li><a href=//localhost:1313/tags/nginx/>Nginx</a></li><li><a href=//localhost:1313/tags/gin/>Gin</a></li><li><a href=//localhost:1313/tags/vue/>Vue</a></li><li><a href=//localhost:1313/tags/go/>Go</a></li></ul><nav class=paginav><a class=prev href=//localhost:1313/posts/notes/data-analysis/spider/><span class=title>« Prev</span><br><span>使用Selenium库爬取网易云音乐和携程旅行评论</span>
</a><a class=next href=//localhost:1313/posts/notes/network/clash-for-linux%E9%A3%9F%E7%94%A8%E6%8C%87%E5%8D%97/><span class=title>Next »</span><br><span>在linux上配置clash，通过Dashboard控制</span></a></nav></footer><script>function createGiscusScript(e){const t=document.createElement("script");Object.entries(e).forEach(([e,n])=>t.setAttribute(e,n)),document.querySelector("article").appendChild(t);const n=document.querySelector('label[for="switch_default"]');n&&n.addEventListener("click",function(){const e=document.body.classList.contains("dark")?"transparent_dark":"light";t.setAttribute("data-theme",e),sendMessage({setConfig:{theme:e}})})}function sendMessage(e){const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")}document.addEventListener("DOMContentLoaded",function(){const e={src:"https://giscus.app/client.js","data-repo":"yunyit/yunyit.github.io","data-repo-id":"R_kgDOKqkPYw","data-category":"Comments","data-category-id":"DIC_kwDOKqkPY84CceDi","data-mapping":"url","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"top","data-lang":"en",crossorigin:"anonymous",async:""};e["data-theme"]=document.body.classList.contains("dark")?"transparent_dark":"light",createGiscusScript(e);const t=new MutationObserver(()=>{const e=document.body.classList.contains("dark")?"transparent_dark":"light";sendMessage({setConfig:{theme:e}})});t.observe(document.body,{attributes:!0,attributeFilter:["class"]})})</script></article></main><footer class=footer><span><a href=https://us.umami.is/websites/5e6ac0c1-e2b2-4d0f-9542-b79ac2cf89c4 rel="noopener noreferrer" target=_blank>Analysis</a>
</span>|
<script defer src=https://cloud.umami.is/script.js data-website-id=5e6ac0c1-e2b2-4d0f-9542-b79ac2cf89c4></script><span><a href=https://beian.miit.gov.cn/ target=_blank>渝ICP备2024018631号</a>
</span>|
<span>&copy; 2024 <a href=//localhost:1313/>Sirius' Blog</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>