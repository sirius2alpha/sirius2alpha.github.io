<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>gRPC调用坎坷历程记录 | Sirius' Blog</title>
<meta name=keywords content="软件开发,auth"><meta name=description content="protoc代码生成了哪些东西？RPC和RESTful有什么不同？"><meta name=author content="sirius1y"><link rel=canonical href=https://sirius1y.top/posts/notes/dev/dev-aorb-grpc/><link crossorigin=anonymous href=/assets/css/stylesheet.3551607c8eb1ef998f0b6c81d22f9f03dd2c3b8ecaf983e42c023e8d41e39f66.css integrity="sha256-NVFgfI6x75mPC2yB0i+fA90sO47K+YPkLAI+jUHjn2Y=" rel="preload stylesheet" as=style><link rel=icon href=https://sirius1y.top/images/icon.png><link rel=icon type=image/png sizes=16x16 href=https://sirius1y.top/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://sirius1y.top/favicon-32x32.png><link rel=apple-touch-icon href=https://sirius1y.top/apple-touch-icon.png><link rel=mask-icon href=https://sirius1y.top/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://sirius1y.top/posts/notes/dev/dev-aorb-grpc/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="gRPC调用坎坷历程记录"><meta property="og:description" content="protoc代码生成了哪些东西？RPC和RESTful有什么不同？"><meta property="og:type" content="article"><meta property="og:url" content="https://sirius1y.top/posts/notes/dev/dev-aorb-grpc/"><meta property="og:image" content="https://sirius1y.top/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-07-23T00:00:00+00:00"><meta property="article:modified_time" content="2024-07-23T00:00:00+00:00"><meta property="og:site_name" content="Sirius' Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://sirius1y.top/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="gRPC调用坎坷历程记录"><meta name=twitter:description content="protoc代码生成了哪些东西？RPC和RESTful有什么不同？"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://sirius1y.top/posts/"},{"@type":"ListItem","position":2,"name":"gRPC调用坎坷历程记录","item":"https://sirius1y.top/posts/notes/dev/dev-aorb-grpc/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"gRPC调用坎坷历程记录","name":"gRPC调用坎坷历程记录","description":"protoc代码生成了哪些东西？RPC和RESTful有什么不同？","keywords":["软件开发","auth"],"articleBody":"gRPC服务的架构图 RPC调用总的来说就是客户端调用存根的代码，然后存根代码和RPC库实现通信，服务端的存根收到了信息后交给具体的服务进行处理，之后再原路返回就完了。\n这里附上一篇关于gRPC讲解的博客园的文章\nProto文件代码生成 项目的前后端都是使用的gRPC进行通信，都需要使用protoc编译器把之前定义好的proto文件进行编译生成对应的代码进行调用。\n问题1 timestamp.proto文件找不到 timestamp.proto是google的一个时间戳的包，因为在我们自己的proto文件中使用到了google.protobuf.Timestamp，在proeo文件的最上方也要导入对应的proto文件import \"google/protobuf/timestamp.proto\";\n我记得在下载protoc编译器的时候，压缩包下面就有一个include文件夹，其中就包含有timestamp.proto文件\n问题2 go代码生成对应的包名和位置对不上 项目的后端采用的是go，想要把proto文件编译成golang的代码。这就需要在proto文件中加上go_package的字段，比如：\nsyntax = \"proto3\"; package rpc.auth; option go_package = \"github.com/BigNoseCattyHome/aorb/backend/rpc/auth;auth\"; import \"google/protobuf/timestamp.proto\"; // 定义消息，用于请求和响应结构 message LoginRequest { string username = 1; // 用户名/用户ID string password = 2; // 密码的md5摘要 string device_id = 3; // 设备ID google.protobuf.Timestamp timestamp = 4; // 时间戳 string nonce = 5; // 随机数 } 然后在使用protoc编译的时候，在命令行中也要加上go的一些选项，比如：\nprotoc --go_out=. person.proto\t// 找到当前目录下的person.proto并生成go的代码，输出到当前目录(.) 但是又有了一个问题就是在该文件夹下面，会生成你的包名go_package的层级目录，最后才是你的最终代码。但是我想让proto文件直接生成在一个固定的文件夹位置，并且没有那么多的层级文件夹。\n然后发现了有一个命令选项是--go_opt=paths=source_relative,使得生成的Go代码文件的路径与对应的.proto文件的路径保持一致\n问题3 dart代码生成的时候老是存在找不到pb.xx 后来上google和stackoverflow看了半天，发现结果是依赖版本的问题，把protobuf的依赖版本从^2.1.0改为^3.1.0，重新拉取一下依赖就没问题了。\n之后队友给力解决了这个问题，把proto代码生成写进了Makefile，总算解决了proto文件代码生成的问题\nPROTO_PATH=./idl GOOGLE_PROTO_PATH=/usr/local/include OUTPUT_DART_PATH=./frontend/lib/generated/ GO_OUT_PATH=./backend/rpc PROTOC_GEN_DART=$(shell which protoc-gen-dart) proto: @echo \"Creating golang and dart grpc files...\" @for file in $(PROTO_PATH)/*.proto; do \\ if [ -f \"$$file\" ]; then \\ prefix=$$(basename \"$$file\" .proto); \\ mkdir -p $(GO_OUT_PATH)/\"$${prefix}\"; \\ mkdir -p $(OUTPUT_DART_PATH); \\ echo \"Created directory for $$prefix\"; \\ protoc -I$(PROTO_PATH) -I$(GOOGLE_PROTO_PATH) \\ --go_out=$(GO_OUT_PATH)/$$prefix --go_opt=paths=source_relative \\ --go-grpc_out=$(GO_OUT_PATH)/$$prefix --go-grpc_opt=paths=source_relative \\ --dart_out=grpc:$(OUTPUT_DART_PATH) \\ --plugin=protoc-gen-dart=$(PROTOC_GEN_DART) \\ $$file; \\ echo \"Generated gRPC code for $$prefix\"; \\ fi; \\ done @protoc -I$(GOOGLE_PROTO_PATH) \\ --dart_out=grpc:$(OUTPUT_DART_PATH) \\ --plugin=protoc-gen-dart=$(PROTOC_GEN_DART) \\ google/protobuf/timestamp.proto @echo \"Generated Dart code for Google's timestamp.proto\" 问题4 在windows上无法运行脚本 在另外一个队友的电脑上，他是使用的windows进行开发，然后遇到了代码生成失败的问题。然后看了一下，大概的问题就是命令行工具不一样，有些命令识别不了，之后把脚本改成windows的一些版本就ok了。\n网关中使用consul进行服务发现 我们项目的架构就是前端向后端发送gRPC请求，实际上就是向后端的网关进行发送，前端就不用管后端具体是怎么实现的了，只需要向网关中发送请求即可。\n网关的职责就是接收来自前端的请求，然后把请求转发给具体的微服务，等微服务处理好之后，再返回给网关，网关再给人家前端传回去就好了。\n项目中使用到了consul进行服务注册和发现，当微服务启动的时候，就会向consul发送一个微服务注册，告诉consul他自己微服务的名字和地址。然后网关通过consul客户端与consul程序进行交流，可以对在线的微服务根据服务名进行查询，获取到这些微服务实例的地址，然后把来自前端的请求准确地转发到这些实例中。\n这里有两个问题\n问题1 gRPC调用的方法名和在consul中注册的名字不同 一般来说，gRPC的方法名是服务接口的一部分，像这样：./\n我们的网关依赖于根据名字查找微服务的地址，我们的微服务的注册名为AorB-AuthService，而我们的gRPC的方法名为rpc.auth.AuthService/Register（包名为rpc.auth）\n所以需要在网关中增加一个映射，把gRPC的方法名转为在consul中注册的名字。\n// gRPC 服务名到 Consul 服务名的映射 var serviceNameMapping = map[string]string{ \"rpc.auth.AuthService\": config.AuthRpcServerName, \"rpc.user.UserService\": config.UserRpcServerName, \"rpc.comment.CommentService\": config.CommentRpcServerName, \"rpc.vote.VoteService\": config.VoteRpcServerName, \"rpc.poll.QuestionService\": config.PollRpcServerName, \"rpc.recommend.RecommendService\": config.RecommendRpcServerName, } 问题2 网关转发gRPC请求的前提是能够正确识别和接收gRPC请求 之前没有找到问题的时候情况be like:前端写好了注册的逻辑，点击发送的按钮，在前端的控制台上可以看见各个发送的数据均是正常，但是会收到gRPC的错误代码13，找不到对应的服务unknow service rpc.auth.AuthService。后端也启动了网关和auth微服务，但是在后端上在对应的方法上添加了日志输出，也没有任何日志打印出来。\n尝试直接与微服务通信 想了半天没有什么思路，然后就想排查一下后端微服务的功能是不是OK的，然后就直接把前端的请求发送到auth微服务上去，结果就是能够正常返回。这就说明了就是网关的转发的问题。锁定了目标在网关，感觉问题就解决一大半了。\n网关修复 在查阅了很多资料后发现，网关中虽然是转发gRPC请求，但是他也是一个gRPC服务器，也需要能够正确接收并处理AuthService的请求，所以他也需要实现AuthService接口，不过服务的实现采用\tauth.UnimplementedAuthServiceServer就OK了，因为具体的处理也并不是在这里，他只用转发就好了。然后在gRPC服务器上注册 auth.RegisterAuthServiceServer(s, \u0026GatewayServer{})服务就可以正常实现转发了。\n将RESTful代码重构为gRPC代码 因为之前项目开发的时候后端采用了RESTful，后来决定整体上使用gRPC进行通讯，RESTful写得不是很多，所以就想要把它转过来。\nRESTful和gRPC他们之间的差异是在调用资源和传输的方式上有所差异，但是对于数据的操作部分，如service之类的代码其实并没有影响，代码的重构只用考虑：如何从RESTful风格下获取资源变为在gRPC调用下如何获取。\n理解生成的存根代码 首先需要生成对应语言的存根（stub）代码，比如在proto文件中有这么一个文件：\nsyntax = \"proto3\"; package user; option go_package = \"github.com/BigNoseCattyHome/aorb/backend/rpc/user;user\"; message CoinRecord { int64 consume = 1; // 消耗的金币数 string question_id = 2; // 为其投币的问题ID string user_id = 3; // 使用者的ID } // TODO optional 字段在后续开发过程中应该逐步取消 message User { string avatar = 1; // 用户头像 repeated string blacklist = 2; // 屏蔽好友 optional double coins = 3; // 用户的金币数 repeated CoinRecord coins_record = 4; // 用户金币流水记录 repeated string followed = 5; // 关注者 repeated string follower = 6; // 被关注者 uint32 id = 7; // 用户ID optional string ipaddress = 8; // IP归属地 string nickname = 9; // 用户昵称 repeated uint32 questions_ask = 10; // 发起过的问题 repeated uint32 questions_asw = 11; // 回答过的问题 repeated uint32 questions_collect = 12; // 收藏的问题 string username = 13; // 用户登录名 } message UserRequest{ uint32 user_id = 1; // 用户id uint32 actor_id = 2; // 发送请求的用户的id } message UserResponse{ int32 status_code = 1; // 状态码，0-成功，其他值-失败 string status_msg = 2; // 返回状态描述 User user = 3; // 用户信息 } message UserExistRequest{ uint32 user_id = 1; // 用户id } message UserExistResponse{ int32 status_code = 1; // 状态码，0-成功，其他值-失败 string status_msg = 2; // 返回状态描述 bool existed = 3; // 是否存在用户 } service UserService{ rpc GetUserInfo(UserRequest) returns (UserResponse); rpc GetUserExistInformation(UserExistRequest) returns (UserExistResponse); } 然后他生成了对应的存根代码文件就是user.pb.go和user_grpc.pb.go\n其中user.pb.go中就是对定义的各个数据结构比如UserRequest进行定义以及序列化和反序列化的代码 user_grpc.pb.go主要包括了UserServiceClient和UserServiceServer这两个接口的定义，以及他们中具体的方法 // UserServiceClient is the client API for UserService service. // // For semantics around ctx use and closing/ending streaming RPCs, please refer to https://pkg.go.dev/google.golang.org/grpc/?tab=doc#ClientConn.NewStream. type UserServiceClient interface { GetUserInfo(ctx context.Context, in *UserRequest, opts ...grpc.CallOption) (*UserResponse, error) GetUserExistInformation(ctx context.Context, in *UserExistRequest, opts ...grpc.CallOption) (*UserExistResponse, error) } type userServiceClient struct { cc grpc.ClientConnInterface } func NewUserServiceClient(cc grpc.ClientConnInterface) UserServiceClient { return \u0026userServiceClient{cc} } func (c *userServiceClient) GetUserInfo(ctx context.Context, in *UserRequest, opts ...grpc.CallOption) (*UserResponse, error) { cOpts := append([]grpc.CallOption{grpc.StaticMethod()}, opts...) out := new(UserResponse) err := c.cc.Invoke(ctx, UserService_GetUserInfo_FullMethodName, in, out, cOpts...) if err != nil { return nil, err } return out, nil } func (c *userServiceClient) GetUserExistInformation(ctx context.Context, in *UserExistRequest, opts ...grpc.CallOption) (*UserExistResponse, error) { cOpts := append([]grpc.CallOption{grpc.StaticMethod()}, opts...) out := new(UserExistResponse) err := c.cc.Invoke(ctx, UserService_GetUserExistInformation_FullMethodName, in, out, cOpts...) if err != nil { return nil, err } return out, nil } // UserServiceServer is the server API for UserService service. // All implementations must embed UnimplementedUserServiceServer // for forward compatibility type UserServiceServer interface { GetUserInfo(context.Context, *UserRequest) (*UserResponse, error) GetUserExistInformation(context.Context, *UserExistRequest) (*UserExistResponse, error) mustEmbedUnimplementedUserServiceServer() } 服务的具体实现 这些方法直接在你的handler中进行实现，比如在auth的handler中进行实现Register\n无非是参数需要从定义的auth.RegisterRequest中获取，其他的就是你的正常的服务。\n// Register 注册 func (a AuthServiceImpl) Register(context context.Context, request *auth.RegisterRequest) (*auth.RegisterResponse, error) { log.Infof(\"Received Register request: %v\", request) // 解析参数 user := models.User{ Username: request.Username, Password: request.Password, Nickname: request.Nickname, Avatar: request.Avatar, Ipaddress: request.Ipaddress, } // 调用服务 err := services.RegisterUser(user) if err != nil { return nil, status.Errorf(codes.Unauthenticated, \"register failed: %v\", err) } // 返回响应 registerResponse := \u0026auth.RegisterResponse{ Success: true, Message: \"User registered successfully\", } return registerResponse, nil } 其他要做的 完成好这些实现之后，最后再写一个main函数启动你的微服务，向consul中注册微服务，管理好日志以便于日后查找问题就好了。\n","wordCount":"662","inLanguage":"en","image":"https://sirius1y.top/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2024-07-23T00:00:00Z","dateModified":"2024-07-23T00:00:00Z","author":{"@type":"Person","name":"sirius1y"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://sirius1y.top/posts/notes/dev/dev-aorb-grpc/"},"publisher":{"@type":"Organization","name":"Sirius' Blog","logo":{"@type":"ImageObject","url":"https://sirius1y.top/images/icon.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://sirius1y.top/ accesskey=h title="Home (Alt + H)"><img src=https://sirius1y.top/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://sirius1y.top/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://sirius1y.top/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://sirius1y.top/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://sirius1y.top/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://sirius1y.top/>Home</a>&nbsp;»&nbsp;<a href=https://sirius1y.top/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">gRPC调用坎坷历程记录</h1><div class=post-description>protoc代码生成了哪些东西？RPC和RESTful有什么不同？</div><div class=post-meta><span title='2024-07-23 00:00:00 +0000 UTC'>July 23, 2024</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;662 words&nbsp;·&nbsp;sirius1y</div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#grpc%e6%9c%8d%e5%8a%a1%e7%9a%84%e6%9e%b6%e6%9e%84%e5%9b%be aria-label=gRPC服务的架构图>gRPC服务的架构图</a></li><li><a href=#proto%e6%96%87%e4%bb%b6%e4%bb%a3%e7%a0%81%e7%94%9f%e6%88%90 aria-label=Proto文件代码生成>Proto文件代码生成</a><ul><li><a href=#%e9%97%ae%e9%a2%981-timestampproto%e6%96%87%e4%bb%b6%e6%89%be%e4%b8%8d%e5%88%b0 aria-label="问题1 timestamp.proto文件找不到">问题1 timestamp.proto文件找不到</a></li><li><a href=#%e9%97%ae%e9%a2%982-go%e4%bb%a3%e7%a0%81%e7%94%9f%e6%88%90%e5%af%b9%e5%ba%94%e7%9a%84%e5%8c%85%e5%90%8d%e5%92%8c%e4%bd%8d%e7%bd%ae%e5%af%b9%e4%b8%8d%e4%b8%8a aria-label="问题2 go代码生成对应的包名和位置对不上">问题2 go代码生成对应的包名和位置对不上</a></li><li><a href=#%e9%97%ae%e9%a2%983-dart%e4%bb%a3%e7%a0%81%e7%94%9f%e6%88%90%e7%9a%84%e6%97%b6%e5%80%99%e8%80%81%e6%98%af%e5%ad%98%e5%9c%a8%e6%89%be%e4%b8%8d%e5%88%b0pbxx aria-label="问题3 dart代码生成的时候老是存在找不到pb.xx">问题3 dart代码生成的时候老是存在找不到pb.xx</a></li><li><a href=#%e9%97%ae%e9%a2%984-%e5%9c%a8windows%e4%b8%8a%e6%97%a0%e6%b3%95%e8%bf%90%e8%a1%8c%e8%84%9a%e6%9c%ac aria-label="问题4 在windows上无法运行脚本">问题4 在windows上无法运行脚本</a></li></ul></li><li><a href=#%e7%bd%91%e5%85%b3%e4%b8%ad%e4%bd%bf%e7%94%a8consul%e8%bf%9b%e8%a1%8c%e6%9c%8d%e5%8a%a1%e5%8f%91%e7%8e%b0 aria-label=网关中使用consul进行服务发现>网关中使用consul进行服务发现</a><ul><li><a href=#%e9%97%ae%e9%a2%981-grpc%e8%b0%83%e7%94%a8%e7%9a%84%e6%96%b9%e6%b3%95%e5%90%8d%e5%92%8c%e5%9c%a8consul%e4%b8%ad%e6%b3%a8%e5%86%8c%e7%9a%84%e5%90%8d%e5%ad%97%e4%b8%8d%e5%90%8c aria-label="问题1 gRPC调用的方法名和在consul中注册的名字不同">问题1 gRPC调用的方法名和在consul中注册的名字不同</a></li><li><a href=#%e9%97%ae%e9%a2%982-%e7%bd%91%e5%85%b3%e8%bd%ac%e5%8f%91grpc%e8%af%b7%e6%b1%82%e7%9a%84%e5%89%8d%e6%8f%90%e6%98%af%e8%83%bd%e5%a4%9f%e6%ad%a3%e7%a1%ae%e8%af%86%e5%88%ab%e5%92%8c%e6%8e%a5%e6%94%b6grpc%e8%af%b7%e6%b1%82 aria-label="问题2 网关转发gRPC请求的前提是能够正确识别和接收gRPC请求">问题2 网关转发gRPC请求的前提是能够正确识别和接收gRPC请求</a><ul><li><a href=#%e5%b0%9d%e8%af%95%e7%9b%b4%e6%8e%a5%e4%b8%8e%e5%be%ae%e6%9c%8d%e5%8a%a1%e9%80%9a%e4%bf%a1 aria-label=尝试直接与微服务通信>尝试直接与微服务通信</a></li><li><a href=#%e7%bd%91%e5%85%b3%e4%bf%ae%e5%a4%8d aria-label=网关修复>网关修复</a></li></ul></li></ul></li><li><a href=#%e5%b0%86restful%e4%bb%a3%e7%a0%81%e9%87%8d%e6%9e%84%e4%b8%bagrpc%e4%bb%a3%e7%a0%81 aria-label=将RESTful代码重构为gRPC代码>将RESTful代码重构为gRPC代码</a><ul><li><a href=#%e7%90%86%e8%a7%a3%e7%94%9f%e6%88%90%e7%9a%84%e5%ad%98%e6%a0%b9%e4%bb%a3%e7%a0%81 aria-label=理解生成的存根代码>理解生成的存根代码</a></li><li><a href=#%e6%9c%8d%e5%8a%a1%e7%9a%84%e5%85%b7%e4%bd%93%e5%ae%9e%e7%8e%b0 aria-label=服务的具体实现>服务的具体实现</a></li><li><a href=#%e5%85%b6%e4%bb%96%e8%a6%81%e5%81%9a%e7%9a%84 aria-label=其他要做的>其他要做的</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=grpc服务的架构图>gRPC服务的架构图<a hidden class=anchor aria-hidden=true href=#grpc服务的架构图>#</a></h2><p><img loading=lazy src=https://s2.loli.net/2024/07/23/il8HzcF1vrAmE7x.png alt=gRPC调用图></p><p>RPC调用总的来说就是客户端调用存根的代码，然后存根代码和RPC库实现通信，服务端的存根收到了信息后交给具体的服务进行处理，之后再原路返回就完了。</p><p>这里附上一篇<a href=https://www.cnblogs.com/songgj/p/13463717.html>关于gRPC讲解的博客园的文章</a></p><h2 id=proto文件代码生成>Proto文件代码生成<a hidden class=anchor aria-hidden=true href=#proto文件代码生成>#</a></h2><p>项目的前后端都是使用的gRPC进行通信，都需要使用protoc编译器把之前定义好的proto文件进行编译生成对应的代码进行调用。</p><h3 id=问题1-timestampproto文件找不到>问题1 timestamp.proto文件找不到<a hidden class=anchor aria-hidden=true href=#问题1-timestampproto文件找不到>#</a></h3><p><code>timestamp.proto</code>是google的一个时间戳的包，因为在我们自己的proto文件中使用到了<code>google.protobuf.Timestamp</code>，在proeo文件的最上方也要导入对应的proto文件<code>import "google/protobuf/timestamp.proto";</code></p><p>我记得在下载protoc编译器的时候，压缩包下面就有一个include文件夹，其中就包含有<code>timestamp.proto</code>文件</p><h3 id=问题2-go代码生成对应的包名和位置对不上>问题2 go代码生成对应的包名和位置对不上<a hidden class=anchor aria-hidden=true href=#问题2-go代码生成对应的包名和位置对不上>#</a></h3><p>项目的后端采用的是go，想要把proto文件编译成golang的代码。这就需要在proto文件中加上go_package的字段，比如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-protobuf data-lang=protobuf><span class=line><span class=cl><span class=n>syntax</span> <span class=o>=</span> <span class=s>&#34;proto3&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kn>package</span> <span class=nn>rpc</span><span class=o>.</span><span class=n>auth</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>option</span> <span class=n>go_package</span> <span class=o>=</span> <span class=s>&#34;github.com/BigNoseCattyHome/aorb/backend/rpc/auth;auth&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>import</span> <span class=s>&#34;google/protobuf/timestamp.proto&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c1>// 定义消息，用于请求和响应结构
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>message</span> <span class=nc>LoginRequest</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>string</span> <span class=n>username</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=c1>// 用户名/用户ID
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>string</span> <span class=n>password</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span> <span class=c1>// 密码的md5摘要
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>string</span> <span class=n>device_id</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span> <span class=c1>// 设备ID
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>google.protobuf.Timestamp</span> <span class=n>timestamp</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span> <span class=c1>// 时间戳
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>string</span> <span class=n>nonce</span> <span class=o>=</span> <span class=mi>5</span><span class=p>;</span> <span class=c1>// 随机数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></div><p>然后在使用protoc编译的时候，在命令行中也要加上go的一些选项，比如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>protoc --go_out<span class=o>=</span>. person.proto	// 找到当前目录下的person.proto并生成go的代码，输出到当前目录<span class=o>(</span>.<span class=o>)</span>
</span></span></code></pre></div><p>但是又有了一个问题就是在该文件夹下面，会生成你的包名go_package的层级目录，最后才是你的最终代码。但是我想让proto文件直接生成在一个固定的文件夹位置，并且没有那么多的层级文件夹。</p><p>然后发现了有一个命令选项是<code>--go_opt=paths=source_relative</code>,使得生成的Go代码文件的路径与对应的<code>.proto</code>文件的路径保持一致</p><h3 id=问题3-dart代码生成的时候老是存在找不到pbxx>问题3 dart代码生成的时候老是存在找不到pb.xx<a hidden class=anchor aria-hidden=true href=#问题3-dart代码生成的时候老是存在找不到pbxx>#</a></h3><p>后来上google和stackoverflow看了半天，发现结果是依赖版本的问题，把protobuf的依赖版本从^2.1.0改为^3.1.0，重新拉取一下依赖就没问题了。</p><p>之后队友给力解决了这个问题，把proto代码生成写进了Makefile，总算解决了proto文件代码生成的问题</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nv>PROTO_PATH</span><span class=o>=</span>./idl
</span></span><span class=line><span class=cl><span class=nv>GOOGLE_PROTO_PATH</span><span class=o>=</span>/usr/local/include
</span></span><span class=line><span class=cl><span class=nv>OUTPUT_DART_PATH</span><span class=o>=</span>./frontend/lib/generated/
</span></span><span class=line><span class=cl><span class=nv>GO_OUT_PATH</span><span class=o>=</span>./backend/rpc
</span></span><span class=line><span class=cl><span class=nv>PROTOC_GEN_DART</span><span class=o>=</span><span class=k>$(</span>shell which protoc-gen-dart<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>proto</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	@echo <span class=s2>&#34;Creating golang and dart grpc files...&#34;</span>
</span></span><span class=line><span class=cl>	@for file in <span class=k>$(</span>PROTO_PATH<span class=k>)</span>/*.proto<span class=p>;</span> <span class=k>do</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>		<span class=k>if</span> <span class=o>[</span> -f <span class=s2>&#34;</span><span class=nv>$$</span><span class=s2>file&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>			<span class=nv>prefix</span><span class=o>=</span><span class=nv>$$</span><span class=o>(</span>basename <span class=s2>&#34;</span><span class=nv>$$</span><span class=s2>file&#34;</span> .proto<span class=o>)</span><span class=p>;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>			mkdir -p <span class=k>$(</span>GO_OUT_PATH<span class=k>)</span>/<span class=s2>&#34;</span><span class=nv>$$</span><span class=s2>{prefix}&#34;</span><span class=p>;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>			mkdir -p <span class=k>$(</span>OUTPUT_DART_PATH<span class=k>)</span><span class=p>;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>			<span class=nb>echo</span> <span class=s2>&#34;Created directory for </span><span class=nv>$$</span><span class=s2>prefix&#34;</span><span class=p>;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>			protoc -I<span class=k>$(</span>PROTO_PATH<span class=k>)</span> -I<span class=k>$(</span>GOOGLE_PROTO_PATH<span class=k>)</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>				--go_out<span class=o>=</span><span class=k>$(</span>GO_OUT_PATH<span class=k>)</span>/<span class=nv>$$</span>prefix --go_opt<span class=o>=</span><span class=nv>paths</span><span class=o>=</span>source_relative <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>				--go-grpc_out<span class=o>=</span><span class=k>$(</span>GO_OUT_PATH<span class=k>)</span>/<span class=nv>$$</span>prefix --go-grpc_opt<span class=o>=</span><span class=nv>paths</span><span class=o>=</span>source_relative <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>				--dart_out<span class=o>=</span>grpc:<span class=k>$(</span>OUTPUT_DART_PATH<span class=k>)</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>				--plugin<span class=o>=</span>protoc-gen-dart<span class=o>=</span><span class=k>$(</span>PROTOC_GEN_DART<span class=k>)</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>				<span class=nv>$$</span>file<span class=p>;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>			<span class=nb>echo</span> <span class=s2>&#34;Generated gRPC code for </span><span class=nv>$$</span><span class=s2>prefix&#34;</span><span class=p>;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>		<span class=k>fi</span><span class=p>;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	<span class=k>done</span>
</span></span><span class=line><span class=cl>	@protoc -I<span class=k>$(</span>GOOGLE_PROTO_PATH<span class=k>)</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>		--dart_out<span class=o>=</span>grpc:<span class=k>$(</span>OUTPUT_DART_PATH<span class=k>)</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>		--plugin<span class=o>=</span>protoc-gen-dart<span class=o>=</span><span class=k>$(</span>PROTOC_GEN_DART<span class=k>)</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>		google/protobuf/timestamp.proto
</span></span><span class=line><span class=cl>	@echo <span class=s2>&#34;Generated Dart code for Google&#39;s timestamp.proto&#34;</span>
</span></span></code></pre></div><h3 id=问题4-在windows上无法运行脚本>问题4 在windows上无法运行脚本<a hidden class=anchor aria-hidden=true href=#问题4-在windows上无法运行脚本>#</a></h3><p>在另外一个队友的电脑上，他是使用的windows进行开发，然后遇到了代码生成失败的问题。然后看了一下，大概的问题就是命令行工具不一样，有些命令识别不了，之后把脚本改成windows的一些版本就ok了。</p><h2 id=网关中使用consul进行服务发现>网关中使用consul进行服务发现<a hidden class=anchor aria-hidden=true href=#网关中使用consul进行服务发现>#</a></h2><p>我们项目的架构就是前端向后端发送gRPC请求，实际上就是向后端的网关进行发送，前端就不用管后端具体是怎么实现的了，只需要向网关中发送请求即可。</p><p>网关的职责就是接收来自前端的请求，然后把请求转发给具体的微服务，等微服务处理好之后，再返回给网关，网关再给人家前端传回去就好了。</p><p>项目中使用到了consul进行服务注册和发现，当微服务启动的时候，就会向consul发送一个微服务注册，告诉consul他自己微服务的名字和地址。然后网关通过consul客户端与consul程序进行交流，可以对在线的微服务根据服务名进行查询，获取到这些微服务实例的地址，然后把来自前端的请求准确地转发到这些实例中。</p><p>这里有两个问题</p><h3 id=问题1-grpc调用的方法名和在consul中注册的名字不同>问题1 gRPC调用的方法名和在consul中注册的名字不同<a hidden class=anchor aria-hidden=true href=#问题1-grpc调用的方法名和在consul中注册的名字不同>#</a></h3><p>一般来说，gRPC的方法名是服务接口的一部分，像这样：<code>&lt;package>.&lt;service>/&lt;method></code></p><p>我们的网关依赖于根据名字查找微服务的地址，我们的微服务的注册名为<code>AorB-AuthService</code>，而我们的gRPC的方法名为<code>rpc.auth.AuthService/Register</code>（包名为<code>rpc.auth</code>）</p><p>所以需要在网关中增加一个映射，把gRPC的方法名转为在consul中注册的名字。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// gRPC 服务名到 Consul 服务名的映射
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>serviceNameMapping</span> <span class=p>=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;rpc.auth.AuthService&#34;</span><span class=p>:</span>           <span class=nx>config</span><span class=p>.</span><span class=nx>AuthRpcServerName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;rpc.user.UserService&#34;</span><span class=p>:</span>           <span class=nx>config</span><span class=p>.</span><span class=nx>UserRpcServerName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;rpc.comment.CommentService&#34;</span><span class=p>:</span>     <span class=nx>config</span><span class=p>.</span><span class=nx>CommentRpcServerName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;rpc.vote.VoteService&#34;</span><span class=p>:</span>           <span class=nx>config</span><span class=p>.</span><span class=nx>VoteRpcServerName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;rpc.poll.QuestionService&#34;</span><span class=p>:</span>       <span class=nx>config</span><span class=p>.</span><span class=nx>PollRpcServerName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;rpc.recommend.RecommendService&#34;</span><span class=p>:</span> <span class=nx>config</span><span class=p>.</span><span class=nx>RecommendRpcServerName</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=问题2-网关转发grpc请求的前提是能够正确识别和接收grpc请求>问题2 网关转发gRPC请求的前提是能够正确识别和接收gRPC请求<a hidden class=anchor aria-hidden=true href=#问题2-网关转发grpc请求的前提是能够正确识别和接收grpc请求>#</a></h3><p>之前没有找到问题的时候情况be like:前端写好了注册的逻辑，点击发送的按钮，在前端的控制台上可以看见各个发送的数据均是正常，但是会收到gRPC的错误代码13，找不到对应的服务<code>unknow service rpc.auth.AuthService</code>。后端也启动了网关和auth微服务，但是在后端上在对应的方法上添加了日志输出，也没有任何日志打印出来。</p><h4 id=尝试直接与微服务通信>尝试直接与微服务通信<a hidden class=anchor aria-hidden=true href=#尝试直接与微服务通信>#</a></h4><p>想了半天没有什么思路，然后就想排查一下后端微服务的功能是不是OK的，然后就直接把前端的请求发送到auth微服务上去，结果就是能够正常返回。这就说明了就是网关的转发的问题。锁定了目标在网关，感觉问题就解决一大半了。</p><h4 id=网关修复>网关修复<a hidden class=anchor aria-hidden=true href=#网关修复>#</a></h4><p>在查阅了很多资料后发现，网关中虽然是转发gRPC请求，但是他也是一个gRPC服务器，也需要能够正确接收并处理AuthService的请求，所以他也需要实现AuthService接口，不过服务的实现采用<code> auth.UnimplementedAuthServiceServer</code>就OK了，因为具体的处理也并不是在这里，他只用转发就好了。然后在gRPC服务器上注册<code> auth.RegisterAuthServiceServer(s, &amp;GatewayServer{})</code>服务就可以正常实现转发了。</p><h2 id=将restful代码重构为grpc代码>将RESTful代码重构为gRPC代码<a hidden class=anchor aria-hidden=true href=#将restful代码重构为grpc代码>#</a></h2><p>因为之前项目开发的时候后端采用了RESTful，后来决定整体上使用gRPC进行通讯，RESTful写得不是很多，所以就想要把它转过来。</p><p>RESTful和gRPC他们之间的差异是在调用资源和传输的方式上有所差异，但是对于数据的操作部分，如service之类的代码其实并没有影响，代码的重构只用考虑：如何从RESTful风格下获取资源变为在gRPC调用下如何获取。</p><h3 id=理解生成的存根代码>理解生成的存根代码<a hidden class=anchor aria-hidden=true href=#理解生成的存根代码>#</a></h3><p>首先需要生成对应语言的存根（stub）代码，比如在proto文件中有这么一个文件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-protobuf data-lang=protobuf><span class=line><span class=cl><span class=n>syntax</span> <span class=o>=</span> <span class=s>&#34;proto3&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kn>package</span> <span class=nn>user</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>option</span> <span class=n>go_package</span> <span class=o>=</span> <span class=s>&#34;github.com/BigNoseCattyHome/aorb/backend/rpc/user;user&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>CoinRecord</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>int64</span> <span class=n>consume</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=c1>// 消耗的金币数
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>string</span> <span class=n>question_id</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span> <span class=c1>// 为其投币的问题ID
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>string</span> <span class=n>user_id</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span> <span class=c1>// 使用者的ID
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c1>// TODO optional 字段在后续开发过程中应该逐步取消
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>message</span> <span class=nc>User</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>string</span> <span class=n>avatar</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=c1>// 用户头像
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>repeated</span> <span class=kt>string</span> <span class=n>blacklist</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span> <span class=c1>// 屏蔽好友
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>optional</span> <span class=kt>double</span> <span class=n>coins</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span> <span class=c1>// 用户的金币数
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>repeated</span> <span class=n>CoinRecord</span> <span class=n>coins_record</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span> <span class=c1>// 用户金币流水记录
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>repeated</span> <span class=kt>string</span> <span class=n>followed</span> <span class=o>=</span> <span class=mi>5</span><span class=p>;</span> <span class=c1>// 关注者
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>repeated</span> <span class=kt>string</span> <span class=n>follower</span> <span class=o>=</span> <span class=mi>6</span><span class=p>;</span> <span class=c1>// 被关注者
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>uint32</span> <span class=n>id</span> <span class=o>=</span> <span class=mi>7</span><span class=p>;</span> <span class=c1>// 用户ID
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>optional</span> <span class=kt>string</span> <span class=n>ipaddress</span> <span class=o>=</span> <span class=mi>8</span><span class=p>;</span> <span class=c1>// IP归属地
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>string</span> <span class=n>nickname</span> <span class=o>=</span> <span class=mi>9</span><span class=p>;</span> <span class=c1>// 用户昵称
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>repeated</span> <span class=kt>uint32</span> <span class=n>questions_ask</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span> <span class=c1>// 发起过的问题
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>repeated</span> <span class=kt>uint32</span> <span class=n>questions_asw</span> <span class=o>=</span> <span class=mi>11</span><span class=p>;</span> <span class=c1>// 回答过的问题
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>repeated</span> <span class=kt>uint32</span> <span class=n>questions_collect</span> <span class=o>=</span> <span class=mi>12</span><span class=p>;</span> <span class=c1>// 收藏的问题
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>string</span> <span class=n>username</span> <span class=o>=</span> <span class=mi>13</span><span class=p>;</span> <span class=c1>// 用户登录名
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>UserRequest</span><span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>uint32</span> <span class=n>user_id</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>   <span class=c1>// 用户id
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>uint32</span> <span class=n>actor_id</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>  <span class=c1>// 发送请求的用户的id
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>UserResponse</span><span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>int32</span> <span class=n>status_code</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>  <span class=c1>// 状态码，0-成功，其他值-失败
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>string</span> <span class=n>status_msg</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>  <span class=c1>// 返回状态描述
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>User</span> <span class=n>user</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>  <span class=c1>// 用户信息
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>UserExistRequest</span><span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>uint32</span> <span class=n>user_id</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=c1>// 用户id
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>UserExistResponse</span><span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>int32</span> <span class=n>status_code</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>  <span class=c1>// 状态码，0-成功，其他值-失败
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>string</span> <span class=n>status_msg</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>  <span class=c1>// 返回状态描述
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>bool</span> <span class=n>existed</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>  <span class=c1>// 是否存在用户
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>service</span> <span class=n>UserService</span><span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=k>rpc</span> <span class=n>GetUserInfo</span><span class=p>(</span><span class=n>UserRequest</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>UserResponse</span><span class=p>);</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=k>rpc</span> <span class=n>GetUserExistInformation</span><span class=p>(</span><span class=n>UserExistRequest</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>UserExistResponse</span><span class=p>);</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></div><p>然后他生成了对应的存根代码文件就是<code>user.pb.go</code>和<code>user_grpc.pb.go</code></p><ul><li>其中<code>user.pb.go</code>中就是对定义的各个数据结构比如<code>UserRequest</code>进行定义以及序列化和反序列化的代码</li><li><code>user_grpc.pb.go</code>主要包括了<code>UserServiceClient</code>和<code>UserServiceServer</code>这两个接口的定义，以及他们中具体的方法</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// UserServiceClient is the client API for UserService service.
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>// For semantics around ctx use and closing/ending streaming RPCs, please refer to https://pkg.go.dev/google.golang.org/grpc/?tab=doc#ClientConn.NewStream.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>UserServiceClient</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>GetUserInfo</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>in</span> <span class=o>*</span><span class=nx>UserRequest</span><span class=p>,</span> <span class=nx>opts</span> <span class=o>...</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>CallOption</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>UserResponse</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nf>GetUserExistInformation</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>in</span> <span class=o>*</span><span class=nx>UserExistRequest</span><span class=p>,</span> <span class=nx>opts</span> <span class=o>...</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>CallOption</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>UserExistResponse</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>userServiceClient</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>cc</span> <span class=nx>grpc</span><span class=p>.</span><span class=nx>ClientConnInterface</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewUserServiceClient</span><span class=p>(</span><span class=nx>cc</span> <span class=nx>grpc</span><span class=p>.</span><span class=nx>ClientConnInterface</span><span class=p>)</span> <span class=nx>UserServiceClient</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>userServiceClient</span><span class=p>{</span><span class=nx>cc</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>userServiceClient</span><span class=p>)</span> <span class=nf>GetUserInfo</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>in</span> <span class=o>*</span><span class=nx>UserRequest</span><span class=p>,</span> <span class=nx>opts</span> <span class=o>...</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>CallOption</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>UserResponse</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>cOpts</span> <span class=o>:=</span> <span class=nb>append</span><span class=p>([]</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>CallOption</span><span class=p>{</span><span class=nx>grpc</span><span class=p>.</span><span class=nf>StaticMethod</span><span class=p>()},</span> <span class=nx>opts</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>out</span> <span class=o>:=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>UserResponse</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>cc</span><span class=p>.</span><span class=nf>Invoke</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>UserService_GetUserInfo_FullMethodName</span><span class=p>,</span> <span class=nx>in</span><span class=p>,</span> <span class=nx>out</span><span class=p>,</span> <span class=nx>cOpts</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>out</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>userServiceClient</span><span class=p>)</span> <span class=nf>GetUserExistInformation</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>in</span> <span class=o>*</span><span class=nx>UserExistRequest</span><span class=p>,</span> <span class=nx>opts</span> <span class=o>...</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>CallOption</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>UserExistResponse</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>cOpts</span> <span class=o>:=</span> <span class=nb>append</span><span class=p>([]</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>CallOption</span><span class=p>{</span><span class=nx>grpc</span><span class=p>.</span><span class=nf>StaticMethod</span><span class=p>()},</span> <span class=nx>opts</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>out</span> <span class=o>:=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>UserExistResponse</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>cc</span><span class=p>.</span><span class=nf>Invoke</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>UserService_GetUserExistInformation_FullMethodName</span><span class=p>,</span> <span class=nx>in</span><span class=p>,</span> <span class=nx>out</span><span class=p>,</span> <span class=nx>cOpts</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>out</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// UserServiceServer is the server API for UserService service.
</span></span></span><span class=line><span class=cl><span class=c1>// All implementations must embed UnimplementedUserServiceServer
</span></span></span><span class=line><span class=cl><span class=c1>// for forward compatibility
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>UserServiceServer</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>GetUserInfo</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=o>*</span><span class=nx>UserRequest</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>UserResponse</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nf>GetUserExistInformation</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=o>*</span><span class=nx>UserExistRequest</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>UserExistResponse</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nf>mustEmbedUnimplementedUserServiceServer</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=服务的具体实现>服务的具体实现<a hidden class=anchor aria-hidden=true href=#服务的具体实现>#</a></h3><p>这些方法直接在你的handler中进行实现，比如在auth的handler中进行实现Register</p><p>无非是参数需要从定义的auth.RegisterRequest中获取，其他的就是你的正常的服务。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Register 注册
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>a</span> <span class=nx>AuthServiceImpl</span><span class=p>)</span> <span class=nf>Register</span><span class=p>(</span><span class=nx>context</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>request</span> <span class=o>*</span><span class=nx>auth</span><span class=p>.</span><span class=nx>RegisterRequest</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>auth</span><span class=p>.</span><span class=nx>RegisterResponse</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Received Register request: %v&#34;</span><span class=p>,</span> <span class=nx>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 解析参数
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>user</span> <span class=o>:=</span> <span class=nx>models</span><span class=p>.</span><span class=nx>User</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Username</span><span class=p>:</span>  <span class=nx>request</span><span class=p>.</span><span class=nx>Username</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Password</span><span class=p>:</span>  <span class=nx>request</span><span class=p>.</span><span class=nx>Password</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Nickname</span><span class=p>:</span>  <span class=nx>request</span><span class=p>.</span><span class=nx>Nickname</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Avatar</span><span class=p>:</span>    <span class=nx>request</span><span class=p>.</span><span class=nx>Avatar</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Ipaddress</span><span class=p>:</span> <span class=nx>request</span><span class=p>.</span><span class=nx>Ipaddress</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 调用服务
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>services</span><span class=p>.</span><span class=nf>RegisterUser</span><span class=p>(</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>status</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=nx>codes</span><span class=p>.</span><span class=nx>Unauthenticated</span><span class=p>,</span> <span class=s>&#34;register failed: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 返回响应
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>registerResponse</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>auth</span><span class=p>.</span><span class=nx>RegisterResponse</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Success</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Message</span><span class=p>:</span> <span class=s>&#34;User registered successfully&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>registerResponse</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=其他要做的>其他要做的<a hidden class=anchor aria-hidden=true href=#其他要做的>#</a></h3><p>完成好这些实现之后，最后再写一个main函数启动你的微服务，向consul中注册微服务，管理好日志以便于日后查找问题就好了。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://sirius1y.top/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/>微服务</a></li><li><a href=https://sirius1y.top/tags/protobuf/>Protobuf</a></li><li><a href=https://sirius1y.top/tags/rpc/>Rpc</a></li><li><a href=https://sirius1y.top/tags/dev/>Dev</a></li></ul><nav class=paginav><a class=prev href=https://sirius1y.top/posts/notes/go-srccode/go-context/><span class=title>« Prev</span><br><span>【go的源码阅读】context的实现：context.go</span>
</a><a class=next href=https://sirius1y.top/posts/notes/dev/dev-aorb-auth/><span class=title>Next »</span><br><span>Auth微服务开发记录</span></a></nav></footer><script>function createGiscusScript(e){const t=document.createElement("script");Object.entries(e).forEach(([e,n])=>t.setAttribute(e,n)),document.querySelector("article").appendChild(t);const n=document.querySelector('label[for="switch_default"]');n&&n.addEventListener("click",function(){const e=document.body.classList.contains("dark")?"transparent_dark":"light";t.setAttribute("data-theme",e),sendMessage({setConfig:{theme:e}})})}function sendMessage(e){const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")}document.addEventListener("DOMContentLoaded",function(){const e={src:"https://giscus.app/client.js","data-repo":"yunyit/yunyit.github.io","data-repo-id":"R_kgDOKqkPYw","data-category":"Comments","data-category-id":"DIC_kwDOKqkPY84CceDi","data-mapping":"url","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"top","data-lang":"en",crossorigin:"anonymous",async:""};e["data-theme"]=document.body.classList.contains("dark")?"transparent_dark":"light",createGiscusScript(e);const t=new MutationObserver(()=>{const e=document.body.classList.contains("dark")?"transparent_dark":"light";sendMessage({setConfig:{theme:e}})});t.observe(document.body,{attributes:!0,attributeFilter:["class"]})})</script></article></main><footer class=footer><span><a href=https://us.umami.is/websites/5e6ac0c1-e2b2-4d0f-9542-b79ac2cf89c4 rel="noopener noreferrer" target=_blank>Analysis</a>
</span>|
<script defer src=https://cloud.umami.is/script.js data-website-id=5e6ac0c1-e2b2-4d0f-9542-b79ac2cf89c4></script><span><a href=https://beian.miit.gov.cn/ target=_blank>渝ICP备2024018631号</a>
</span>|
<span>&copy; 2025 <a href=https://sirius1y.top/>Sirius' Blog</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>