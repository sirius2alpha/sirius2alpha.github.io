<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>CSRF攻击 | Sirius' Blog</title>
<meta name=keywords content="网络安全,CSRF,网络攻击"><meta name=description content='简介 CSRF攻击利用了受害者已经通过身份验证并且在一个网站上建立的有效会话，来执行未经授权的操作。当受害者在一个网站上登录并获得一个会话（例如通过使用用户名和密码进行身份验证），该网站会为其分配一个令牌或会话ID，以便在后续的请求中验证用户的身份。
CSRF攻击者会通过诱使受害者访问一个恶意网站或点击恶意链接，来利用受害者的已验证会话。由于受害者在浏览器中仍然保持着有效会话，攻击者可以构造特制的请求，以利用该会话来执行恶意操作，而这些操作是受害者并不知情或未经授权的。
例如，假设受害者在银行网站上登录并建立了一个有效的会话。攻击者可以通过电子邮件或社交媒体发送一个包含恶意链接的消息给受害者。如果受害者点击了该链接，他们的浏览器将自动向银行网站发送一个请求，而这个请求中包含了受害者的有效会话信息。银行网站在验证会话时会认为这个请求是合法的，因为会话是有效的，所以它执行了该请求所代表的操作，如转账、修改账户信息等，而受害者是毫不知情的。
CSRF攻击的目标是利用受害者的已验证会话来执行攻击者所期望的未经授权操作，从而导致受害者的损失或者对系统的安全产生威胁。
补充知识 cookie 一般情况下，cookie是以键值对进行表示的(key-value)，例如name=jack，这个就表示cookie的名字是name，cookie携带的值是jack。
cookie有2种存储方式，一种是会话性，一种是持久性。
会话性：如果cookie为会话性，那么cookie仅会保存在客户端的内存中，当我们关闭客服端时cookie也就失效了 持久性：如果cookie为持久性，那么cookie会保存在用户的硬盘中，直至生存期结束或者用户主动将其销毁。
组成 （1）cookie名称 （2）cookie值 （3）Expires：过期时间。当过了过期时间后，浏览器会将该cookie删除。如果不设置Expires，则关闭浏览器后该cookie失效。 （4）Path：用来设置在路径下面的页面才可以访问该cookie，一般设为/，以表示同一站点的所有页面都可以访问该cookie。 （5）Domain：用来指定哪些子域才可以访问cookie，格式一般为“.XXX.com” （6）Secure:如果设置了secure没有值，则代表只有使用HTTPS协议才可以访问 （7）HttpOnly：如果在cookie中设置了HttpOnly属性，那么通过JavaScript脚本等将无法读取到cookie信息。
URL URL（统一资源定位符）的一般格式如下：
scheme://host:port/path?query_parameters#fragment_identifier 具体解释如下：
Scheme（协议）：指定用于访问资源的协议，例如HTTP、HTTPS、FTP等。它是URL的开头部分，通常以双斜杠（//）结尾。 Host（主机）：指定目标资源所在的主机名或IP地址。主机名可以是域名（例如example.com）或IP地址（例如192.168.0.1）。 Port（端口）：指定用于访问目标资源的端口号（可选）。默认的端口号根据协议而不同，如HTTP默认端口是80，HTTPS默认端口是443。如果URL中没有指定端口，将使用默认端口。 Path（路径）：指定资源在服务器上的路径（可选）。路径部分是指服务器上资源的具体位置，可以是文件路径或目录路径。 Query Parameters（查询参数）：包含在URL中的键值对参数（可选）。查询参数通常用于向服务器传递额外的信息，多个参数之间使用"&&ldquo;符号分隔。 Fragment Identifier（片段标识符）：用于标识文档中的特定片段（可选）。片段标识符通常由一个锚点或特定位置的标识符组成，用于在文档中导航到指定位置。 实验过程 使用Flask框架进行构建web应用。
文件架构 ├── web-csrf/ │ ├── webA.py │ ├── webB.py │ ├── templates/ │ │ ├── home.html │ │ ├── login.html │ └── static/ │ └── style.css 源码 webA:
# webA.py import hashlib import re import mysql.connector from flask import Flask, request, render_template, make_response app = Flask(__name__) db = mysql.'><meta name=author content="sirius1y"><link rel=canonical href=https://sirius1y.top/posts/notes/security/csrf-attack/><link crossorigin=anonymous href=/assets/css/stylesheet.3551607c8eb1ef998f0b6c81d22f9f03dd2c3b8ecaf983e42c023e8d41e39f66.css integrity="sha256-NVFgfI6x75mPC2yB0i+fA90sO47K+YPkLAI+jUHjn2Y=" rel="preload stylesheet" as=style><link rel=icon href=https://sirius1y.top/images/icon.png><link rel=icon type=image/png sizes=16x16 href=https://sirius1y.top/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://sirius1y.top/favicon-32x32.png><link rel=apple-touch-icon href=https://sirius1y.top/apple-touch-icon.png><link rel=mask-icon href=https://sirius1y.top/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://sirius1y.top/posts/notes/security/csrf-attack/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="CSRF攻击"><meta property="og:description" content='简介 CSRF攻击利用了受害者已经通过身份验证并且在一个网站上建立的有效会话，来执行未经授权的操作。当受害者在一个网站上登录并获得一个会话（例如通过使用用户名和密码进行身份验证），该网站会为其分配一个令牌或会话ID，以便在后续的请求中验证用户的身份。
CSRF攻击者会通过诱使受害者访问一个恶意网站或点击恶意链接，来利用受害者的已验证会话。由于受害者在浏览器中仍然保持着有效会话，攻击者可以构造特制的请求，以利用该会话来执行恶意操作，而这些操作是受害者并不知情或未经授权的。
例如，假设受害者在银行网站上登录并建立了一个有效的会话。攻击者可以通过电子邮件或社交媒体发送一个包含恶意链接的消息给受害者。如果受害者点击了该链接，他们的浏览器将自动向银行网站发送一个请求，而这个请求中包含了受害者的有效会话信息。银行网站在验证会话时会认为这个请求是合法的，因为会话是有效的，所以它执行了该请求所代表的操作，如转账、修改账户信息等，而受害者是毫不知情的。
CSRF攻击的目标是利用受害者的已验证会话来执行攻击者所期望的未经授权操作，从而导致受害者的损失或者对系统的安全产生威胁。
补充知识 cookie 一般情况下，cookie是以键值对进行表示的(key-value)，例如name=jack，这个就表示cookie的名字是name，cookie携带的值是jack。
cookie有2种存储方式，一种是会话性，一种是持久性。
会话性：如果cookie为会话性，那么cookie仅会保存在客户端的内存中，当我们关闭客服端时cookie也就失效了 持久性：如果cookie为持久性，那么cookie会保存在用户的硬盘中，直至生存期结束或者用户主动将其销毁。
组成 （1）cookie名称 （2）cookie值 （3）Expires：过期时间。当过了过期时间后，浏览器会将该cookie删除。如果不设置Expires，则关闭浏览器后该cookie失效。 （4）Path：用来设置在路径下面的页面才可以访问该cookie，一般设为/，以表示同一站点的所有页面都可以访问该cookie。 （5）Domain：用来指定哪些子域才可以访问cookie，格式一般为“.XXX.com” （6）Secure:如果设置了secure没有值，则代表只有使用HTTPS协议才可以访问 （7）HttpOnly：如果在cookie中设置了HttpOnly属性，那么通过JavaScript脚本等将无法读取到cookie信息。
URL URL（统一资源定位符）的一般格式如下：
scheme://host:port/path?query_parameters#fragment_identifier 具体解释如下：
Scheme（协议）：指定用于访问资源的协议，例如HTTP、HTTPS、FTP等。它是URL的开头部分，通常以双斜杠（//）结尾。 Host（主机）：指定目标资源所在的主机名或IP地址。主机名可以是域名（例如example.com）或IP地址（例如192.168.0.1）。 Port（端口）：指定用于访问目标资源的端口号（可选）。默认的端口号根据协议而不同，如HTTP默认端口是80，HTTPS默认端口是443。如果URL中没有指定端口，将使用默认端口。 Path（路径）：指定资源在服务器上的路径（可选）。路径部分是指服务器上资源的具体位置，可以是文件路径或目录路径。 Query Parameters（查询参数）：包含在URL中的键值对参数（可选）。查询参数通常用于向服务器传递额外的信息，多个参数之间使用"&&ldquo;符号分隔。 Fragment Identifier（片段标识符）：用于标识文档中的特定片段（可选）。片段标识符通常由一个锚点或特定位置的标识符组成，用于在文档中导航到指定位置。 实验过程 使用Flask框架进行构建web应用。
文件架构 ├── web-csrf/ │ ├── webA.py │ ├── webB.py │ ├── templates/ │ │ ├── home.html │ │ ├── login.html │ └── static/ │ └── style.css 源码 webA:
# webA.py import hashlib import re import mysql.connector from flask import Flask, request, render_template, make_response app = Flask(__name__) db = mysql.'><meta property="og:type" content="article"><meta property="og:url" content="https://sirius1y.top/posts/notes/security/csrf-attack/"><meta property="og:image" content="https://sirius1y.top/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-05-21T00:00:00+00:00"><meta property="article:modified_time" content="2023-05-21T00:00:00+00:00"><meta property="og:site_name" content="Sirius' Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://sirius1y.top/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="CSRF攻击"><meta name=twitter:description content='简介 CSRF攻击利用了受害者已经通过身份验证并且在一个网站上建立的有效会话，来执行未经授权的操作。当受害者在一个网站上登录并获得一个会话（例如通过使用用户名和密码进行身份验证），该网站会为其分配一个令牌或会话ID，以便在后续的请求中验证用户的身份。
CSRF攻击者会通过诱使受害者访问一个恶意网站或点击恶意链接，来利用受害者的已验证会话。由于受害者在浏览器中仍然保持着有效会话，攻击者可以构造特制的请求，以利用该会话来执行恶意操作，而这些操作是受害者并不知情或未经授权的。
例如，假设受害者在银行网站上登录并建立了一个有效的会话。攻击者可以通过电子邮件或社交媒体发送一个包含恶意链接的消息给受害者。如果受害者点击了该链接，他们的浏览器将自动向银行网站发送一个请求，而这个请求中包含了受害者的有效会话信息。银行网站在验证会话时会认为这个请求是合法的，因为会话是有效的，所以它执行了该请求所代表的操作，如转账、修改账户信息等，而受害者是毫不知情的。
CSRF攻击的目标是利用受害者的已验证会话来执行攻击者所期望的未经授权操作，从而导致受害者的损失或者对系统的安全产生威胁。
补充知识 cookie 一般情况下，cookie是以键值对进行表示的(key-value)，例如name=jack，这个就表示cookie的名字是name，cookie携带的值是jack。
cookie有2种存储方式，一种是会话性，一种是持久性。
会话性：如果cookie为会话性，那么cookie仅会保存在客户端的内存中，当我们关闭客服端时cookie也就失效了 持久性：如果cookie为持久性，那么cookie会保存在用户的硬盘中，直至生存期结束或者用户主动将其销毁。
组成 （1）cookie名称 （2）cookie值 （3）Expires：过期时间。当过了过期时间后，浏览器会将该cookie删除。如果不设置Expires，则关闭浏览器后该cookie失效。 （4）Path：用来设置在路径下面的页面才可以访问该cookie，一般设为/，以表示同一站点的所有页面都可以访问该cookie。 （5）Domain：用来指定哪些子域才可以访问cookie，格式一般为“.XXX.com” （6）Secure:如果设置了secure没有值，则代表只有使用HTTPS协议才可以访问 （7）HttpOnly：如果在cookie中设置了HttpOnly属性，那么通过JavaScript脚本等将无法读取到cookie信息。
URL URL（统一资源定位符）的一般格式如下：
scheme://host:port/path?query_parameters#fragment_identifier 具体解释如下：
Scheme（协议）：指定用于访问资源的协议，例如HTTP、HTTPS、FTP等。它是URL的开头部分，通常以双斜杠（//）结尾。 Host（主机）：指定目标资源所在的主机名或IP地址。主机名可以是域名（例如example.com）或IP地址（例如192.168.0.1）。 Port（端口）：指定用于访问目标资源的端口号（可选）。默认的端口号根据协议而不同，如HTTP默认端口是80，HTTPS默认端口是443。如果URL中没有指定端口，将使用默认端口。 Path（路径）：指定资源在服务器上的路径（可选）。路径部分是指服务器上资源的具体位置，可以是文件路径或目录路径。 Query Parameters（查询参数）：包含在URL中的键值对参数（可选）。查询参数通常用于向服务器传递额外的信息，多个参数之间使用"&&ldquo;符号分隔。 Fragment Identifier（片段标识符）：用于标识文档中的特定片段（可选）。片段标识符通常由一个锚点或特定位置的标识符组成，用于在文档中导航到指定位置。 实验过程 使用Flask框架进行构建web应用。
文件架构 ├── web-csrf/ │ ├── webA.py │ ├── webB.py │ ├── templates/ │ │ ├── home.html │ │ ├── login.html │ └── static/ │ └── style.css 源码 webA:
# webA.py import hashlib import re import mysql.connector from flask import Flask, request, render_template, make_response app = Flask(__name__) db = mysql.'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://sirius1y.top/posts/"},{"@type":"ListItem","position":2,"name":"CSRF攻击","item":"https://sirius1y.top/posts/notes/security/csrf-attack/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"CSRF攻击","name":"CSRF攻击","description":"简介 CSRF攻击利用了受害者已经通过身份验证并且在一个网站上建立的有效会话，来执行未经授权的操作。当受害者在一个网站上登录并获得一个会话（例如通过使用用户名和密码进行身份验证），该网站会为其分配一个令牌或会话ID，以便在后续的请求中验证用户的身份。\nCSRF攻击者会通过诱使受害者访问一个恶意网站或点击恶意链接，来利用受害者的已验证会话。由于受害者在浏览器中仍然保持着有效会话，攻击者可以构造特制的请求，以利用该会话来执行恶意操作，而这些操作是受害者并不知情或未经授权的。\n例如，假设受害者在银行网站上登录并建立了一个有效的会话。攻击者可以通过电子邮件或社交媒体发送一个包含恶意链接的消息给受害者。如果受害者点击了该链接，他们的浏览器将自动向银行网站发送一个请求，而这个请求中包含了受害者的有效会话信息。银行网站在验证会话时会认为这个请求是合法的，因为会话是有效的，所以它执行了该请求所代表的操作，如转账、修改账户信息等，而受害者是毫不知情的。\nCSRF攻击的目标是利用受害者的已验证会话来执行攻击者所期望的未经授权操作，从而导致受害者的损失或者对系统的安全产生威胁。\n补充知识 cookie 一般情况下，cookie是以键值对进行表示的(key-value)，例如name=jack，这个就表示cookie的名字是name，cookie携带的值是jack。\ncookie有2种存储方式，一种是会话性，一种是持久性。\n会话性：如果cookie为会话性，那么cookie仅会保存在客户端的内存中，当我们关闭客服端时cookie也就失效了 持久性：如果cookie为持久性，那么cookie会保存在用户的硬盘中，直至生存期结束或者用户主动将其销毁。\n组成 （1）cookie名称 （2）cookie值 （3）Expires：过期时间。当过了过期时间后，浏览器会将该cookie删除。如果不设置Expires，则关闭浏览器后该cookie失效。 （4）Path：用来设置在路径下面的页面才可以访问该cookie，一般设为/，以表示同一站点的所有页面都可以访问该cookie。 （5）Domain：用来指定哪些子域才可以访问cookie，格式一般为“.XXX.com” （6）Secure:如果设置了secure没有值，则代表只有使用HTTPS协议才可以访问 （7）HttpOnly：如果在cookie中设置了HttpOnly属性，那么通过JavaScript脚本等将无法读取到cookie信息。\nURL URL（统一资源定位符）的一般格式如下：\nscheme://host:port/path?query_parameters#fragment_identifier 具体解释如下：\nScheme（协议）：指定用于访问资源的协议，例如HTTP、HTTPS、FTP等。它是URL的开头部分，通常以双斜杠（//）结尾。 Host（主机）：指定目标资源所在的主机名或IP地址。主机名可以是域名（例如example.com）或IP地址（例如192.168.0.1）。 Port（端口）：指定用于访问目标资源的端口号（可选）。默认的端口号根据协议而不同，如HTTP默认端口是80，HTTPS默认端口是443。如果URL中没有指定端口，将使用默认端口。 Path（路径）：指定资源在服务器上的路径（可选）。路径部分是指服务器上资源的具体位置，可以是文件路径或目录路径。 Query Parameters（查询参数）：包含在URL中的键值对参数（可选）。查询参数通常用于向服务器传递额外的信息，多个参数之间使用\u0026quot;\u0026amp;\u0026ldquo;符号分隔。 Fragment Identifier（片段标识符）：用于标识文档中的特定片段（可选）。片段标识符通常由一个锚点或特定位置的标识符组成，用于在文档中导航到指定位置。 实验过程 使用Flask框架进行构建web应用。\n文件架构 ├── web-csrf/ │ ├── webA.py │ ├── webB.py │ ├── templates/ │ │ ├── home.html │ │ ├── login.html │ └── static/ │ └── style.css 源码 webA:\n# webA.py import hashlib import re import mysql.connector from flask import Flask, request, render_template, make_response app = Flask(__name__) db = mysql.","keywords":["网络安全","CSRF","网络攻击"],"articleBody":"简介 CSRF攻击利用了受害者已经通过身份验证并且在一个网站上建立的有效会话，来执行未经授权的操作。当受害者在一个网站上登录并获得一个会话（例如通过使用用户名和密码进行身份验证），该网站会为其分配一个令牌或会话ID，以便在后续的请求中验证用户的身份。\nCSRF攻击者会通过诱使受害者访问一个恶意网站或点击恶意链接，来利用受害者的已验证会话。由于受害者在浏览器中仍然保持着有效会话，攻击者可以构造特制的请求，以利用该会话来执行恶意操作，而这些操作是受害者并不知情或未经授权的。\n例如，假设受害者在银行网站上登录并建立了一个有效的会话。攻击者可以通过电子邮件或社交媒体发送一个包含恶意链接的消息给受害者。如果受害者点击了该链接，他们的浏览器将自动向银行网站发送一个请求，而这个请求中包含了受害者的有效会话信息。银行网站在验证会话时会认为这个请求是合法的，因为会话是有效的，所以它执行了该请求所代表的操作，如转账、修改账户信息等，而受害者是毫不知情的。\nCSRF攻击的目标是利用受害者的已验证会话来执行攻击者所期望的未经授权操作，从而导致受害者的损失或者对系统的安全产生威胁。\n补充知识 cookie 一般情况下，cookie是以键值对进行表示的(key-value)，例如name=jack，这个就表示cookie的名字是name，cookie携带的值是jack。\ncookie有2种存储方式，一种是会话性，一种是持久性。\n会话性：如果cookie为会话性，那么cookie仅会保存在客户端的内存中，当我们关闭客服端时cookie也就失效了 持久性：如果cookie为持久性，那么cookie会保存在用户的硬盘中，直至生存期结束或者用户主动将其销毁。\n组成 （1）cookie名称 （2）cookie值 （3）Expires：过期时间。当过了过期时间后，浏览器会将该cookie删除。如果不设置Expires，则关闭浏览器后该cookie失效。 （4）Path：用来设置在路径下面的页面才可以访问该cookie，一般设为/，以表示同一站点的所有页面都可以访问该cookie。 （5）Domain：用来指定哪些子域才可以访问cookie，格式一般为“.XXX.com” （6）Secure:如果设置了secure没有值，则代表只有使用HTTPS协议才可以访问 （7）HttpOnly：如果在cookie中设置了HttpOnly属性，那么通过JavaScript脚本等将无法读取到cookie信息。\nURL URL（统一资源定位符）的一般格式如下：\nscheme://host:port/path?query_parameters#fragment_identifier 具体解释如下：\nScheme（协议）：指定用于访问资源的协议，例如HTTP、HTTPS、FTP等。它是URL的开头部分，通常以双斜杠（//）结尾。 Host（主机）：指定目标资源所在的主机名或IP地址。主机名可以是域名（例如example.com）或IP地址（例如192.168.0.1）。 Port（端口）：指定用于访问目标资源的端口号（可选）。默认的端口号根据协议而不同，如HTTP默认端口是80，HTTPS默认端口是443。如果URL中没有指定端口，将使用默认端口。 Path（路径）：指定资源在服务器上的路径（可选）。路径部分是指服务器上资源的具体位置，可以是文件路径或目录路径。 Query Parameters（查询参数）：包含在URL中的键值对参数（可选）。查询参数通常用于向服务器传递额外的信息，多个参数之间使用\"\u0026“符号分隔。 Fragment Identifier（片段标识符）：用于标识文档中的特定片段（可选）。片段标识符通常由一个锚点或特定位置的标识符组成，用于在文档中导航到指定位置。 实验过程 使用Flask框架进行构建web应用。\n文件架构 ├── web-csrf/ │ ├── webA.py │ ├── webB.py │ ├── templates/ │ │ ├── home.html │ │ ├── login.html │ └── static/ │ └── style.css 源码 webA:\n# webA.py import hashlib import re import mysql.connector from flask import Flask, request, render_template, make_response app = Flask(__name__) db = mysql.connector.connect( host=\"localhost\", user=\"root\", password=\"111111\", database=\"web-csrf\" ) cursor = db.cursor() # 登录功能 @app.route('/') @app.route('/login', methods=['GET', 'POST']) def login(): if request.method == 'POST': username = request.form['username'] password = request.form['password'] # 检查用户名和密码是否匹配，参数化查询的方式 query = \"SELECT * FROM user WHERE id = %s AND pwd = %s\" cursor.execute(query, (username, password)) user = cursor.fetchone() # fetchone方法从查询结果中获取一条记录，以元组的形式返回 cursor.fetchall() # fetchall方法从查询结果中获取所有记录，以元组的形式返回 if user: user_id = user[0] user_token = hashlib.md5() user_token.update((user_id + str(request.cookies.get('timestamp'))).encode('utf-8')) response = make_response(render_template('home.html', user_id=user[0], balance=user[3],user_token=user_token.hexdigest())) # 用户标识为用户ID和当前时间的md5摘要,在cookie中设置用户身份标识 user_id = user[0] user_token = hashlib.md5() user_token.update((user_id + str(request.cookies.get('timestamp'))).encode('utf-8')) response.set_cookie('user_id', user_id) response.set_cookie('user_token', user_token.hexdigest()) # 将cookie中的用户身份标识存入数据库 query = \"UPDATE user SET cookie = %s WHERE id = %s\" cursor.execute(query, (user_token.hexdigest(), user_id)) db.commit() return response else: return \"用户名或密码错误\" return render_template('login.html') # 转账功能 @app.route('/transfer', methods=['POST']) def transfer(): user_id_cookie = request.cookies.get('user_id') user_token_cookie = request.cookies.get('user_token') if not user_id_cookie or not user_token_cookie: return \"你的用户身份已过期，请重新登录\" # 比较user_token是否与数据库中的cookie一致 # 根据user_id从数据库中获取cookie cursor.fetchall() query = \"SELECT cookie FROM user WHERE id = %s\" cursor.execute(query, (user_id_cookie,)) cookie = cursor.fetchone()[0] if cookie != user_token_cookie: return \"cookie匹配失败！你的用户身份已过期，请重新登录\" # 获取转账目标用户的ID和金额 target_id = request.form['target_id'] amount = request.form['amount'] # 检测转账金额是否合法 # 用正则表达式匹配小数 if not re.match(r'^\\d+(\\.\\d+)?$', amount): return \"转账金额必须为数字\" if float(amount) \u003c= 0: return \"转账金额必须大于0\" # 检查转账目标用户是否存在 cursor.fetchall() query = \"SELECT * FROM user WHERE id = %s\" cursor.execute(query, (target_id,)) target = cursor.fetchone() if not target: return \"目标账户不存在\" # 检测当前账户是否有这么多钱 cursor.fetchall() query = \"SELECT * FROM user WHERE id = %s\" cursor.execute(query, (user_id_cookie,)) user = cursor.fetchone() if user[3] \u003c float(amount): return \"余额不足\" # 执行转账操作 cursor.fetchall() query = \"UPDATE user SET balance = balance - %s WHERE id = %s\" cursor.execute(query, (amount, user_id_cookie)) query = \"UPDATE user SET balance = balance + %s WHERE id = %s\" cursor.execute(query, (amount, target_id)) db.commit() # 更新账户信息，返回网站 cursor.fetchall() query = \"SELECT * FROM user WHERE id = %s\" cursor.execute(query, (user_id_cookie,)) user = cursor.fetchone() return render_template('home.html', user_id=user[0], balance=user[3], user_token=user[2],transfer_success=True) if __name__ == '__main__': app.run() webB\nimport mysql.connector from flask import Flask, request app = Flask(__name__) db = mysql.connector.connect( host=\"localhost\", user=\"root\", password=\"111111\", database=\"web-csrf\" ) cursor = db.cursor() # 转账请求 @app.route('/') def csrf_attack(): user_id_cookie = request.args.get('user_id') user_token_cookie = request.args.get('user_token') if user_token_cookie or user_id_cookie: # 模拟服务器的验证操作，通过user_id_cookie查询对应的user_token，检查user_token_cookie是否与user_token相同，相同就允许执行转账操作 query = \"SELECT cookie FROM user WHERE id = %s\" cursor.execute(query, (user_id_cookie,)) user_token = cursor.fetchone()[0] if user_token == user_token_cookie: # 执行转账操作 cursor.fetchall() query = \"UPDATE user SET balance = balance - 100 WHERE id = 'user_id_cookie'\" cursor.execute(query) query = \"UPDATE user SET balance = balance + 100 WHERE id = 'hacker'\" cursor.execute(query) db.commit() return \"CSRF攻击执行成功！\" else: print(\"user_token:\", user_token) print(\"user_token_cookie:\", user_token_cookie) return \"Invalid user credentials\" else:# login.html ```html \u003c!-- login.html --\u003e \u003c!DOCTYPE html\u003e \u003chtml lang=\"en\"\u003e \u003chead\u003e \u003cmeta charset=\"UTF-8\"\u003e \u003ctitle\u003eDoggyCoin用户登录\u003c/title\u003e \u003clink rel=\"stylesheet\" type=\"text/css\" href=\"../static/style.css\"\u003e \u003c/head\u003e \u003cbody\u003e \u003ch1\u003eDoggyCoin用户登录\u003c/h1\u003e \u003cform action=\"/login\" method=\"POST\"\u003e \u003cdiv\u003e \u003clabel for=\"username\"\u003e用户名:\u003c/label\u003e \u003cinput type=\"text\" id=\"username\" name=\"username\" required\u003e \u003c/div\u003e \u003cdiv\u003e \u003clabel for=\"password\"\u003e密码:\u003c/label\u003e \u003cinput type=\"password\" id=\"password\" name=\"password\" required\u003e \u003c/div\u003e \u003cdiv\u003e \u003cbutton type=\"submit\"\u003e登录\u003c/button\u003e \u003c/div\u003e \u003c/form\u003e \u003c/body\u003e \u003c/html\u003e home.html\n\u003c!DOCTYPE html\u003e# \u003c/div\u003e \u003ch1\u003e欢迎访问DoggyCoin转账中心\u003c/h1\u003e \u003ch2\u003e账户余额: {{ balance }}\u003c/h2\u003e \u003cscript\u003e // 检查是否存在转账成功的消息 var transferSuccess = \"{{ transfer_success }}\"; if (transferSuccess) { // 显示转账成功的消息提示框 alert(\"转账成功！\"); } \u003c/script\u003e \u003cform action=\"/transfer\" method=\"POST\"\u003e \u003cdiv\u003e \u003clabel for=\"target_id\"\u003e转账ID:\u003c/label\u003e \u003cinput type=\"text\" id=\"target_id\" name=\"target_id\" required\u003e \u003c/div\u003e \u003cdiv\u003e \u003clabel for=\"amount\"\u003e转账金额:\u003c/label\u003e \u003cinput type=\"text\" id=\"amount\" name=\"amount\" required\u003e \u003c/div\u003e \u003cdiv\u003e \u003cbutton type=\"submit\"\u003e确认转账\u003c/button\u003e \u003c/div\u003e \u003c/form\u003e \u003ca href=\"http://127.0.0.1:5001?user_id={{ user_id }}\u0026user_token={{ user_token }}\"\u003e一般人都不知道的DoggyCoin转账技巧！特殊转账技巧转一送一！\u003c/a\u003e \u003c/body\u003e \u003c/html\u003e style.css\n/* style.css */ body { background-color: #f2f2f2; font-family: Arial, sans-serif; } .container { display: flex; justify-content: space-between; align-items: center; padding: 10px; background-color: #fff; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); } .logo { font-size: 24px; font-weight: bold; } .user-info { display: flex; align-items: center; } .user-info .username { margin-right: 10px; } .logout-link { margin: 0; display: flex; align-items: center; color: #4CAF50; text-decoration: none; } h1 { color: #333; text-align: center; } form { max-width: 400px; margin: 0 auto; padding: 20px; background-color: #fff; border-radius: 5px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); } label { display: block; margin-bottom: 10px; font-weight: bold; } input[type=\"text\"], input[type=\"password\"] { width: 94%; padding: 10px; border: 1px solid #ccc; border-radius: 3px; } button { display: block; width: 100%; padding: 10px; margin-top: 10px; background-color: #4CAF50; color: #fff; border: none; border-radius: 3px; cursor: pointer; } h2 { margin-top: 20px; font-size: 18px; text-align: center; } a { display: block; text-align: cente# } ​\t当用户点击这个链接，就会带着在webA中的登录信息（cookie）去访问webB，构建这个webB的黑客就可以获取到用户B的cookie信息，并且向webA发送请求转账的请求，就可以绕过服务器的验证达到冒充用户去进行转账操作。\n实现难点 webA需要具备登录登出、转账、转账时需要token进行验证等必备功能；\nwebB需要具备使用用户的cookie数据向webA发送转账的请求，而不仅仅是在本地直接操作数据库实现修改数据；\n数据库中需要存放用户ID、用户密码、用户的cookie、账户余额等信息；\n对于cookie数据的保存、设计、更新策略。\n实验过程 数据库的设计 ​\t数据库中主要包含\"id”, “pwd”, “cookie”, “balance\"字段，id是他们的登陆账户名，pwd是登陆密码，cookie表示他们的用户安全令牌，当转账的时候需要进行验证，balance表示账户余额。通过数据生成出一批用户。\n​\t其中hacker代表黑客，其他的都是普通用户。\n验证webA功能的完整性 ​\twebA从服务器启动之后，运行在本地的5000端口上，进行访问之后会出现用户的登陆界面，输入在数据库中注册的用户名和密码进行登录。 ​\t登录成功之后会进入到DoggyCoin转账中心，在网站左上角显示当前的登陆用户名和退出登录返回登录页面的按钮，中间的form表单就是正常进行转账操作的地方，输入正确的转账ID和合法的转账金额之后就能够进行转账操作。\n​\t这里也简单的进行了一些对于非法输入的防护，以防止出现服务器内部错误。比如对于转账ID的是否存在，转账金额是否大于0，使用正则表达式匹配转账金额小数点的情况等等。\n进行CSRF漏洞的利用攻击。 ​\t当用户在登录webA的时候，服务器根据user1的id和登陆时间在后台生成一个md5摘要作为user1的cookie，存储在数据库中并且返回给user。\n​\t在webA上有一个诈骗链接，就是在转账表单下方的绿色链接“一般人都不知道的DoggyCoin转账技巧！特殊转账技巧转一送一！”，这个就是模拟的一个网页上的弹窗或者是通过电子邮件等方式，诱使用户点击从当前网页转到另外一个网页上，该链接的HTML为：\n\u003ca href=\"http://127.0.0.1:5001?user_id={{ user_id }}\u0026user_token={{ user_token }}\"\u003e一般人都不知道的DoggyCoin转账技巧！特殊转账技巧转一送一！\u003c/a\u003e ​\t当用户点击链接之后就会带着当前网站上的cookie信息去访问webB，而webB的后台就从这个链接中获取到用户的user_id和user_token信息，就可以进行转账的操作了，就自动地从当前用户向hacker账户中转账100\n​\twebB是运行在本地的5001端口上的，当直接访问127.0.0.1:5001的时候，由于没有进行user_id和user_token的转发，所以在webB上无法得到用户的信息，也就不能够进行CSRF攻击。\n防护策略 在防御CSRF（Cross-Site Request Forgery）攻击时，验证HTTP Referer字段是一种常见的方法之一。HTTP Referer字段用于指示请求的源头，即告诉服务器该请求是从哪个页面发起的。通过验证HTTP Referer字段，可以确保请求来源于预期的页面，从而减少CSRF攻击的风险。\n要实现验证HTTP Referer字段的防御措施，可以按照以下步骤进行：\n在服务器端验证：当服务器接收到请求时，首先检查HTTP头部中的Referer字段。该字段包含了请求的来源页面的URL。服务器可以通过比较Referer字段的值与预期的来源页面的URL进行验证。如果Referer字段的值与预期不符，服务器可以拒绝该请求。 验证来源页面的域名：为了增加安全性，可以进一步验证Referer字段中的来源页面域名。服务器可以检查Referer字段中的域名与当前请求的域名是否一致。这可以防止攻击者通过篡改Referer字段来绕过验证。 考虑Referer字段的可靠性：需要注意的是，Referer字段并非百分之百可靠，因为它可以被篡改或者被一些浏览器或代理程序禁用。因此，验证Referer字段应该作为综合的安全策略的一部分，而不是单一的依赖点。 ","wordCount":"800","inLanguage":"en","image":"https://sirius1y.top/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2023-05-21T00:00:00Z","dateModified":"2023-05-21T00:00:00Z","author":{"@type":"Person","name":"sirius1y"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://sirius1y.top/posts/notes/security/csrf-attack/"},"publisher":{"@type":"Organization","name":"Sirius' Blog","logo":{"@type":"ImageObject","url":"https://sirius1y.top/images/icon.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://sirius1y.top/ accesskey=h title="Home (Alt + H)"><img src=https://sirius1y.top/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://sirius1y.top/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://sirius1y.top/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://sirius1y.top/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://sirius1y.top/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://sirius1y.top/>Home</a>&nbsp;»&nbsp;<a href=https://sirius1y.top/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">CSRF攻击</h1><div class=post-meta><span title='2023-05-21 00:00:00 +0000 UTC'>May 21, 2023</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;800 words&nbsp;·&nbsp;sirius1y</div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e7%ae%80%e4%bb%8b aria-label=简介>简介</a></li><li><a href=#%e8%a1%a5%e5%85%85%e7%9f%a5%e8%af%86 aria-label=补充知识>补充知识</a><ul><li><a href=#cookie aria-label=cookie>cookie</a><ul><li><a href=#%e7%bb%84%e6%88%90 aria-label=组成>组成</a></li></ul></li><li><a href=#url aria-label=URL>URL</a></li></ul></li><li><a href=#%e5%ae%9e%e9%aa%8c%e8%bf%87%e7%a8%8b aria-label=实验过程>实验过程</a><ul><li><a href=#%e6%96%87%e4%bb%b6%e6%9e%b6%e6%9e%84 aria-label=文件架构>文件架构</a></li><li><a href=#%e6%ba%90%e7%a0%81 aria-label=源码>源码</a></li><li><a href=#%e5%ae%9e%e7%8e%b0%e9%9a%be%e7%82%b9 aria-label=实现难点>实现难点</a></li><li><a href=#%e5%ae%9e%e9%aa%8c%e8%bf%87%e7%a8%8b-1 aria-label=实验过程>实验过程</a><ul><li><a href=#%e6%95%b0%e6%8d%ae%e5%ba%93%e7%9a%84%e8%ae%be%e8%ae%a1 aria-label=数据库的设计>数据库的设计</a></li><li><a href=#%e9%aa%8c%e8%af%81weba%e5%8a%9f%e8%83%bd%e7%9a%84%e5%ae%8c%e6%95%b4%e6%80%a7 aria-label=验证webA功能的完整性>验证webA功能的完整性</a></li><li><a href=#%e8%bf%9b%e8%a1%8ccsrf%e6%bc%8f%e6%b4%9e%e7%9a%84%e5%88%a9%e7%94%a8%e6%94%bb%e5%87%bb aria-label=进行CSRF漏洞的利用攻击。>进行CSRF漏洞的利用攻击。</a></li></ul></li><li><a href=#%e9%98%b2%e6%8a%a4%e7%ad%96%e7%95%a5 aria-label=防护策略>防护策略</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h1 id=简介>简介<a hidden class=anchor aria-hidden=true href=#简介>#</a></h1><p>CSRF攻击利用了受害者已经通过身份验证并且在一个网站上建立的有效会话，来执行未经授权的操作。当受害者在一个网站上登录并获得一个会话（例如通过使用用户名和密码进行身份验证），该网站会为其分配一个令牌或会话ID，以便在后续的请求中验证用户的身份。</p><p>CSRF攻击者会通过诱使受害者访问一个恶意网站或点击恶意链接，来利用受害者的已验证会话。由于受害者在浏览器中仍然保持着有效会话，攻击者可以构造特制的请求，以利用该会话来执行恶意操作，而这些操作是受害者并不知情或未经授权的。</p><p>例如，假设受害者在银行网站上登录并建立了一个有效的会话。攻击者可以通过电子邮件或社交媒体发送一个包含恶意链接的消息给受害者。如果受害者点击了该链接，他们的浏览器将自动向银行网站发送一个请求，而这个请求中包含了受害者的有效会话信息。银行网站在验证会话时会认为这个请求是合法的，因为会话是有效的，所以它执行了该请求所代表的操作，如转账、修改账户信息等，而受害者是毫不知情的。</p><p>CSRF攻击的目标是利用受害者的已验证会话来执行攻击者所期望的未经授权操作，从而导致受害者的损失或者对系统的安全产生威胁。</p><h1 id=补充知识>补充知识<a hidden class=anchor aria-hidden=true href=#补充知识>#</a></h1><h2 id=cookie>cookie<a hidden class=anchor aria-hidden=true href=#cookie>#</a></h2><p>一般情况下，cookie是以<strong>键值对进行表示</strong>的(key-value)，例如name=jack，这个就表示cookie的名字是name，cookie携带的值是jack。</p><p>cookie有2种<strong>存储方式</strong>，一种是会话性，一种是持久性。</p><p>会话性：如果cookie为会话性，那么cookie仅会保存在客户端的内存中，当我们关闭客服端时cookie也就失效了
持久性：如果cookie为持久性，那么cookie会保存在用户的硬盘中，直至生存期结束或者用户主动将其销毁。</p><h3 id=组成>组成<a hidden class=anchor aria-hidden=true href=#组成>#</a></h3><p>（1）cookie名称
（2）cookie值
（3）Expires：过期时间。当过了过期时间后，浏览器会将该cookie删除。如果不设置Expires，则关闭浏览器后该cookie失效。
（4）Path：用来设置在路径下面的页面才可以访问该cookie，一般设为/，以表示同一站点的所有页面都可以访问该cookie。
（5）Domain：用来指定哪些子域才可以访问cookie，格式一般为“.XXX.com”
（6）Secure:如果设置了secure没有值，则代表只有使用HTTPS协议才可以访问
（7）HttpOnly：如果在cookie中设置了HttpOnly属性，那么通过JavaScript脚本等将无法读取到cookie信息。</p><p><img loading=lazy src=https://raw.githubusercontent.com/sirius2alpha/Typora-pics/master/2023/05/upgit_20230521_1684665360.png alt=image-20230521183600290></p><p><img loading=lazy src=https://raw.githubusercontent.com/sirius2alpha/Typora-pics/master/2023/05/upgit_20230521_1684665295.png alt=cookie组成></p><h2 id=url>URL<a hidden class=anchor aria-hidden=true href=#url>#</a></h2><p>URL（统一资源定位符）的一般格式如下：</p><pre tabindex=0><code>scheme://host:port/path?query_parameters#fragment_identifier
</code></pre><p>具体解释如下：</p><ol><li>Scheme（协议）：指定用于访问资源的协议，例如HTTP、HTTPS、FTP等。它是URL的开头部分，通常以双斜杠（//）结尾。</li><li>Host（主机）：指定目标资源所在的主机名或IP地址。主机名可以是域名（例如example.com）或IP地址（例如192.168.0.1）。</li><li>Port（端口）：指定用于访问目标资源的端口号（可选）。默认的端口号根据协议而不同，如HTTP默认端口是80，HTTPS默认端口是443。如果URL中没有指定端口，将使用默认端口。</li><li>Path（路径）：指定资源在服务器上的路径（可选）。路径部分是指服务器上资源的具体位置，可以是文件路径或目录路径。</li><li>Query Parameters（查询参数）：包含在URL中的键值对参数（可选）。查询参数通常用于向服务器传递额外的信息，多个参数之间使用"&&ldquo;符号分隔。</li><li>Fragment Identifier（片段标识符）：用于标识文档中的特定片段（可选）。片段标识符通常由一个锚点或特定位置的标识符组成，用于在文档中导航到指定位置。</li></ol><h1 id=实验过程>实验过程<a hidden class=anchor aria-hidden=true href=#实验过程>#</a></h1><p>使用Flask框架进行构建web应用。</p><h2 id=文件架构>文件架构<a hidden class=anchor aria-hidden=true href=#文件架构>#</a></h2><pre tabindex=0><code>├── web-csrf/
│   ├── webA.py
│   ├── webB.py
│   ├── templates/
│   │   ├── home.html
│   │   ├── login.html
│   └── static/
│       └── style.css
</code></pre><h2 id=源码>源码<a hidden class=anchor aria-hidden=true href=#源码>#</a></h2><p>webA:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># webA.py</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>mysql.connector</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>flask</span> <span class=kn>import</span> <span class=n>Flask</span><span class=p>,</span> <span class=n>request</span><span class=p>,</span> <span class=n>render_template</span><span class=p>,</span> <span class=n>make_response</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>Flask</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>db</span> <span class=o>=</span> <span class=n>mysql</span><span class=o>.</span><span class=n>connector</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>host</span><span class=o>=</span><span class=s2>&#34;localhost&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>user</span><span class=o>=</span><span class=s2>&#34;root&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>password</span><span class=o>=</span><span class=s2>&#34;111111&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>database</span><span class=o>=</span><span class=s2>&#34;web-csrf&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>cursor</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 登录功能</span>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/login&#39;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;GET&#39;</span><span class=p>,</span> <span class=s1>&#39;POST&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>login</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>request</span><span class=o>.</span><span class=n>method</span> <span class=o>==</span> <span class=s1>&#39;POST&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>username</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>form</span><span class=p>[</span><span class=s1>&#39;username&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>password</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>form</span><span class=p>[</span><span class=s1>&#39;password&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 检查用户名和密码是否匹配，参数化查询的方式</span>
</span></span><span class=line><span class=cl>        <span class=n>query</span> <span class=o>=</span> <span class=s2>&#34;SELECT * FROM user WHERE id = </span><span class=si>%s</span><span class=s2> AND pwd = </span><span class=si>%s</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=p>(</span><span class=n>username</span><span class=p>,</span> <span class=n>password</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>user</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()</span>  <span class=c1># fetchone方法从查询结果中获取一条记录，以元组的形式返回</span>
</span></span><span class=line><span class=cl>        <span class=n>cursor</span><span class=o>.</span><span class=n>fetchall</span><span class=p>()</span>  <span class=c1># fetchall方法从查询结果中获取所有记录，以元组的形式返回</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>user</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>user_id</span> <span class=o>=</span> <span class=n>user</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>user_token</span> <span class=o>=</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>md5</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>user_token</span><span class=o>.</span><span class=n>update</span><span class=p>((</span><span class=n>user_id</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>request</span><span class=o>.</span><span class=n>cookies</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;timestamp&#39;</span><span class=p>)))</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>response</span> <span class=o>=</span> <span class=n>make_response</span><span class=p>(</span><span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;home.html&#39;</span><span class=p>,</span> <span class=n>user_id</span><span class=o>=</span><span class=n>user</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>balance</span><span class=o>=</span><span class=n>user</span><span class=p>[</span><span class=mi>3</span><span class=p>],</span><span class=n>user_token</span><span class=o>=</span><span class=n>user_token</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 用户标识为用户ID和当前时间的md5摘要,在cookie中设置用户身份标识</span>
</span></span><span class=line><span class=cl>            <span class=n>user_id</span> <span class=o>=</span> <span class=n>user</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>user_token</span> <span class=o>=</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>md5</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>user_token</span><span class=o>.</span><span class=n>update</span><span class=p>((</span><span class=n>user_id</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>request</span><span class=o>.</span><span class=n>cookies</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;timestamp&#39;</span><span class=p>)))</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>response</span><span class=o>.</span><span class=n>set_cookie</span><span class=p>(</span><span class=s1>&#39;user_id&#39;</span><span class=p>,</span> <span class=n>user_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>response</span><span class=o>.</span><span class=n>set_cookie</span><span class=p>(</span><span class=s1>&#39;user_token&#39;</span><span class=p>,</span> <span class=n>user_token</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 将cookie中的用户身份标识存入数据库</span>
</span></span><span class=line><span class=cl>            <span class=n>query</span> <span class=o>=</span> <span class=s2>&#34;UPDATE user SET cookie = </span><span class=si>%s</span><span class=s2> WHERE id = </span><span class=si>%s</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=p>(</span><span class=n>user_token</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>(),</span> <span class=n>user_id</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>db</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s2>&#34;用户名或密码错误&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;login.html&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 转账功能</span>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/transfer&#39;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;POST&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>transfer</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>user_id_cookie</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>cookies</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;user_id&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>user_token_cookie</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>cookies</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;user_token&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>user_id_cookie</span> <span class=ow>or</span> <span class=ow>not</span> <span class=n>user_token_cookie</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;你的用户身份已过期，请重新登录&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 比较user_token是否与数据库中的cookie一致</span>
</span></span><span class=line><span class=cl>    <span class=c1># 根据user_id从数据库中获取cookie</span>
</span></span><span class=line><span class=cl>    <span class=n>cursor</span><span class=o>.</span><span class=n>fetchall</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>query</span> <span class=o>=</span> <span class=s2>&#34;SELECT cookie FROM user WHERE id = </span><span class=si>%s</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=p>(</span><span class=n>user_id_cookie</span><span class=p>,))</span>
</span></span><span class=line><span class=cl>    <span class=n>cookie</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>cookie</span> <span class=o>!=</span> <span class=n>user_token_cookie</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;cookie匹配失败！你的用户身份已过期，请重新登录&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 获取转账目标用户的ID和金额</span>
</span></span><span class=line><span class=cl>    <span class=n>target_id</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>form</span><span class=p>[</span><span class=s1>&#39;target_id&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>amount</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>form</span><span class=p>[</span><span class=s1>&#39;amount&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 检测转账金额是否合法</span>
</span></span><span class=line><span class=cl>    <span class=c1># 用正则表达式匹配小数</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>re</span><span class=o>.</span><span class=k>match</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;^\d+(\.\d+)?$&#39;</span><span class=p>,</span> <span class=n>amount</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;转账金额必须为数字&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>float</span><span class=p>(</span><span class=n>amount</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;转账金额必须大于0&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 检查转账目标用户是否存在</span>
</span></span><span class=line><span class=cl>    <span class=n>cursor</span><span class=o>.</span><span class=n>fetchall</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>query</span> <span class=o>=</span> <span class=s2>&#34;SELECT * FROM user WHERE id = </span><span class=si>%s</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=p>(</span><span class=n>target_id</span><span class=p>,))</span>
</span></span><span class=line><span class=cl>    <span class=n>target</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>target</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;目标账户不存在&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 检测当前账户是否有这么多钱</span>
</span></span><span class=line><span class=cl>    <span class=n>cursor</span><span class=o>.</span><span class=n>fetchall</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>query</span> <span class=o>=</span> <span class=s2>&#34;SELECT * FROM user WHERE id = </span><span class=si>%s</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=p>(</span><span class=n>user_id_cookie</span><span class=p>,))</span>
</span></span><span class=line><span class=cl>    <span class=n>user</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>user</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>&lt;</span> <span class=nb>float</span><span class=p>(</span><span class=n>amount</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;余额不足&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 执行转账操作</span>
</span></span><span class=line><span class=cl>    <span class=n>cursor</span><span class=o>.</span><span class=n>fetchall</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>query</span> <span class=o>=</span> <span class=s2>&#34;UPDATE user SET balance = balance - </span><span class=si>%s</span><span class=s2> WHERE id = </span><span class=si>%s</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=p>(</span><span class=n>amount</span><span class=p>,</span> <span class=n>user_id_cookie</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>query</span> <span class=o>=</span> <span class=s2>&#34;UPDATE user SET balance = balance + </span><span class=si>%s</span><span class=s2> WHERE id = </span><span class=si>%s</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=p>(</span><span class=n>amount</span><span class=p>,</span> <span class=n>target_id</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>db</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 更新账户信息，返回网站</span>
</span></span><span class=line><span class=cl>    <span class=n>cursor</span><span class=o>.</span><span class=n>fetchall</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>query</span> <span class=o>=</span> <span class=s2>&#34;SELECT * FROM user WHERE id = </span><span class=si>%s</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=p>(</span><span class=n>user_id_cookie</span><span class=p>,))</span>
</span></span><span class=line><span class=cl>    <span class=n>user</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>render_template</span><span class=p>(</span><span class=s1>&#39;home.html&#39;</span><span class=p>,</span> <span class=n>user_id</span><span class=o>=</span><span class=n>user</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>balance</span><span class=o>=</span><span class=n>user</span><span class=p>[</span><span class=mi>3</span><span class=p>],</span> <span class=n>user_token</span><span class=o>=</span><span class=n>user</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span><span class=n>transfer_success</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>run</span><span class=p>()</span>
</span></span></code></pre></div><p>webB</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>mysql.connector</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>flask</span> <span class=kn>import</span> <span class=n>Flask</span><span class=p>,</span> <span class=n>request</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>Flask</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>db</span> <span class=o>=</span> <span class=n>mysql</span><span class=o>.</span><span class=n>connector</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>host</span><span class=o>=</span><span class=s2>&#34;localhost&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>user</span><span class=o>=</span><span class=s2>&#34;root&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>password</span><span class=o>=</span><span class=s2>&#34;111111&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>database</span><span class=o>=</span><span class=s2>&#34;web-csrf&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>cursor</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 转账请求</span>
</span></span><span class=line><span class=cl><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>csrf_attack</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>user_id_cookie</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>args</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;user_id&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>user_token_cookie</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>args</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;user_token&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>user_token_cookie</span> <span class=ow>or</span>  <span class=n>user_id_cookie</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 模拟服务器的验证操作，通过user_id_cookie查询对应的user_token，检查user_token_cookie是否与user_token相同，相同就允许执行转账操作</span>
</span></span><span class=line><span class=cl>        <span class=n>query</span> <span class=o>=</span> <span class=s2>&#34;SELECT cookie FROM user WHERE id = </span><span class=si>%s</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=p>(</span><span class=n>user_id_cookie</span><span class=p>,))</span>
</span></span><span class=line><span class=cl>        <span class=n>user_token</span> <span class=o>=</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>user_token</span> <span class=o>==</span> <span class=n>user_token_cookie</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 执行转账操作</span>
</span></span><span class=line><span class=cl>            <span class=n>cursor</span><span class=o>.</span><span class=n>fetchall</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>query</span> <span class=o>=</span> <span class=s2>&#34;UPDATE user SET balance = balance - 100 WHERE id = &#39;user_id_cookie&#39;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>query</span> <span class=o>=</span> <span class=s2>&#34;UPDATE user SET balance = balance + 100 WHERE id = &#39;hacker&#39;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>db</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s2>&#34;&lt;h1 style=&#39;color: red; text-align: center; padding: 20px;&#39;&gt;CSRF攻击执行成功！&lt;/h1&gt;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;user_token:&#34;</span><span class=p>,</span> <span class=n>user_token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;user_token_cookie:&#34;</span><span class=p>,</span> <span class=n>user_token_cookie</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s2>&#34;Invalid user credentials&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span><span class=c1>#</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>login</span><span class=o>.</span><span class=n>html</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>```</span><span class=n>html</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=err>!</span><span class=o>--</span> <span class=n>login</span><span class=o>.</span><span class=n>html</span> <span class=o>--&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=err>!</span><span class=n>DOCTYPE</span> <span class=n>html</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>html</span> <span class=n>lang</span><span class=o>=</span><span class=s2>&#34;en&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>head</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=n>meta</span> <span class=n>charset</span><span class=o>=</span><span class=s2>&#34;UTF-8&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=n>title</span><span class=o>&gt;</span><span class=n>DoggyCoin用户登录</span><span class=o>&lt;/</span><span class=n>title</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=n>link</span> <span class=n>rel</span><span class=o>=</span><span class=s2>&#34;stylesheet&#34;</span> <span class=nb>type</span><span class=o>=</span><span class=s2>&#34;text/css&#34;</span> <span class=n>href</span><span class=o>=</span><span class=s2>&#34;../static/style.css&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&lt;/</span><span class=n>head</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>body</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>h1</span><span class=o>&gt;</span><span class=n>DoggyCoin用户登录</span><span class=o>&lt;/</span><span class=n>h1</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>form</span> <span class=n>action</span><span class=o>=</span><span class=s2>&#34;/login&#34;</span> <span class=n>method</span><span class=o>=</span><span class=s2>&#34;POST&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=n>div</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=n>label</span> <span class=k>for</span><span class=o>=</span><span class=s2>&#34;username&#34;</span><span class=o>&gt;</span><span class=n>用户名</span><span class=p>:</span><span class=o>&lt;/</span><span class=n>label</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=nb>input</span> <span class=nb>type</span><span class=o>=</span><span class=s2>&#34;text&#34;</span> <span class=nb>id</span><span class=o>=</span><span class=s2>&#34;username&#34;</span> <span class=n>name</span><span class=o>=</span><span class=s2>&#34;username&#34;</span> <span class=n>required</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;/</span><span class=n>div</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=n>div</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=n>label</span> <span class=k>for</span><span class=o>=</span><span class=s2>&#34;password&#34;</span><span class=o>&gt;</span><span class=n>密码</span><span class=p>:</span><span class=o>&lt;/</span><span class=n>label</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=nb>input</span> <span class=nb>type</span><span class=o>=</span><span class=s2>&#34;password&#34;</span> <span class=nb>id</span><span class=o>=</span><span class=s2>&#34;password&#34;</span> <span class=n>name</span><span class=o>=</span><span class=s2>&#34;password&#34;</span> <span class=n>required</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;/</span><span class=n>div</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=n>div</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=n>button</span> <span class=nb>type</span><span class=o>=</span><span class=s2>&#34;submit&#34;</span><span class=o>&gt;</span><span class=n>登录</span><span class=o>&lt;/</span><span class=n>button</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;/</span><span class=n>div</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&lt;/</span><span class=n>form</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&lt;/</span><span class=n>body</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&lt;/</span><span class=n>html</span><span class=o>&gt;</span>
</span></span></code></pre></div><p>home.html</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=c>&lt;!-- home.html --&gt;</span>
</span></span><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE html&gt;</span>#
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>h1</span><span class=p>&gt;</span>欢迎访问DoggyCoin转账中心<span class=p>&lt;/</span><span class=nt>h1</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>h2</span><span class=p>&gt;</span>账户余额: {{ balance }}<span class=p>&lt;/</span><span class=nt>h2</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 检查是否存在转账成功的消息
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>var</span> <span class=nx>transferSuccess</span> <span class=o>=</span> <span class=s2>&#34;{{ transfer_success }}&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>transferSuccess</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 显示转账成功的消息提示框
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>alert</span><span class=p>(</span><span class=s2>&#34;转账成功！&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>form</span> <span class=na>action</span><span class=o>=</span><span class=s>&#34;/transfer&#34;</span> <span class=na>method</span><span class=o>=</span><span class=s>&#34;POST&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>label</span> <span class=na>for</span><span class=o>=</span><span class=s>&#34;target_id&#34;</span><span class=p>&gt;</span>转账ID:<span class=p>&lt;/</span><span class=nt>label</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;text&#34;</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;target_id&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;target_id&#34;</span> <span class=na>required</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>label</span> <span class=na>for</span><span class=o>=</span><span class=s>&#34;amount&#34;</span><span class=p>&gt;</span>转账金额:<span class=p>&lt;/</span><span class=nt>label</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;text&#34;</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;amount&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;amount&#34;</span> <span class=na>required</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>button</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;submit&#34;</span><span class=p>&gt;</span>确认转账<span class=p>&lt;/</span><span class=nt>button</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>form</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;http://127.0.0.1:5001?user_id={{ user_id }}&amp;user_token={{ user_token }}&#34;</span><span class=p>&gt;</span>一般人都不知道的DoggyCoin转账技巧！特殊转账技巧转一送一！<span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>style.css</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=c>/* style.css */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>body</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>background-color</span><span class=p>:</span> <span class=mh>#f2f2f2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>font-family</span><span class=p>:</span> <span class=n>Arial</span><span class=p>,</span> <span class=kc>sans-serif</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>.</span><span class=nc>container</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>display</span><span class=p>:</span> <span class=kc>flex</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>justify-content</span><span class=p>:</span> <span class=kc>space-between</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>align-items</span><span class=p>:</span> <span class=kc>center</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>padding</span><span class=p>:</span> <span class=mi>10</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>background-color</span><span class=p>:</span> <span class=mh>#fff</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>box-shadow</span><span class=p>:</span> <span class=mi>0</span> <span class=mi>2</span><span class=kt>px</span> <span class=mi>4</span><span class=kt>px</span> <span class=nb>rgba</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>.</span><span class=nc>logo</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>font-size</span><span class=p>:</span> <span class=mi>24</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>font-weight</span><span class=p>:</span> <span class=kc>bold</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>.</span><span class=nc>user-info</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>display</span><span class=p>:</span> <span class=kc>flex</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>align-items</span><span class=p>:</span> <span class=kc>center</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>.</span><span class=nc>user-info</span> <span class=p>.</span><span class=nc>username</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>margin-right</span><span class=p>:</span> <span class=mi>10</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>.</span><span class=nc>logout-link</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>margin</span><span class=p>:</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>display</span><span class=p>:</span> <span class=kc>flex</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>align-items</span><span class=p>:</span> <span class=kc>center</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>color</span><span class=p>:</span> <span class=mh>#4CAF50</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>text-decoration</span><span class=p>:</span> <span class=kc>none</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>h1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>color</span><span class=p>:</span> <span class=mh>#333</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>text-align</span><span class=p>:</span> <span class=kc>center</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>form</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>max-width</span><span class=p>:</span> <span class=mi>400</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>margin</span><span class=p>:</span> <span class=mi>0</span> <span class=kc>auto</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>padding</span><span class=p>:</span> <span class=mi>20</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>background-color</span><span class=p>:</span> <span class=mh>#fff</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>border-radius</span><span class=p>:</span> <span class=mi>5</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>box-shadow</span><span class=p>:</span> <span class=mi>0</span> <span class=mi>0</span> <span class=mi>10</span><span class=kt>px</span> <span class=nb>rgba</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>label</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>display</span><span class=p>:</span> <span class=kc>block</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>margin-bottom</span><span class=p>:</span> <span class=mi>10</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>font-weight</span><span class=p>:</span> <span class=kc>bold</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>input</span><span class=o>[</span><span class=nt>type</span><span class=o>=</span><span class=s2>&#34;text&#34;</span><span class=o>],</span>
</span></span><span class=line><span class=cl><span class=nt>input</span><span class=o>[</span><span class=nt>type</span><span class=o>=</span><span class=s2>&#34;password&#34;</span><span class=o>]</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>width</span><span class=p>:</span> <span class=mi>94</span><span class=kt>%</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>padding</span><span class=p>:</span> <span class=mi>10</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>border</span><span class=p>:</span> <span class=mi>1</span><span class=kt>px</span> <span class=kc>solid</span> <span class=mh>#ccc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>border-radius</span><span class=p>:</span> <span class=mi>3</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>button</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>display</span><span class=p>:</span> <span class=kc>block</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>width</span><span class=p>:</span> <span class=mi>100</span><span class=kt>%</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>padding</span><span class=p>:</span> <span class=mi>10</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>margin-top</span><span class=p>:</span> <span class=mi>10</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>background-color</span><span class=p>:</span> <span class=mh>#4CAF50</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>color</span><span class=p>:</span> <span class=mh>#fff</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>border</span><span class=p>:</span> <span class=kc>none</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>border-radius</span><span class=p>:</span> <span class=mi>3</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>cursor</span><span class=p>:</span> <span class=kc>pointer</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>h2</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>margin-top</span><span class=p>:</span> <span class=mi>20</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>font-size</span><span class=p>:</span> <span class=mi>18</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>text-align</span><span class=p>:</span> <span class=kc>center</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>a</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>display</span><span class=p>:</span> <span class=kc>block</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>text-align</span><span class=p>:</span> <span class=n>cente</span><span class=err>#</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>​ 当用户点击这个链接，就会带着在webA中的登录信息（cookie）去访问webB，构建这个webB的黑客就可以获取到用户B的cookie信息，并且向webA发送请求转账的请求，就可以绕过服务器的验证达到冒充用户去进行转账操作。</p><h2 id=实现难点>实现难点<a hidden class=anchor aria-hidden=true href=#实现难点>#</a></h2><p>webA需要具备登录登出、转账、转账时需要token进行验证等必备功能；</p><p>webB需要具备使用用户的cookie数据向webA发送转账的请求，而不仅仅是在本地直接操作数据库实现修改数据；</p><p>数据库中需要存放用户ID、用户密码、用户的cookie、账户余额等信息；</p><p>对于cookie数据的保存、设计、更新策略。</p><h2 id=实验过程-1>实验过程<a hidden class=anchor aria-hidden=true href=#实验过程-1>#</a></h2><p><img loading=lazy src=https://raw.githubusercontent.com/sirius2alpha/Typora-pics/master/2023/05/upgit_20230523_1684808860.png alt=CSRF></p><h3 id=数据库的设计>数据库的设计<a hidden class=anchor aria-hidden=true href=#数据库的设计>#</a></h3><p>​ 数据库中主要包含"id&rdquo;, &ldquo;pwd&rdquo;, &ldquo;cookie&rdquo;, &ldquo;balance"字段，id是他们的登陆账户名，pwd是登陆密码，cookie表示他们的用户安全令牌，当转账的时候需要进行验证，balance表示账户余额。通过数据生成出一批用户。</p><p>​ 其中hacker代表黑客，其他的都是普通用户。</p><p><img loading=lazy src=https://raw.githubusercontent.com/sirius2alpha/Typora-pics/master/2023/05/upgit_20230524_1684897323.png alt=image-20230524110159461></p><h3 id=验证weba功能的完整性>验证webA功能的完整性<a hidden class=anchor aria-hidden=true href=#验证weba功能的完整性>#</a></h3><p>​ webA从服务器启动之后，运行在本地的5000端口上，进行访问之后会出现用户的登陆界面，输入在数据库中注册的用户名和密码进行登录。<img loading=lazy src=https://raw.githubusercontent.com/sirius2alpha/Typora-pics/master/2023/05/upgit_20230524_1684897513.png alt=image-20230524110512901></p><p>​ 登录成功之后会进入到DoggyCoin转账中心，在网站左上角显示当前的登陆用户名和退出登录返回登录页面的按钮，中间的form表单就是正常进行转账操作的地方，输入正确的转账ID和合法的转账金额之后就能够进行转账操作。</p><p><img loading=lazy src=https://raw.githubusercontent.com/sirius2alpha/Typora-pics/master/2023/05/upgit_20230524_1684897762.png alt=image-20230524110921459></p><p><img loading=lazy src=https://raw.githubusercontent.com/sirius2alpha/Typora-pics/master/2023/05/upgit_20230524_1684898021.png alt=image-20230524111341249></p><p><img loading=lazy src=https://raw.githubusercontent.com/sirius2alpha/Typora-pics/master/2023/05/upgit_20230524_1684898080.png alt=image-20230524111439974></p><p>​ 这里也简单的进行了一些对于非法输入的防护，以防止出现服务器内部错误。比如对于转账ID的是否存在，转账金额是否大于0，使用正则表达式匹配转账金额小数点的情况等等。</p><h3 id=进行csrf漏洞的利用攻击>进行CSRF漏洞的利用攻击。<a hidden class=anchor aria-hidden=true href=#进行csrf漏洞的利用攻击>#</a></h3><p>​ 当用户在登录webA的时候，服务器根据user1的id和登陆时间在后台生成一个md5摘要作为user1的cookie，存储在数据库中并且返回给user。</p><p><img loading=lazy src=https://raw.githubusercontent.com/sirius2alpha/Typora-pics/master/2023/05/upgit_20230524_1684898353.png alt=image-20230524111913178></p><p>​ 在webA上有一个诈骗链接，就是在转账表单下方的绿色链接“一般人都不知道的DoggyCoin转账技巧！特殊转账技巧转一送一！”，这个就是模拟的一个网页上的弹窗或者是通过电子邮件等方式，诱使用户点击从当前网页转到另外一个网页上，该链接的HTML为：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;http://127.0.0.1:5001?user_id={{ user_id }}&amp;user_token={{ user_token }}&#34;</span><span class=p>&gt;</span>一般人都不知道的DoggyCoin转账技巧！特殊转账技巧转一送一！<span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>​ 当用户点击链接之后就会带着当前网站上的cookie信息去访问webB，而webB的后台就从这个链接中获取到用户的user_id和user_token信息，就可以进行转账的操作了，就自动地从当前用户向hacker账户中转账100</p><p><img loading=lazy src=https://raw.githubusercontent.com/sirius2alpha/Typora-pics/master/2023/05/upgit_20230524_1684898931.png alt=image-20230524112851120></p><p>​ webB是运行在本地的5001端口上的，当直接访问127.0.0.1:5001的时候，由于没有进行user_id和user_token的转发，所以在webB上无法得到用户的信息，也就不能够进行CSRF攻击。</p><p><img loading=lazy src=https://raw.githubusercontent.com/sirius2alpha/Typora-pics/master/2023/05/upgit_20230524_1684899340.png alt=image-20230524113540728></p><h2 id=防护策略>防护策略<a hidden class=anchor aria-hidden=true href=#防护策略>#</a></h2><p>在防御CSRF（Cross-Site Request Forgery）攻击时，验证HTTP Referer字段是一种常见的方法之一。HTTP Referer字段用于指示请求的源头，即告诉服务器该请求是从哪个页面发起的。通过验证HTTP Referer字段，可以确保请求来源于预期的页面，从而减少CSRF攻击的风险。</p><p>要实现验证HTTP Referer字段的防御措施，可以按照以下步骤进行：</p><ol><li>在服务器端验证：当服务器接收到请求时，首先检查HTTP头部中的Referer字段。该字段包含了请求的来源页面的URL。服务器可以通过比较Referer字段的值与预期的来源页面的URL进行验证。如果Referer字段的值与预期不符，服务器可以拒绝该请求。</li><li>验证来源页面的域名：为了增加安全性，可以进一步验证Referer字段中的来源页面域名。服务器可以检查Referer字段中的域名与当前请求的域名是否一致。这可以防止攻击者通过篡改Referer字段来绕过验证。</li><li>考虑Referer字段的可靠性：需要注意的是，Referer字段并非百分之百可靠，因为它可以被篡改或者被一些浏览器或代理程序禁用。因此，验证Referer字段应该作为综合的安全策略的一部分，而不是单一的依赖点。</li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://sirius1y.top/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/>网络安全</a></li><li><a href=https://sirius1y.top/tags/csrf/>Csrf</a></li></ul><nav class=paginav><a class=prev href=https://sirius1y.top/posts/notes/notes/note-go/><span class=title>« Prev</span><br><span>Go学习笔记</span>
</a><a class=next href=https://sirius1y.top/posts/notes/security/stack_overflow-attack/><span class=title>Next »</span><br><span>栈溢出攻击</span></a></nav></footer><script>function createGiscusScript(e){const t=document.createElement("script");Object.entries(e).forEach(([e,n])=>t.setAttribute(e,n)),document.querySelector("article").appendChild(t);const n=document.querySelector('label[for="switch_default"]');n&&n.addEventListener("click",function(){const e=document.body.classList.contains("dark")?"transparent_dark":"light";t.setAttribute("data-theme",e),sendMessage({setConfig:{theme:e}})})}function sendMessage(e){const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")}document.addEventListener("DOMContentLoaded",function(){const e={src:"https://giscus.app/client.js","data-repo":"yunyit/yunyit.github.io","data-repo-id":"R_kgDOKqkPYw","data-category":"Comments","data-category-id":"DIC_kwDOKqkPY84CceDi","data-mapping":"url","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"top","data-lang":"en",crossorigin:"anonymous",async:""};e["data-theme"]=document.body.classList.contains("dark")?"transparent_dark":"light",createGiscusScript(e);const t=new MutationObserver(()=>{const e=document.body.classList.contains("dark")?"transparent_dark":"light";sendMessage({setConfig:{theme:e}})});t.observe(document.body,{attributes:!0,attributeFilter:["class"]})})</script></article></main><footer class=footer><span><a href=https://us.umami.is/websites/5e6ac0c1-e2b2-4d0f-9542-b79ac2cf89c4 rel="noopener noreferrer" target=_blank>Analysis</a>
</span>|
<script defer src=https://cloud.umami.is/script.js data-website-id=5e6ac0c1-e2b2-4d0f-9542-b79ac2cf89c4></script><span><a href=https://beian.miit.gov.cn/ target=_blank>渝ICP备2024018631号</a>
</span>|
<span>&copy; 2025 <a href=https://sirius1y.top/>Sirius' Blog</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>