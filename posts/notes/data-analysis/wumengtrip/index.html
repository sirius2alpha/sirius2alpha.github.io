<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>全国大学生市场调研大赛-数据分析 | Sirius' Blog</title>
<meta name=keywords content="数据分析,聚类,关联规则,决策树,因子分析,灰色关联,孤立森林,随机森林"><meta name=description content="记录在正大杯中使用到的一些数据分析思路方法"><meta name=author content="sirius1y"><link rel=canonical href=https://sirius1y.top/posts/notes/data-analysis/wumengtrip/><link crossorigin=anonymous href=/assets/css/stylesheet.3551607c8eb1ef998f0b6c81d22f9f03dd2c3b8ecaf983e42c023e8d41e39f66.css integrity="sha256-NVFgfI6x75mPC2yB0i+fA90sO47K+YPkLAI+jUHjn2Y=" rel="preload stylesheet" as=style><link rel=icon href=https://sirius1y.top/images/icon.png><link rel=icon type=image/png sizes=16x16 href=https://sirius1y.top/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://sirius1y.top/favicon-32x32.png><link rel=apple-touch-icon href=https://sirius1y.top/apple-touch-icon.png><link rel=mask-icon href=https://sirius1y.top/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://sirius1y.top/posts/notes/data-analysis/wumengtrip/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="全国大学生市场调研大赛-数据分析"><meta property="og:description" content="记录在正大杯中使用到的一些数据分析思路方法"><meta property="og:type" content="article"><meta property="og:url" content="https://sirius1y.top/posts/notes/data-analysis/wumengtrip/"><meta property="og:image" content="https://sirius1y.top/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-03-21T00:00:00+00:00"><meta property="article:modified_time" content="2024-03-21T00:00:00+00:00"><meta property="og:site_name" content="Sirius' Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://sirius1y.top/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="全国大学生市场调研大赛-数据分析"><meta name=twitter:description content="记录在正大杯中使用到的一些数据分析思路方法"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://sirius1y.top/posts/"},{"@type":"ListItem","position":2,"name":"全国大学生市场调研大赛-数据分析","item":"https://sirius1y.top/posts/notes/data-analysis/wumengtrip/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"全国大学生市场调研大赛-数据分析","name":"全国大学生市场调研大赛-数据分析","description":"记录在正大杯中使用到的一些数据分析思路方法","keywords":["数据分析","聚类","关联规则","决策树","因子分析","灰色关联","孤立森林","随机森林"],"articleBody":"数据的预处理 删除答题时间小于1分钟的 对异常数据进行一些修改 检查有没有重复的问卷 保留研究所需要的列 处理公共题目缺失值 把数据分为总数据df，来过游客的数据df_gone，没有来过游客的数据df_not_gone，所有原始信息保留 对于df_gone和df_not_gone分别应用孤立森林清洗异常问卷 得到最后的数据集df, df_gone, df_not_gone import pandas as pd df = pd.read_csv('乌蒙大草原旅游问卷调查_final.csv') print(df.shape) df.head() 这两段代码主要是排除答题时间小于60s的问卷，不过问卷网上可以直接进行筛选\n# 先把答题时间转换为时间格式 def convert_to_seconds(time_str): if '分' in time_str: minutes, seconds = time_str[:-1].split('分') return int(minutes) * 60 + int(seconds) else: return int(time_str[:-1]) df['答题时长'] = df['答题时长'].astype(str) df['答题时长'] = pd.to_timedelta(df['答题时长'].apply(convert_to_seconds), unit='s') # 删除答题时间小于1分钟的数据 df = df[df['答题时长'] \u003e '00:01:00'] print(df.shape) df.head() 针对Q2年龄的一些数据问题进行处理\nimport seaborn as sns import matplotlib.pyplot as plt # 查看Q2有没有非数字的数据 df['Q2'].unique() # 修改数据 df['Q2'] = df['Q2'].replace('1995', 29) df['Q2'] = df['Q2'].replace('50\\n\\n50', '50') df['Q2'].unique() df['Q2'] = pd.to_numeric(df['Q2'], errors='coerce') print(df['Q2'].dtypes) 这里用使用 pandas 的 duplicated 函数来找出重复的行\n# 检查df中是否有重复的行 df_duplicates = df.duplicated().sum() print(f\"df中有{df_duplicates}行重复的数据。\") # 列名列表 columns = ['Q1', 'Q2', 'Q3', 'Q3|open', 'Q4', 'Q5', 'Q6|1|open', 'Q6|2|open', 'Q6|3|open', 'Q7|1', 'Q7|4', 'Q7|2', 'Q7|3', 'Q7|5', 'Q7|6', 'Q8', 'Q9', 'Q10', 'Q11', 'Q12', 'Q13', 'Q14', 'Q14|open', 'Q15', 'Q16|6', 'Q16|1', 'Q16|2', 'Q16|3', 'Q16|7', 'Q16|4', 'Q16|10', 'Q16|11', 'Q16|9', 'Q16|9|open', 'Q17', 'Q18', 'Q19', 'Q20', 'Q21|R1', 'Q21|R2', 'Q21|R3', 'Q21|R4', 'Q21|R5', 'Q22|1', 'Q23', 'Q24|R1', 'Q24|R2', 'Q24|R3', 'Q24|R4', 'Q24|R5', 'Q24|R6', 'Q24|R7', 'Q24|R8', 'Q24|R9', 'Q24|R10', 'Q24|R11', 'Q24|R12', 'Q24|R13', 'Q24|R14', 'Q24|R18', 'Q24|R15', 'Q24|R16', 'Q24|R17', 'Q25|R5', 'Q25|R8', 'Q25|R10', 'Q25|R13', 'Q25|R14', 'Q25|R15', 'Q25|R16', 'Q25|R17', 'Q25|R18', 'Q26|1', 'Q27|1', 'Q28|1', 'Q28|23', 'Q28|21', 'Q28|22', 'Q28|24', 'Q28|25', 'Q28|4', 'Q28|2', 'Q28|26', 'Q28|27', 'Q28|28', 'Q28|29', 'Q28|35', 'Q28|34', 'Q28|34|open', 'Q29|R1', 'Q29|R2', 'Q29|R3', 'Q29|R4', 'Q30|R1', 'Q30|R2', 'Q30|R3', 'Q30|R4', 'Q30|R5', 'Q30|R6', 'Q31|R1', 'Q31|R2', 'Q31|R8', 'Q31|R4', 'Q31|R7', 'Q31|R9', 'Q31|R6', 'Q31|R5', 'Q32|R3', 'Q32|R7', 'Q32|R4', 'Q32|R5', 'Q32|R1', 'Q32|R2', 'Q32|R6', 'Q33|R10', 'Q33|R12', 'Q33|R11', 'Q33|R4', 'Q33|R5', 'Q33|R1', 'Q33|R8', 'Q33|R7', 'Q34', 'IP地址'] # 找出重复的行 duplicates = df.duplicated(subset=columns) # 只保留没有重复的行 df = df[~duplicates] # 打印数据的形状 print(df.shape) 去除不关心的列\n答题序号\t来源 开始时间\t提交时间\t答题时长\tIP省份\tIP城市\tIP地址\t浏览器\t操作系统\ncolumns_to_drop = ['答题序号', '来源', '开始时间', '提交时间', '答题时长', 'IP省份', 'IP城市', 'IP地址', '浏览器', '操作系统'] df = df.drop(columns_to_drop, axis=1) print(df.shape) df.head() 检查公共题目有没有缺失值 公共题目：‘Q1’, ‘Q2’, ‘Q3’, ‘Q3|open’, ‘Q4’, ‘Q5’, ‘Q6|1|open’, ‘Q6|2|open’, ‘Q6|3|open’, ‘Q7|1’, ‘Q7|4’, ‘Q7|2’, ‘Q7|3’, ‘Q7|5’, ‘Q7|6’, ‘Q8’, ‘Q9’, ‘Q10’, ‘Q11’, ‘Q12’, ‘Q13’, ‘Q14’, ‘Q14|open’, ‘Q15’, ‘Q16|6’, ‘Q16|1’, ‘Q16|2’, ‘Q16|3’, ‘Q16|7’, ‘Q16|4’, ‘Q16|10’, ‘Q16|11’, ‘Q16|9’, ‘Q16|9|open’, ‘Q17’,Q30|R1,Q30|R2,Q30|R3,Q30|R4,Q30|R5,Q30|R6,Q33|R10,Q33|R12,Q33|R11,Q33|R4,Q33|R5,Q33|R1,Q33|R8,Q33|R7\ncommon_columns = ['Q1', 'Q2', 'Q3', 'Q3|open', 'Q4', 'Q5', 'Q6|1|open', 'Q6|2|open', 'Q6|3|open', 'Q7|1', 'Q7|4', 'Q7|2', 'Q7|3', 'Q7|5', 'Q7|6', 'Q8', 'Q9', 'Q10', 'Q11', 'Q12', 'Q13', 'Q14', 'Q14|open', 'Q15', 'Q16|6', 'Q16|1', 'Q16|2', 'Q16|3', 'Q16|7', 'Q16|4', 'Q16|10', 'Q16|11', 'Q16|9', 'Q16|9|open', 'Q17', 'Q30|R1', 'Q30|R2', 'Q30|R3', 'Q30|R4', 'Q30|R5', 'Q30|R6', 'Q33|R10', 'Q33|R12', 'Q33|R11', 'Q33|R4', 'Q33|R5', 'Q33|R1', 'Q33|R8', 'Q33|R7'] missing_values = df[common_columns].isnull().any() print(missing_values) missing_rows = df[df['Q2'].isnull()] print(missing_rows) 依照Q17的选项1（去过），2（没去过）把数据分为去过的和没有去过的，同时保留原始数据\n# 依照Q17的选项1（去过），2（没去过）把数据分为去过的和没有去过的，同时保留原始数据 print(df['Q17'].value_counts()) # 去过的数据 df_gone = df[df['Q17'] == 1 ] # 没去过的数据 df_not_gone = df[df['Q17'] == 2] print(\"-\"*100) print(\"df_gone shape\"+str(df_gone.shape)) print(\"df_not_gone shape\"+str(df_not_gone.shape)) 孤立森林 尝试使用孤立森林找出异常的问卷数据，并删除异常数据\n# 使用孤立森林算法检测异常值 from sklearn.ensemble import IsolationForest # 对于去过的 # 屏蔽开放性问题 df_gone_IsolationForest = df_gone.drop(['Q3|open', 'Q6|1|open', 'Q6|2|open', 'Q6|3|open', 'Q14|open', 'Q16|9|open', 'Q28|34|open','Q34'], axis=1) print(\"df_gone_IsolationForest shape\"+str(df_gone_IsolationForest.shape)) # 屏蔽没有去过的问题，会出现nan df_gone_IsolationForest = df_gone_IsolationForest.drop(['Q29|R1','Q29|R2','Q29|R3','Q29|R4'], axis=1) print(\"df_gone_IsolationForest shape\"+str(df_gone_IsolationForest.shape)) # 使用中位数填充数值列的空值 for col in df_gone_IsolationForest.columns: if df_gone_IsolationForest[col].dtype == 'int64' or df_gone_IsolationForest[col].dtype == 'float64': df_gone_IsolationForest[col] = df_gone_IsolationForest[col].fillna(df[col].median()) # 使用最常见的值填充类别列的空值 for col in df_gone_IsolationForest.columns: if df_gone_IsolationForest[col].dtype == 'object': df_gone_IsolationForest[col] = df_gone_IsolationForest[col].fillna(df_gone_IsolationForest[col].mode()[0]) # 对于没有去过的 # 屏蔽开放性问题 df_not_gone_IsolationForest = df_not_gone.drop(['Q3|open', 'Q6|1|open', 'Q6|2|open', 'Q6|3|open', 'Q14|open', 'Q16|9|open', 'Q28|34|open','Q34',], axis=1) print(\"df_not_gone_IsolationForest shape\"+str(df_not_gone_IsolationForest.shape)) # 屏蔽去过的问题，会出现nan columns_to_drop_1 = ['Q19','Q20','Q21|R1','Q21|R2','Q21|R3','Q21|R4','Q21|R5'] columns_to_drop_2 = ['Q24|R1', 'Q24|R2', 'Q24|R3', 'Q24|R4', 'Q24|R5', 'Q24|R6', 'Q24|R7', 'Q24|R8', 'Q24|R9', 'Q24|R10', 'Q24|R11', 'Q24|R12', 'Q24|R13', 'Q24|R14', 'Q24|R18', 'Q24|R15', 'Q24|R16', 'Q24|R17'] columns_to_drop_3 = ['Q25|R5', 'Q25|R8', 'Q25|R10', 'Q25|R13', 'Q25|R14', 'Q25|R15', 'Q25|R16', 'Q25|R17', 'Q25|R18', 'Q26|1', 'Q27|1'] columns_to_drop_4 = ['Q28|1', 'Q28|23', 'Q28|21', 'Q28|22', 'Q28|24', 'Q28|25', 'Q28|4', 'Q28|2', 'Q28|26', 'Q28|27', 'Q28|28', 'Q28|29', 'Q28|35', 'Q28|34'] columns_to_drop_5 = ['Q31|R1', 'Q31|R2', 'Q31|R8', 'Q31|R4', 'Q31|R7', 'Q31|R9', 'Q31|R6', 'Q31|R5', 'Q32|R3', 'Q32|R7', 'Q32|R4', 'Q32|R5', 'Q32|R1', 'Q32|R2', 'Q32|R6'] columns_to_drop = columns_to_drop_1 + columns_to_drop_2 + columns_to_drop_3 + columns_to_drop_4 + columns_to_drop_5 df_not_gone_IsolationForest = df_not_gone_IsolationForest.drop(columns_to_drop, axis=1) print(\"df_not_gone_IsolationForest shape\"+str(df_not_gone_IsolationForest.shape)) # 使用中位数填充数值列的空值 for col in df_not_gone_IsolationForest.columns: if df_not_gone_IsolationForest[col].dtype == 'int64' or df_not_gone_IsolationForest[col].dtype == 'float64': df_not_gone_IsolationForest[col] = df_not_gone_IsolationForest[col].fillna(df[col].median()) # 使用最常见的值填充类别列的空值 for col in df_not_gone_IsolationForest.columns: if df_not_gone_IsolationForest[col].dtype == 'object': df_not_gone_IsolationForest[col] = df_not_gone_IsolationForest[col].fillna(df_not_gone_IsolationForest[col].mode()[0]) print(df_gone_IsolationForest.head(100)) print(df_not_gone_IsolationForest.head(100)) X = df_gone_IsolationForest.values Y = df_not_gone_IsolationForest.values # 创建孤立森林模型，contamination参数表示你预计的异常点的比例 clf_X = IsolationForest(contamination=0.01) clf_Y = IsolationForest(contamination=0.01) # 训练模型 clf_X.fit(X) clf_Y.fit(Y) # 预测异常点，返回1表示正常点，-1表示异常点 pred_X = clf_X.predict(X) pred_Y = clf_Y.predict(Y) # 将预测结果添加到数据框中 df_gone_IsolationForest['anomaly'] = pred_X df_not_gone_IsolationForest['anomaly'] = pred_Y # 打印出预测结果 print(\"-\"*100+\"\\n去过的数据异常值预测结果：\\n\") print(df_gone_IsolationForest['anomaly'].value_counts()) print(\"-\"*100+\"\\n异常数据：\\n\") print(df_gone_IsolationForest[df_gone_IsolationForest['anomaly'] == -1]) print(\"-\"*100+\"\\n没有去过的数据异常值预测结果：\\n\") print(df_not_gone_IsolationForest['anomaly'].value_counts()) print(\"-\"*100+\"\\n异常数据：\\n\") print(df_not_gone_IsolationForest[df_not_gone_IsolationForest['anomaly'] == -1]) # 在原来的df上删除异常值，先找到异常值的序号 print(\"删除异常值前df的形状\"+str(df.shape)) df = df.drop(df_gone_IsolationForest[df_gone_IsolationForest['anomaly'] == -1].index) df = df.drop(df_not_gone_IsolationForest[df_not_gone_IsolationForest['anomaly'] == -1].index) print(\"删除异常值后df的形状\"+str(df.shape)) # 在df_gone和df_not_gone上删除异常值 print(\"删除异常值前df_gone的形状\"+str(df_gone.shape)) df_gone = df_gone.drop(df_gone_IsolationForest[df_gone_IsolationForest['anomaly'] == -1].index) print(\"删除异常值后df_gone的形状\"+str(df_gone.shape)) print(\"删除异常值前df_not_gone的形状\"+str(df_not_gone.shape)) df_not_gone = df_not_gone.drop(df_not_gone_IsolationForest[df_not_gone_IsolationForest['anomaly'] == -1].index) print(\"删除异常值后df_not_gone的形状\"+str(df_not_gone.shape)) # 删除异常值 df_gone_IsolationForest = df_gone_IsolationForest[df_gone_IsolationForest['anomaly'] == 1] df_not_gone_IsolationForest = df_not_gone_IsolationForest[df_not_gone_IsolationForest['anomaly'] == 1] 再次检查有没有重复的行\n# 检查df中是否有重复的行 df_duplicates = df.duplicated().sum() print(f\"df中有{df_duplicates}行重复的数据。\") # 检查df_gone中是否有重复的行 df_gone_duplicates = df_gone.duplicated().sum() print(f\"df_gone中有{df_gone_duplicates}行重复的数据。\") # 检查df_not_gone中是否有重复的行 df_not_gone_duplicates = df_not_gone.duplicated().sum() print(f\"df_not_gone中有{df_not_gone_duplicates}行重复的数据。\") 最终数据集 df，全体的数据集 df_gone，去过的游客的数据集 df_not_gone，没有去过的游客数据集 PS:所有的数据都在\nprint(df.shape) df.head() print(df_gone.shape) df_gone.head() print(df_not_gone.shape) df_not_gone.head() 数据分析 对所有游客\n基本游客画像 Q1-Q16\n[未来打造项目的喜爱程度] Q30\n聚类方法：\nk-prototypes\n感觉对于分类的效果不是很好，另外地理位置信息因为分成了三列，所以在聚类之后会出现不匹配的现象； 使用肘部图确定的n=6；使用轮廓系数确定n=1；\n基于密度聚类DBSCAN\n对去过的游客进行分析\n游玩乌蒙大草原的基本情况:Q18 Q19 Q20\n因子分析 Q21 （交给wyx了） 摆渡车 Q22 Q23 结构方程 Q24 Q25 (交给wyx了) 再次游玩意愿 Q26\n关联分析[推荐意愿] Q27 Q28 [盘州特产、非遗文化] Q31 Q32 [改进建议] Q34 针对没有去过的游客\n决策树[未前往原因] Q29 结构方程 结构方程模型（Structural Equation Modeling, SEM）是一种复杂的统计分析方法，用于研究变量之间的因果关系。它能够同时处理测量误差和多变量之间的关系，非常适用于社会科学、行为科学、营销研究、教育研究等领域。\n基础知识 需要的数据类型\n量表数据：SEM通常需要量表数据，即通过问卷调查收集的、用于测量潜在变量（如态度、满意度、感知质量等）的多个观察指标。 连续数据：SEM分析通常假定数据是连续的，特别是当使用最大似然估计方法时。 正态分布的数据：SEM的某些估计方法（如最大似然估计）要求数据近似正态分布。 作用\n因果关系分析：SEM允许研究者构建和测试变量之间的因果关系模型。 潜在变量建模：它可以用来测量不易直接观察的潜在变量，并分析这些潜在变量之间的关系。 同时测试多个假设：SEM能够在单一模型中同时测试多个假设，提供全面的分析视角。 实现方法\n协方差基础的SEM（如LISREL，AMOS）：通过构建协方差矩阵并使用最大似然估计或其他方法来估计模型参数。 基于方差的SEM（如PLS-SEM）：主要关注构建模型的预测能力，适用于理论发展阶段较早、样本较小或数据分布假设不严格的情况。 聚类分析 基础知识 方法分类 聚类分析是一种无监督学习方法，旨在将数据集中的对象分组成若干个簇，使得同一簇内的对象相似度较高，而不同簇内的对象相似度较低。它在市场细分、社会网络分析、生物信息学、图像分割等领域有广泛应用。根据聚类的方法和原理，主要可以分为以下几类：\n划分方法：这种方法将数据集划分成若干个非重叠的簇，使得每个数据对象恰好属于一个簇。最著名的划分方法是K-均值聚类（K-means clustering），它通过迭代地将数据点分配给最近的簇中心，然后更新簇中心，直到满足停止条件。\n层次方法：层次聚类方法根据对象之间的相似性逐渐合并或分裂簇。它们可以是凝聚的（自底向上），从每个对象作为单个簇开始，逐步合并到一个全体簇；或是分裂的（自顶向下），从所有对象组成一个簇开始，逐步分裂成更小的簇。层次方法的一个优点是可以形成簇的层次结构，非常适合解释性分析。\n基于密度的方法：这些方法根据数据空间的密度分布来形成簇。它们能够识别任意形状的簇，并且对噪声和孤立点有良好的鲁棒性。著名的算法包括DBSCAN（Density-Based Spatial Clustering of Applications with Noise）和OPTICS（Ordering Points To Identify the Clustering Structure）。\n基于网格的方法：网格聚类算法将数据空间划分为有限数量的单元，形成一个网格结构，并在这个结构上进行聚类。这些方法的优点是计算效率高，特别适合处理大数据集。STING（Statistical Information Grid）和WaveCluster是两种典型的基于网格的聚类方法。\n基于模型的方法：这些方法基于统计模型将数据分配给簇，最常见的是基于高斯混合模型（Gaussian Mixture Models, GMM）的聚类。这类方法的优点是可以提供丰富的统计信息，对簇的形状和大小有更灵活的假设。\n比较 K-prototypes \u0026 K-means K-原型（K-prototypes）聚类算法是K-均值（K-means）聚类算法的扩展，专门设计来处理同时包含数值数据和分类数据的情况。这两种算法的主要区别在于它们处理数据类型的方式和计算簇中心（或称为原型）的方法。\nK-means聚类算法\n数据类型：K-means主要适用于数值型数据。它通过计算数据点与簇中心之间的欧氏距离来划分簇，以最小化簇内距离的总和。 簇中心：K-means的簇中心是簇内所有点的均值。 限制：K-means对分类数据处理不佳，因为分类数据（如性别、职业等）没有自然的数值中心，且不能通过常规的欧氏距离来衡量相似性。 K-原型聚类算法\n数据类型：K-原型算法可以同时处理数值数据和分类数据。这使得它非常适用于现实世界的数据集，这些数据集通常包含这两种类型的数据。 簇中心和距离计算：K-原型算法通过结合数值数据的均值和分类数据的众数来计算簇中心。同时，它使用特殊的距离度量来计算数值数据和分类数据的相似性，常见的方法是将数值数据的欧式距离和分类数据的汉明距离（Hamming distance）进行组合。 优势：K-原型能够处理混合数据类型，使其更适合多种数据集，尤其是那些同时包含数值和分类属性的数据集。 应用场景对比\n当数据集仅包含数值型数据时，K-means是一个简单且有效的选择。 当数据集包含数值数据和分类数据时，K-原型算法是更合适的选择，因为它能够同时处理这两种数据类型，并考虑它们在数据集中的相互作用。 总结来说，K-原型聚类算法是对K-means的重要补充，它扩展了聚类分析的应用范围，使之能够有效处理更加复杂和多样化的数据集。\nK-Prototypes 聚类：所有游客/来过的游客画像 总的题目： ‘Q1’, ‘Q2’, ‘Q3’, ‘Q3|open’, ‘Q4’, ‘Q5’, ‘Q6|1|open’, ‘Q6|2|open’, ‘Q6|3|open’, ‘Q7|1’, ‘Q7|4’, ‘Q7|2’, ‘Q7|3’, ‘Q7|5’, ‘Q7|6’, ‘Q8’, ‘Q9’, ‘Q10’, ‘Q11’, ‘Q12’, ‘Q13’, ‘Q14’, ‘Q14|open’, ‘Q15’, ‘Q16|6’, ‘Q16|1’, ‘Q16|2’, ‘Q16|3’, ‘Q16|7’, ‘Q16|4’, ‘Q16|10’, ‘Q16|11’, ‘Q16|9’, ‘Q16|9|open’\n对于Q3,Q14,Q16的其他选项对于聚类来说意义不大且不好处理，直接忽略\n确定聚类簇数 使用肘部图确定最佳簇数 # 去过的游客 df_gone from kmodes.kprototypes import KPrototypes import matplotlib.pyplot as plt columns = ['Q1', 'Q2', 'Q3', 'Q4', 'Q5', 'Q7|1', 'Q7|4', 'Q7|2', 'Q7|3', 'Q7|5', 'Q7|6', 'Q8', 'Q9', 'Q10', 'Q11', 'Q12', 'Q13', 'Q14', 'Q15', 'Q19', 'Q20','Q21|R1','Q21|R2','Q21|R3','Q21|R4','Q21|R5'] numerical_columns = ['Q2', 'Q4', 'Q5','Q7|1', 'Q7|4', 'Q7|2', 'Q7|3', 'Q7|5', 'Q7|6'] # 类别型列 categorical_columns = [col for col in columns if col not in numerical_columns] # 将类别型列的索引转换为数字 categorical_columns_indices = [columns.index(col) for col in categorical_columns] costs = [] for n_clusters in range(1, 10): kproto = KPrototypes(n_clusters=n_clusters, init='Cao', verbose=2) kproto.fit_predict(df_gone[columns].values, categorical=categorical_columns_indices) costs.append(kproto.cost_) # 绘制成本随簇数变化的图 plt.plot(range(1, 10), costs, 'o-') plt.title('Elbow Method (visited tourists)') plt.xlabel('Number of clusters') plt.ylabel('Cost') plt.show() 使用轮廓系数确定簇数的方法 # 轮廓图，去过的游客 from kmodes.kprototypes import KPrototypes from sklearn.metrics import silhouette_score import matplotlib.pyplot as plt columns = ['Q1', 'Q2', 'Q3', 'Q4', 'Q5', 'Q7|1', 'Q7|4', 'Q7|2', 'Q7|3', 'Q7|5', 'Q7|6', 'Q8', 'Q9', 'Q10', 'Q11', 'Q12', 'Q13', 'Q14', 'Q15', 'Q19', 'Q20','Q21|R1','Q21|R2','Q21|R3','Q21|R4','Q21|R5'] numerical_columns = ['Q2', 'Q4', 'Q5','Q7|1', 'Q7|4', 'Q7|2', 'Q7|3', 'Q7|5', 'Q7|6'] # 类别型列 categorical_columns = [col for col in columns if col not in numerical_columns] # 将类别型列的索引转换为数字 categorical_columns_indices = [columns.index(col) for col in categorical_columns] silhouette_scores = [] for n_clusters in range(2, 10): # 轮廓系数至少需要2个簇 kproto = KPrototypes(n_clusters=n_clusters, init='Cao', verbose=2) clusters = kproto.fit_predict(df_gone[columns].values, categorical=categorical_columns_indices) score = silhouette_score(df_gone[columns], clusters) silhouette_scores.append(score) # 绘制轮廓系数随簇数变化的图 plt.plot(range(2, 10), silhouette_scores, 'o-') plt.title('Silhouette Method (visited tourists)') plt.xlabel('Number of clusters') plt.ylabel('Silhouette Score') plt.show() 开始聚类 from kmodes.kprototypes import KPrototypes # 加入乌蒙大草原游客的基本信息，只能对已经来过的游客进行聚类 columns = ['Q1', 'Q2', 'Q3', 'Q4', 'Q5', 'Q7|1', 'Q7|4', 'Q7|2', 'Q7|3', 'Q7|5', 'Q7|6', 'Q8', 'Q9', 'Q10', 'Q11', 'Q12', 'Q13', 'Q14', 'Q15', 'Q19', 'Q20','Q21|R1','Q21|R2','Q21|R3','Q21|R4','Q21|R5'] # 数值型列 numerical_columns = ['Q2', 'Q4', 'Q5','Q7|1', 'Q7|4', 'Q7|2', 'Q7|3', 'Q7|5', 'Q7|6'] # 类别型列 categorical_columns = [col for col in columns if col not in numerical_columns] # 将类别型列的索引转换为数字 categorical_columns_indices = [columns.index(col) for col in categorical_columns] # 初始化 K-原型聚类器 kproto = KPrototypes(n_clusters=3, init='Cao', verbose=2) clusters = kproto.fit_predict(df_gone[columns].values, categorical=categorical_columns_indices) # 将聚类结果添加到数据集作为新的特征 df_gone['k-prototypes cluster'] = clusters # 想查看每个簇的中心点 print(kproto.cluster_centroids_) # 查看每个簇的数量 print(df_gone['k-prototypes cluster'].value_counts()) df_gone.head() # 把'k-prototypes cluster'为0的数据保存到csv文件 df_gone[df_gone['k-prototypes cluster'] == 0].to_csv('cluster_0.csv', index=False) 特征选择：通过伪标签进行方差分析和卡方检验 from scipy.stats import f_oneway, chi2_contingency # 对 numerical_columns 进行方差分析 for column in numerical_columns: groups = df_gone.groupby('k-prototypes cluster')[column].apply(list) f_val, p_val = f_oneway(*groups) if p_val \u003c 0.05: print(f'Column: {column}, F-value: {f_val}, p-value: {p_val}. significant.') else: print(f'Column: {column}, F-value: {f_val}, p-value: {p_val}. NO.') # 对 categorical_columns 进行卡方检验 for column in categorical_columns: contingency_table = pd.crosstab(df_gone[column], df_gone['k-prototypes cluster']) chi2, p_val, dof, expected = chi2_contingency(contingency_table) if p_val \u003c 0.05: print(f'Column: {column}, Chi2: {chi2}, p-value: {p_val}. significant.') else: print(f'Column: {column}, Chi2: {chi2}, p-value: {p_val}. NO.') from kmodes.kprototypes import KPrototypes # # 列表中的列名 # columns = ['Q1', 'Q2', 'Q3', 'Q4', 'Q5', 'Q7|1', 'Q7|4', 'Q7|2', 'Q7|3', 'Q7|5', 'Q7|6', 'Q8', 'Q9', 'Q10', 'Q11', 'Q12', 'Q13', 'Q14', 'Q15'] # columns = ['Q2', 'Q4', 'Q5', 'Q8', 'Q10', 'Q11', 'Q12', 'Q13', 'Q14'] # 加入乌蒙大草原游客的基本信息，只能对已经来过的游客进行聚类 columns_again = ['Q4', 'Q5', 'Q7|5', 'Q10', 'Q19'] # # 数值型列 numerical_columns = ['Q4', 'Q5','Q7|5'] # numerical_columns = ['Q2', 'Q4', 'Q5'] # 类别型列 categorical_columns = [col for col in columns_again if col not in numerical_columns] # 将类别型列的索引转换为数字 categorical_columns_indices = [columns_again.index(col) for col in categorical_columns] # 初始化 K-原型聚类器 kproto = KPrototypes(n_clusters=2, init='Cao', verbose=2) # 对所有游客进行聚类 # clusters = kproto.fit_predict(df[columns].values, categorical=categorical_columns_indices) clusters = kproto.fit_predict(df_gone[columns_again].values, categorical=categorical_columns_indices) # 将聚类结果添加到数据集作为新的特征 # df['k-prototypes cluster'] = clusters df_gone['k-prototypes cluster'] = clusters # 想查看每个簇的中心点 print(kproto.cluster_centroids_) # 查看每个簇的数量 # print(df['k-prototypes cluster'].value_counts()) print(df_gone['k-prototypes cluster'].value_counts()) # df.head() df_gone.head() 分布分析 对每个聚类中的：\n数值数据进行最小值、最大值（范围）、平均值、中位数（50%分位数）、四分位数（25%和75%分位数）、标准差的分析； 分类数据进行各个类别的计数和比例 import matplotlib.pyplot as plt import seaborn as sns import pandas as pd df_selected = df_gone df_cluster_1 = df_selected[df_selected['k-prototypes cluster'] == 0] df_cluster_2 = df_selected[df_selected['k-prototypes cluster'] == 1] df_cluster_3 = df_selected[df_selected['k-prototypes cluster'] == 2] clusters_list = [df_cluster_1, df_cluster_2, df_cluster_3] cluster_names = ['人群 1', '人群 2','人群 3'] # 数值数据的描述性统计 desc_stats = [] for i, df_cluster in enumerate(clusters_list): desc_stats.append(df_cluster[numerical_columns].describe()) desc_stats_df = pd.concat(desc_stats, axis=1, keys=cluster_names) print(desc_stats_df) # 分类数据的各个类别的计数和比例 cat_counts = [] for i, df_cluster in enumerate(clusters_list): cat_counts.append(df_cluster[categorical_columns].apply(lambda x: x.value_counts()).T.stack() / df_cluster.shape[0]) cat_counts_df = pd.concat(cat_counts, axis=1, keys=cluster_names) print(cat_counts_df) #################### import matplotlib.pyplot as plt import seaborn as sns import pandas as pd import numpy as np # 设置全局字体 plt.rcParams['font.sans-serif'] = ['SimHei'] # 用来正常显示中文标签 plt.rcParams['axes.unicode_minus'] = False # 用来正常显示负号 # 计算子图的行数和列数 n = len(numerical_columns) ncols = 3 nrows = n // ncols if n % ncols == 0 else n // ncols + 1 # 创建一个大图和子图的数组，每个子图都有自己独立的y轴刻度 fig, axs = plt.subplots(nrows, ncols, figsize=(15, 5*nrows), sharey=False) # 创建一个ExcelWriter对象 with pd.ExcelWriter('output.xlsx') as writer: # 描述性统计的可视化 for idx, question in enumerate(numerical_columns): # 计算子图的位置 row = idx // ncols col = idx % ncols # 创建一个空的数据框来存储所有的簇的数据 all_clusters = pd.DataFrame() for i, df_cluster in enumerate(clusters_list): # 添加一个新的列来标识簇 df_cluster = df_cluster.copy() df_cluster['Cluster'] = f'Cluster {i+1}' all_clusters = pd.concat([all_clusters, df_cluster]) # 在子图上绘制小提琴图，这里将使用各自的数据范围设置y轴刻度 sns.violinplot(x='Cluster', y=question, data=all_clusters, ax=axs[row, col]) axs[row, col].set_title(f'各簇{question}的小提琴图') axs[row, col].set_ylabel('') # 将数据写入Excel文件的一个新工作表 all_clusters.to_excel(writer, sheet_name=question) # 删除多余的子图 if n % ncols != 0: for col in range(n % ncols, ncols): fig.delaxes(axs[nrows-1, col]) plt.tight_layout() plt.show() import matplotlib.pyplot as plt import seaborn as sns import pandas as pd import numpy as np # 设置全局字体 plt.rcParams['font.sans-serif'] = ['SimHei'] # 用来正常显示中文标签 plt.rcParams['axes.unicode_minus'] = False # 用来正常显示负号 # 计算子图的行数和列数 n = len(categorical_columns) ncols = 5 nrows = n // ncols if n % ncols == 0 else n // ncols + 1 # 创建一个大图和子图的数组 fig, axs = plt.subplots(nrows, ncols, figsize=(15, 5*nrows)) # 创建一个ExcelWriter对象 with pd.ExcelWriter('output.xlsx') as writer: # 描述性统计的可视化 for idx, question in enumerate(categorical_columns): # 计算子图的位置 row = idx // ncols col = idx % ncols # 创建一个空的数据框来存储所有的簇的数据 all_clusters = pd.DataFrame() for i, df_cluster in enumerate(clusters_list): # 添加一个新的列来标识簇 df_cluster = df_cluster.copy() df_cluster['Cluster'] = f'Cluster {i+1}' all_clusters = pd.concat([all_clusters, df_cluster], ignore_index=True) # 数据透视以便于绘图，计算每个簇每个分类的数量 pivot_df = all_clusters.pivot_table(index='Cluster', columns=question, aggfunc='size').fillna(0) # 将数量转换为占比 pivot_df_percent = pivot_df.div(pivot_df.sum(axis=1), axis=0) * 100 # 计算占总数的百分比 # 绘制堆叠条形图，展示百分比 pivot_df_percent.plot(kind='bar', stacked=True, ax=axs[row, col], legend=True) axs[row, col].set_title(f'各簇{question}的堆叠条形图') axs[row, col].set_ylabel('百分比 (%)') # 将数据写入Excel文件的一个新工作表 pivot_df_percent.to_excel(writer, sheet_name=question) # 删除多余的子图 if n % ncols != 0: for col in range(n % ncols, ncols): fig.delaxes(axs[nrows-1, col]) plt.tight_layout() plt.show() 聚类结果可视化 使用PCA，t-SNE，UMAP方法进行降维，得到2D和3D的图像，选择效果最好的可视化。\n六合一可视化 from sklearn.decomposition import PCA from sklearn.manifold import TSNE from umap import UMAP import matplotlib.pyplot as plt from mpl_toolkits.mplot3d import Axes3D # 数据 # X = df[columns].values X = df_gone[columns].values # 创建PCA，t-SNE，UMAP对象 pca = PCA(n_components=2) tsne = TSNE(n_components=2) umap = UMAP(n_components=2) # 降维 X_pca = pca.fit_transform(X) X_tsne = tsne.fit_transform(X) X_umap = umap.fit_transform(X) # 创建图形和子图 fig, axs = plt.subplots(3, 2, figsize=(15, 20)) # 绘制二维版本 sc = axs[0, 0].scatter(X_pca[:, 0], X_pca[:, 1], c=clusters, cmap='viridis', alpha=0.5) axs[0, 0].set_title('PCA 2D') fig.colorbar(sc, ax=axs[0, 0], shrink=0.6) sc = axs[1, 0].scatter(X_tsne[:, 0], X_tsne[:, 1], c=clusters, cmap='viridis', alpha=0.5) axs[1, 0].set_title('t-SNE 2D') fig.colorbar(sc, ax=axs[1, 0], shrink=0.6) sc = axs[2, 0].scatter(X_umap[:, 0], X_umap[:, 1], c=clusters, cmap='viridis', alpha=0.5) axs[2, 0].set_title('UMAP 2D') fig.colorbar(sc, ax=axs[2, 0], shrink=0.6) # 创建PCA，t-SNE，UMAP对象 pca = PCA(n_components=3) tsne = TSNE(n_components=3) umap = UMAP(n_components=3) # 降维 X_pca = pca.fit_transform(X) X_tsne = tsne.fit_transform(X) X_umap = umap.fit_transform(X) # 绘制三维版本 axs[0, 1] = fig.add_subplot(3, 2, 2, projection='3d') sc = axs[0, 1].scatter(X_pca[:, 0], X_pca[:, 1], X_pca[:, 2], c=clusters, cmap='viridis', alpha=0.5) axs[0, 1].set_title('PCA 3D') fig.colorbar(sc, ax=axs[0, 1], shrink=0.6, pad=0.2) # 修改的代码 axs[1, 1] = fig.add_subplot(3, 2, 4, projection='3d') sc = axs[1, 1].scatter(X_tsne[:, 0], X_tsne[:, 1], X_tsne[:, 2], c=clusters, cmap='viridis', alpha=0.5) axs[1, 1].set_title('t-SNE 3D') fig.colorbar(sc, ax=axs[1, 1], shrink=0.6, pad=0.2) # 修改的代码 axs[2, 1] = fig.add_subplot(3, 2, 6, projection='3d') sc = axs[2, 1].scatter(X_umap[:, 0], X_umap[:, 1], X_umap[:, 2], c=clusters, cmap='viridis', alpha=0.5) axs[2, 1].set_title('UMAP 3D') fig.colorbar(sc, ax=axs[2, 1], shrink=0.6, pad=0.2) # 修改的代码 # 调整子图之间的间隙 plt.subplots_adjust(wspace=0.5, hspace=0.5) plt.tight_layout() plt.show() PCA主成分降维 from sklearn.decomposition import PCA import matplotlib.pyplot as plt df_selected = df_gone # 使用PCA进行降维 pca = PCA(n_components=2) X_pca = pca.fit_transform(df_selected[columns].values) # 绘制散点图 plt.figure(figsize=(8, 6)) plt.scatter(X_pca[:, 0], X_pca[:, 1], c=clusters, cmap='viridis', alpha=0.5) plt.title('K-Prototypes Clustering (PCA-reduced data)') plt.xlabel('Principal Component 1') plt.ylabel('Principal Component 2') plt.colorbar(label='Cluster') plt.show() PCA主成分降维 3D from sklearn.decomposition import PCA import matplotlib.pyplot as plt from mpl_toolkits.mplot3d import Axes3D df_selected = df_gone # 使用PCA进行降维 pca = PCA(n_components=3) X_pca = pca.fit_transform(df_selected[columns].values) # 创建一个3D图形 fig = plt.figure(figsize=(8, 6)) ax = fig.add_subplot(111, projection='3d') # 绘制散点图 sc = ax.scatter(X_pca[:, 0], X_pca[:, 1], X_pca[:, 2], c=clusters, cmap='viridis', alpha=0.5) plt.title('K-Prototypes Clustering (PCA-reduced data)') ax.set_xlabel('Principal Component 1') ax.set_ylabel('Principal Component 2') ax.set_zlabel('Principal Component 3') fig.colorbar(sc, label='Cluster', pad=0.1) plt.show() df.head() from sklearn.decomposition import PCA import matplotlib.pyplot as plt from mpl_toolkits.mplot3d import Axes3D import imageio import os df_selected = df_gone # 使用PCA进行降维 pca = PCA(n_components=3) X_pca = pca.fit_transform(df_selected[columns].values) # 创建GIF的帧 filenames = [] for azim in range(-90, 90, 2): # 从0度旋转到360度，每次增加10度 # 创建一个3D图形 fig = plt.figure(figsize=(8, 6)) ax = fig.add_subplot(111, projection='3d') # 绘制散点图 sc = ax.scatter(X_pca[:, 0], X_pca[:, 1], X_pca[:, 2], c=clusters, cmap='viridis', alpha=0.5) ax.set_title('K-Prototypes Clustering (PCA-reduced data)') ax.set_xlabel('Principal Component 1') ax.set_ylabel('Principal Component 2') ax.set_zlabel('Principal Component 3') fig.colorbar(sc, label='Cluster', pad=0.1) # 设置视角 ax.view_init(elev=20., azim=azim) # 保存帧 filename = f'frame_{azim}.png' plt.savefig(filename) filenames.append(filename) plt.close(fig) # 关闭图形，防止在notebook中显示 # 使用所有的帧创建一个GIF with imageio.get_writer('mygif.gif', mode='I') as writer: for filename in filenames: image = imageio.imread(filename) writer.append_data(image) # 删除所有的帧 for filename in filenames: os.remove(filename) t-SNE降维 from sklearn.manifold import TSNE import matplotlib.pyplot as plt from mpl_toolkits.mplot3d import Axes3D # 使用t-SNE进行降维 tsne = TSNE(n_components=3) X_tsne = tsne.fit_transform(df[columns].values) # 创建一个3D图形 fig = plt.figure(figsize=(8, 6)) ax = fig.add_subplot(111, projection='3d') # 绘制散点图 sc = ax.scatter(X_tsne[:, 0], X_tsne[:, 1], X_tsne[:, 2], c=clusters, cmap='viridis', alpha=0.5) plt.title('K-Prototypes Clustering') ax.set_xlabel('t-SNE Dimension 1') ax.set_ylabel('t-SNE Dimension 2') ax.set_zlabel('t-SNE Dimension 3') fig.colorbar(sc, label='Cluster') plt.show() df.head() 制作t-SNE gif版本 import numpy as np import matplotlib.pyplot as plt from mpl_toolkits.mplot3d import Axes3D import imageio from sklearn.manifold import TSNE # 初始化t-SNE tsne = TSNE(n_components=3) #, init='random', random_state=0, n_iter=1000, method='exact' # 保存每次迭代的图像 frames = [] for i in range(250, 1000, 50): tsne.n_iter = i X_tsne = tsne.fit_transform(df[columns].values) fig = plt.figure(figsize=(8, 6)) ax = fig.add_subplot(111, projection='3d') scatter = ax.scatter(X_tsne[:, 0], X_tsne[:, 1], X_tsne[:, 2], c=clusters, cmap='viridis', alpha=0.5) ax.set_title(f't-SNE with {i} iterations') ax.set_xlabel('t-SNE Dimension 1') ax.set_ylabel('t-SNE Dimension 2') ax.set_zlabel('t-SNE Dimension 3') fig.colorbar(scatter, label='Cluster') plt.savefig(f'tsne_{i}.png') plt.close(fig) frames.append(imageio.imread(f'tsne_{i}.png')) # 保存为GIF imageio.mimsave('tsne.gif', frames, 'GIF', duration=1) df.head() 使用UMAP降维 import umap import matplotlib.pyplot as plt from mpl_toolkits.mplot3d import Axes3D # 假设df是你的数据框，columns是你想要降维的列 reducer = umap.UMAP(n_components=3, random_state=8) embedding = reducer.fit_transform(df[columns].values) # 创建一个3D图形 fig = plt.figure(figsize=(8, 6)) ax = fig.add_subplot(111, projection='3d') # 绘制散点图 sc = ax.scatter(embedding[:, 0], embedding[:, 1], embedding[:, 2], c=clusters, cmap='viridis', alpha=0.5) plt.title('UMAP projection') ax.set_xlabel('Dimension 1') ax.set_ylabel('Dimension 2') ax.set_zlabel('Dimension 3') fig.colorbar(sc, label='Cluster') # 调整布局 plt.tight_layout() plt.show() df.head() UMAP GIF import umap import matplotlib.pyplot as plt from mpl_toolkits.mplot3d import Axes3D import imageio # 假设df是你的数据框，columns是你想要降维的列 frames = [] for n in range(10, 51, 5): reducer = umap.UMAP(n_components=3, random_state=8, n_neighbors=n) embedding = reducer.fit_transform(df[columns].values) # 创建一个3D图形 fig = plt.figure(figsize=(8, 6)) ax = fig.add_subplot(111, projection='3d') # 绘制散点图 sc = ax.scatter(embedding[:, 0], embedding[:, 1], embedding[:, 2], c=clusters, cmap='viridis', alpha=0.5) plt.title(f'UMAP projection with {n} neighbors') ax.set_xlabel('Dimension 1') ax.set_ylabel('Dimension 2') ax.set_zlabel('Dimension 3') fig.colorbar(sc, label='Cluster') # 调整布局 plt.tight_layout() # 保存图像 plt.savefig(f'umap_{n}.png') plt.close(fig) frames.append(imageio.imread(f'umap_{n}.png')) # 保存为GIF imageio.mimsave('umap.gif', frames, 'GIF', duration=1) df.head() 输出聚类结果 import csv # 聚类中心 centroids = kproto.cluster_centroids_ # show_columns = ['Q2', 'Q4', 'Q5','Q7|1', 'Q7|4', 'Q7|2', 'Q7|3', 'Q7|5', 'Q7|6','Q1', 'Q3', 'Q8', 'Q9', 'Q10', 'Q11', 'Q12', 'Q13', 'Q14', 'Q15', 'Q16|6', 'Q16|1', 'Q16|2', 'Q16|3', 'Q16|7', 'Q16|4', 'Q16|10', 'Q16|11', 'Q16|9'] show_columns = columns # 打开你想要写入的文件 with open('centroids.csv', 'w', newline='') as file: writer = csv.writer(file) # 写入题号作为第一行 writer.writerow(show_columns) # 写入数据 writer.writerows(centroids) # 打印题号和聚类中心 print(\"Question IDs:\") print(show_columns) print(\"Cluster centroids:\") print(centroids) # 聚类标签 labels = kproto.labels_ print(\"Labels of first 10 data points:\") print(labels[:10]) df.head() 对照文本编码 读取centroids.csv匹配structured_questions.json中的题号把对应的单选选项换掉，并添加上题目\n结果在centrios.csv中\nimport csv import json import re # 读取 structured_questions.json 文件 with open('structured_questions.json', 'r') as json_file: structured_questions = json.load(json_file) # 读取 centroids.csv 文件 with open('centroids.csv', 'r') as csv_file: csv_reader = csv.reader(csv_file) data = list(csv_reader) # 先替换选项 for i, row in enumerate(data): if i == 0: continue for j, value in enumerate(row): # 遍历每一列 question_id = data[0][j] # 获取题号，只有单选和填空的格式是Q1这种，可以匹配上 if question_id in structured_questions: # 如果题号在 structured_questions 中 # 替换选项 data[i][j] = structured_questions[question_id]['options'].get(value, value) # 再替换题目 for i, row in enumerate(data): if i == 0: # 指针对第一行替换题目 for j, value in enumerate(row): if value in structured_questions: data[i][j] = value +\" \"+structured_questions[value]['text'] # 对于题目为Q7 | 1这种格式，把Q7替换为text的内容，1替换为options中的内容 # 用正则表达式匹配 if re.match(r\"^Q\\d+\\|\\d+$\", value): question_id, option_id = value.split('|', 1) if question_id in structured_questions: data[i][j] = question_id +\" \"+ structured_questions[question_id]['text'] + \": \" + structured_questions[question_id]['options'][option_id] if i!=0: break # 将更新后的数据写回 centroids.csv 文件 with open('centroids.csv', 'w', newline='') as csv_file: csv_writer = csv.writer(csv_file) csv_writer.writerows(data) df.head() 基于密度聚类 DBSCAN from sklearn.cluster import DBSCAN from sklearn.preprocessing import StandardScaler from sklearn.manifold import TSNE import matplotlib.pyplot as plt import pandas as pd print(df) # 列表中的列名 columns = ['Q1', 'Q2', 'Q3', 'Q4', 'Q5', 'Q7|1', 'Q7|4', 'Q7|2', 'Q7|3', 'Q7|5', 'Q7|6', 'Q8', 'Q9', 'Q10', 'Q11', 'Q12', 'Q13', 'Q14', 'Q15', 'Q16|6', 'Q16|1', 'Q16|2', 'Q16|3', 'Q16|7', 'Q16|4', 'Q16|10', 'Q16|11', 'Q16|9'] # 数值型列 numerical_columns = ['Q2', 'Q4', 'Q5','Q7|1', 'Q7|4', 'Q7|2', 'Q7|3', 'Q7|5', 'Q7|6'] # 对数值型列进行标准化 scaler = StandardScaler() df[numerical_columns] = scaler.fit_transform(df[numerical_columns]) X = df[columns].values # 初始化 DBSCAN 聚类器 dbscan = DBSCAN(eps=4.7, min_samples=7) # 进行聚类 clusters = dbscan.fit_predict(X) # 添加数据标签 df['dbscan cluster'] = clusters # 使用t-SNE进行降维 tsne = TSNE(n_components=2, random_state=42) X_tsne = tsne.fit_transform(X) # 绘制散点图 plt.figure(figsize=(8, 6)) plt.scatter(X_tsne[:, 0], X_tsne[:, 1], c=clusters, cmap='viridis', alpha=0.5) plt.title('t-SNE projection') plt.xlabel('Dimension 1') plt.ylabel('Dimension 2') plt.colorbar(label='Cluster') plt.show() df.head() from sklearn.cluster import DBSCAN from sklearn.preprocessing import StandardScaler from sklearn.manifold import TSNE import matplotlib.pyplot as plt from mpl_toolkits.mplot3d import Axes3D import pandas as pd print(df.columns) # 列表中的列名 columns = ['Q1', 'Q2', 'Q3', 'Q4', 'Q5', 'Q7|1', 'Q7|4', 'Q7|2', 'Q7|3', 'Q7|5', 'Q7|6', 'Q8', 'Q9', 'Q10', 'Q11', 'Q12', 'Q13', 'Q14', 'Q15', 'Q16|6', 'Q16|1', 'Q16|2', 'Q16|3', 'Q16|7', 'Q16|4', 'Q16|10', 'Q16|11', 'Q16|9'] # 数值型列 numerical_columns = ['Q2', 'Q4', 'Q5','Q7|1', 'Q7|4', 'Q7|2', 'Q7|3', 'Q7|5', 'Q7|6'] # 对数值型列进行标准化 scaler = StandardScaler() df[numerical_columns] = scaler.fit_transform(df[numerical_columns]) X = df[columns].values # 初始化 DBSCAN 聚类器 dbscan = DBSCAN(eps=4.7, min_samples=7) # 进行聚类 clusters = dbscan.fit_predict(X) # 使用t-SNE进行降维 tsne = TSNE(n_components=3, random_state=42) X_tsne = tsne.fit_transform(X) # 创建一个3D图形 fig = plt.figure(figsize=(8, 6)) ax = fig.add_subplot(111, projection='3d') # 绘制散点图 sc = ax.scatter(X_tsne[:, 0], X_tsne[:, 1], X_tsne[:, 2], c=clusters, cmap='viridis', alpha=0.5) plt.title('t-SNE projection') ax.set_xlabel('Dimension 1') ax.set_ylabel('Dimension 2') ax.set_zlabel('Dimension 3') fig.colorbar(sc, label='Cluster') plt.show() df.head() 决策树 基础知识 决策树是一种常用的数据挖掘技术，用于分类和回归任务。它通过构造一个树状结构来模拟决策过程。主要的决策树算法包括：\nID3（Iterative Dichotomiser 3）：基于信息增益来选择特征。 C4.5：ID3的改进版，使用增益率来选择特征。 CART（Classification and Regression Trees）：同时支持分类和回归任务，基于基尼不纯度（对于分类）或最小二乘偏差（对于回归）来选择特征。 CHAID（Chi-squared Automatic Interaction Detector）：使用卡方检验来选择最佳特征，可以处理分类变量。 这些方法在不同的情况下各有优势。例如，CART是最常用的算法之一，因为它简单且适用于各种类型的数据。\nCART决策树：决定游客来不来的画像因素分析 针对没有来过的游客，分析他们没有来过的原因\n决策树处理 核心问题是Q29，可以结合游客的基本信息一起分析 Q29|R1,Q29|R2,Q29|R3,Q29|R4\nk-prototypes cluster 之前聚类的结果\nfeature_columns是问卷的一组问题，目标变量是去了还是没有去\nfrom sklearn.model_selection import train_test_split from sklearn.tree import DecisionTreeClassifier from sklearn.metrics import classification_report from sklearn.tree import plot_tree from sklearn.feature_selection import SelectPercentile, chi2 import matplotlib.pyplot as plt # 定义特征和目标变量 feature_columns = ['Q8','Q9','Q10','Q11','Q12','Q13','Q14','Q15'] X_unencoded = df[feature_columns] target_column = df['Q17'] # 对特征进行0-1编码 X_encoded = pd.get_dummies(X_unencoded, columns=feature_columns) # 对目标变量进行0-1编码 y_encoded = target_column # 特征选择 selector = SelectPercentile(chi2, percentile=10) X_new = selector.fit_transform(X_encoded, y_encoded) # 划分训练集和测试集 X_train, X_test, y_train, y_test = train_test_split(X_new, y_encoded, test_size=0.1, random_state=42) # Best feature selector: SelectPercentile # Best parameters: {'criterion': 'gini', 'max_depth': 5, 'min_samples_leaf': 3, 'min_samples_split': 2, 'splitter': 'best'} # 初始化决策树分类器 classifier = DecisionTreeClassifier(random_state=42, max_depth=5,criterion='gini',splitter='best',min_samples_split=2,min_samples_leaf=3) # 训练模型 classifier.fit(X_train, y_train) # 预测测试集 y_pred = classifier.predict(X_test) # 打印分类报告 print(classification_report(y_test, y_pred)) # 获取目标变量的类别名称 class_names = target_column.unique().tolist() # 将类别名称转换为字符串 class_names = [str(name) for name in class_names] # 绘制决策树 plt.figure(figsize=(80,40)) plot_tree(classifier, filled=True, class_names=class_names) plt.show() 超参数调优 from sklearn.feature_selection import SelectKBest, chi2, SelectPercentile, mutual_info_classif, f_classif, SelectFromModel from sklearn.linear_model import LogisticRegression from sklearn.model_selection import GridSearchCV from sklearn.tree import DecisionTreeClassifier from sklearn.metrics import f1_score # 定义特征选择方法 feature_selectors = [ ('SelectKBest_chi2', SelectKBest(chi2, k=10)), ('SelectPercentile', SelectPercentile(chi2, percentile=10)), ('mutual_info_classif', SelectKBest(mutual_info_classif, k=10)), ('f_classif', SelectKBest(f_classif, k=10)), ('SelectFromModel', SelectFromModel(LogisticRegression(penalty=\"l1\", solver='liblinear'))), ] # 定义要搜索的参数范围 param_grid = { 'max_depth': [3, 4, 5, 6, 7, 8, 9, 10], 'criterion': ['gini', 'entropy'], 'splitter': ['best', 'random'], 'min_samples_split': [2, 3, 4, 5], 'min_samples_leaf': [1, 2, 3, 4, 5], } # 初始化决策树分类器 classifier = DecisionTreeClassifier(random_state=42) # 初始化网格搜索 grid_search = GridSearchCV(classifier, param_grid, cv=5, scoring='f1_macro') best_score = 0 best_selector = None best_params = None # 对每个特征选择方法进行迭代 for name, selector in feature_selectors: # 执行特征选择 X_new = selector.fit_transform(X_encoded, y_encoded) # 执行网格搜索 grid_search.fit(X_new, y_encoded) # 如果这个得分比之前的得分好，就更新最好的得分和最好的参数 if grid_search.best_score_ \u003e best_score: best_score = grid_search.best_score_ best_selector = name best_params = grid_search.best_params_ # 打印最好的特征选择方法和最好的参数 print('Best feature selector:', best_selector) print('Best parameters:', best_params) CART决策树：游客满意度因素分析 数据集：df_cart_satisfaction\n目标变量是’满意度’，分类变量：Q24|R1,Q24|R2,Q24|R3,Q24|R4,Q24|R5,Q24|R6,Q24|R7,Q24|R8,Q24|R9,Q24|R10,Q24|R11,Q24|R12,Q24|R13,Q24|R14,Q24|R18,Q24|R15,Q24|R16,Q24|R17\nimport pandas as pd # 从\"熵权满意度.xlsx\"中读取数据 df_cart_satisfaction = pd.read_excel('熵权满意度.xlsx') df_cart_satisfaction.head() from sklearn.model_selection import train_test_split from sklearn.tree import DecisionTreeRegressor from sklearn.metrics import mean_squared_error from sklearn.tree import plot_tree import matplotlib.pyplot as plt # 定义特征和目标变量 feature_columns =['Q24|R1', 'Q24|R2', 'Q24|R3', 'Q24|R4', 'Q24|R5', 'Q24|R6', 'Q24|R7', 'Q24|R8', 'Q24|R9', 'Q24|R10', 'Q24|R11', 'Q24|R12', 'Q24|R13', 'Q24|R14', 'Q24|R18', 'Q24|R15', 'Q24|R16', 'Q24|R17'] X = df_cart_satisfaction[feature_columns] y = df_cart_satisfaction['满意度'] # Best feature selector: mutual_info_regression # Best parameters: {'max_depth': 10, 'min_samples_leaf': 1, 'min_samples_split': 3, 'splitter': 'random'} # 划分训练集和测试集 X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.1, random_state=42) # 初始化决策树回归器 regressor = DecisionTreeRegressor(random_state=42, max_depth=3,min_samples_split=3,min_samples_leaf=1,splitter='random') # 训练模型 regressor.fit(X_train, y_train) # 预测测试集 y_pred = regressor.predict(X_test) # 打印均方误差 print(\"Mean Squared Error: \", mean_squared_error(y_test, y_pred)) # 绘制决策树 plt.figure(figsize=(80,40)) plot_tree(regressor, filled=True) plt.show() from sklearn.feature_selection import SelectKBest, f_regression, mutual_info_regression, SelectFromModel from sklearn.linear_model import Lasso from sklearn.model_selection import GridSearchCV from sklearn.tree import DecisionTreeRegressor from sklearn.metrics import make_scorer, mean_squared_error # 定义特征选择方法 feature_selectors = [ ('SelectKBest_f_regression', SelectKBest(f_regression, k=10)), ('mutual_info_regression', SelectKBest(mutual_info_regression, k=10)), ('SelectFromModel', SelectFromModel(Lasso(alpha=0.1))), ] # 定义要搜索的参数范围 param_grid = { 'max_depth': [3, 4, 5, 6, 7, 8, 9, 10], 'splitter': ['best', 'random'], 'min_samples_split': [2, 3, 4, 5], 'min_samples_leaf': [1, 2, 3, 4, 5], } # 初始化决策树回归器 regressor = DecisionTreeRegressor(random_state=42) # 初始化网格搜索 grid_search = GridSearchCV(regressor, param_grid, cv=5, scoring=make_scorer(mean_squared_error, greater_is_better=False)) best_score = float('inf') best_selector = None best_params = None # 对每个特征选择方法进行迭代 for name, selector in feature_selectors: # 执行特征选择 X_new = selector.fit_transform(X, y) # 执行网格搜索 grid_search.fit(X_new, y) # 如果这个得分比之前的得分好，就更新最好的得分和最好的参数 if grid_search.best_score_ \u003c best_score: best_score = grid_search.best_score_ best_selector = name best_params = grid_search.best_params_ # 打印最好的特征选择方法和最好的参数 print('Best feature selector:', best_selector) print('Best parameters:', best_params) import pandas as pd # Load the dataset df_cart_satisfaction = pd.read_excel('熵权满意度.xlsx') from sklearn.model_selection import train_test_split from sklearn.tree import DecisionTreeRegressor from sklearn.metrics import mean_squared_error, r2_score # Feature and target columns feature_columns = ['Q24|R1', 'Q24|R2', 'Q24|R3', 'Q24|R4', 'Q24|R5', 'Q24|R6', 'Q24|R7', 'Q24|R8', 'Q24|R9', 'Q24|R10', 'Q24|R11', 'Q24|R12', 'Q24|R13', 'Q24|R14', 'Q24|R18', 'Q24|R15', 'Q24|R16', 'Q24|R17'] X = df_cart_satisfaction[feature_columns] y = df_cart_satisfaction['满意度'] # Splitting data into training and testing sets X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42) # Initialize and train Decision Tree Regressor dt_regressor = DecisionTreeRegressor(random_state=42) dt_regressor.fit(X_train, y_train) # Predicting the Test set results y_pred = dt_regressor.predict(X_test) # Evaluate the model mse = mean_squared_error(y_test, y_pred) r2 = r2_score(y_test, y_pred) mse, r2 # Getting feature importances feature_importances = pd.Series(dt_regressor.feature_importances_, index=feature_columns) # Sort the feature importances in descending order feature_importances_sorted = feature_importances.sort_values(ascending=False) feature_importances_sorted from sklearn.tree import plot_tree import matplotlib.pyplot as plt from matplotlib.colors import ListedColormap # 为决策树的不同深度生成一个绿色渐变颜色映射 cmap = ListedColormap([\"#e5f5e0\", \"#a1d99b\", \"#31a354\"]) # Plotting the Decision Tree with green color scheme plt.figure(figsize=(20,10)) # 使用colormap参数指定颜色映射 plot_tree(dt_regressor, feature_names=feature_columns, filled=True, max_depth=3, fontsize=10, cmap=cmap) plt.title(\"满意度影响因素决策树\") plt.show() 灰色关联 灰色关联分析（Grey Relational Analysis, GRA）是灰色系统理论的一个重要部分，由中国学者邓聚龙在20世纪80年代初提出。灰色系统理论主要研究部分信息已知、部分信息未知的系统，而灰色关联分析则是用来分析和处理系统中因素之间的关联程度的一种方法。\n基础知识 主要用途\n关联度分析：通过计算和比较序列之间的关联度（相似度），确定各个因素对系统行为的影响程度，识别出主要影响因素和次要影响因素。 预测与决策支持：在只有少量数据或系统信息不完全的情况下，灰色关联分析可以用来预测系统的未来发展趋势，为决策提供依据。 模式识别和分类：根据关联度的高低，可以将系统中的因素或对象进行分类，识别出具有相似性质的群体或模式。 分析特点\n适用于小样本和不完全信息：与传统的统计分析方法相比，灰色关联分析不需要大量数据，适用于信息不完全和数据量少的情况。 操作简便，易于理解和实施：灰色关联分析的计算过程相对简单，容易实现，计算结果直观易懂。 广泛的应用领域：灰色关联分析在经济分析、社会科学、环境工程、生物医药等多个领域都有应用。 应用示例\n假设要分析某一地区经济增长与多个因素（如投资、消费、出口等）之间的关系，可以使用灰色关联分析来确定哪些因素与经济增长的关联度最高，从而为经济政策的制定提供依据。\n灰色关联分析通过计算参考数列（如经济增长率）与比较数列（如投资增长率、消费增长率等）之间的关联度，来评估各因素对目标（经济增长）的影响程度。通过比较各因素的关联度大小，可以辨识出对经济增长影响最大的因素。\n灰色关联：探究满意度的提升和打造产品的关系 import pandas as pd import numpy as np import matplotlib.pyplot as plt # 假设 df_gone 是自变量的DataFrame，df_gone['Q26|1'] 是因变量 # 数据准备 columns = ['Q2', 'Q4', 'Q5', 'Q8', 'Q9', 'Q10', 'Q11', 'Q12', 'Q13', 'Q14', 'Q15'] # 数值型列 numerical_columns = ['Q2', 'Q4', 'Q5'] # 类别型列 categorical_columns = [col for col in columns if col not in numerical_columns] # 分类变量进行独热编码 df_encoded = pd.get_dummies(df_gone[categorical_columns]) # 保留数值型列的原始数据 df_numerical = df_gone[numerical_columns] # 合并数值型数据和经过独热编码的分类数据 X_encoded = pd.concat([df_numerical, df_encoded], axis=1) X = X_encoded # 自变量数据 y = df_gone['Q26|1'].values # 因变量数据 # 标准化（归一化）处理 X_norm = (X - X.min()) / (X.max() - X.min()) y_norm = (y - y.min()) / (y.max() - y.min()) # 计算关联系数 def grey_relational_coefficient(x, y): epsilon = 0.5 # 分辨系数，一般取值为(0,1) delta = np.abs(x - y) min_delta = np.min(delta) max_delta = np.max(delta) xi = (min_delta + epsilon * max_delta) / (delta + epsilon * max_delta) return xi # 计算每个自变量与因变量的关联系数 xi_matrix = np.array([grey_relational_coefficient(X_norm.iloc[:, i].values, y_norm) for i in range(X_norm.shape[1])]) # 计算关联度 grey_relational_grades = np.mean(xi_matrix, axis=1) # 对关联度进行降序排列，并获取排序后的索引 sorted_indices = np.argsort(grey_relational_grades)[::-1] # 可视化关联度 plt.figure(figsize=(10, 6)) plt.barh(range(len(sorted_indices)), grey_relational_grades[sorted_indices], color='skyblue') plt.yticks(range(len(sorted_indices)), X_encoded.columns[sorted_indices]) plt.xlabel('Grey Relational Grade') plt.title('Grey Relational Analysis (GRA) of Variables to Q26') plt.gca().invert_yaxis() # 使得y轴按关联度从高到低排列 plt.show() 关联规则 关联规则分析是一种在大数据集中寻找项目间的有趣关系（如频繁模式、关联、相关性）的方法，主要用于事务数据、序列数据等。它最著名的应用是市场篮分析，但也广泛应用于生物信息学、药品配对、推荐系统等领域。\n基础知识 作用\n发现数据间隐藏的关系：帮助识别数据集中不同项目之间的关联性，即用户行为或特征之间的内在联系。 决策支持：为零售商提供交叉销售和产品捆绑的策略依据，通过理解产品之间的关系来优化库存管理和推广策略。 推荐系统：基于用户的购买历史或行为模式，推荐他们可能感兴趣的商品或服务。 实现方法\nApriori算法：最早也是最著名的关联规则挖掘算法，通过逐层搜索频繁项集的方法来发现数据之间的强规则。 FP-Growth算法：比Apriori效率更高，不需要产生候选项集，直接构造FP树来挖掘频繁项集。 Eclat算法：基于垂直数据格式，使用交集操作来快速得到频繁项集，效率高于Apriori。 关联规则分析：推荐意愿分析 针对27、28进行关联规则分析\nQ27|1,Q28|1,Q28|23,Q28|21,Q28|22,Q28|24,Q28|25,Q28|4,Q28|2,Q28|26,Q28|27,Q28|28,Q28|29,Q28|35,Q28|34,\n排除Q28|34|open\n支持度（Support）：支持度可以理解为物品当前流行程度。计算方式是：\n支持度 = （包含物品A的记录数量） / （总的记录数量） 用上面的超市记录举例，一共有五个交易，牛奶出现在三个交易中，故而{牛奶}的支持度为3/5。{鸡蛋}的支持度是4/5。牛奶和鸡蛋同时出现的次数是2，故而{牛奶，鸡蛋}的支持度为2/5。 置信度（Confidence）：置信度是指如果购买物品A，有较大可能购买物品B。计算方式是这样：\n置信度( A -\u003e B) = （包含物品A和B的记录数量） / （包含 A 的记录数量） 举例：我们已经知道，(牛奶，鸡蛋)一起购买的次数是两次，鸡蛋的购买次数是4次。那么Confidence(牛奶-\u003e鸡蛋)的计算方式是Confidence(牛奶-\u003e鸡蛋)=2 / 4。 提升度（Lift）：提升度指当销售一个物品时，另一个物品销售率会增加多少。计算方式是：\n提升度( A -\u003e B) = 置信度( A -\u003e B) / (支持度 A) 泡泡图：support, confidence, lift\nfrom mlxtend.frequent_patterns import apriori from mlxtend.frequent_patterns import association_rules import matplotlib.pyplot as plt import pandas as pd df_apriori = df_gone[['Q28|1','Q28|23','Q28|21','Q28|22','Q28|24','Q28|25','Q28|4','Q28|2','Q28|26','Q28|27','Q28|28','Q28|29','Q28|35','Q28|34']] df_apriori = df_apriori.rename(columns={ 'Q28|1': '草原风光', 'Q28|23': '矮杜鹃花花海', 'Q28|21': '乌蒙滑雪场', 'Q28|22': '七彩滑道', 'Q28|24': '玻璃水滑道', 'Q28|25': '观佛台观赏佛光', 'Q28|4': '野炊露营', 'Q28|2': '民俗风情', 'Q28|26': '蒙古包酒店', 'Q28|27': '精品民宿', 'Q28|28': '牛肉馆', 'Q28|29': '羊汤锅', 'Q28|35': '旅游商品', # （刺梨系列商品、盘县火腿、人民小酒、茶叶、银杏系列商品等） 'Q28|34': '其他' }) # 将数据集中的所有值都转换为数值，忽略无法转换的值 df_apriori = df_apriori.apply(pd.to_numeric, errors='coerce') # 然后再将数据集中的值转换为布尔值 df_encoded = df_apriori.applymap(lambda x: False if x \u003c= 0 else True) # print(df_encoded) # 使用apriori找出频繁项集，将支持度阈值提高到0.5 frequent_itemsets = apriori(df_encoded, min_support=0.3, use_colnames=True) # 使用association_rules找出关联规则，将置信度阈值提高到0.8 rules = association_rules(frequent_itemsets, metric=\"confidence\", min_threshold=0.5) # 打印关联规则 # print(rules) # 现在我们绘制泡泡图 # 规则的支持度决定泡泡的大小，提升度决定颜色的深浅 plt.scatter(rules['support'], rules['confidence'], s=rules['support']*1000, c=rules['lift'], cmap='RdYlBu', alpha=0.5) plt.xlabel('Support') plt.ylabel('Confidence') plt.title('Bubble Chart for Association Rules') plt.colorbar(label='Lift') plt.show() 变量可视化\n# 设置字体为SimHei显示中文 plt.rcParams['font.sans-serif'] = ['SimHei'] plt.rcParams['axes.unicode_minus'] = False # 创建一个空的矩阵，用于存放支持度和提升度 support_matrix = pd.DataFrame(index=df_encoded.columns, columns=df_encoded.columns) lift_matrix = pd.DataFrame(index=df_encoded.columns, columns=df_encoded.columns) # 填充矩阵 for i, rule in rules.iterrows(): antecedents = next(iter(rule['antecedents'])) consequents = next(iter(rule['consequents'])) support_matrix.loc[antecedents, consequents] = rule['support'] lift_matrix.loc[antecedents, consequents] = rule['lift'] import matplotlib.colors as mcolors # 绘制泡泡图 fig, ax = plt.subplots(figsize=(14, 9)) # 修改图表宽度 norm = mcolors.Normalize(vmin=lift_matrix.min().min(), vmax=lift_matrix.max().max()) # 创建归一化对象 for i in support_matrix.columns: for j in support_matrix.index: support = support_matrix.loc[j, i] lift = lift_matrix.loc[j, i] if pd.notnull(support): ax.scatter(i, j, s=support*3500, c=lift, cmap='RdYlBu', norm=norm, alpha=0.7) # 修改散点图的大小 # 设置图表格式 ax.set_xticks(range(len(support_matrix.columns))) ax.set_yticks(range(len(support_matrix.index))) ax.set_xticklabels(support_matrix.columns, rotation=90) ax.set_yticklabels(support_matrix.index) # 显示背景网格 ax.grid(True, linestyle='--') # 添加颜色条 sm = plt.cm.ScalarMappable(cmap='RdYlBu', norm=plt.Normalize(vmin=lift_matrix.min().min(), vmax=lift_matrix.max().max())) sm._A = [] cbar = plt.colorbar(sm, shrink=0.7) # 修改颜色条的大小 cbar.set_label('Lift') # 显示图表 plt.show() 热力图\nimport seaborn as sns # 创建一个空的DataFrame，用于存储提升度 lift_matrix = pd.DataFrame(index=df_apriori.columns, columns=df_apriori.columns) for i in range(rules.shape[0]): antecedent = rules.iloc[i]['antecedents'] consequent = rules.iloc[i]['consequents'] lift = rules.iloc[i]['lift'] if len(antecedent) == 1 and len(consequent) == 1: antecedent = list(antecedent)[0] consequent = list(consequent)[0] if isinstance(antecedent, str) and isinstance(consequent, str): lift_matrix.loc[antecedent, consequent] = lift # 将NaN值填充为0 lift_matrix = lift_matrix.fillna(0) # 使用seaborn的heatmap函数绘制热图 plt.figure(figsize=(10, 8)) sns.heatmap(lift_matrix, cmap='RdYlBu_r', annot=True, fmt=\".2f\") plt.title('Lift Matrix') plt.show() 关联规则分析：旅游资源产品开发 针对Q30,Q31,Q32这三个题项进行分析\nQ30|R1,Q30|R2,Q30|R3,Q30|R4,Q30|R5,Q30|R6,Q31|R1,Q31|R2,Q31|R8,Q31|R4,Q31|R7,Q31|R9,Q31|R6,Q31|R5,Q32|R3,Q32|R7,Q32|R4,Q32|R5,Q32|R1,Q32|R2,Q32|R6,Q33|R10,Q33|R12,Q33|R11,Q33|R4,Q33|R5,Q33|R1,Q33|R8,Q33|R7\n这些题目都是量表题，关联分析需要多选题，4分及以上算作选择了；然后进行3维的关联规则分析\n# 关联规则分析 # 先对把每个问卷的选项转换为布尔值，并把三个问题的选项合并到一起 columns_to_convert = ['Q30|R1', 'Q30|R2', 'Q30|R3', 'Q30|R4', 'Q30|R5', 'Q30|R6', 'Q31|R1', 'Q31|R2', 'Q31|R8', 'Q31|R4', 'Q31|R7', 'Q31|R9', 'Q31|R6', 'Q31|R5', 'Q32|R3', 'Q32|R7', 'Q32|R4', 'Q32|R5', 'Q32|R1', 'Q32|R2', 'Q32|R6'] def convert_score(score): return score \u003e= 4 df_product = df_gone[columns_to_convert].map(convert_score) # 把df_product到处为csv df_product.to_csv('product.csv', index=False) df_product.head() 利用关联规则算法Apriori分析和可视化\nfrom mlxtend.frequent_patterns import apriori from mlxtend.frequent_patterns import association_rules import matplotlib.pyplot as plt import pandas as pd # 设置字体为SimHei显示中文 plt.rcParams['font.sans-serif'] = ['SimHei'] plt.rcParams['axes.unicode_minus'] = False df_encoded = df_product.rename(columns={ 'Q30|R1': '体育项目', 'Q30|R2': '网红打卡点', 'Q30|R3': '趣味项目', 'Q30|R4': '民族服饰', 'Q30|R5': '专业旅拍', 'Q30|R6': '特色民宿', 'Q31|R1': '盘县火腿', 'Q31|R2': '刺梨系列产品', 'Q31|R8': '盘州茶叶', 'Q31|R4': '核桃乳', 'Q31|R7': '人民小酒', 'Q31|R9': '银杏系列商品', 'Q31|R6': '民族手工制品', 'Q31|R5': '彝族服饰', 'Q32|R3': '非遗火腿工艺参观', 'Q32|R7': '非遗技艺制作地方特色小吃体验', 'Q32|R4': '非遗剪纸体验', 'Q32|R5': '古法造纸参观', 'Q32|R1': '民族刺绣体验', 'Q32|R2': '民族蜡染体验', 'Q32|R6': '民族歌舞表演' }) # 使用apriori找出频繁项集，将支持度阈值提高到0.5 frequent_itemsets = apriori(df_encoded, min_support=0.7, use_colnames=True) # 使用association_rules找出关联规则，将置信度阈值提高到0.8 rules = association_rules(frequent_itemsets, metric=\"confidence\", min_threshold=0.5) # 规则的支持度决定泡泡的大小，提升度决定颜色的深浅 plt.scatter(rules['support'], rules['confidence'], s=rules['support']*1000, c=rules['lift'], cmap='viridis', alpha=0.5) plt.xlabel('支持度') plt.ylabel('值信度') plt.title('关联规则气泡图') plt.colorbar(label='提升度') plt.show() import matplotlib.colors as mcolors # 创建一个空的矩阵，用于存放支持度和提升度 support_matrix = pd.DataFrame(index=df_encoded.columns, columns=df_encoded.columns) lift_matrix = pd.DataFrame(index=df_encoded.columns, columns=df_encoded.columns) # 填充矩阵 for i, rule in rules.iterrows(): antecedents = next(iter(rule['antecedents'])) consequents = next(iter(rule['consequents'])) support_matrix.loc[antecedents, consequents] = rule['support'] lift_matrix.loc[antecedents, consequents] = rule['lift'] # 绘制泡泡图 fig, ax = plt.subplots(figsize=(14, 9)) # 修改图表宽度 norm = mcolors.Normalize(vmin=lift_matrix.min().min(), vmax=lift_matrix.max().max()) # 创建归一化对象 for i in support_matrix.columns: for j in support_matrix.index: support = support_matrix.loc[j, i] lift = lift_matrix.loc[j, i] if pd.notnull(support): ax.scatter(i, j, s=support*500, c=lift, cmap='viridis', norm=norm, alpha=0.7) # 修改散点图的大小 # 修改图表的 x 轴和 y 轴标签 ax.set_xticks(range(len(support_matrix.columns))) ax.set_yticks(range(len(support_matrix.index))) ax.set_xticklabels(support_matrix.columns, rotation=90) ax.set_yticklabels(support_matrix.index) # 显示背景网格 ax.grid(True, linestyle='--') # 添加颜色条 sm = plt.cm.ScalarMappable(cmap='viridis', norm=plt.Normalize(vmin=lift_matrix.min().min(), vmax=lift_matrix.max().max())) sm._A = [] cbar = plt.colorbar(sm, shrink=0.7) # 修改颜色条的大小 cbar.set_label('Lift') # 显示图表 plt.show() import matplotlib.pyplot as plt import pandas as pd from mpl_toolkits.mplot3d import Axes3D import matplotlib.colors as mcolors # 假设 scatter_data 已经正确定义，且包含必要的列 question_names = { 'Q30|R1': '体育项目', 'Q30|R2': '网红打卡点', 'Q30|R3': '趣味项目', 'Q30|R4': '民族服饰', 'Q30|R5': '专业旅拍', 'Q30|R6': '特色民宿', 'Q31|R1': '盘县火腿', 'Q31|R2': '刺梨系列产品', 'Q31|R8': '盘州茶叶', 'Q31|R4': '核桃乳', 'Q31|R7': '人民小酒', 'Q31|R9': '银杏系列商品', 'Q31|R6': '民族手工制品', 'Q31|R5': '彝族服饰', 'Q32|R3': '非遗火腿工艺参观', 'Q32|R7': '非遗技艺制作地方特色小吃体验', 'Q32|R4': '非遗剪纸体验', 'Q32|R5': '古法造纸参观', 'Q32|R1': '民族刺绣体验', 'Q32|R2': '民族蜡染体验', 'Q32|R6': '民族歌舞表演' } # 创建映射：从题目名称映射到索引 category_mapping = {name: index for index, name in enumerate(question_names.values())} # 创建逆映射：从索引映射回题目名称 inverse_mapping = {index: name for name, index in category_mapping.items()} scatter_data = pd.DataFrame(columns=['Antecedent1', 'Antecedent2', 'Consequent', 'Support', 'Lift']) for index, row in rules.iterrows(): antecedents = list(row['antecedents']) consequent = next(iter(row['consequents'])) if len(antecedents) == 2: # 确保前件有两个元素 scatter_data.loc[index] = [ category_mapping[antecedents[0]], category_mapping[antecedents[1]], category_mapping[consequent], row['support'], row['lift'] ] # 定义颜色映射和规范化实例 cmap = plt.get_cmap('viridis') # 使用matplotlib内置的颜色映射 norm = mcolors.Normalize(vmin=scatter_data['Lift'].min(), vmax=scatter_data['Lift'].max()) # 根据提升度的最小值和最大值创建规范化实例 # 绘制三维散点图 fig = plt.figure(figsize=(25, 10)) # 调整图表大小 ax = fig.add_subplot(111, projection='3d') # 散点图绘制 points = ax.scatter( scatter_data['Antecedent1'], scatter_data['Antecedent2'], scatter_data['Consequent'], s=scatter_data['Support']*150, # 泡泡大小基于支持度 c=[cmap(norm(val)) for val in scatter_data['Lift']], # 颜色基于提升度 alpha=0.6 ) # 调整坐标轴标签为题目名称，并调整字体大小和旋转角度 ax.set_xticks(list(category_mapping.values())) ax.set_xticklabels(list(category_mapping.keys()), rotation=45, ha=\"right\", fontsize=8) # 调整X轴标签 ax.set_yticks(list(category_mapping.values())) ax.set_yticklabels(list(category_mapping.keys()), rotation=-45, ha=\"left\", fontsize=8) # 调整Y轴标签 ax.set_zticks(list(category_mapping.values())) ax.set_zticklabels(list(category_mapping.keys()), fontsize=8) # 调整Z轴标签字体大小 # 调整视角 ax.view_init(elev=20, azim=-45) # 调整视角 # 添加颜色条 sm = plt.cm.ScalarMappable(cmap=cmap, norm=norm) sm.set_array([]) cbar = fig.colorbar(sm, shrink=0.4, aspect=15, label='提升度') cbar.ax.tick_params(labelsize=8) # 调整颜色条刻度的字体大小 plt.show() 生成动态gif\nimport matplotlib.pyplot as plt import pandas as pd from mpl_toolkits.mplot3d import Axes3D import matplotlib.colors as mcolors import numpy as np import imageio # 用于生成GIF # 假设 scatter_data 已经正确定义，且包含必要的列 # 绘制三维散点图的函数 def plot_3d(ax, azim): ax.clear() # 清除之前的绘图 # 散点图绘制 ax.scatter( scatter_data['Antecedent1'], scatter_data['Antecedent2'], scatter_data['Consequent'], s=scatter_data['Support']*150, # 泡泡大小基于支持度 c=[cmap(norm(val)) for val in scatter_data['Lift']], # 颜色基于提升度 alpha=0.6 ) # 设置坐标轴标签 ax.set_xticks(list(category_mapping.values())) ax.set_xticklabels(list(category_mapping.keys()), rotation=45, ha=\"right\", fontsize=8) ax.set_yticks(list(category_mapping.values())) ax.set_yticklabels(list(category_mapping.keys()), rotation=-45, ha=\"left\", fontsize=8) ax.set_zticks(list(category_mapping.values())) ax.set_zticklabels(list(category_mapping.keys()), fontsize=8) # 调整视角 ax.view_init(elev=20, azim=azim) # 旋转视角 # 由于在函数内部调用 plt.show() 或 plt.savefig() 会阻断循环，我们在这里不调用它们 # 创建GIF的帧 filenames = [] fig = plt.figure(figsize=(25, 10)) ax = fig.add_subplot(111, projection='3d') for azim in range(0, 90, 2): # 从-45度旋转到315度，每次增加2度 plot_3d(ax, azim) # 绘图 filename = f'frame_{azim}.png' plt.savefig(filename) # 保存帧 filenames.append(filename) # 使用imageio生成GIF images = [] for filename in filenames: images.append(imageio.imread(filename)) imageio.mimsave('rotation.gif', images, fps=20) # 调整fps（每秒帧数）根据需要 # 清理临时生成的PNG文件 import os for filename in filenames: os.remove(filename) antecedent_mapping = category_mapping antecedent_mapping_reverse = inverse_mapping consequent_mapping = category_mapping consequent_mapping_reverse = inverse_mapping q30_options = ['体育项目', '网红打卡点', '趣味项目', '民族服饰', '专业旅拍', '特色民宿'] q31_options = ['盘县火腿', '刺梨系列产品', '盘州茶叶', '核桃乳', '人民小酒', '银杏系列商品', '民族手工制品', '彝族服饰'] q32_options = ['非遗火腿工艺参观', '非遗技艺制作地方特色小吃体验', '非遗剪纸体验', '古法造纸参观', '民族刺绣体验', '民族蜡染体验', '民族歌舞表演'] # 遍历scatter_data for i, row in scatter_data.iterrows(): lift = row['Lift'] # 只输出提升度大于1.45的规则 if lift \u003e 1.3: antecedent1 = antecedent_mapping_reverse.get(row['Antecedent1'], 'Unknown') antecedent2 = antecedent_mapping_reverse.get(row['Antecedent2'], 'Unknown') consequent = consequent_mapping_reverse.get(row['Consequent'], 'Unknown') support = row['Support'] # 检查前件和后件是否包含q30、q31和q32中的任意一个问题 if ((antecedent1 in q30_options and antecedent2 in q31_options and consequent in q32_options) or (antecedent1 in q30_options and antecedent2 in q32_options and consequent in q31_options) or (antecedent1 in q31_options and antecedent2 in q30_options and consequent in q32_options) or (antecedent1 in q31_options and antecedent2 in q32_options and consequent in q30_options) or (antecedent1 in q32_options and antecedent2 in q30_options and consequent in q31_options) or (antecedent1 in q32_options and antecedent2 in q31_options and consequent in q30_options)): print(f\"规则: {antecedent1}, {antecedent2} =\u003e {consequent}, 支持度: {support:.2f}, 提升度: {lift:.2f}\") 客户粘性分析 游客画像作为自变量，客户粘性作为因变量进行分析\n比较关心的是客户粘性打分为4/5的客户，看他们的游客画像是什么。\n第一个思路是，把去过的游客先进行聚类，再把聚类的结果来看哪一类人群的粘性最高；在数据处理的逻辑上思路更好。 第二个思路是，把游客的基本信息不处理，全部丢给随机森林进行处理 客户粘性题号：Q26|1\n游客基本信息：columns 游客画像聚类结果：\n注：运行此段代码前，先运行“开始聚类”代码\n# 查看Q26的打分分布 print(\"查看Q26的打分分布\\n\",df_gone['Q26|1'].value_counts()) # 查看总的数据量 print(\"\\n查看总的数据量\\n\",df_gone.shape) # 检查游客基本信息的题号，排除开放性题号 print(\"\\n检查游客基本信息的题号，排除开放性题号\\n\",columns) # 聚类结果统计 print(\"\\n聚类结果统计\\n \",df_gone['k-prototypes cluster'].value_counts()) 对df_gone进行聚类 # 思路1 把去过的游客先进行聚类，再把聚类的结果来看哪一类人群的粘性最高 from kmodes.kprototypes import KPrototypes # 列表中的列名 # columns = ['Q1', 'Q2', 'Q3', 'Q4', 'Q5', 'Q7|1', 'Q7|4', 'Q7|2', 'Q7|3', 'Q7|5', 'Q7|6', 'Q8', 'Q9', 'Q10', 'Q11', 'Q12', 'Q13', 'Q14', 'Q15'] columns = ['Q2', 'Q4', 'Q5', 'Q8', 'Q9', 'Q10', 'Q11', 'Q12', 'Q13', 'Q14', 'Q15'] # 数值型列 numerical_columns = ['Q2', 'Q4', 'Q5'] # 类别型列 categorical_columns = [col for col in columns if col not in numerical_columns] # 将类别型列的索引转换为数字 categorical_columns_indices = [columns.index(col) for col in categorical_columns] # 初始化 K-原型聚类器 kproto = KPrototypes(n_clusters=4, init='Cao', verbose=2) # 对所有游客进行聚类 clusters = kproto.fit_predict(df_gone[columns].values, categorical=categorical_columns_indices) # 将聚类结果添加到数据集作为新的特征 df_gone['k-prototypes cluster'] = clusters # 想查看每个簇的中心点 print(kproto.cluster_centroids_) # 查看每个簇的数量 print(df_gone['k-prototypes cluster'].value_counts()) df_gone.head() 可视化 from sklearn.decomposition import PCA from sklearn.manifold import TSNE from umap import UMAP import matplotlib.pyplot as plt from mpl_toolkits.mplot3d import Axes3D # 数据 X = df_gone[columns].values # 创建PCA，t-SNE，UMAP对象 pca = PCA(n_components=2) tsne = TSNE(n_components=2) umap = UMAP(n_components=2) # 降维 X_pca = pca.fit_transform(X) X_tsne = tsne.fit_transform(X) X_umap = umap.fit_transform(X) # 创建图形和子图 fig, axs = plt.subplots(3, 2, figsize=(15, 20)) # 绘制二维版本 axs[0, 0].scatter(X_pca[:, 0], X_pca[:, 1], c=clusters, cmap='viridis', alpha=0.5) axs[0, 0].set_title('PCA 2D') fig.colorbar(sc, ax=axs[0, 0], shrink=0.6) axs[1, 0].scatter(X_tsne[:, 0], X_tsne[:, 1], c=clusters, cmap='viridis', alpha=0.5) axs[1, 0].set_title('t-SNE 2D') fig.colorbar(sc, ax=axs[1, 0], shrink=0.6) axs[2, 0].scatter(X_umap[:, 0], X_umap[:, 1], c=clusters, cmap='viridis', alpha=0.5) axs[2, 0].set_title('UMAP 2D') fig.colorbar(sc, ax=axs[2, 0], shrink=0.6) # 创建PCA，t-SNE，UMAP对象 pca = PCA(n_components=3) tsne = TSNE(n_components=3) umap = UMAP(n_components=3) # 降维 X_pca = pca.fit_transform(X) X_tsne = tsne.fit_transform(X) X_umap = umap.fit_transform(X) # 绘制三维版本 axs[0, 1] = fig.add_subplot(3, 2, 2, projection='3d') axs[0, 1].scatter(X_pca[:, 0], X_pca[:, 1], X_pca[:, 2], c=clusters, cmap='viridis', alpha=0.5) axs[0, 1].set_title('PCA 3D') fig.colorbar(sc, ax=axs[0, 1], shrink=0.6, pad=0.2) # 修改的代码 axs[1, 1] = fig.add_subplot(3, 2, 4, projection='3d') axs[1, 1].scatter(X_tsne[:, 0], X_tsne[:, 1], X_tsne[:, 2], c=clusters, cmap='viridis', alpha=0.5) axs[1, 1].set_title('t-SNE 3D') fig.colorbar(sc, ax=axs[1, 1], shrink=0.6, pad=0.2) # 修改的代码 axs[2, 1] = fig.add_subplot(3, 2, 6, projection='3d') axs[2, 1].scatter(X_umap[:, 0], X_umap[:, 1], X_umap[:, 2], c=clusters, cmap='viridis', alpha=0.5) axs[2, 1].set_title('UMAP 3D') fig.colorbar(sc, ax=axs[2, 1], shrink=0.6, pad=0.2) # 修改的代码 plt.tight_layout() plt.show() 描述性统计 分析df_gone中的’k-prototypes cluster’和’Q26|1’之间的关系\n卡方检验：如果p值小于0.05，那么我们可以拒绝零假设，认为’k-prototypes cluster’和’Q26|1’之间存在显著的关系。如果p值大于0.05，那么我们不能拒绝零假设，认为’k-prototypes cluster’和’Q26|1’之间不存在显著的关系。\nfrom scipy.stats import chi2_contingency # 创建列联表 contingency_table = pd.crosstab(df_gone['k-prototypes cluster'], df_gone['Q26|1'] \u003e= 4) # 进行卡方检验 chi2, p, dof, expected = chi2_contingency(contingency_table) print(f\"Chi-square value: {chi2}\") print(f\"P-value: {p}\") print(f\"Degrees of freedom: {dof}\") import seaborn as sns # 创建新的二元变量 df_gone['Q26|1_high_score'] = (df_gone['Q26|1'] \u003e= 4) # 绘制计数图 sns.countplot(x='k-prototypes cluster', hue='Q26|1_high_score', data=df_gone) plt.show() 随机森林模型 自变量是聚类的结果，因变量是Q26的打分（这个不行） 方法二可以做随机森林\n我想研究的是哪一类人群在Q26的打分更高，我比较关注打分在大于等于4分的人群是哪一类\nfrom sklearn.ensemble import RandomForestClassifier from sklearn.model_selection import train_test_split from sklearn.metrics import classification_report # 定义自变量和因变量 X = df_gone[columns] y = df_gone['Q26|1'].values # 划分训练集和测试集 X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42) # 创建随机森林模型 clf = RandomForestClassifier(n_estimators=100, random_state=42) # 训练模型 clf.fit(X_train, y_train) # 预测测试集 y_pred = clf.predict(X_test) # 打印分类报告 print(classification_report(y_test, y_pred)) import shap import numpy as np # 创建解释器 explainer = shap.TreeExplainer(clf) # 计算SHAP值 shap_values = explainer.shap_values(X_test) # 创建类别标签 class_labels = ['Class 1', 'Class 2', 'Class 3', 'Class 4', 'Class 5'] # 设置图形大小 plt.figure(figsize=(40, 10)) # 绘制所有类别的SHAP值概览图（保持原始顺序） plt.subplot(1, 3, 1) shap.summary_plot(shap_values, X_test, class_names=class_labels, plot_type=\"bar\", show=False) plt.title(\"All Classes Feature Importance\") # 绘制类别4的特征贡献度 plt.subplot(1, 3, 2) shap.summary_plot(shap_values[3][:, sorted_indices_class_4], X_test.iloc[:, sorted_indices_class_4], plot_type=\"bar\", feature_names=X_test.columns[sorted_indices_class_4], show=False) plt.title(\"Class 4 Feature Importance\") # 绘制类别5的特征贡献度 plt.subplot(1, 3, 3) shap.summary_plot(shap_values[4][:, sorted_indices_class_5], X_test.iloc[:, sorted_indices_class_5], plot_type=\"bar\", feature_names=X_test.columns[sorted_indices_class_5], show=False) plt.title(\"Class 5 Feature Importance\") plt.tight_layout() plt.show() shap.summary_plot(shap_values, X_test, class_names=class_labels, plot_type=\"bar\", show=False) plt.title(\"All Classes Feature Importance\") # mean(|SHAP value|)(average impact on model output magnitude) ","wordCount":"5544","inLanguage":"en","image":"https://sirius1y.top/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2024-03-21T00:00:00Z","dateModified":"2024-03-21T00:00:00Z","author":{"@type":"Person","name":"sirius1y"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://sirius1y.top/posts/notes/data-analysis/wumengtrip/"},"publisher":{"@type":"Organization","name":"Sirius' Blog","logo":{"@type":"ImageObject","url":"https://sirius1y.top/images/icon.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://sirius1y.top/ accesskey=h title="Home (Alt + H)"><img src=https://sirius1y.top/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://sirius1y.top/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://sirius1y.top/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://sirius1y.top/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://sirius1y.top/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://sirius1y.top/>Home</a>&nbsp;»&nbsp;<a href=https://sirius1y.top/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">全国大学生市场调研大赛-数据分析</h1><div class=post-description>记录在正大杯中使用到的一些数据分析思路方法</div><div class=post-meta><span title='2024-03-21 00:00:00 +0000 UTC'>March 21, 2024</span>&nbsp;·&nbsp;27 min&nbsp;·&nbsp;5544 words&nbsp;·&nbsp;sirius1y</div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e6%95%b0%e6%8d%ae%e7%9a%84%e9%a2%84%e5%a4%84%e7%90%86 aria-label=数据的预处理>数据的预处理</a><ul><li><a href=#%e6%a3%80%e6%9f%a5%e5%85%ac%e5%85%b1%e9%a2%98%e7%9b%ae%e6%9c%89%e6%b2%a1%e6%9c%89%e7%bc%ba%e5%a4%b1%e5%80%bc aria-label=检查公共题目有没有缺失值>检查公共题目有没有缺失值</a></li><li><a href=#%e5%ad%a4%e7%ab%8b%e6%a3%ae%e6%9e%97 aria-label=孤立森林>孤立森林</a></li><li><a href=#%e6%9c%80%e7%bb%88%e6%95%b0%e6%8d%ae%e9%9b%86 aria-label=最终数据集>最终数据集</a></li></ul></li><li><a href=#%e6%95%b0%e6%8d%ae%e5%88%86%e6%9e%90 aria-label=数据分析>数据分析</a><ul><li><a href=#%e7%bb%93%e6%9e%84%e6%96%b9%e7%a8%8b aria-label=结构方程>结构方程</a><ul><li><a href=#%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86 aria-label=基础知识>基础知识</a></li></ul></li><li><a href=#%e8%81%9a%e7%b1%bb%e5%88%86%e6%9e%90 aria-label=聚类分析>聚类分析</a><ul><li><a href=#%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86-1 aria-label=基础知识>基础知识</a><ul><li><a href=#%e6%96%b9%e6%b3%95%e5%88%86%e7%b1%bb aria-label=方法分类>方法分类</a></li><li><a href=#%e6%af%94%e8%be%83-k-prototypes--k-means aria-label="比较 K-prototypes &amp;amp; K-means">比较 K-prototypes & K-means</a></li></ul></li><li><a href=#k-prototypes-%e8%81%9a%e7%b1%bb%e6%89%80%e6%9c%89%e6%b8%b8%e5%ae%a2%e6%9d%a5%e8%bf%87%e7%9a%84%e6%b8%b8%e5%ae%a2%e7%94%bb%e5%83%8f aria-label="K-Prototypes 聚类：所有游客/来过的游客画像">K-Prototypes 聚类：所有游客/来过的游客画像</a><ul><li><a href=#%e7%a1%ae%e5%ae%9a%e8%81%9a%e7%b1%bb%e7%b0%87%e6%95%b0 aria-label=确定聚类簇数>确定聚类簇数</a><ul><li><a href=#%e4%bd%bf%e7%94%a8%e8%82%98%e9%83%a8%e5%9b%be%e7%a1%ae%e5%ae%9a%e6%9c%80%e4%bd%b3%e7%b0%87%e6%95%b0 aria-label=使用肘部图确定最佳簇数>使用肘部图确定最佳簇数</a></li><li><a href=#%e4%bd%bf%e7%94%a8%e8%bd%ae%e5%bb%93%e7%b3%bb%e6%95%b0%e7%a1%ae%e5%ae%9a%e7%b0%87%e6%95%b0%e7%9a%84%e6%96%b9%e6%b3%95 aria-label=使用轮廓系数确定簇数的方法>使用轮廓系数确定簇数的方法</a></li></ul></li><li><a href=#%e5%bc%80%e5%a7%8b%e8%81%9a%e7%b1%bb aria-label=开始聚类>开始聚类</a></li><li><a href=#%e7%89%b9%e5%be%81%e9%80%89%e6%8b%a9%e9%80%9a%e8%bf%87%e4%bc%aa%e6%a0%87%e7%ad%be%e8%bf%9b%e8%a1%8c%e6%96%b9%e5%b7%ae%e5%88%86%e6%9e%90%e5%92%8c%e5%8d%a1%e6%96%b9%e6%a3%80%e9%aa%8c aria-label=特征选择：通过伪标签进行方差分析和卡方检验>特征选择：通过伪标签进行方差分析和卡方检验</a></li><li><a href=#%e5%88%86%e5%b8%83%e5%88%86%e6%9e%90 aria-label=分布分析>分布分析</a></li><li><a href=#%e8%81%9a%e7%b1%bb%e7%bb%93%e6%9e%9c%e5%8f%af%e8%a7%86%e5%8c%96 aria-label=聚类结果可视化>聚类结果可视化</a><ul><li><a href=#%e5%85%ad%e5%90%88%e4%b8%80%e5%8f%af%e8%a7%86%e5%8c%96 aria-label=六合一可视化>六合一可视化</a></li><li><a href=#pca%e4%b8%bb%e6%88%90%e5%88%86%e9%99%8d%e7%bb%b4 aria-label=PCA主成分降维>PCA主成分降维</a></li><li><a href=#pca%e4%b8%bb%e6%88%90%e5%88%86%e9%99%8d%e7%bb%b4-3d aria-label="PCA主成分降维 3D">PCA主成分降维 3D</a></li><li><a href=#t-sne%e9%99%8d%e7%bb%b4 aria-label=t-SNE降维>t-SNE降维</a></li><li><a href=#%e5%88%b6%e4%bd%9ct-sne-gif%e7%89%88%e6%9c%ac aria-label="制作t-SNE gif版本">制作t-SNE gif版本</a></li><li><a href=#%e4%bd%bf%e7%94%a8umap%e9%99%8d%e7%bb%b4 aria-label=使用UMAP降维>使用UMAP降维</a></li><li><a href=#umap-gif aria-label="UMAP GIF">UMAP GIF</a></li></ul></li><li><a href=#%e8%be%93%e5%87%ba%e8%81%9a%e7%b1%bb%e7%bb%93%e6%9e%9c aria-label=输出聚类结果>输出聚类结果</a></li><li><a href=#%e5%af%b9%e7%85%a7%e6%96%87%e6%9c%ac%e7%bc%96%e7%a0%81 aria-label=对照文本编码>对照文本编码</a></li></ul></li><li><a href=#%e5%9f%ba%e4%ba%8e%e5%af%86%e5%ba%a6%e8%81%9a%e7%b1%bb-dbscan aria-label="基于密度聚类 DBSCAN">基于密度聚类 DBSCAN</a></li></ul></li><li><a href=#%e5%86%b3%e7%ad%96%e6%a0%91 aria-label=决策树>决策树</a><ul><li><a href=#%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86-2 aria-label=基础知识>基础知识</a></li><li><a href=#cart%e5%86%b3%e7%ad%96%e6%a0%91%e5%86%b3%e5%ae%9a%e6%b8%b8%e5%ae%a2%e6%9d%a5%e4%b8%8d%e6%9d%a5%e7%9a%84%e7%94%bb%e5%83%8f%e5%9b%a0%e7%b4%a0%e5%88%86%e6%9e%90 aria-label=CART决策树：决定游客来不来的画像因素分析>CART决策树：决定游客来不来的画像因素分析</a><ul><li><a href=#%e5%86%b3%e7%ad%96%e6%a0%91%e5%a4%84%e7%90%86 aria-label=决策树处理>决策树处理</a></li><li><a href=#%e8%b6%85%e5%8f%82%e6%95%b0%e8%b0%83%e4%bc%98 aria-label=超参数调优>超参数调优</a></li></ul></li><li><a href=#cart%e5%86%b3%e7%ad%96%e6%a0%91%e6%b8%b8%e5%ae%a2%e6%bb%a1%e6%84%8f%e5%ba%a6%e5%9b%a0%e7%b4%a0%e5%88%86%e6%9e%90 aria-label=CART决策树：游客满意度因素分析>CART决策树：游客满意度因素分析</a></li></ul></li><li><a href=#%e7%81%b0%e8%89%b2%e5%85%b3%e8%81%94 aria-label=灰色关联>灰色关联</a><ul><li><a href=#%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86-3 aria-label=基础知识>基础知识</a></li><li><a href=#%e7%81%b0%e8%89%b2%e5%85%b3%e8%81%94%e6%8e%a2%e7%a9%b6%e6%bb%a1%e6%84%8f%e5%ba%a6%e7%9a%84%e6%8f%90%e5%8d%87%e5%92%8c%e6%89%93%e9%80%a0%e4%ba%a7%e5%93%81%e7%9a%84%e5%85%b3%e7%b3%bb aria-label=灰色关联：探究满意度的提升和打造产品的关系>灰色关联：探究满意度的提升和打造产品的关系</a></li></ul></li><li><a href=#%e5%85%b3%e8%81%94%e8%a7%84%e5%88%99 aria-label=关联规则>关联规则</a><ul><li><a href=#%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86-4 aria-label=基础知识>基础知识</a></li><li><a href=#%e5%85%b3%e8%81%94%e8%a7%84%e5%88%99%e5%88%86%e6%9e%90%e6%8e%a8%e8%8d%90%e6%84%8f%e6%84%bf%e5%88%86%e6%9e%90 aria-label=关联规则分析：推荐意愿分析>关联规则分析：推荐意愿分析</a></li><li><a href=#%e5%85%b3%e8%81%94%e8%a7%84%e5%88%99%e5%88%86%e6%9e%90%e6%97%85%e6%b8%b8%e8%b5%84%e6%ba%90%e4%ba%a7%e5%93%81%e5%bc%80%e5%8f%91 aria-label=关联规则分析：旅游资源产品开发>关联规则分析：旅游资源产品开发</a></li></ul></li><li><a href=#%e5%ae%a2%e6%88%b7%e7%b2%98%e6%80%a7%e5%88%86%e6%9e%90 aria-label=客户粘性分析>客户粘性分析</a><ul><li><a href=#%e5%af%b9df_gone%e8%bf%9b%e8%a1%8c%e8%81%9a%e7%b1%bb aria-label=对df_gone进行聚类>对df_gone进行聚类</a></li><li><a href=#%e5%8f%af%e8%a7%86%e5%8c%96 aria-label=可视化>可视化</a></li><li><a href=#%e6%8f%8f%e8%bf%b0%e6%80%a7%e7%bb%9f%e8%ae%a1 aria-label=描述性统计>描述性统计</a></li><li><a href=#%e9%9a%8f%e6%9c%ba%e6%a3%ae%e6%9e%97%e6%a8%a1%e5%9e%8b aria-label=随机森林模型>随机森林模型</a></li></ul></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h1 id=数据的预处理>数据的预处理<a hidden class=anchor aria-hidden=true href=#数据的预处理>#</a></h1><ul><li>删除答题时间小于1分钟的</li><li>对异常数据进行一些修改</li><li>检查有没有重复的问卷</li><li>保留研究所需要的列</li><li>处理公共题目缺失值</li><li>把数据分为总数据df，来过游客的数据df_gone，没有来过游客的数据df_not_gone，所有原始信息保留</li><li>对于df_gone和df_not_gone分别应用孤立森林清洗异常问卷</li><li>得到最后的数据集df, df_gone, df_not_gone</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pandas</span> <span class=k>as</span> <span class=nn>pd</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>read_csv</span><span class=p>(</span><span class=s1>&#39;乌蒙大草原旅游问卷调查_final.csv&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>df</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=o>.</span><span class=n>head</span><span class=p>()</span>
</span></span></code></pre></div><p>这两段代码主要是排除答题时间小于60s的问卷，不过问卷网上可以直接进行筛选</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 先把答题时间转换为时间格式</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>convert_to_seconds</span><span class=p>(</span><span class=n>time_str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s1>&#39;分&#39;</span> <span class=ow>in</span> <span class=n>time_str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>minutes</span><span class=p>,</span> <span class=n>seconds</span> <span class=o>=</span> <span class=n>time_str</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;分&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>int</span><span class=p>(</span><span class=n>minutes</span><span class=p>)</span> <span class=o>*</span> <span class=mi>60</span> <span class=o>+</span> <span class=nb>int</span><span class=p>(</span><span class=n>seconds</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>int</span><span class=p>(</span><span class=n>time_str</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=p>[</span><span class=s1>&#39;答题时长&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;答题时长&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>str</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=p>[</span><span class=s1>&#39;答题时长&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>to_timedelta</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;答题时长&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=n>convert_to_seconds</span><span class=p>),</span> <span class=n>unit</span><span class=o>=</span><span class=s1>&#39;s&#39;</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 删除答题时间小于1分钟的数据</span>
</span></span><span class=line><span class=cl><span class=n>df</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;答题时长&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=s1>&#39;00:01:00&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>df</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=o>.</span><span class=n>head</span><span class=p>()</span>
</span></span></code></pre></div><p>针对Q2年龄的一些数据问题进行处理</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>seaborn</span> <span class=k>as</span> <span class=nn>sns</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看Q2有没有非数字的数据</span>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=p>[</span><span class=s1>&#39;Q2&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>unique</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 修改数据</span>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=p>[</span><span class=s1>&#39;Q2&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;Q2&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;1995&#39;</span><span class=p>,</span> <span class=mi>29</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=p>[</span><span class=s1>&#39;Q2&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;Q2&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;50</span><span class=se>\n\n</span><span class=s1>50&#39;</span><span class=p>,</span> <span class=s1>&#39;50&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=p>[</span><span class=s1>&#39;Q2&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>unique</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=p>[</span><span class=s1>&#39;Q2&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>to_numeric</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;Q2&#39;</span><span class=p>],</span> <span class=n>errors</span><span class=o>=</span><span class=s1>&#39;coerce&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;Q2&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>dtypes</span><span class=p>)</span>
</span></span></code></pre></div><p>这里用使用 pandas 的 duplicated 函数来找出重复的行</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 检查df中是否有重复的行</span>
</span></span><span class=line><span class=cl><span class=n>df_duplicates</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>duplicated</span><span class=p>()</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;df中有</span><span class=si>{</span><span class=n>df_duplicates</span><span class=si>}</span><span class=s2>行重复的数据。&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 列名列表</span>
</span></span><span class=line><span class=cl><span class=n>columns</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;Q1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q3&#39;</span><span class=p>,</span> <span class=s1>&#39;Q3|open&#39;</span><span class=p>,</span> <span class=s1>&#39;Q4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q6|1|open&#39;</span><span class=p>,</span> <span class=s1>&#39;Q6|2|open&#39;</span><span class=p>,</span> <span class=s1>&#39;Q6|3|open&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|3&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|6&#39;</span><span class=p>,</span> <span class=s1>&#39;Q8&#39;</span><span class=p>,</span> <span class=s1>&#39;Q9&#39;</span><span class=p>,</span> <span class=s1>&#39;Q10&#39;</span><span class=p>,</span> <span class=s1>&#39;Q11&#39;</span><span class=p>,</span> <span class=s1>&#39;Q12&#39;</span><span class=p>,</span> <span class=s1>&#39;Q13&#39;</span><span class=p>,</span> <span class=s1>&#39;Q14&#39;</span><span class=p>,</span> <span class=s1>&#39;Q14|open&#39;</span><span class=p>,</span> <span class=s1>&#39;Q15&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|6&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|3&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|7&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|10&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|11&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|9&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|9|open&#39;</span><span class=p>,</span> <span class=s1>&#39;Q17&#39;</span><span class=p>,</span> <span class=s1>&#39;Q18&#39;</span><span class=p>,</span> <span class=s1>&#39;Q19&#39;</span><span class=p>,</span> <span class=s1>&#39;Q20&#39;</span><span class=p>,</span> <span class=s1>&#39;Q21|R1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q21|R2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q21|R3&#39;</span><span class=p>,</span> <span class=s1>&#39;Q21|R4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q21|R5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q22|1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q23&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R3&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R6&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R7&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R8&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R9&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R10&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R11&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R12&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R13&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R14&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R18&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R15&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R16&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R17&#39;</span><span class=p>,</span> <span class=s1>&#39;Q25|R5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q25|R8&#39;</span><span class=p>,</span> <span class=s1>&#39;Q25|R10&#39;</span><span class=p>,</span> <span class=s1>&#39;Q25|R13&#39;</span><span class=p>,</span> <span class=s1>&#39;Q25|R14&#39;</span><span class=p>,</span> <span class=s1>&#39;Q25|R15&#39;</span><span class=p>,</span> <span class=s1>&#39;Q25|R16&#39;</span><span class=p>,</span> <span class=s1>&#39;Q25|R17&#39;</span><span class=p>,</span> <span class=s1>&#39;Q25|R18&#39;</span><span class=p>,</span> <span class=s1>&#39;Q26|1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q27|1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q28|1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q28|23&#39;</span><span class=p>,</span> <span class=s1>&#39;Q28|21&#39;</span><span class=p>,</span> <span class=s1>&#39;Q28|22&#39;</span><span class=p>,</span> <span class=s1>&#39;Q28|24&#39;</span><span class=p>,</span> <span class=s1>&#39;Q28|25&#39;</span><span class=p>,</span> <span class=s1>&#39;Q28|4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q28|2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q28|26&#39;</span><span class=p>,</span> <span class=s1>&#39;Q28|27&#39;</span><span class=p>,</span> <span class=s1>&#39;Q28|28&#39;</span><span class=p>,</span> <span class=s1>&#39;Q28|29&#39;</span><span class=p>,</span> <span class=s1>&#39;Q28|35&#39;</span><span class=p>,</span> <span class=s1>&#39;Q28|34&#39;</span><span class=p>,</span> <span class=s1>&#39;Q28|34|open&#39;</span><span class=p>,</span> <span class=s1>&#39;Q29|R1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q29|R2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q29|R3&#39;</span><span class=p>,</span> <span class=s1>&#39;Q29|R4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q30|R1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q30|R2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q30|R3&#39;</span><span class=p>,</span> <span class=s1>&#39;Q30|R4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q30|R5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q30|R6&#39;</span><span class=p>,</span> <span class=s1>&#39;Q31|R1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q31|R2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q31|R8&#39;</span><span class=p>,</span> <span class=s1>&#39;Q31|R4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q31|R7&#39;</span><span class=p>,</span> <span class=s1>&#39;Q31|R9&#39;</span><span class=p>,</span> <span class=s1>&#39;Q31|R6&#39;</span><span class=p>,</span> <span class=s1>&#39;Q31|R5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q32|R3&#39;</span><span class=p>,</span> <span class=s1>&#39;Q32|R7&#39;</span><span class=p>,</span> <span class=s1>&#39;Q32|R4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q32|R5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q32|R1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q32|R2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q32|R6&#39;</span><span class=p>,</span> <span class=s1>&#39;Q33|R10&#39;</span><span class=p>,</span> <span class=s1>&#39;Q33|R12&#39;</span><span class=p>,</span> <span class=s1>&#39;Q33|R11&#39;</span><span class=p>,</span> <span class=s1>&#39;Q33|R4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q33|R5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q33|R1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q33|R8&#39;</span><span class=p>,</span> <span class=s1>&#39;Q33|R7&#39;</span><span class=p>,</span> <span class=s1>&#39;Q34&#39;</span><span class=p>,</span> <span class=s1>&#39;IP地址&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 找出重复的行</span>
</span></span><span class=line><span class=cl><span class=n>duplicates</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>duplicated</span><span class=p>(</span><span class=n>subset</span><span class=o>=</span><span class=n>columns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 只保留没有重复的行</span>
</span></span><span class=line><span class=cl><span class=n>df</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=o>~</span><span class=n>duplicates</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 打印数据的形状</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>df</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span>
</span></span></code></pre></div><p>去除不关心的列</p><p>答题序号 来源 开始时间 提交时间 答题时长 IP省份 IP城市 IP地址 浏览器 操作系统</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>columns_to_drop</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;答题序号&#39;</span><span class=p>,</span> <span class=s1>&#39;来源&#39;</span><span class=p>,</span> <span class=s1>&#39;开始时间&#39;</span><span class=p>,</span> <span class=s1>&#39;提交时间&#39;</span><span class=p>,</span> <span class=s1>&#39;答题时长&#39;</span><span class=p>,</span> <span class=s1>&#39;IP省份&#39;</span><span class=p>,</span> <span class=s1>&#39;IP城市&#39;</span><span class=p>,</span> <span class=s1>&#39;IP地址&#39;</span><span class=p>,</span> <span class=s1>&#39;浏览器&#39;</span><span class=p>,</span> <span class=s1>&#39;操作系统&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>df</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>drop</span><span class=p>(</span><span class=n>columns_to_drop</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>df</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=o>.</span><span class=n>head</span><span class=p>()</span>
</span></span></code></pre></div><h2 id=检查公共题目有没有缺失值>检查公共题目有没有缺失值<a hidden class=anchor aria-hidden=true href=#检查公共题目有没有缺失值>#</a></h2><p>公共题目：&lsquo;Q1&rsquo;, &lsquo;Q2&rsquo;, &lsquo;Q3&rsquo;, &lsquo;Q3|open&rsquo;, &lsquo;Q4&rsquo;, &lsquo;Q5&rsquo;, &lsquo;Q6|1|open&rsquo;, &lsquo;Q6|2|open&rsquo;, &lsquo;Q6|3|open&rsquo;, &lsquo;Q7|1&rsquo;, &lsquo;Q7|4&rsquo;, &lsquo;Q7|2&rsquo;, &lsquo;Q7|3&rsquo;, &lsquo;Q7|5&rsquo;, &lsquo;Q7|6&rsquo;, &lsquo;Q8&rsquo;, &lsquo;Q9&rsquo;, &lsquo;Q10&rsquo;, &lsquo;Q11&rsquo;, &lsquo;Q12&rsquo;, &lsquo;Q13&rsquo;, &lsquo;Q14&rsquo;, &lsquo;Q14|open&rsquo;, &lsquo;Q15&rsquo;, &lsquo;Q16|6&rsquo;, &lsquo;Q16|1&rsquo;, &lsquo;Q16|2&rsquo;, &lsquo;Q16|3&rsquo;, &lsquo;Q16|7&rsquo;, &lsquo;Q16|4&rsquo;, &lsquo;Q16|10&rsquo;, &lsquo;Q16|11&rsquo;, &lsquo;Q16|9&rsquo;, &lsquo;Q16|9|open&rsquo;, &lsquo;Q17&rsquo;,Q30|R1,Q30|R2,Q30|R3,Q30|R4,Q30|R5,Q30|R6,Q33|R10,Q33|R12,Q33|R11,Q33|R4,Q33|R5,Q33|R1,Q33|R8,Q33|R7</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>common_columns</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;Q1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q3&#39;</span><span class=p>,</span> <span class=s1>&#39;Q3|open&#39;</span><span class=p>,</span> <span class=s1>&#39;Q4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q6|1|open&#39;</span><span class=p>,</span> <span class=s1>&#39;Q6|2|open&#39;</span><span class=p>,</span> <span class=s1>&#39;Q6|3|open&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|3&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|6&#39;</span><span class=p>,</span> <span class=s1>&#39;Q8&#39;</span><span class=p>,</span> <span class=s1>&#39;Q9&#39;</span><span class=p>,</span> <span class=s1>&#39;Q10&#39;</span><span class=p>,</span> <span class=s1>&#39;Q11&#39;</span><span class=p>,</span> <span class=s1>&#39;Q12&#39;</span><span class=p>,</span> <span class=s1>&#39;Q13&#39;</span><span class=p>,</span> <span class=s1>&#39;Q14&#39;</span><span class=p>,</span> <span class=s1>&#39;Q14|open&#39;</span><span class=p>,</span> <span class=s1>&#39;Q15&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|6&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|3&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|7&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|10&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|11&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|9&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|9|open&#39;</span><span class=p>,</span> <span class=s1>&#39;Q17&#39;</span><span class=p>,</span> <span class=s1>&#39;Q30|R1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q30|R2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q30|R3&#39;</span><span class=p>,</span> <span class=s1>&#39;Q30|R4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q30|R5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q30|R6&#39;</span><span class=p>,</span> <span class=s1>&#39;Q33|R10&#39;</span><span class=p>,</span> <span class=s1>&#39;Q33|R12&#39;</span><span class=p>,</span> <span class=s1>&#39;Q33|R11&#39;</span><span class=p>,</span> <span class=s1>&#39;Q33|R4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q33|R5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q33|R1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q33|R8&#39;</span><span class=p>,</span> <span class=s1>&#39;Q33|R7&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>missing_values</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>common_columns</span><span class=p>]</span><span class=o>.</span><span class=n>isnull</span><span class=p>()</span><span class=o>.</span><span class=n>any</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>missing_values</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>missing_rows</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;Q2&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>isnull</span><span class=p>()]</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>missing_rows</span><span class=p>)</span>
</span></span></code></pre></div><p>依照Q17的选项1（去过），2（没去过）把数据分为去过的和没有去过的，同时保留原始数据</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 依照Q17的选项1（去过），2（没去过）把数据分为去过的和没有去过的，同时保留原始数据</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;Q17&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>value_counts</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 去过的数据</span>
</span></span><span class=line><span class=cl><span class=n>df_gone</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;Q17&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span> <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 没去过的数据</span>
</span></span><span class=line><span class=cl><span class=n>df_not_gone</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;Q17&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;-&#34;</span><span class=o>*</span><span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;df_gone shape&#34;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=n>df_gone</span><span class=o>.</span><span class=n>shape</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;df_not_gone shape&#34;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=n>df_not_gone</span><span class=o>.</span><span class=n>shape</span><span class=p>))</span>
</span></span></code></pre></div><h2 id=孤立森林>孤立森林<a hidden class=anchor aria-hidden=true href=#孤立森林>#</a></h2><p>尝试使用孤立森林找出异常的问卷数据，并删除异常数据</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 使用孤立森林算法检测异常值</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.ensemble</span> <span class=kn>import</span> <span class=n>IsolationForest</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 对于去过的</span>
</span></span><span class=line><span class=cl><span class=c1># 屏蔽开放性问题</span>
</span></span><span class=line><span class=cl><span class=n>df_gone_IsolationForest</span> <span class=o>=</span> <span class=n>df_gone</span><span class=o>.</span><span class=n>drop</span><span class=p>([</span><span class=s1>&#39;Q3|open&#39;</span><span class=p>,</span> <span class=s1>&#39;Q6|1|open&#39;</span><span class=p>,</span> <span class=s1>&#39;Q6|2|open&#39;</span><span class=p>,</span> <span class=s1>&#39;Q6|3|open&#39;</span><span class=p>,</span> <span class=s1>&#39;Q14|open&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|9|open&#39;</span><span class=p>,</span> <span class=s1>&#39;Q28|34|open&#39;</span><span class=p>,</span><span class=s1>&#39;Q34&#39;</span><span class=p>],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;df_gone_IsolationForest shape&#34;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=n>df_gone_IsolationForest</span><span class=o>.</span><span class=n>shape</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1># 屏蔽没有去过的问题，会出现nan</span>
</span></span><span class=line><span class=cl><span class=n>df_gone_IsolationForest</span> <span class=o>=</span> <span class=n>df_gone_IsolationForest</span><span class=o>.</span><span class=n>drop</span><span class=p>([</span><span class=s1>&#39;Q29|R1&#39;</span><span class=p>,</span><span class=s1>&#39;Q29|R2&#39;</span><span class=p>,</span><span class=s1>&#39;Q29|R3&#39;</span><span class=p>,</span><span class=s1>&#39;Q29|R4&#39;</span><span class=p>],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;df_gone_IsolationForest shape&#34;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=n>df_gone_IsolationForest</span><span class=o>.</span><span class=n>shape</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用中位数填充数值列的空值</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=n>df_gone_IsolationForest</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>df_gone_IsolationForest</span><span class=p>[</span><span class=n>col</span><span class=p>]</span><span class=o>.</span><span class=n>dtype</span> <span class=o>==</span> <span class=s1>&#39;int64&#39;</span> <span class=ow>or</span> <span class=n>df_gone_IsolationForest</span><span class=p>[</span><span class=n>col</span><span class=p>]</span><span class=o>.</span><span class=n>dtype</span> <span class=o>==</span> <span class=s1>&#39;float64&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>         <span class=n>df_gone_IsolationForest</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>df_gone_IsolationForest</span><span class=p>[</span><span class=n>col</span><span class=p>]</span><span class=o>.</span><span class=n>fillna</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=n>col</span><span class=p>]</span><span class=o>.</span><span class=n>median</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用最常见的值填充类别列的空值</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=n>df_gone_IsolationForest</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>df_gone_IsolationForest</span><span class=p>[</span><span class=n>col</span><span class=p>]</span><span class=o>.</span><span class=n>dtype</span> <span class=o>==</span> <span class=s1>&#39;object&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>df_gone_IsolationForest</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>df_gone_IsolationForest</span><span class=p>[</span><span class=n>col</span><span class=p>]</span><span class=o>.</span><span class=n>fillna</span><span class=p>(</span><span class=n>df_gone_IsolationForest</span><span class=p>[</span><span class=n>col</span><span class=p>]</span><span class=o>.</span><span class=n>mode</span><span class=p>()[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl><span class=c1># 对于没有去过的</span>
</span></span><span class=line><span class=cl><span class=c1># 屏蔽开放性问题</span>
</span></span><span class=line><span class=cl><span class=n>df_not_gone_IsolationForest</span> <span class=o>=</span> <span class=n>df_not_gone</span><span class=o>.</span><span class=n>drop</span><span class=p>([</span><span class=s1>&#39;Q3|open&#39;</span><span class=p>,</span> <span class=s1>&#39;Q6|1|open&#39;</span><span class=p>,</span> <span class=s1>&#39;Q6|2|open&#39;</span><span class=p>,</span> <span class=s1>&#39;Q6|3|open&#39;</span><span class=p>,</span> <span class=s1>&#39;Q14|open&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|9|open&#39;</span><span class=p>,</span> <span class=s1>&#39;Q28|34|open&#39;</span><span class=p>,</span><span class=s1>&#39;Q34&#39;</span><span class=p>,],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;df_not_gone_IsolationForest shape&#34;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=n>df_not_gone_IsolationForest</span><span class=o>.</span><span class=n>shape</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1># 屏蔽去过的问题，会出现nan</span>
</span></span><span class=line><span class=cl><span class=n>columns_to_drop_1</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;Q19&#39;</span><span class=p>,</span><span class=s1>&#39;Q20&#39;</span><span class=p>,</span><span class=s1>&#39;Q21|R1&#39;</span><span class=p>,</span><span class=s1>&#39;Q21|R2&#39;</span><span class=p>,</span><span class=s1>&#39;Q21|R3&#39;</span><span class=p>,</span><span class=s1>&#39;Q21|R4&#39;</span><span class=p>,</span><span class=s1>&#39;Q21|R5&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>columns_to_drop_2</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;Q24|R1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R3&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R6&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R7&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R8&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R9&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R10&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R11&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R12&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R13&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R14&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R18&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R15&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R16&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R17&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>columns_to_drop_3</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;Q25|R5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q25|R8&#39;</span><span class=p>,</span> <span class=s1>&#39;Q25|R10&#39;</span><span class=p>,</span> <span class=s1>&#39;Q25|R13&#39;</span><span class=p>,</span> <span class=s1>&#39;Q25|R14&#39;</span><span class=p>,</span> <span class=s1>&#39;Q25|R15&#39;</span><span class=p>,</span> <span class=s1>&#39;Q25|R16&#39;</span><span class=p>,</span> <span class=s1>&#39;Q25|R17&#39;</span><span class=p>,</span> <span class=s1>&#39;Q25|R18&#39;</span><span class=p>,</span> <span class=s1>&#39;Q26|1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q27|1&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>columns_to_drop_4</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;Q28|1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q28|23&#39;</span><span class=p>,</span> <span class=s1>&#39;Q28|21&#39;</span><span class=p>,</span> <span class=s1>&#39;Q28|22&#39;</span><span class=p>,</span> <span class=s1>&#39;Q28|24&#39;</span><span class=p>,</span> <span class=s1>&#39;Q28|25&#39;</span><span class=p>,</span> <span class=s1>&#39;Q28|4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q28|2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q28|26&#39;</span><span class=p>,</span> <span class=s1>&#39;Q28|27&#39;</span><span class=p>,</span> <span class=s1>&#39;Q28|28&#39;</span><span class=p>,</span> <span class=s1>&#39;Q28|29&#39;</span><span class=p>,</span> <span class=s1>&#39;Q28|35&#39;</span><span class=p>,</span> <span class=s1>&#39;Q28|34&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>columns_to_drop_5</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;Q31|R1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q31|R2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q31|R8&#39;</span><span class=p>,</span> <span class=s1>&#39;Q31|R4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q31|R7&#39;</span><span class=p>,</span> <span class=s1>&#39;Q31|R9&#39;</span><span class=p>,</span> <span class=s1>&#39;Q31|R6&#39;</span><span class=p>,</span> <span class=s1>&#39;Q31|R5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q32|R3&#39;</span><span class=p>,</span> <span class=s1>&#39;Q32|R7&#39;</span><span class=p>,</span> <span class=s1>&#39;Q32|R4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q32|R5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q32|R1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q32|R2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q32|R6&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>columns_to_drop</span> <span class=o>=</span> <span class=n>columns_to_drop_1</span> <span class=o>+</span> <span class=n>columns_to_drop_2</span> <span class=o>+</span> <span class=n>columns_to_drop_3</span> <span class=o>+</span> <span class=n>columns_to_drop_4</span> <span class=o>+</span> <span class=n>columns_to_drop_5</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>df_not_gone_IsolationForest</span> <span class=o>=</span> <span class=n>df_not_gone_IsolationForest</span><span class=o>.</span><span class=n>drop</span><span class=p>(</span><span class=n>columns_to_drop</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;df_not_gone_IsolationForest shape&#34;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=n>df_not_gone_IsolationForest</span><span class=o>.</span><span class=n>shape</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用中位数填充数值列的空值</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=n>df_not_gone_IsolationForest</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>df_not_gone_IsolationForest</span><span class=p>[</span><span class=n>col</span><span class=p>]</span><span class=o>.</span><span class=n>dtype</span> <span class=o>==</span> <span class=s1>&#39;int64&#39;</span> <span class=ow>or</span> <span class=n>df_not_gone_IsolationForest</span><span class=p>[</span><span class=n>col</span><span class=p>]</span><span class=o>.</span><span class=n>dtype</span> <span class=o>==</span> <span class=s1>&#39;float64&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>         <span class=n>df_not_gone_IsolationForest</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>df_not_gone_IsolationForest</span><span class=p>[</span><span class=n>col</span><span class=p>]</span><span class=o>.</span><span class=n>fillna</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=n>col</span><span class=p>]</span><span class=o>.</span><span class=n>median</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用最常见的值填充类别列的空值</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=n>df_not_gone_IsolationForest</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>df_not_gone_IsolationForest</span><span class=p>[</span><span class=n>col</span><span class=p>]</span><span class=o>.</span><span class=n>dtype</span> <span class=o>==</span> <span class=s1>&#39;object&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>df_not_gone_IsolationForest</span><span class=p>[</span><span class=n>col</span><span class=p>]</span> <span class=o>=</span> <span class=n>df_not_gone_IsolationForest</span><span class=p>[</span><span class=n>col</span><span class=p>]</span><span class=o>.</span><span class=n>fillna</span><span class=p>(</span><span class=n>df_not_gone_IsolationForest</span><span class=p>[</span><span class=n>col</span><span class=p>]</span><span class=o>.</span><span class=n>mode</span><span class=p>()[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>df_gone_IsolationForest</span><span class=o>.</span><span class=n>head</span><span class=p>(</span><span class=mi>100</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>df_not_gone_IsolationForest</span><span class=o>.</span><span class=n>head</span><span class=p>(</span><span class=mi>100</span><span class=p>))</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>X</span> <span class=o>=</span> <span class=n>df_gone_IsolationForest</span><span class=o>.</span><span class=n>values</span>
</span></span><span class=line><span class=cl><span class=n>Y</span> <span class=o>=</span> <span class=n>df_not_gone_IsolationForest</span><span class=o>.</span><span class=n>values</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建孤立森林模型，contamination参数表示你预计的异常点的比例</span>
</span></span><span class=line><span class=cl><span class=n>clf_X</span> <span class=o>=</span> <span class=n>IsolationForest</span><span class=p>(</span><span class=n>contamination</span><span class=o>=</span><span class=mf>0.01</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>clf_Y</span> <span class=o>=</span> <span class=n>IsolationForest</span><span class=p>(</span><span class=n>contamination</span><span class=o>=</span><span class=mf>0.01</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 训练模型</span>
</span></span><span class=line><span class=cl><span class=n>clf_X</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span><span class=n>X</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>clf_Y</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span><span class=n>Y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 预测异常点，返回1表示正常点，-1表示异常点</span>
</span></span><span class=line><span class=cl><span class=n>pred_X</span> <span class=o>=</span> <span class=n>clf_X</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>X</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>pred_Y</span> <span class=o>=</span> <span class=n>clf_Y</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>Y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 将预测结果添加到数据框中</span>
</span></span><span class=line><span class=cl><span class=n>df_gone_IsolationForest</span><span class=p>[</span><span class=s1>&#39;anomaly&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>pred_X</span>
</span></span><span class=line><span class=cl><span class=n>df_not_gone_IsolationForest</span><span class=p>[</span><span class=s1>&#39;anomaly&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>pred_Y</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 打印出预测结果</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;-&#34;</span><span class=o>*</span><span class=mi>100</span><span class=o>+</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>去过的数据异常值预测结果：</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>df_gone_IsolationForest</span><span class=p>[</span><span class=s1>&#39;anomaly&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>value_counts</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;-&#34;</span><span class=o>*</span><span class=mi>100</span><span class=o>+</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>异常数据：</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>df_gone_IsolationForest</span><span class=p>[</span><span class=n>df_gone_IsolationForest</span><span class=p>[</span><span class=s1>&#39;anomaly&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;-&#34;</span><span class=o>*</span><span class=mi>100</span><span class=o>+</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>没有去过的数据异常值预测结果：</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>df_not_gone_IsolationForest</span><span class=p>[</span><span class=s1>&#39;anomaly&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>value_counts</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;-&#34;</span><span class=o>*</span><span class=mi>100</span><span class=o>+</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>异常数据：</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>df_not_gone_IsolationForest</span><span class=p>[</span><span class=n>df_not_gone_IsolationForest</span><span class=p>[</span><span class=s1>&#39;anomaly&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 在原来的df上删除异常值，先找到异常值的序号</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;删除异常值前df的形状&#34;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=n>df</span><span class=o>.</span><span class=n>shape</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>df</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>drop</span><span class=p>(</span><span class=n>df_gone_IsolationForest</span><span class=p>[</span><span class=n>df_gone_IsolationForest</span><span class=p>[</span><span class=s1>&#39;anomaly&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>index</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>df</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>drop</span><span class=p>(</span><span class=n>df_not_gone_IsolationForest</span><span class=p>[</span><span class=n>df_not_gone_IsolationForest</span><span class=p>[</span><span class=s1>&#39;anomaly&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>index</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;删除异常值后df的形状&#34;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=n>df</span><span class=o>.</span><span class=n>shape</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1># 在df_gone和df_not_gone上删除异常值</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;删除异常值前df_gone的形状&#34;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=n>df_gone</span><span class=o>.</span><span class=n>shape</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>df_gone</span> <span class=o>=</span> <span class=n>df_gone</span><span class=o>.</span><span class=n>drop</span><span class=p>(</span><span class=n>df_gone_IsolationForest</span><span class=p>[</span><span class=n>df_gone_IsolationForest</span><span class=p>[</span><span class=s1>&#39;anomaly&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>index</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;删除异常值后df_gone的形状&#34;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=n>df_gone</span><span class=o>.</span><span class=n>shape</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;删除异常值前df_not_gone的形状&#34;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=n>df_not_gone</span><span class=o>.</span><span class=n>shape</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>df_not_gone</span> <span class=o>=</span> <span class=n>df_not_gone</span><span class=o>.</span><span class=n>drop</span><span class=p>(</span><span class=n>df_not_gone_IsolationForest</span><span class=p>[</span><span class=n>df_not_gone_IsolationForest</span><span class=p>[</span><span class=s1>&#39;anomaly&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>index</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;删除异常值后df_not_gone的形状&#34;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=n>df_not_gone</span><span class=o>.</span><span class=n>shape</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 删除异常值</span>
</span></span><span class=line><span class=cl><span class=n>df_gone_IsolationForest</span> <span class=o>=</span> <span class=n>df_gone_IsolationForest</span><span class=p>[</span><span class=n>df_gone_IsolationForest</span><span class=p>[</span><span class=s1>&#39;anomaly&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>df_not_gone_IsolationForest</span> <span class=o>=</span> <span class=n>df_not_gone_IsolationForest</span><span class=p>[</span><span class=n>df_not_gone_IsolationForest</span><span class=p>[</span><span class=s1>&#39;anomaly&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>]</span>
</span></span></code></pre></div><p>再次检查有没有重复的行</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 检查df中是否有重复的行</span>
</span></span><span class=line><span class=cl><span class=n>df_duplicates</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>duplicated</span><span class=p>()</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;df中有</span><span class=si>{</span><span class=n>df_duplicates</span><span class=si>}</span><span class=s2>行重复的数据。&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 检查df_gone中是否有重复的行</span>
</span></span><span class=line><span class=cl><span class=n>df_gone_duplicates</span> <span class=o>=</span> <span class=n>df_gone</span><span class=o>.</span><span class=n>duplicated</span><span class=p>()</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;df_gone中有</span><span class=si>{</span><span class=n>df_gone_duplicates</span><span class=si>}</span><span class=s2>行重复的数据。&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 检查df_not_gone中是否有重复的行</span>
</span></span><span class=line><span class=cl><span class=n>df_not_gone_duplicates</span> <span class=o>=</span> <span class=n>df_not_gone</span><span class=o>.</span><span class=n>duplicated</span><span class=p>()</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;df_not_gone中有</span><span class=si>{</span><span class=n>df_not_gone_duplicates</span><span class=si>}</span><span class=s2>行重复的数据。&#34;</span><span class=p>)</span>
</span></span></code></pre></div><h2 id=最终数据集>最终数据集<a hidden class=anchor aria-hidden=true href=#最终数据集>#</a></h2><ul><li>df，全体的数据集</li><li>df_gone，去过的游客的数据集</li><li>df_not_gone，没有去过的游客数据集</li></ul><p>PS:所有的数据都在</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>df</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=o>.</span><span class=n>head</span><span class=p>()</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>df_gone</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>df_gone</span><span class=o>.</span><span class=n>head</span><span class=p>()</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>df_not_gone</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>df_not_gone</span><span class=o>.</span><span class=n>head</span><span class=p>()</span>
</span></span></code></pre></div><h1 id=数据分析>数据分析<a hidden class=anchor aria-hidden=true href=#数据分析>#</a></h1><hr><p><strong>对所有游客</strong></p><p>基本游客画像 Q1-Q16</p><p>[未来打造项目的喜爱程度] Q30</p><p><strong>聚类方法：</strong></p><ul><li><p>k-prototypes</p><p>感觉对于分类的效果不是很好，另外地理位置信息因为分成了三列，所以在聚类之后会出现不匹配的现象；
使用肘部图确定的n=6；使用轮廓系数确定n=1；</p></li><li><p>基于密度聚类DBSCAN</p></li></ul><hr><p><strong>对去过的游客进行分析</strong></p><p>游玩乌蒙大草原的基本情况:Q18 Q19 Q20</p><ul><li>因子分析 Q21 （交给wyx了）</li><li>摆渡车 Q22 Q23</li><li>结构方程 Q24 Q25 (交给wyx了)</li></ul><p>再次游玩意愿 Q26</p><ul><li>关联分析[推荐意愿] Q27 Q28</li><li>[盘州特产、非遗文化] Q31 Q32</li><li>[改进建议] Q34</li></ul><hr><p><strong>针对没有去过的游客</strong></p><ul><li>决策树[未前往原因] Q29</li></ul><hr><h2 id=结构方程>结构方程<a hidden class=anchor aria-hidden=true href=#结构方程>#</a></h2><p>结构方程模型（Structural Equation Modeling, SEM）是一种复杂的统计分析方法，用于研究变量之间的因果关系。它能够同时处理测量误差和多变量之间的关系，非常适用于社会科学、行为科学、营销研究、教育研究等领域。</p><h3 id=基础知识>基础知识<a hidden class=anchor aria-hidden=true href=#基础知识>#</a></h3><p><strong>需要的数据类型</strong></p><ul><li><strong>量表数据</strong>：SEM通常需要量表数据，即通过问卷调查收集的、用于测量潜在变量（如态度、满意度、感知质量等）的多个观察指标。</li><li><strong>连续数据</strong>：SEM分析通常假定数据是连续的，特别是当使用最大似然估计方法时。</li><li><strong>正态分布的数据</strong>：SEM的某些估计方法（如最大似然估计）要求数据近似正态分布。</li></ul><p><strong>作用</strong></p><ul><li><strong>因果关系分析</strong>：SEM允许研究者构建和测试变量之间的因果关系模型。</li><li><strong>潜在变量建模</strong>：它可以用来测量不易直接观察的潜在变量，并分析这些潜在变量之间的关系。</li><li><strong>同时测试多个假设</strong>：SEM能够在单一模型中同时测试多个假设，提供全面的分析视角。</li></ul><p><strong>实现方法</strong></p><ul><li><strong>协方差基础的SEM</strong>（如LISREL，AMOS）：通过构建协方差矩阵并使用最大似然估计或其他方法来估计模型参数。</li><li><strong>基于方差的SEM</strong>（如PLS-SEM）：主要关注构建模型的预测能力，适用于理论发展阶段较早、样本较小或数据分布假设不严格的情况。</li></ul><h2 id=聚类分析>聚类分析<a hidden class=anchor aria-hidden=true href=#聚类分析>#</a></h2><h3 id=基础知识-1>基础知识<a hidden class=anchor aria-hidden=true href=#基础知识-1>#</a></h3><h4 id=方法分类>方法分类<a hidden class=anchor aria-hidden=true href=#方法分类>#</a></h4><p>聚类分析是一种无监督学习方法，旨在将数据集中的对象分组成若干个簇，使得同一簇内的对象相似度较高，而不同簇内的对象相似度较低。它在市场细分、社会网络分析、生物信息学、图像分割等领域有广泛应用。根据聚类的方法和原理，主要可以分为以下几类：</p><ol><li><p><strong>划分方法</strong>：这种方法将数据集划分成若干个非重叠的簇，使得每个数据对象恰好属于一个簇。最著名的划分方法是K-均值聚类（K-means clustering），它通过迭代地将数据点分配给最近的簇中心，然后更新簇中心，直到满足停止条件。</p></li><li><p><strong>层次方法</strong>：层次聚类方法根据对象之间的相似性逐渐合并或分裂簇。它们可以是凝聚的（自底向上），从每个对象作为单个簇开始，逐步合并到一个全体簇；或是分裂的（自顶向下），从所有对象组成一个簇开始，逐步分裂成更小的簇。层次方法的一个优点是可以形成簇的层次结构，非常适合解释性分析。</p></li><li><p><strong>基于密度的方法</strong>：这些方法根据数据空间的密度分布来形成簇。它们能够识别任意形状的簇，并且对噪声和孤立点有良好的鲁棒性。著名的算法包括DBSCAN（Density-Based Spatial Clustering of Applications with Noise）和OPTICS（Ordering Points To Identify the Clustering Structure）。</p></li><li><p><strong>基于网格的方法</strong>：网格聚类算法将数据空间划分为有限数量的单元，形成一个网格结构，并在这个结构上进行聚类。这些方法的优点是计算效率高，特别适合处理大数据集。STING（Statistical Information Grid）和WaveCluster是两种典型的基于网格的聚类方法。</p></li><li><p><strong>基于模型的方法</strong>：这些方法基于统计模型将数据分配给簇，最常见的是基于高斯混合模型（Gaussian Mixture Models, GMM）的聚类。这类方法的优点是可以提供丰富的统计信息，对簇的形状和大小有更灵活的假设。</p></li></ol><h4 id=比较-k-prototypes--k-means>比较 K-prototypes & K-means<a hidden class=anchor aria-hidden=true href=#比较-k-prototypes--k-means>#</a></h4><p>K-原型（K-prototypes）聚类算法是K-均值（K-means）聚类算法的扩展，专门设计来处理同时包含数值数据和分类数据的情况。这两种算法的主要区别在于它们处理数据类型的方式和计算簇中心（或称为原型）的方法。</p><p><strong>K-means聚类算法</strong></p><ul><li><strong>数据类型</strong>：K-means主要适用于数值型数据。它通过计算数据点与簇中心之间的欧氏距离来划分簇，以最小化簇内距离的总和。</li><li><strong>簇中心</strong>：K-means的簇中心是簇内所有点的均值。</li><li><strong>限制</strong>：K-means对分类数据处理不佳，因为分类数据（如性别、职业等）没有自然的数值中心，且不能通过常规的欧氏距离来衡量相似性。</li></ul><p><strong>K-原型聚类算法</strong></p><ul><li><strong>数据类型</strong>：K-原型算法可以同时处理数值数据和分类数据。这使得它非常适用于现实世界的数据集，这些数据集通常包含这两种类型的数据。</li><li><strong>簇中心和距离计算</strong>：K-原型算法通过结合数值数据的均值和分类数据的众数来计算簇中心。同时，它使用特殊的距离度量来计算数值数据和分类数据的相似性，常见的方法是将数值数据的欧式距离和分类数据的汉明距离（Hamming distance）进行组合。</li><li><strong>优势</strong>：K-原型能够处理混合数据类型，使其更适合多种数据集，尤其是那些同时包含数值和分类属性的数据集。</li></ul><p><strong>应用场景对比</strong></p><ul><li>当数据集仅包含数值型数据时，K-means是一个简单且有效的选择。</li><li>当数据集包含数值数据和分类数据时，K-原型算法是更合适的选择，因为它能够同时处理这两种数据类型，并考虑它们在数据集中的相互作用。</li></ul><p>总结来说，K-原型聚类算法是对K-means的重要补充，它扩展了聚类分析的应用范围，使之能够有效处理更加复杂和多样化的数据集。</p><h3 id=k-prototypes-聚类所有游客来过的游客画像>K-Prototypes 聚类：所有游客/来过的游客画像<a hidden class=anchor aria-hidden=true href=#k-prototypes-聚类所有游客来过的游客画像>#</a></h3><p><em>总的题目：</em>
<em>&lsquo;Q1&rsquo;, &lsquo;Q2&rsquo;, &lsquo;Q3&rsquo;, &lsquo;Q3|open&rsquo;, &lsquo;Q4&rsquo;, &lsquo;Q5&rsquo;, &lsquo;Q6|1|open&rsquo;, &lsquo;Q6|2|open&rsquo;, &lsquo;Q6|3|open&rsquo;, &lsquo;Q7|1&rsquo;, &lsquo;Q7|4&rsquo;, &lsquo;Q7|2&rsquo;, &lsquo;Q7|3&rsquo;, &lsquo;Q7|5&rsquo;, &lsquo;Q7|6&rsquo;, &lsquo;Q8&rsquo;, &lsquo;Q9&rsquo;, &lsquo;Q10&rsquo;, &lsquo;Q11&rsquo;, &lsquo;Q12&rsquo;, &lsquo;Q13&rsquo;, &lsquo;Q14&rsquo;, &lsquo;Q14|open&rsquo;, &lsquo;Q15&rsquo;, &lsquo;Q16|6&rsquo;, &lsquo;Q16|1&rsquo;, &lsquo;Q16|2&rsquo;, &lsquo;Q16|3&rsquo;, &lsquo;Q16|7&rsquo;, &lsquo;Q16|4&rsquo;, &lsquo;Q16|10&rsquo;, &lsquo;Q16|11&rsquo;, &lsquo;Q16|9&rsquo;, &lsquo;Q16|9|open&rsquo;</em></p><p><em>对于Q3,Q14,Q16的其他选项对于聚类来说意义不大且不好处理，直接忽略</em></p><h4 id=确定聚类簇数>确定聚类簇数<a hidden class=anchor aria-hidden=true href=#确定聚类簇数>#</a></h4><h5 id=使用肘部图确定最佳簇数>使用肘部图确定最佳簇数<a hidden class=anchor aria-hidden=true href=#使用肘部图确定最佳簇数>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 去过的游客 df_gone</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>kmodes.kprototypes</span> <span class=kn>import</span> <span class=n>KPrototypes</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>columns</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;Q1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q3&#39;</span><span class=p>,</span> <span class=s1>&#39;Q4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q5&#39;</span><span class=p>,</span>  <span class=s1>&#39;Q7|1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|3&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|6&#39;</span><span class=p>,</span> <span class=s1>&#39;Q8&#39;</span><span class=p>,</span> <span class=s1>&#39;Q9&#39;</span><span class=p>,</span> <span class=s1>&#39;Q10&#39;</span><span class=p>,</span> <span class=s1>&#39;Q11&#39;</span><span class=p>,</span> <span class=s1>&#39;Q12&#39;</span><span class=p>,</span> <span class=s1>&#39;Q13&#39;</span><span class=p>,</span> <span class=s1>&#39;Q14&#39;</span><span class=p>,</span> <span class=s1>&#39;Q15&#39;</span><span class=p>,</span> <span class=s1>&#39;Q19&#39;</span><span class=p>,</span> <span class=s1>&#39;Q20&#39;</span><span class=p>,</span><span class=s1>&#39;Q21|R1&#39;</span><span class=p>,</span><span class=s1>&#39;Q21|R2&#39;</span><span class=p>,</span><span class=s1>&#39;Q21|R3&#39;</span><span class=p>,</span><span class=s1>&#39;Q21|R4&#39;</span><span class=p>,</span><span class=s1>&#39;Q21|R5&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>numerical_columns</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;Q2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q5&#39;</span><span class=p>,</span><span class=s1>&#39;Q7|1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|3&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|6&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 类别型列</span>
</span></span><span class=line><span class=cl><span class=n>categorical_columns</span> <span class=o>=</span> <span class=p>[</span><span class=n>col</span> <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=n>columns</span> <span class=k>if</span> <span class=n>col</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>numerical_columns</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 将类别型列的索引转换为数字</span>
</span></span><span class=line><span class=cl><span class=n>categorical_columns_indices</span> <span class=o>=</span> <span class=p>[</span><span class=n>columns</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=n>col</span><span class=p>)</span> <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=n>categorical_columns</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>costs</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>n_clusters</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>10</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>kproto</span> <span class=o>=</span> <span class=n>KPrototypes</span><span class=p>(</span><span class=n>n_clusters</span><span class=o>=</span><span class=n>n_clusters</span><span class=p>,</span> <span class=n>init</span><span class=o>=</span><span class=s1>&#39;Cao&#39;</span><span class=p>,</span> <span class=n>verbose</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>kproto</span><span class=o>.</span><span class=n>fit_predict</span><span class=p>(</span><span class=n>df_gone</span><span class=p>[</span><span class=n>columns</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> <span class=n>categorical</span><span class=o>=</span><span class=n>categorical_columns_indices</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>costs</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>kproto</span><span class=o>.</span><span class=n>cost_</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 绘制成本随簇数变化的图</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>10</span><span class=p>),</span> <span class=n>costs</span><span class=p>,</span> <span class=s1>&#39;o-&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>title</span><span class=p>(</span><span class=s1>&#39;Elbow Method (visited tourists)&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>xlabel</span><span class=p>(</span><span class=s1>&#39;Number of clusters&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>ylabel</span><span class=p>(</span><span class=s1>&#39;Cost&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span></code></pre></div><h5 id=使用轮廓系数确定簇数的方法>使用轮廓系数确定簇数的方法<a hidden class=anchor aria-hidden=true href=#使用轮廓系数确定簇数的方法>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 轮廓图，去过的游客</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>kmodes.kprototypes</span> <span class=kn>import</span> <span class=n>KPrototypes</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.metrics</span> <span class=kn>import</span> <span class=n>silhouette_score</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>columns</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;Q1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q3&#39;</span><span class=p>,</span> <span class=s1>&#39;Q4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q5&#39;</span><span class=p>,</span>  <span class=s1>&#39;Q7|1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|3&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|6&#39;</span><span class=p>,</span> <span class=s1>&#39;Q8&#39;</span><span class=p>,</span> <span class=s1>&#39;Q9&#39;</span><span class=p>,</span> <span class=s1>&#39;Q10&#39;</span><span class=p>,</span> <span class=s1>&#39;Q11&#39;</span><span class=p>,</span> <span class=s1>&#39;Q12&#39;</span><span class=p>,</span> <span class=s1>&#39;Q13&#39;</span><span class=p>,</span> <span class=s1>&#39;Q14&#39;</span><span class=p>,</span> <span class=s1>&#39;Q15&#39;</span><span class=p>,</span> <span class=s1>&#39;Q19&#39;</span><span class=p>,</span> <span class=s1>&#39;Q20&#39;</span><span class=p>,</span><span class=s1>&#39;Q21|R1&#39;</span><span class=p>,</span><span class=s1>&#39;Q21|R2&#39;</span><span class=p>,</span><span class=s1>&#39;Q21|R3&#39;</span><span class=p>,</span><span class=s1>&#39;Q21|R4&#39;</span><span class=p>,</span><span class=s1>&#39;Q21|R5&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>numerical_columns</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;Q2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q5&#39;</span><span class=p>,</span><span class=s1>&#39;Q7|1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|3&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|6&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 类别型列</span>
</span></span><span class=line><span class=cl><span class=n>categorical_columns</span> <span class=o>=</span> <span class=p>[</span><span class=n>col</span> <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=n>columns</span> <span class=k>if</span> <span class=n>col</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>numerical_columns</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 将类别型列的索引转换为数字</span>
</span></span><span class=line><span class=cl><span class=n>categorical_columns_indices</span> <span class=o>=</span> <span class=p>[</span><span class=n>columns</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=n>col</span><span class=p>)</span> <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=n>categorical_columns</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>silhouette_scores</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>n_clusters</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>10</span><span class=p>):</span>  <span class=c1># 轮廓系数至少需要2个簇</span>
</span></span><span class=line><span class=cl>    <span class=n>kproto</span> <span class=o>=</span> <span class=n>KPrototypes</span><span class=p>(</span><span class=n>n_clusters</span><span class=o>=</span><span class=n>n_clusters</span><span class=p>,</span> <span class=n>init</span><span class=o>=</span><span class=s1>&#39;Cao&#39;</span><span class=p>,</span> <span class=n>verbose</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>clusters</span> <span class=o>=</span> <span class=n>kproto</span><span class=o>.</span><span class=n>fit_predict</span><span class=p>(</span><span class=n>df_gone</span><span class=p>[</span><span class=n>columns</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> <span class=n>categorical</span><span class=o>=</span><span class=n>categorical_columns_indices</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>score</span> <span class=o>=</span> <span class=n>silhouette_score</span><span class=p>(</span><span class=n>df_gone</span><span class=p>[</span><span class=n>columns</span><span class=p>],</span> <span class=n>clusters</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>silhouette_scores</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>score</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 绘制轮廓系数随簇数变化的图</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>10</span><span class=p>),</span> <span class=n>silhouette_scores</span><span class=p>,</span> <span class=s1>&#39;o-&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>title</span><span class=p>(</span><span class=s1>&#39;Silhouette Method (visited tourists)&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>xlabel</span><span class=p>(</span><span class=s1>&#39;Number of clusters&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>ylabel</span><span class=p>(</span><span class=s1>&#39;Silhouette Score&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span></code></pre></div><h4 id=开始聚类>开始聚类<a hidden class=anchor aria-hidden=true href=#开始聚类>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>kmodes.kprototypes</span> <span class=kn>import</span> <span class=n>KPrototypes</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 加入乌蒙大草原游客的基本信息，只能对已经来过的游客进行聚类</span>
</span></span><span class=line><span class=cl><span class=n>columns</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;Q1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q3&#39;</span><span class=p>,</span> <span class=s1>&#39;Q4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q5&#39;</span><span class=p>,</span>  <span class=s1>&#39;Q7|1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|3&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|6&#39;</span><span class=p>,</span> <span class=s1>&#39;Q8&#39;</span><span class=p>,</span> <span class=s1>&#39;Q9&#39;</span><span class=p>,</span> <span class=s1>&#39;Q10&#39;</span><span class=p>,</span> <span class=s1>&#39;Q11&#39;</span><span class=p>,</span> <span class=s1>&#39;Q12&#39;</span><span class=p>,</span> <span class=s1>&#39;Q13&#39;</span><span class=p>,</span> <span class=s1>&#39;Q14&#39;</span><span class=p>,</span> <span class=s1>&#39;Q15&#39;</span><span class=p>,</span> <span class=s1>&#39;Q19&#39;</span><span class=p>,</span> <span class=s1>&#39;Q20&#39;</span><span class=p>,</span><span class=s1>&#39;Q21|R1&#39;</span><span class=p>,</span><span class=s1>&#39;Q21|R2&#39;</span><span class=p>,</span><span class=s1>&#39;Q21|R3&#39;</span><span class=p>,</span><span class=s1>&#39;Q21|R4&#39;</span><span class=p>,</span><span class=s1>&#39;Q21|R5&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 数值型列</span>
</span></span><span class=line><span class=cl><span class=n>numerical_columns</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;Q2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q5&#39;</span><span class=p>,</span><span class=s1>&#39;Q7|1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|3&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|6&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 类别型列</span>
</span></span><span class=line><span class=cl><span class=n>categorical_columns</span> <span class=o>=</span> <span class=p>[</span><span class=n>col</span> <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=n>columns</span> <span class=k>if</span> <span class=n>col</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>numerical_columns</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 将类别型列的索引转换为数字</span>
</span></span><span class=line><span class=cl><span class=n>categorical_columns_indices</span> <span class=o>=</span> <span class=p>[</span><span class=n>columns</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=n>col</span><span class=p>)</span> <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=n>categorical_columns</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 初始化 K-原型聚类器</span>
</span></span><span class=line><span class=cl><span class=n>kproto</span> <span class=o>=</span> <span class=n>KPrototypes</span><span class=p>(</span><span class=n>n_clusters</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span> <span class=n>init</span><span class=o>=</span><span class=s1>&#39;Cao&#39;</span><span class=p>,</span> <span class=n>verbose</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>clusters</span> <span class=o>=</span> <span class=n>kproto</span><span class=o>.</span><span class=n>fit_predict</span><span class=p>(</span><span class=n>df_gone</span><span class=p>[</span><span class=n>columns</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> <span class=n>categorical</span><span class=o>=</span><span class=n>categorical_columns_indices</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 将聚类结果添加到数据集作为新的特征</span>
</span></span><span class=line><span class=cl><span class=n>df_gone</span><span class=p>[</span><span class=s1>&#39;k-prototypes cluster&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>clusters</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 想查看每个簇的中心点</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>kproto</span><span class=o>.</span><span class=n>cluster_centroids_</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看每个簇的数量</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>df_gone</span><span class=p>[</span><span class=s1>&#39;k-prototypes cluster&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>value_counts</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>df_gone</span><span class=o>.</span><span class=n>head</span><span class=p>()</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 把&#39;k-prototypes cluster&#39;为0的数据保存到csv文件</span>
</span></span><span class=line><span class=cl><span class=n>df_gone</span><span class=p>[</span><span class=n>df_gone</span><span class=p>[</span><span class=s1>&#39;k-prototypes cluster&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>to_csv</span><span class=p>(</span><span class=s1>&#39;cluster_0.csv&#39;</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span></code></pre></div><h4 id=特征选择通过伪标签进行方差分析和卡方检验>特征选择：通过伪标签进行方差分析和卡方检验<a hidden class=anchor aria-hidden=true href=#特征选择通过伪标签进行方差分析和卡方检验>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>scipy.stats</span> <span class=kn>import</span> <span class=n>f_oneway</span><span class=p>,</span> <span class=n>chi2_contingency</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 对 numerical_columns 进行方差分析</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>column</span> <span class=ow>in</span> <span class=n>numerical_columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>groups</span> <span class=o>=</span> <span class=n>df_gone</span><span class=o>.</span><span class=n>groupby</span><span class=p>(</span><span class=s1>&#39;k-prototypes cluster&#39;</span><span class=p>)[</span><span class=n>column</span><span class=p>]</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=nb>list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>f_val</span><span class=p>,</span> <span class=n>p_val</span> <span class=o>=</span> <span class=n>f_oneway</span><span class=p>(</span><span class=o>*</span><span class=n>groups</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>p_val</span> <span class=o>&lt;</span> <span class=mf>0.05</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Column: </span><span class=si>{</span><span class=n>column</span><span class=si>}</span><span class=s1>, F-value: </span><span class=si>{</span><span class=n>f_val</span><span class=si>}</span><span class=s1>, p-value: </span><span class=si>{</span><span class=n>p_val</span><span class=si>}</span><span class=s1>. significant.&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Column: </span><span class=si>{</span><span class=n>column</span><span class=si>}</span><span class=s1>, F-value: </span><span class=si>{</span><span class=n>f_val</span><span class=si>}</span><span class=s1>, p-value: </span><span class=si>{</span><span class=n>p_val</span><span class=si>}</span><span class=s1>. NO.&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 对 categorical_columns 进行卡方检验</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>column</span> <span class=ow>in</span> <span class=n>categorical_columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>contingency_table</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>crosstab</span><span class=p>(</span><span class=n>df_gone</span><span class=p>[</span><span class=n>column</span><span class=p>],</span> <span class=n>df_gone</span><span class=p>[</span><span class=s1>&#39;k-prototypes cluster&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>chi2</span><span class=p>,</span> <span class=n>p_val</span><span class=p>,</span> <span class=n>dof</span><span class=p>,</span> <span class=n>expected</span> <span class=o>=</span> <span class=n>chi2_contingency</span><span class=p>(</span><span class=n>contingency_table</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>p_val</span> <span class=o>&lt;</span> <span class=mf>0.05</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Column: </span><span class=si>{</span><span class=n>column</span><span class=si>}</span><span class=s1>, Chi2: </span><span class=si>{</span><span class=n>chi2</span><span class=si>}</span><span class=s1>, p-value: </span><span class=si>{</span><span class=n>p_val</span><span class=si>}</span><span class=s1>. significant.&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Column: </span><span class=si>{</span><span class=n>column</span><span class=si>}</span><span class=s1>, Chi2: </span><span class=si>{</span><span class=n>chi2</span><span class=si>}</span><span class=s1>, p-value: </span><span class=si>{</span><span class=n>p_val</span><span class=si>}</span><span class=s1>. NO.&#39;</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>kmodes.kprototypes</span> <span class=kn>import</span> <span class=n>KPrototypes</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># # 列表中的列名</span>
</span></span><span class=line><span class=cl><span class=c1># columns = [&#39;Q1&#39;, &#39;Q2&#39;, &#39;Q3&#39;, &#39;Q4&#39;, &#39;Q5&#39;, &#39;Q7|1&#39;, &#39;Q7|4&#39;, &#39;Q7|2&#39;, &#39;Q7|3&#39;, &#39;Q7|5&#39;, &#39;Q7|6&#39;, &#39;Q8&#39;, &#39;Q9&#39;, &#39;Q10&#39;, &#39;Q11&#39;, &#39;Q12&#39;, &#39;Q13&#39;, &#39;Q14&#39;, &#39;Q15&#39;]</span>
</span></span><span class=line><span class=cl><span class=c1># columns = [&#39;Q2&#39;, &#39;Q4&#39;, &#39;Q5&#39;, &#39;Q8&#39;, &#39;Q10&#39;, &#39;Q11&#39;, &#39;Q12&#39;, &#39;Q13&#39;, &#39;Q14&#39;]</span>
</span></span><span class=line><span class=cl><span class=c1># 加入乌蒙大草原游客的基本信息，只能对已经来过的游客进行聚类</span>
</span></span><span class=line><span class=cl><span class=n>columns_again</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;Q4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q10&#39;</span><span class=p>,</span> <span class=s1>&#39;Q19&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># # 数值型列</span>
</span></span><span class=line><span class=cl><span class=n>numerical_columns</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;Q4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q5&#39;</span><span class=p>,</span><span class=s1>&#39;Q7|5&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=c1># numerical_columns = [&#39;Q2&#39;, &#39;Q4&#39;, &#39;Q5&#39;]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 类别型列</span>
</span></span><span class=line><span class=cl><span class=n>categorical_columns</span> <span class=o>=</span> <span class=p>[</span><span class=n>col</span> <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=n>columns_again</span> <span class=k>if</span> <span class=n>col</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>numerical_columns</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 将类别型列的索引转换为数字</span>
</span></span><span class=line><span class=cl><span class=n>categorical_columns_indices</span> <span class=o>=</span> <span class=p>[</span><span class=n>columns_again</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=n>col</span><span class=p>)</span> <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=n>categorical_columns</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 初始化 K-原型聚类器</span>
</span></span><span class=line><span class=cl><span class=n>kproto</span> <span class=o>=</span> <span class=n>KPrototypes</span><span class=p>(</span><span class=n>n_clusters</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>init</span><span class=o>=</span><span class=s1>&#39;Cao&#39;</span><span class=p>,</span> <span class=n>verbose</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 对所有游客进行聚类</span>
</span></span><span class=line><span class=cl><span class=c1># clusters = kproto.fit_predict(df[columns].values, categorical=categorical_columns_indices)</span>
</span></span><span class=line><span class=cl><span class=n>clusters</span> <span class=o>=</span> <span class=n>kproto</span><span class=o>.</span><span class=n>fit_predict</span><span class=p>(</span><span class=n>df_gone</span><span class=p>[</span><span class=n>columns_again</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> <span class=n>categorical</span><span class=o>=</span><span class=n>categorical_columns_indices</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 将聚类结果添加到数据集作为新的特征</span>
</span></span><span class=line><span class=cl><span class=c1># df[&#39;k-prototypes cluster&#39;] = clusters</span>
</span></span><span class=line><span class=cl><span class=n>df_gone</span><span class=p>[</span><span class=s1>&#39;k-prototypes cluster&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>clusters</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 想查看每个簇的中心点</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>kproto</span><span class=o>.</span><span class=n>cluster_centroids_</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看每个簇的数量</span>
</span></span><span class=line><span class=cl><span class=c1># print(df[&#39;k-prototypes cluster&#39;].value_counts())</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>df_gone</span><span class=p>[</span><span class=s1>&#39;k-prototypes cluster&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>value_counts</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># df.head()</span>
</span></span><span class=line><span class=cl><span class=n>df_gone</span><span class=o>.</span><span class=n>head</span><span class=p>()</span>
</span></span></code></pre></div><h4 id=分布分析>分布分析<a hidden class=anchor aria-hidden=true href=#分布分析>#</a></h4><p>对每个聚类中的：</p><ul><li>数值数据进行最小值、最大值（范围）、平均值、中位数（50%分位数）、四分位数（25%和75%分位数）、标准差的分析；</li><li>分类数据进行各个类别的计数和比例</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>seaborn</span> <span class=k>as</span> <span class=nn>sns</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pandas</span> <span class=k>as</span> <span class=nn>pd</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>df_selected</span> <span class=o>=</span> <span class=n>df_gone</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>df_cluster_1</span> <span class=o>=</span> <span class=n>df_selected</span><span class=p>[</span><span class=n>df_selected</span><span class=p>[</span><span class=s1>&#39;k-prototypes cluster&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>df_cluster_2</span> <span class=o>=</span> <span class=n>df_selected</span><span class=p>[</span><span class=n>df_selected</span><span class=p>[</span><span class=s1>&#39;k-prototypes cluster&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>df_cluster_3</span> <span class=o>=</span> <span class=n>df_selected</span><span class=p>[</span><span class=n>df_selected</span><span class=p>[</span><span class=s1>&#39;k-prototypes cluster&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>clusters_list</span> <span class=o>=</span> <span class=p>[</span><span class=n>df_cluster_1</span><span class=p>,</span> <span class=n>df_cluster_2</span><span class=p>,</span> <span class=n>df_cluster_3</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>cluster_names</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;人群 1&#39;</span><span class=p>,</span> <span class=s1>&#39;人群 2&#39;</span><span class=p>,</span><span class=s1>&#39;人群 3&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 数值数据的描述性统计</span>
</span></span><span class=line><span class=cl><span class=n>desc_stats</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>df_cluster</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>clusters_list</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>desc_stats</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>df_cluster</span><span class=p>[</span><span class=n>numerical_columns</span><span class=p>]</span><span class=o>.</span><span class=n>describe</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>desc_stats_df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>(</span><span class=n>desc_stats</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>keys</span><span class=o>=</span><span class=n>cluster_names</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>desc_stats_df</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 分类数据的各个类别的计数和比例</span>
</span></span><span class=line><span class=cl><span class=n>cat_counts</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>df_cluster</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>clusters_list</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>cat_counts</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>df_cluster</span><span class=p>[</span><span class=n>categorical_columns</span><span class=p>]</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=o>.</span><span class=n>value_counts</span><span class=p>())</span><span class=o>.</span><span class=n>T</span><span class=o>.</span><span class=n>stack</span><span class=p>()</span> <span class=o>/</span> <span class=n>df_cluster</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>cat_counts_df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>(</span><span class=n>cat_counts</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>keys</span><span class=o>=</span><span class=n>cluster_names</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>cat_counts_df</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>####################</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>seaborn</span> <span class=k>as</span> <span class=nn>sns</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pandas</span> <span class=k>as</span> <span class=nn>pd</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置全局字体</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>rcParams</span><span class=p>[</span><span class=s1>&#39;font.sans-serif&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;SimHei&#39;</span><span class=p>]</span>  <span class=c1># 用来正常显示中文标签</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>rcParams</span><span class=p>[</span><span class=s1>&#39;axes.unicode_minus&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span>  <span class=c1># 用来正常显示负号</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 计算子图的行数和列数</span>
</span></span><span class=line><span class=cl><span class=n>n</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>numerical_columns</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ncols</span> <span class=o>=</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=n>nrows</span> <span class=o>=</span> <span class=n>n</span> <span class=o>//</span> <span class=n>ncols</span> <span class=k>if</span> <span class=n>n</span> <span class=o>%</span> <span class=n>ncols</span> <span class=o>==</span> <span class=mi>0</span> <span class=k>else</span> <span class=n>n</span> <span class=o>//</span> <span class=n>ncols</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建一个大图和子图的数组，每个子图都有自己独立的y轴刻度</span>
</span></span><span class=line><span class=cl><span class=n>fig</span><span class=p>,</span> <span class=n>axs</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>subplots</span><span class=p>(</span><span class=n>nrows</span><span class=p>,</span> <span class=n>ncols</span><span class=p>,</span> <span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>15</span><span class=p>,</span> <span class=mi>5</span><span class=o>*</span><span class=n>nrows</span><span class=p>),</span> <span class=n>sharey</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建一个ExcelWriter对象</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>pd</span><span class=o>.</span><span class=n>ExcelWriter</span><span class=p>(</span><span class=s1>&#39;output.xlsx&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>writer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 描述性统计的可视化</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>idx</span><span class=p>,</span> <span class=n>question</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>numerical_columns</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 计算子图的位置</span>
</span></span><span class=line><span class=cl>        <span class=n>row</span> <span class=o>=</span> <span class=n>idx</span> <span class=o>//</span> <span class=n>ncols</span>
</span></span><span class=line><span class=cl>        <span class=n>col</span> <span class=o>=</span> <span class=n>idx</span> <span class=o>%</span> <span class=n>ncols</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 创建一个空的数据框来存储所有的簇的数据</span>
</span></span><span class=line><span class=cl>        <span class=n>all_clusters</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>df_cluster</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>clusters_list</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=c1># 添加一个新的列来标识簇</span>
</span></span><span class=line><span class=cl>            <span class=n>df_cluster</span> <span class=o>=</span> <span class=n>df_cluster</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>df_cluster</span><span class=p>[</span><span class=s1>&#39;Cluster&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;Cluster </span><span class=si>{</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=si>}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>            <span class=n>all_clusters</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>([</span><span class=n>all_clusters</span><span class=p>,</span> <span class=n>df_cluster</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 在子图上绘制小提琴图，这里将使用各自的数据范围设置y轴刻度</span>
</span></span><span class=line><span class=cl>        <span class=n>sns</span><span class=o>.</span><span class=n>violinplot</span><span class=p>(</span><span class=n>x</span><span class=o>=</span><span class=s1>&#39;Cluster&#39;</span><span class=p>,</span> <span class=n>y</span><span class=o>=</span><span class=n>question</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>all_clusters</span><span class=p>,</span> <span class=n>ax</span><span class=o>=</span><span class=n>axs</span><span class=p>[</span><span class=n>row</span><span class=p>,</span> <span class=n>col</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>axs</span><span class=p>[</span><span class=n>row</span><span class=p>,</span> <span class=n>col</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;各簇</span><span class=si>{</span><span class=n>question</span><span class=si>}</span><span class=s1>的小提琴图&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>axs</span><span class=p>[</span><span class=n>row</span><span class=p>,</span> <span class=n>col</span><span class=p>]</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 将数据写入Excel文件的一个新工作表</span>
</span></span><span class=line><span class=cl>        <span class=n>all_clusters</span><span class=o>.</span><span class=n>to_excel</span><span class=p>(</span><span class=n>writer</span><span class=p>,</span> <span class=n>sheet_name</span><span class=o>=</span><span class=n>question</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 删除多余的子图</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>n</span> <span class=o>%</span> <span class=n>ncols</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n</span> <span class=o>%</span> <span class=n>ncols</span><span class=p>,</span> <span class=n>ncols</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>fig</span><span class=o>.</span><span class=n>delaxes</span><span class=p>(</span><span class=n>axs</span><span class=p>[</span><span class=n>nrows</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=n>col</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>tight_layout</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>seaborn</span> <span class=k>as</span> <span class=nn>sns</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pandas</span> <span class=k>as</span> <span class=nn>pd</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置全局字体</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>rcParams</span><span class=p>[</span><span class=s1>&#39;font.sans-serif&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;SimHei&#39;</span><span class=p>]</span>  <span class=c1># 用来正常显示中文标签</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>rcParams</span><span class=p>[</span><span class=s1>&#39;axes.unicode_minus&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span>  <span class=c1># 用来正常显示负号</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 计算子图的行数和列数</span>
</span></span><span class=line><span class=cl><span class=n>n</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>categorical_columns</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ncols</span> <span class=o>=</span> <span class=mi>5</span>
</span></span><span class=line><span class=cl><span class=n>nrows</span> <span class=o>=</span> <span class=n>n</span> <span class=o>//</span> <span class=n>ncols</span> <span class=k>if</span> <span class=n>n</span> <span class=o>%</span> <span class=n>ncols</span> <span class=o>==</span> <span class=mi>0</span> <span class=k>else</span> <span class=n>n</span> <span class=o>//</span> <span class=n>ncols</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建一个大图和子图的数组</span>
</span></span><span class=line><span class=cl><span class=n>fig</span><span class=p>,</span> <span class=n>axs</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>subplots</span><span class=p>(</span><span class=n>nrows</span><span class=p>,</span> <span class=n>ncols</span><span class=p>,</span> <span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>15</span><span class=p>,</span> <span class=mi>5</span><span class=o>*</span><span class=n>nrows</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建一个ExcelWriter对象</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>pd</span><span class=o>.</span><span class=n>ExcelWriter</span><span class=p>(</span><span class=s1>&#39;output.xlsx&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>writer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 描述性统计的可视化</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>idx</span><span class=p>,</span> <span class=n>question</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>categorical_columns</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 计算子图的位置</span>
</span></span><span class=line><span class=cl>        <span class=n>row</span> <span class=o>=</span> <span class=n>idx</span> <span class=o>//</span> <span class=n>ncols</span>
</span></span><span class=line><span class=cl>        <span class=n>col</span> <span class=o>=</span> <span class=n>idx</span> <span class=o>%</span> <span class=n>ncols</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 创建一个空的数据框来存储所有的簇的数据</span>
</span></span><span class=line><span class=cl>        <span class=n>all_clusters</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>df_cluster</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>clusters_list</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=c1># 添加一个新的列来标识簇</span>
</span></span><span class=line><span class=cl>            <span class=n>df_cluster</span> <span class=o>=</span> <span class=n>df_cluster</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>df_cluster</span><span class=p>[</span><span class=s1>&#39;Cluster&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;Cluster </span><span class=si>{</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=si>}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>            <span class=n>all_clusters</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>([</span><span class=n>all_clusters</span><span class=p>,</span> <span class=n>df_cluster</span><span class=p>],</span> <span class=n>ignore_index</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 数据透视以便于绘图，计算每个簇每个分类的数量</span>
</span></span><span class=line><span class=cl>        <span class=n>pivot_df</span> <span class=o>=</span> <span class=n>all_clusters</span><span class=o>.</span><span class=n>pivot_table</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=s1>&#39;Cluster&#39;</span><span class=p>,</span> <span class=n>columns</span><span class=o>=</span><span class=n>question</span><span class=p>,</span> <span class=n>aggfunc</span><span class=o>=</span><span class=s1>&#39;size&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>fillna</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 将数量转换为占比</span>
</span></span><span class=line><span class=cl>        <span class=n>pivot_df_percent</span> <span class=o>=</span> <span class=n>pivot_df</span><span class=o>.</span><span class=n>div</span><span class=p>(</span><span class=n>pivot_df</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>),</span> <span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span> <span class=o>*</span> <span class=mi>100</span>  <span class=c1># 计算占总数的百分比</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 绘制堆叠条形图，展示百分比</span>
</span></span><span class=line><span class=cl>        <span class=n>pivot_df_percent</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>kind</span><span class=o>=</span><span class=s1>&#39;bar&#39;</span><span class=p>,</span> <span class=n>stacked</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>ax</span><span class=o>=</span><span class=n>axs</span><span class=p>[</span><span class=n>row</span><span class=p>,</span> <span class=n>col</span><span class=p>],</span> <span class=n>legend</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>axs</span><span class=p>[</span><span class=n>row</span><span class=p>,</span> <span class=n>col</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;各簇</span><span class=si>{</span><span class=n>question</span><span class=si>}</span><span class=s1>的堆叠条形图&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>axs</span><span class=p>[</span><span class=n>row</span><span class=p>,</span> <span class=n>col</span><span class=p>]</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s1>&#39;百分比 (%)&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 将数据写入Excel文件的一个新工作表</span>
</span></span><span class=line><span class=cl>        <span class=n>pivot_df_percent</span><span class=o>.</span><span class=n>to_excel</span><span class=p>(</span><span class=n>writer</span><span class=p>,</span> <span class=n>sheet_name</span><span class=o>=</span><span class=n>question</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 删除多余的子图</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>n</span> <span class=o>%</span> <span class=n>ncols</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n</span> <span class=o>%</span> <span class=n>ncols</span><span class=p>,</span> <span class=n>ncols</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>fig</span><span class=o>.</span><span class=n>delaxes</span><span class=p>(</span><span class=n>axs</span><span class=p>[</span><span class=n>nrows</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=n>col</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>tight_layout</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span></code></pre></div><h4 id=聚类结果可视化>聚类结果可视化<a hidden class=anchor aria-hidden=true href=#聚类结果可视化>#</a></h4><p>使用PCA，t-SNE，UMAP方法进行降维，得到2D和3D的图像，选择效果最好的可视化。</p><h5 id=六合一可视化>六合一可视化<a hidden class=anchor aria-hidden=true href=#六合一可视化>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.decomposition</span> <span class=kn>import</span> <span class=n>PCA</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.manifold</span> <span class=kn>import</span> <span class=n>TSNE</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>umap</span> <span class=kn>import</span> <span class=n>UMAP</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mpl_toolkits.mplot3d</span> <span class=kn>import</span> <span class=n>Axes3D</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 数据</span>
</span></span><span class=line><span class=cl><span class=c1># X = df[columns].values</span>
</span></span><span class=line><span class=cl><span class=n>X</span> <span class=o>=</span> <span class=n>df_gone</span><span class=p>[</span><span class=n>columns</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建PCA，t-SNE，UMAP对象</span>
</span></span><span class=line><span class=cl><span class=n>pca</span> <span class=o>=</span> <span class=n>PCA</span><span class=p>(</span><span class=n>n_components</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>tsne</span> <span class=o>=</span> <span class=n>TSNE</span><span class=p>(</span><span class=n>n_components</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>umap</span> <span class=o>=</span> <span class=n>UMAP</span><span class=p>(</span><span class=n>n_components</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 降维</span>
</span></span><span class=line><span class=cl><span class=n>X_pca</span> <span class=o>=</span> <span class=n>pca</span><span class=o>.</span><span class=n>fit_transform</span><span class=p>(</span><span class=n>X</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>X_tsne</span> <span class=o>=</span> <span class=n>tsne</span><span class=o>.</span><span class=n>fit_transform</span><span class=p>(</span><span class=n>X</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>X_umap</span> <span class=o>=</span> <span class=n>umap</span><span class=o>.</span><span class=n>fit_transform</span><span class=p>(</span><span class=n>X</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建图形和子图</span>
</span></span><span class=line><span class=cl><span class=n>fig</span><span class=p>,</span> <span class=n>axs</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>subplots</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>15</span><span class=p>,</span> <span class=mi>20</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 绘制二维版本</span>
</span></span><span class=line><span class=cl><span class=n>sc</span> <span class=o>=</span> <span class=n>axs</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>X_pca</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>],</span> <span class=n>X_pca</span><span class=p>[:,</span> <span class=mi>1</span><span class=p>],</span> <span class=n>c</span><span class=o>=</span><span class=n>clusters</span><span class=p>,</span> <span class=n>cmap</span><span class=o>=</span><span class=s1>&#39;viridis&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axs</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;PCA 2D&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fig</span><span class=o>.</span><span class=n>colorbar</span><span class=p>(</span><span class=n>sc</span><span class=p>,</span> <span class=n>ax</span><span class=o>=</span><span class=n>axs</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>],</span> <span class=n>shrink</span><span class=o>=</span><span class=mf>0.6</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sc</span> <span class=o>=</span> <span class=n>axs</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>X_tsne</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>],</span> <span class=n>X_tsne</span><span class=p>[:,</span> <span class=mi>1</span><span class=p>],</span> <span class=n>c</span><span class=o>=</span><span class=n>clusters</span><span class=p>,</span> <span class=n>cmap</span><span class=o>=</span><span class=s1>&#39;viridis&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axs</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;t-SNE 2D&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fig</span><span class=o>.</span><span class=n>colorbar</span><span class=p>(</span><span class=n>sc</span><span class=p>,</span> <span class=n>ax</span><span class=o>=</span><span class=n>axs</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>],</span> <span class=n>shrink</span><span class=o>=</span><span class=mf>0.6</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sc</span> <span class=o>=</span> <span class=n>axs</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>X_umap</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>],</span> <span class=n>X_umap</span><span class=p>[:,</span> <span class=mi>1</span><span class=p>],</span> <span class=n>c</span><span class=o>=</span><span class=n>clusters</span><span class=p>,</span> <span class=n>cmap</span><span class=o>=</span><span class=s1>&#39;viridis&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axs</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;UMAP 2D&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fig</span><span class=o>.</span><span class=n>colorbar</span><span class=p>(</span><span class=n>sc</span><span class=p>,</span> <span class=n>ax</span><span class=o>=</span><span class=n>axs</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>],</span> <span class=n>shrink</span><span class=o>=</span><span class=mf>0.6</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建PCA，t-SNE，UMAP对象</span>
</span></span><span class=line><span class=cl><span class=n>pca</span> <span class=o>=</span> <span class=n>PCA</span><span class=p>(</span><span class=n>n_components</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>tsne</span> <span class=o>=</span> <span class=n>TSNE</span><span class=p>(</span><span class=n>n_components</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>umap</span> <span class=o>=</span> <span class=n>UMAP</span><span class=p>(</span><span class=n>n_components</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 降维</span>
</span></span><span class=line><span class=cl><span class=n>X_pca</span> <span class=o>=</span> <span class=n>pca</span><span class=o>.</span><span class=n>fit_transform</span><span class=p>(</span><span class=n>X</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>X_tsne</span> <span class=o>=</span> <span class=n>tsne</span><span class=o>.</span><span class=n>fit_transform</span><span class=p>(</span><span class=n>X</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>X_umap</span> <span class=o>=</span> <span class=n>umap</span><span class=o>.</span><span class=n>fit_transform</span><span class=p>(</span><span class=n>X</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 绘制三维版本</span>
</span></span><span class=line><span class=cl><span class=n>axs</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>fig</span><span class=o>.</span><span class=n>add_subplot</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=n>projection</span><span class=o>=</span><span class=s1>&#39;3d&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sc</span> <span class=o>=</span> <span class=n>axs</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>X_pca</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>],</span> <span class=n>X_pca</span><span class=p>[:,</span> <span class=mi>1</span><span class=p>],</span> <span class=n>X_pca</span><span class=p>[:,</span> <span class=mi>2</span><span class=p>],</span> <span class=n>c</span><span class=o>=</span><span class=n>clusters</span><span class=p>,</span> <span class=n>cmap</span><span class=o>=</span><span class=s1>&#39;viridis&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axs</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;PCA 3D&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fig</span><span class=o>.</span><span class=n>colorbar</span><span class=p>(</span><span class=n>sc</span><span class=p>,</span> <span class=n>ax</span><span class=o>=</span><span class=n>axs</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>],</span> <span class=n>shrink</span><span class=o>=</span><span class=mf>0.6</span><span class=p>,</span> <span class=n>pad</span><span class=o>=</span><span class=mf>0.2</span><span class=p>)</span>  <span class=c1># 修改的代码</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>axs</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>fig</span><span class=o>.</span><span class=n>add_subplot</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=n>projection</span><span class=o>=</span><span class=s1>&#39;3d&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sc</span> <span class=o>=</span> <span class=n>axs</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>X_tsne</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>],</span> <span class=n>X_tsne</span><span class=p>[:,</span> <span class=mi>1</span><span class=p>],</span> <span class=n>X_tsne</span><span class=p>[:,</span> <span class=mi>2</span><span class=p>],</span> <span class=n>c</span><span class=o>=</span><span class=n>clusters</span><span class=p>,</span> <span class=n>cmap</span><span class=o>=</span><span class=s1>&#39;viridis&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axs</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;t-SNE 3D&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fig</span><span class=o>.</span><span class=n>colorbar</span><span class=p>(</span><span class=n>sc</span><span class=p>,</span> <span class=n>ax</span><span class=o>=</span><span class=n>axs</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>],</span> <span class=n>shrink</span><span class=o>=</span><span class=mf>0.6</span><span class=p>,</span> <span class=n>pad</span><span class=o>=</span><span class=mf>0.2</span><span class=p>)</span>  <span class=c1># 修改的代码</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>axs</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>fig</span><span class=o>.</span><span class=n>add_subplot</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=n>projection</span><span class=o>=</span><span class=s1>&#39;3d&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sc</span> <span class=o>=</span> <span class=n>axs</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>X_umap</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>],</span> <span class=n>X_umap</span><span class=p>[:,</span> <span class=mi>1</span><span class=p>],</span> <span class=n>X_umap</span><span class=p>[:,</span> <span class=mi>2</span><span class=p>],</span> <span class=n>c</span><span class=o>=</span><span class=n>clusters</span><span class=p>,</span> <span class=n>cmap</span><span class=o>=</span><span class=s1>&#39;viridis&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axs</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;UMAP 3D&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fig</span><span class=o>.</span><span class=n>colorbar</span><span class=p>(</span><span class=n>sc</span><span class=p>,</span> <span class=n>ax</span><span class=o>=</span><span class=n>axs</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>],</span> <span class=n>shrink</span><span class=o>=</span><span class=mf>0.6</span><span class=p>,</span> <span class=n>pad</span><span class=o>=</span><span class=mf>0.2</span><span class=p>)</span>  <span class=c1># 修改的代码</span>
</span></span><span class=line><span class=cl><span class=c1># 调整子图之间的间隙</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>subplots_adjust</span><span class=p>(</span><span class=n>wspace</span><span class=o>=</span><span class=mf>0.5</span><span class=p>,</span> <span class=n>hspace</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>tight_layout</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span></code></pre></div><h5 id=pca主成分降维>PCA主成分降维<a hidden class=anchor aria-hidden=true href=#pca主成分降维>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.decomposition</span> <span class=kn>import</span> <span class=n>PCA</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>df_selected</span> <span class=o>=</span> <span class=n>df_gone</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用PCA进行降维</span>
</span></span><span class=line><span class=cl><span class=n>pca</span> <span class=o>=</span> <span class=n>PCA</span><span class=p>(</span><span class=n>n_components</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>X_pca</span> <span class=o>=</span> <span class=n>pca</span><span class=o>.</span><span class=n>fit_transform</span><span class=p>(</span><span class=n>df_selected</span><span class=p>[</span><span class=n>columns</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 绘制散点图</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>figure</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=mi>6</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>X_pca</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>],</span> <span class=n>X_pca</span><span class=p>[:,</span> <span class=mi>1</span><span class=p>],</span> <span class=n>c</span><span class=o>=</span><span class=n>clusters</span><span class=p>,</span> <span class=n>cmap</span><span class=o>=</span><span class=s1>&#39;viridis&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>title</span><span class=p>(</span><span class=s1>&#39;K-Prototypes Clustering (PCA-reduced data)&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>xlabel</span><span class=p>(</span><span class=s1>&#39;Principal Component 1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>ylabel</span><span class=p>(</span><span class=s1>&#39;Principal Component 2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>colorbar</span><span class=p>(</span><span class=n>label</span><span class=o>=</span><span class=s1>&#39;Cluster&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span></code></pre></div><h5 id=pca主成分降维-3d>PCA主成分降维 3D<a hidden class=anchor aria-hidden=true href=#pca主成分降维-3d>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.decomposition</span> <span class=kn>import</span> <span class=n>PCA</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mpl_toolkits.mplot3d</span> <span class=kn>import</span> <span class=n>Axes3D</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>df_selected</span> <span class=o>=</span> <span class=n>df_gone</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用PCA进行降维</span>
</span></span><span class=line><span class=cl><span class=n>pca</span> <span class=o>=</span> <span class=n>PCA</span><span class=p>(</span><span class=n>n_components</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>X_pca</span> <span class=o>=</span> <span class=n>pca</span><span class=o>.</span><span class=n>fit_transform</span><span class=p>(</span><span class=n>df_selected</span><span class=p>[</span><span class=n>columns</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建一个3D图形</span>
</span></span><span class=line><span class=cl><span class=n>fig</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>figure</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=mi>6</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>ax</span> <span class=o>=</span> <span class=n>fig</span><span class=o>.</span><span class=n>add_subplot</span><span class=p>(</span><span class=mi>111</span><span class=p>,</span> <span class=n>projection</span><span class=o>=</span><span class=s1>&#39;3d&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 绘制散点图</span>
</span></span><span class=line><span class=cl><span class=n>sc</span> <span class=o>=</span> <span class=n>ax</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>X_pca</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>],</span> <span class=n>X_pca</span><span class=p>[:,</span> <span class=mi>1</span><span class=p>],</span> <span class=n>X_pca</span><span class=p>[:,</span> <span class=mi>2</span><span class=p>],</span> <span class=n>c</span><span class=o>=</span><span class=n>clusters</span><span class=p>,</span> <span class=n>cmap</span><span class=o>=</span><span class=s1>&#39;viridis&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>title</span><span class=p>(</span><span class=s1>&#39;K-Prototypes Clustering (PCA-reduced data)&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ax</span><span class=o>.</span><span class=n>set_xlabel</span><span class=p>(</span><span class=s1>&#39;Principal Component 1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ax</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s1>&#39;Principal Component 2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ax</span><span class=o>.</span><span class=n>set_zlabel</span><span class=p>(</span><span class=s1>&#39;Principal Component 3&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fig</span><span class=o>.</span><span class=n>colorbar</span><span class=p>(</span><span class=n>sc</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;Cluster&#39;</span><span class=p>,</span> <span class=n>pad</span><span class=o>=</span><span class=mf>0.1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=o>.</span><span class=n>head</span><span class=p>()</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.decomposition</span> <span class=kn>import</span> <span class=n>PCA</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mpl_toolkits.mplot3d</span> <span class=kn>import</span> <span class=n>Axes3D</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>imageio</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>df_selected</span> <span class=o>=</span> <span class=n>df_gone</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用PCA进行降维</span>
</span></span><span class=line><span class=cl><span class=n>pca</span> <span class=o>=</span> <span class=n>PCA</span><span class=p>(</span><span class=n>n_components</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>X_pca</span> <span class=o>=</span> <span class=n>pca</span><span class=o>.</span><span class=n>fit_transform</span><span class=p>(</span><span class=n>df_selected</span><span class=p>[</span><span class=n>columns</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建GIF的帧</span>
</span></span><span class=line><span class=cl><span class=n>filenames</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>azim</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=o>-</span><span class=mi>90</span><span class=p>,</span> <span class=mi>90</span><span class=p>,</span> <span class=mi>2</span><span class=p>):</span>  <span class=c1># 从0度旋转到360度，每次增加10度</span>
</span></span><span class=line><span class=cl>    <span class=c1># 创建一个3D图形</span>
</span></span><span class=line><span class=cl>    <span class=n>fig</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>figure</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=mi>6</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>ax</span> <span class=o>=</span> <span class=n>fig</span><span class=o>.</span><span class=n>add_subplot</span><span class=p>(</span><span class=mi>111</span><span class=p>,</span> <span class=n>projection</span><span class=o>=</span><span class=s1>&#39;3d&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 绘制散点图</span>
</span></span><span class=line><span class=cl>    <span class=n>sc</span> <span class=o>=</span> <span class=n>ax</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>X_pca</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>],</span> <span class=n>X_pca</span><span class=p>[:,</span> <span class=mi>1</span><span class=p>],</span> <span class=n>X_pca</span><span class=p>[:,</span> <span class=mi>2</span><span class=p>],</span> <span class=n>c</span><span class=o>=</span><span class=n>clusters</span><span class=p>,</span> <span class=n>cmap</span><span class=o>=</span><span class=s1>&#39;viridis&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ax</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;K-Prototypes Clustering (PCA-reduced data)&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax</span><span class=o>.</span><span class=n>set_xlabel</span><span class=p>(</span><span class=s1>&#39;Principal Component 1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s1>&#39;Principal Component 2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax</span><span class=o>.</span><span class=n>set_zlabel</span><span class=p>(</span><span class=s1>&#39;Principal Component 3&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>fig</span><span class=o>.</span><span class=n>colorbar</span><span class=p>(</span><span class=n>sc</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;Cluster&#39;</span><span class=p>,</span> <span class=n>pad</span><span class=o>=</span><span class=mf>0.1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 设置视角</span>
</span></span><span class=line><span class=cl>    <span class=n>ax</span><span class=o>.</span><span class=n>view_init</span><span class=p>(</span><span class=n>elev</span><span class=o>=</span><span class=mf>20.</span><span class=p>,</span> <span class=n>azim</span><span class=o>=</span><span class=n>azim</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 保存帧</span>
</span></span><span class=line><span class=cl>    <span class=n>filename</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;frame_</span><span class=si>{</span><span class=n>azim</span><span class=si>}</span><span class=s1>.png&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>savefig</span><span class=p>(</span><span class=n>filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>filenames</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>close</span><span class=p>(</span><span class=n>fig</span><span class=p>)</span>  <span class=c1># 关闭图形，防止在notebook中显示</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用所有的帧创建一个GIF</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>imageio</span><span class=o>.</span><span class=n>get_writer</span><span class=p>(</span><span class=s1>&#39;mygif.gif&#39;</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s1>&#39;I&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>writer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>filename</span> <span class=ow>in</span> <span class=n>filenames</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>image</span> <span class=o>=</span> <span class=n>imageio</span><span class=o>.</span><span class=n>imread</span><span class=p>(</span><span class=n>filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>writer</span><span class=o>.</span><span class=n>append_data</span><span class=p>(</span><span class=n>image</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 删除所有的帧</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>filename</span> <span class=ow>in</span> <span class=n>filenames</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>os</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>filename</span><span class=p>)</span>
</span></span></code></pre></div><h5 id=t-sne降维>t-SNE降维<a hidden class=anchor aria-hidden=true href=#t-sne降维>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.manifold</span> <span class=kn>import</span> <span class=n>TSNE</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mpl_toolkits.mplot3d</span> <span class=kn>import</span> <span class=n>Axes3D</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用t-SNE进行降维</span>
</span></span><span class=line><span class=cl><span class=n>tsne</span> <span class=o>=</span> <span class=n>TSNE</span><span class=p>(</span><span class=n>n_components</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>X_tsne</span> <span class=o>=</span> <span class=n>tsne</span><span class=o>.</span><span class=n>fit_transform</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=n>columns</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建一个3D图形</span>
</span></span><span class=line><span class=cl><span class=n>fig</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>figure</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=mi>6</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>ax</span> <span class=o>=</span> <span class=n>fig</span><span class=o>.</span><span class=n>add_subplot</span><span class=p>(</span><span class=mi>111</span><span class=p>,</span> <span class=n>projection</span><span class=o>=</span><span class=s1>&#39;3d&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 绘制散点图</span>
</span></span><span class=line><span class=cl><span class=n>sc</span> <span class=o>=</span> <span class=n>ax</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>X_tsne</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>],</span> <span class=n>X_tsne</span><span class=p>[:,</span> <span class=mi>1</span><span class=p>],</span> <span class=n>X_tsne</span><span class=p>[:,</span> <span class=mi>2</span><span class=p>],</span> <span class=n>c</span><span class=o>=</span><span class=n>clusters</span><span class=p>,</span> <span class=n>cmap</span><span class=o>=</span><span class=s1>&#39;viridis&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>title</span><span class=p>(</span><span class=s1>&#39;K-Prototypes Clustering&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ax</span><span class=o>.</span><span class=n>set_xlabel</span><span class=p>(</span><span class=s1>&#39;t-SNE Dimension 1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ax</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s1>&#39;t-SNE Dimension 2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ax</span><span class=o>.</span><span class=n>set_zlabel</span><span class=p>(</span><span class=s1>&#39;t-SNE Dimension 3&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fig</span><span class=o>.</span><span class=n>colorbar</span><span class=p>(</span><span class=n>sc</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;Cluster&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=o>.</span><span class=n>head</span><span class=p>()</span>
</span></span></code></pre></div><h5 id=制作t-sne-gif版本>制作t-SNE gif版本<a hidden class=anchor aria-hidden=true href=#制作t-sne-gif版本>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mpl_toolkits.mplot3d</span> <span class=kn>import</span> <span class=n>Axes3D</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>imageio</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.manifold</span> <span class=kn>import</span> <span class=n>TSNE</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 初始化t-SNE</span>
</span></span><span class=line><span class=cl><span class=n>tsne</span> <span class=o>=</span> <span class=n>TSNE</span><span class=p>(</span><span class=n>n_components</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>#, init=&#39;random&#39;, random_state=0, n_iter=1000, method=&#39;exact&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 保存每次迭代的图像</span>
</span></span><span class=line><span class=cl><span class=n>frames</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>250</span><span class=p>,</span> <span class=mi>1000</span><span class=p>,</span> <span class=mi>50</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>tsne</span><span class=o>.</span><span class=n>n_iter</span> <span class=o>=</span> <span class=n>i</span>
</span></span><span class=line><span class=cl>    <span class=n>X_tsne</span> <span class=o>=</span> <span class=n>tsne</span><span class=o>.</span><span class=n>fit_transform</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=n>columns</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>fig</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>figure</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=mi>6</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>ax</span> <span class=o>=</span> <span class=n>fig</span><span class=o>.</span><span class=n>add_subplot</span><span class=p>(</span><span class=mi>111</span><span class=p>,</span> <span class=n>projection</span><span class=o>=</span><span class=s1>&#39;3d&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>scatter</span> <span class=o>=</span> <span class=n>ax</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>X_tsne</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>],</span> <span class=n>X_tsne</span><span class=p>[:,</span> <span class=mi>1</span><span class=p>],</span> <span class=n>X_tsne</span><span class=p>[:,</span> <span class=mi>2</span><span class=p>],</span> <span class=n>c</span><span class=o>=</span><span class=n>clusters</span><span class=p>,</span> <span class=n>cmap</span><span class=o>=</span><span class=s1>&#39;viridis&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;t-SNE with </span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s1> iterations&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax</span><span class=o>.</span><span class=n>set_xlabel</span><span class=p>(</span><span class=s1>&#39;t-SNE Dimension 1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s1>&#39;t-SNE Dimension 2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax</span><span class=o>.</span><span class=n>set_zlabel</span><span class=p>(</span><span class=s1>&#39;t-SNE Dimension 3&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>fig</span><span class=o>.</span><span class=n>colorbar</span><span class=p>(</span><span class=n>scatter</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;Cluster&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>savefig</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;tsne_</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s1>.png&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>close</span><span class=p>(</span><span class=n>fig</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>frames</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>imageio</span><span class=o>.</span><span class=n>imread</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;tsne_</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s1>.png&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 保存为GIF</span>
</span></span><span class=line><span class=cl><span class=n>imageio</span><span class=o>.</span><span class=n>mimsave</span><span class=p>(</span><span class=s1>&#39;tsne.gif&#39;</span><span class=p>,</span> <span class=n>frames</span><span class=p>,</span> <span class=s1>&#39;GIF&#39;</span><span class=p>,</span> <span class=n>duration</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=o>.</span><span class=n>head</span><span class=p>()</span>
</span></span></code></pre></div><h5 id=使用umap降维>使用UMAP降维<a hidden class=anchor aria-hidden=true href=#使用umap降维>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>umap</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mpl_toolkits.mplot3d</span> <span class=kn>import</span> <span class=n>Axes3D</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 假设df是你的数据框，columns是你想要降维的列</span>
</span></span><span class=line><span class=cl><span class=n>reducer</span> <span class=o>=</span> <span class=n>umap</span><span class=o>.</span><span class=n>UMAP</span><span class=p>(</span><span class=n>n_components</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span> <span class=n>random_state</span><span class=o>=</span><span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>embedding</span> <span class=o>=</span> <span class=n>reducer</span><span class=o>.</span><span class=n>fit_transform</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=n>columns</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建一个3D图形</span>
</span></span><span class=line><span class=cl><span class=n>fig</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>figure</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=mi>6</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>ax</span> <span class=o>=</span> <span class=n>fig</span><span class=o>.</span><span class=n>add_subplot</span><span class=p>(</span><span class=mi>111</span><span class=p>,</span> <span class=n>projection</span><span class=o>=</span><span class=s1>&#39;3d&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 绘制散点图</span>
</span></span><span class=line><span class=cl><span class=n>sc</span> <span class=o>=</span> <span class=n>ax</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>embedding</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>],</span> <span class=n>embedding</span><span class=p>[:,</span> <span class=mi>1</span><span class=p>],</span> <span class=n>embedding</span><span class=p>[:,</span> <span class=mi>2</span><span class=p>],</span> <span class=n>c</span><span class=o>=</span><span class=n>clusters</span><span class=p>,</span> <span class=n>cmap</span><span class=o>=</span><span class=s1>&#39;viridis&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>title</span><span class=p>(</span><span class=s1>&#39;UMAP projection&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ax</span><span class=o>.</span><span class=n>set_xlabel</span><span class=p>(</span><span class=s1>&#39;Dimension 1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ax</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s1>&#39;Dimension 2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ax</span><span class=o>.</span><span class=n>set_zlabel</span><span class=p>(</span><span class=s1>&#39;Dimension 3&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fig</span><span class=o>.</span><span class=n>colorbar</span><span class=p>(</span><span class=n>sc</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;Cluster&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 调整布局</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>tight_layout</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=o>.</span><span class=n>head</span><span class=p>()</span>
</span></span></code></pre></div><h5 id=umap-gif>UMAP GIF<a hidden class=anchor aria-hidden=true href=#umap-gif>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>umap</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mpl_toolkits.mplot3d</span> <span class=kn>import</span> <span class=n>Axes3D</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>imageio</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 假设df是你的数据框，columns是你想要降维的列</span>
</span></span><span class=line><span class=cl><span class=n>frames</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>n</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=mi>51</span><span class=p>,</span> <span class=mi>5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>reducer</span> <span class=o>=</span> <span class=n>umap</span><span class=o>.</span><span class=n>UMAP</span><span class=p>(</span><span class=n>n_components</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span> <span class=n>random_state</span><span class=o>=</span><span class=mi>8</span><span class=p>,</span> <span class=n>n_neighbors</span><span class=o>=</span><span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>embedding</span> <span class=o>=</span> <span class=n>reducer</span><span class=o>.</span><span class=n>fit_transform</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=n>columns</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 创建一个3D图形</span>
</span></span><span class=line><span class=cl>    <span class=n>fig</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>figure</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=mi>6</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>ax</span> <span class=o>=</span> <span class=n>fig</span><span class=o>.</span><span class=n>add_subplot</span><span class=p>(</span><span class=mi>111</span><span class=p>,</span> <span class=n>projection</span><span class=o>=</span><span class=s1>&#39;3d&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 绘制散点图</span>
</span></span><span class=line><span class=cl>    <span class=n>sc</span> <span class=o>=</span> <span class=n>ax</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>embedding</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>],</span> <span class=n>embedding</span><span class=p>[:,</span> <span class=mi>1</span><span class=p>],</span> <span class=n>embedding</span><span class=p>[:,</span> <span class=mi>2</span><span class=p>],</span> <span class=n>c</span><span class=o>=</span><span class=n>clusters</span><span class=p>,</span> <span class=n>cmap</span><span class=o>=</span><span class=s1>&#39;viridis&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>title</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;UMAP projection with </span><span class=si>{</span><span class=n>n</span><span class=si>}</span><span class=s1> neighbors&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax</span><span class=o>.</span><span class=n>set_xlabel</span><span class=p>(</span><span class=s1>&#39;Dimension 1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s1>&#39;Dimension 2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax</span><span class=o>.</span><span class=n>set_zlabel</span><span class=p>(</span><span class=s1>&#39;Dimension 3&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>fig</span><span class=o>.</span><span class=n>colorbar</span><span class=p>(</span><span class=n>sc</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;Cluster&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 调整布局</span>
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>tight_layout</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 保存图像</span>
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>savefig</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;umap_</span><span class=si>{</span><span class=n>n</span><span class=si>}</span><span class=s1>.png&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>close</span><span class=p>(</span><span class=n>fig</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>frames</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>imageio</span><span class=o>.</span><span class=n>imread</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;umap_</span><span class=si>{</span><span class=n>n</span><span class=si>}</span><span class=s1>.png&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 保存为GIF</span>
</span></span><span class=line><span class=cl><span class=n>imageio</span><span class=o>.</span><span class=n>mimsave</span><span class=p>(</span><span class=s1>&#39;umap.gif&#39;</span><span class=p>,</span> <span class=n>frames</span><span class=p>,</span> <span class=s1>&#39;GIF&#39;</span><span class=p>,</span> <span class=n>duration</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=o>.</span><span class=n>head</span><span class=p>()</span>
</span></span></code></pre></div><h4 id=输出聚类结果>输出聚类结果<a hidden class=anchor aria-hidden=true href=#输出聚类结果>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>csv</span>
</span></span><span class=line><span class=cl><span class=c1># 聚类中心</span>
</span></span><span class=line><span class=cl><span class=n>centroids</span> <span class=o>=</span> <span class=n>kproto</span><span class=o>.</span><span class=n>cluster_centroids_</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># show_columns = [&#39;Q2&#39;, &#39;Q4&#39;, &#39;Q5&#39;,&#39;Q7|1&#39;, &#39;Q7|4&#39;, &#39;Q7|2&#39;, &#39;Q7|3&#39;, &#39;Q7|5&#39;, &#39;Q7|6&#39;,&#39;Q1&#39;, &#39;Q3&#39;, &#39;Q8&#39;, &#39;Q9&#39;, &#39;Q10&#39;, &#39;Q11&#39;, &#39;Q12&#39;, &#39;Q13&#39;, &#39;Q14&#39;, &#39;Q15&#39;, &#39;Q16|6&#39;, &#39;Q16|1&#39;, &#39;Q16|2&#39;, &#39;Q16|3&#39;, &#39;Q16|7&#39;, &#39;Q16|4&#39;, &#39;Q16|10&#39;, &#39;Q16|11&#39;, &#39;Q16|9&#39;]</span>
</span></span><span class=line><span class=cl><span class=n>show_columns</span> <span class=o>=</span> <span class=n>columns</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 打开你想要写入的文件</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;centroids.csv&#39;</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>,</span> <span class=n>newline</span><span class=o>=</span><span class=s1>&#39;&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>file</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>writer</span> <span class=o>=</span> <span class=n>csv</span><span class=o>.</span><span class=n>writer</span><span class=p>(</span><span class=n>file</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># 写入题号作为第一行</span>
</span></span><span class=line><span class=cl>    <span class=n>writer</span><span class=o>.</span><span class=n>writerow</span><span class=p>(</span><span class=n>show_columns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># 写入数据</span>
</span></span><span class=line><span class=cl>    <span class=n>writer</span><span class=o>.</span><span class=n>writerows</span><span class=p>(</span><span class=n>centroids</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 打印题号和聚类中心</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Question IDs:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>show_columns</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Cluster centroids:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>centroids</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 聚类标签</span>
</span></span><span class=line><span class=cl><span class=n>labels</span> <span class=o>=</span> <span class=n>kproto</span><span class=o>.</span><span class=n>labels_</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Labels of first 10 data points:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>labels</span><span class=p>[:</span><span class=mi>10</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=o>.</span><span class=n>head</span><span class=p>()</span>
</span></span></code></pre></div><h4 id=对照文本编码>对照文本编码<a hidden class=anchor aria-hidden=true href=#对照文本编码>#</a></h4><p>读取centroids.csv匹配structured_questions.json中的题号把对应的单选选项换掉，并添加上题目</p><p>结果在centrios.csv中</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>csv</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 读取 structured_questions.json 文件</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;structured_questions.json&#39;</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>json_file</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>structured_questions</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>json_file</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 读取 centroids.csv 文件</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;centroids.csv&#39;</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>csv_file</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>csv_reader</span> <span class=o>=</span> <span class=n>csv</span><span class=o>.</span><span class=n>reader</span><span class=p>(</span><span class=n>csv_file</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>csv_reader</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 先替换选项</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>row</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>i</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>  
</span></span><span class=line><span class=cl>        <span class=k>continue</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>j</span><span class=p>,</span> <span class=n>value</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>row</span><span class=p>):</span>  <span class=c1># 遍历每一列</span>
</span></span><span class=line><span class=cl>        <span class=n>question_id</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=n>j</span><span class=p>]</span>  <span class=c1># 获取题号，只有单选和填空的格式是Q1这种，可以匹配上</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>question_id</span> <span class=ow>in</span> <span class=n>structured_questions</span><span class=p>:</span>  <span class=c1># 如果题号在 structured_questions 中</span>
</span></span><span class=line><span class=cl>            <span class=c1># 替换选项</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>structured_questions</span><span class=p>[</span><span class=n>question_id</span><span class=p>][</span><span class=s1>&#39;options&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl><span class=c1># 再替换题目</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>row</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>i</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>  <span class=c1># 指针对第一行替换题目</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>j</span><span class=p>,</span> <span class=n>value</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>row</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>value</span> <span class=ow>in</span> <span class=n>structured_questions</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>data</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>value</span> <span class=o>+</span><span class=s2>&#34; &#34;</span><span class=o>+</span><span class=n>structured_questions</span><span class=p>[</span><span class=n>value</span><span class=p>][</span><span class=s1>&#39;text&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 对于题目为Q7 | 1这种格式，把Q7替换为text的内容，1替换为options中的内容</span>
</span></span><span class=line><span class=cl>            <span class=c1># 用正则表达式匹配</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>re</span><span class=o>.</span><span class=k>match</span><span class=p>(</span><span class=sa>r</span><span class=s2>&#34;^Q\d+\|\d+$&#34;</span><span class=p>,</span> <span class=n>value</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>question_id</span><span class=p>,</span> <span class=n>option_id</span> <span class=o>=</span> <span class=n>value</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;|&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>question_id</span> <span class=ow>in</span> <span class=n>structured_questions</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>data</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>question_id</span> <span class=o>+</span><span class=s2>&#34; &#34;</span><span class=o>+</span> <span class=n>structured_questions</span><span class=p>[</span><span class=n>question_id</span><span class=p>][</span><span class=s1>&#39;text&#39;</span><span class=p>]</span> <span class=o>+</span> <span class=s2>&#34;: &#34;</span> <span class=o>+</span> <span class=n>structured_questions</span><span class=p>[</span><span class=n>question_id</span><span class=p>][</span><span class=s1>&#39;options&#39;</span><span class=p>][</span><span class=n>option_id</span><span class=p>]</span>            
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>i</span><span class=o>!=</span><span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 将更新后的数据写回 centroids.csv 文件</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;centroids.csv&#39;</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>,</span> <span class=n>newline</span><span class=o>=</span><span class=s1>&#39;&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>csv_file</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>csv_writer</span> <span class=o>=</span> <span class=n>csv</span><span class=o>.</span><span class=n>writer</span><span class=p>(</span><span class=n>csv_file</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>csv_writer</span><span class=o>.</span><span class=n>writerows</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=n>df</span><span class=o>.</span><span class=n>head</span><span class=p>()</span>
</span></span></code></pre></div><h3 id=基于密度聚类-dbscan>基于密度聚类 DBSCAN<a hidden class=anchor aria-hidden=true href=#基于密度聚类-dbscan>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.cluster</span> <span class=kn>import</span> <span class=n>DBSCAN</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.preprocessing</span> <span class=kn>import</span> <span class=n>StandardScaler</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.manifold</span> <span class=kn>import</span> <span class=n>TSNE</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pandas</span> <span class=k>as</span> <span class=nn>pd</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>df</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 列表中的列名</span>
</span></span><span class=line><span class=cl><span class=n>columns</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;Q1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q3&#39;</span><span class=p>,</span> <span class=s1>&#39;Q4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|3&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|6&#39;</span><span class=p>,</span> <span class=s1>&#39;Q8&#39;</span><span class=p>,</span> <span class=s1>&#39;Q9&#39;</span><span class=p>,</span> <span class=s1>&#39;Q10&#39;</span><span class=p>,</span> <span class=s1>&#39;Q11&#39;</span><span class=p>,</span> <span class=s1>&#39;Q12&#39;</span><span class=p>,</span> <span class=s1>&#39;Q13&#39;</span><span class=p>,</span> <span class=s1>&#39;Q14&#39;</span><span class=p>,</span> <span class=s1>&#39;Q15&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|6&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|3&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|7&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|10&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|11&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|9&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 数值型列</span>
</span></span><span class=line><span class=cl><span class=n>numerical_columns</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;Q2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q5&#39;</span><span class=p>,</span><span class=s1>&#39;Q7|1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|3&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|6&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 对数值型列进行标准化</span>
</span></span><span class=line><span class=cl><span class=n>scaler</span> <span class=o>=</span> <span class=n>StandardScaler</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=p>[</span><span class=n>numerical_columns</span><span class=p>]</span> <span class=o>=</span> <span class=n>scaler</span><span class=o>.</span><span class=n>fit_transform</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=n>numerical_columns</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>X</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>columns</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 初始化 DBSCAN 聚类器</span>
</span></span><span class=line><span class=cl><span class=n>dbscan</span> <span class=o>=</span> <span class=n>DBSCAN</span><span class=p>(</span><span class=n>eps</span><span class=o>=</span><span class=mf>4.7</span><span class=p>,</span> <span class=n>min_samples</span><span class=o>=</span><span class=mi>7</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 进行聚类</span>
</span></span><span class=line><span class=cl><span class=n>clusters</span> <span class=o>=</span> <span class=n>dbscan</span><span class=o>.</span><span class=n>fit_predict</span><span class=p>(</span><span class=n>X</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 添加数据标签</span>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=p>[</span><span class=s1>&#39;dbscan cluster&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>clusters</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用t-SNE进行降维</span>
</span></span><span class=line><span class=cl><span class=n>tsne</span> <span class=o>=</span> <span class=n>TSNE</span><span class=p>(</span><span class=n>n_components</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>random_state</span><span class=o>=</span><span class=mi>42</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>X_tsne</span> <span class=o>=</span> <span class=n>tsne</span><span class=o>.</span><span class=n>fit_transform</span><span class=p>(</span><span class=n>X</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 绘制散点图</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>figure</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=mi>6</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>X_tsne</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>],</span> <span class=n>X_tsne</span><span class=p>[:,</span> <span class=mi>1</span><span class=p>],</span> <span class=n>c</span><span class=o>=</span><span class=n>clusters</span><span class=p>,</span> <span class=n>cmap</span><span class=o>=</span><span class=s1>&#39;viridis&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>title</span><span class=p>(</span><span class=s1>&#39;t-SNE projection&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>xlabel</span><span class=p>(</span><span class=s1>&#39;Dimension 1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>ylabel</span><span class=p>(</span><span class=s1>&#39;Dimension 2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>colorbar</span><span class=p>(</span><span class=n>label</span><span class=o>=</span><span class=s1>&#39;Cluster&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=o>.</span><span class=n>head</span><span class=p>()</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.cluster</span> <span class=kn>import</span> <span class=n>DBSCAN</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.preprocessing</span> <span class=kn>import</span> <span class=n>StandardScaler</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.manifold</span> <span class=kn>import</span> <span class=n>TSNE</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mpl_toolkits.mplot3d</span> <span class=kn>import</span> <span class=n>Axes3D</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pandas</span> <span class=k>as</span> <span class=nn>pd</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>df</span><span class=o>.</span><span class=n>columns</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># 列表中的列名</span>
</span></span><span class=line><span class=cl><span class=n>columns</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;Q1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q3&#39;</span><span class=p>,</span> <span class=s1>&#39;Q4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|3&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|6&#39;</span><span class=p>,</span> <span class=s1>&#39;Q8&#39;</span><span class=p>,</span> <span class=s1>&#39;Q9&#39;</span><span class=p>,</span> <span class=s1>&#39;Q10&#39;</span><span class=p>,</span> <span class=s1>&#39;Q11&#39;</span><span class=p>,</span> <span class=s1>&#39;Q12&#39;</span><span class=p>,</span> <span class=s1>&#39;Q13&#39;</span><span class=p>,</span> <span class=s1>&#39;Q14&#39;</span><span class=p>,</span> <span class=s1>&#39;Q15&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|6&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|3&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|7&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|10&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|11&#39;</span><span class=p>,</span> <span class=s1>&#39;Q16|9&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 数值型列</span>
</span></span><span class=line><span class=cl><span class=n>numerical_columns</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;Q2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q5&#39;</span><span class=p>,</span><span class=s1>&#39;Q7|1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|3&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q7|6&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 对数值型列进行标准化</span>
</span></span><span class=line><span class=cl><span class=n>scaler</span> <span class=o>=</span> <span class=n>StandardScaler</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=p>[</span><span class=n>numerical_columns</span><span class=p>]</span> <span class=o>=</span> <span class=n>scaler</span><span class=o>.</span><span class=n>fit_transform</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=n>numerical_columns</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>X</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>columns</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 初始化 DBSCAN 聚类器</span>
</span></span><span class=line><span class=cl><span class=n>dbscan</span> <span class=o>=</span> <span class=n>DBSCAN</span><span class=p>(</span><span class=n>eps</span><span class=o>=</span><span class=mf>4.7</span><span class=p>,</span> <span class=n>min_samples</span><span class=o>=</span><span class=mi>7</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 进行聚类</span>
</span></span><span class=line><span class=cl><span class=n>clusters</span> <span class=o>=</span> <span class=n>dbscan</span><span class=o>.</span><span class=n>fit_predict</span><span class=p>(</span><span class=n>X</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用t-SNE进行降维</span>
</span></span><span class=line><span class=cl><span class=n>tsne</span> <span class=o>=</span> <span class=n>TSNE</span><span class=p>(</span><span class=n>n_components</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span> <span class=n>random_state</span><span class=o>=</span><span class=mi>42</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>X_tsne</span> <span class=o>=</span> <span class=n>tsne</span><span class=o>.</span><span class=n>fit_transform</span><span class=p>(</span><span class=n>X</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建一个3D图形</span>
</span></span><span class=line><span class=cl><span class=n>fig</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>figure</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=mi>6</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>ax</span> <span class=o>=</span> <span class=n>fig</span><span class=o>.</span><span class=n>add_subplot</span><span class=p>(</span><span class=mi>111</span><span class=p>,</span> <span class=n>projection</span><span class=o>=</span><span class=s1>&#39;3d&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 绘制散点图</span>
</span></span><span class=line><span class=cl><span class=n>sc</span> <span class=o>=</span> <span class=n>ax</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>X_tsne</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>],</span> <span class=n>X_tsne</span><span class=p>[:,</span> <span class=mi>1</span><span class=p>],</span> <span class=n>X_tsne</span><span class=p>[:,</span> <span class=mi>2</span><span class=p>],</span> <span class=n>c</span><span class=o>=</span><span class=n>clusters</span><span class=p>,</span> <span class=n>cmap</span><span class=o>=</span><span class=s1>&#39;viridis&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>title</span><span class=p>(</span><span class=s1>&#39;t-SNE projection&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ax</span><span class=o>.</span><span class=n>set_xlabel</span><span class=p>(</span><span class=s1>&#39;Dimension 1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ax</span><span class=o>.</span><span class=n>set_ylabel</span><span class=p>(</span><span class=s1>&#39;Dimension 2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ax</span><span class=o>.</span><span class=n>set_zlabel</span><span class=p>(</span><span class=s1>&#39;Dimension 3&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fig</span><span class=o>.</span><span class=n>colorbar</span><span class=p>(</span><span class=n>sc</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;Cluster&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=o>.</span><span class=n>head</span><span class=p>()</span>
</span></span></code></pre></div><h2 id=决策树>决策树<a hidden class=anchor aria-hidden=true href=#决策树>#</a></h2><h3 id=基础知识-2>基础知识<a hidden class=anchor aria-hidden=true href=#基础知识-2>#</a></h3><p>决策树是一种常用的数据挖掘技术，用于分类和回归任务。它通过构造一个树状结构来模拟决策过程。主要的决策树算法包括：</p><ol><li><strong>ID3（Iterative Dichotomiser 3）</strong>：基于信息增益来选择特征。</li><li><strong>C4.5</strong>：ID3的改进版，使用增益率来选择特征。</li><li><strong>CART（Classification and Regression Trees）</strong>：同时支持分类和回归任务，基于基尼不纯度（对于分类）或最小二乘偏差（对于回归）来选择特征。</li><li><strong>CHAID（Chi-squared Automatic Interaction Detector）</strong>：使用卡方检验来选择最佳特征，可以处理分类变量。</li></ol><p>这些方法在不同的情况下各有优势。例如，CART是最常用的算法之一，因为它简单且适用于各种类型的数据。</p><h3 id=cart决策树决定游客来不来的画像因素分析>CART决策树：决定游客来不来的画像因素分析<a hidden class=anchor aria-hidden=true href=#cart决策树决定游客来不来的画像因素分析>#</a></h3><p>针对没有来过的游客，分析他们没有来过的原因</p><h4 id=决策树处理>决策树处理<a hidden class=anchor aria-hidden=true href=#决策树处理>#</a></h4><p>核心问题是Q29，可以结合游客的基本信息一起分析
Q29|R1,Q29|R2,Q29|R3,Q29|R4</p><p>k-prototypes cluster 之前聚类的结果</p><p>feature_columns是问卷的一组问题，目标变量是去了还是没有去</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.model_selection</span> <span class=kn>import</span> <span class=n>train_test_split</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.tree</span> <span class=kn>import</span> <span class=n>DecisionTreeClassifier</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.metrics</span> <span class=kn>import</span> <span class=n>classification_report</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.tree</span> <span class=kn>import</span> <span class=n>plot_tree</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.feature_selection</span> <span class=kn>import</span> <span class=n>SelectPercentile</span><span class=p>,</span> <span class=n>chi2</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 定义特征和目标变量</span>
</span></span><span class=line><span class=cl><span class=n>feature_columns</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;Q8&#39;</span><span class=p>,</span><span class=s1>&#39;Q9&#39;</span><span class=p>,</span><span class=s1>&#39;Q10&#39;</span><span class=p>,</span><span class=s1>&#39;Q11&#39;</span><span class=p>,</span><span class=s1>&#39;Q12&#39;</span><span class=p>,</span><span class=s1>&#39;Q13&#39;</span><span class=p>,</span><span class=s1>&#39;Q14&#39;</span><span class=p>,</span><span class=s1>&#39;Q15&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>X_unencoded</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>feature_columns</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>target_column</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;Q17&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 对特征进行0-1编码</span>
</span></span><span class=line><span class=cl><span class=n>X_encoded</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>get_dummies</span><span class=p>(</span><span class=n>X_unencoded</span><span class=p>,</span> <span class=n>columns</span><span class=o>=</span><span class=n>feature_columns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 对目标变量进行0-1编码</span>
</span></span><span class=line><span class=cl><span class=n>y_encoded</span> <span class=o>=</span> <span class=n>target_column</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 特征选择</span>
</span></span><span class=line><span class=cl><span class=n>selector</span> <span class=o>=</span> <span class=n>SelectPercentile</span><span class=p>(</span><span class=n>chi2</span><span class=p>,</span> <span class=n>percentile</span><span class=o>=</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>X_new</span> <span class=o>=</span> <span class=n>selector</span><span class=o>.</span><span class=n>fit_transform</span><span class=p>(</span><span class=n>X_encoded</span><span class=p>,</span> <span class=n>y_encoded</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 划分训练集和测试集</span>
</span></span><span class=line><span class=cl><span class=n>X_train</span><span class=p>,</span> <span class=n>X_test</span><span class=p>,</span> <span class=n>y_train</span><span class=p>,</span> <span class=n>y_test</span> <span class=o>=</span> <span class=n>train_test_split</span><span class=p>(</span><span class=n>X_new</span><span class=p>,</span> <span class=n>y_encoded</span><span class=p>,</span> <span class=n>test_size</span><span class=o>=</span><span class=mf>0.1</span><span class=p>,</span> <span class=n>random_state</span><span class=o>=</span><span class=mi>42</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Best feature selector: SelectPercentile</span>
</span></span><span class=line><span class=cl><span class=c1># Best parameters: {&#39;criterion&#39;: &#39;gini&#39;, &#39;max_depth&#39;: 5, &#39;min_samples_leaf&#39;: 3, &#39;min_samples_split&#39;: 2, &#39;splitter&#39;: &#39;best&#39;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 初始化决策树分类器</span>
</span></span><span class=line><span class=cl><span class=n>classifier</span> <span class=o>=</span> <span class=n>DecisionTreeClassifier</span><span class=p>(</span><span class=n>random_state</span><span class=o>=</span><span class=mi>42</span><span class=p>,</span> <span class=n>max_depth</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span><span class=n>criterion</span><span class=o>=</span><span class=s1>&#39;gini&#39;</span><span class=p>,</span><span class=n>splitter</span><span class=o>=</span><span class=s1>&#39;best&#39;</span><span class=p>,</span><span class=n>min_samples_split</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span><span class=n>min_samples_leaf</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 训练模型</span>
</span></span><span class=line><span class=cl><span class=n>classifier</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span><span class=n>X_train</span><span class=p>,</span> <span class=n>y_train</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 预测测试集</span>
</span></span><span class=line><span class=cl><span class=n>y_pred</span> <span class=o>=</span> <span class=n>classifier</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>X_test</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 打印分类报告</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>classification_report</span><span class=p>(</span><span class=n>y_test</span><span class=p>,</span> <span class=n>y_pred</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 获取目标变量的类别名称</span>
</span></span><span class=line><span class=cl><span class=n>class_names</span> <span class=o>=</span> <span class=n>target_column</span><span class=o>.</span><span class=n>unique</span><span class=p>()</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 将类别名称转换为字符串</span>
</span></span><span class=line><span class=cl><span class=n>class_names</span> <span class=o>=</span> <span class=p>[</span><span class=nb>str</span><span class=p>(</span><span class=n>name</span><span class=p>)</span> <span class=k>for</span> <span class=n>name</span> <span class=ow>in</span> <span class=n>class_names</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 绘制决策树</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>figure</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>80</span><span class=p>,</span><span class=mi>40</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>plot_tree</span><span class=p>(</span><span class=n>classifier</span><span class=p>,</span> <span class=n>filled</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>class_names</span><span class=o>=</span><span class=n>class_names</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span></code></pre></div><h4 id=超参数调优>超参数调优<a hidden class=anchor aria-hidden=true href=#超参数调优>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.feature_selection</span> <span class=kn>import</span> <span class=n>SelectKBest</span><span class=p>,</span> <span class=n>chi2</span><span class=p>,</span> <span class=n>SelectPercentile</span><span class=p>,</span> <span class=n>mutual_info_classif</span><span class=p>,</span> <span class=n>f_classif</span><span class=p>,</span> <span class=n>SelectFromModel</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.linear_model</span> <span class=kn>import</span> <span class=n>LogisticRegression</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.model_selection</span> <span class=kn>import</span> <span class=n>GridSearchCV</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.tree</span> <span class=kn>import</span> <span class=n>DecisionTreeClassifier</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.metrics</span> <span class=kn>import</span> <span class=n>f1_score</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 定义特征选择方法</span>
</span></span><span class=line><span class=cl><span class=n>feature_selectors</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=s1>&#39;SelectKBest_chi2&#39;</span><span class=p>,</span> <span class=n>SelectKBest</span><span class=p>(</span><span class=n>chi2</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=mi>10</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=s1>&#39;SelectPercentile&#39;</span><span class=p>,</span> <span class=n>SelectPercentile</span><span class=p>(</span><span class=n>chi2</span><span class=p>,</span> <span class=n>percentile</span><span class=o>=</span><span class=mi>10</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=s1>&#39;mutual_info_classif&#39;</span><span class=p>,</span> <span class=n>SelectKBest</span><span class=p>(</span><span class=n>mutual_info_classif</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=mi>10</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=s1>&#39;f_classif&#39;</span><span class=p>,</span> <span class=n>SelectKBest</span><span class=p>(</span><span class=n>f_classif</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=mi>10</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=s1>&#39;SelectFromModel&#39;</span><span class=p>,</span> <span class=n>SelectFromModel</span><span class=p>(</span><span class=n>LogisticRegression</span><span class=p>(</span><span class=n>penalty</span><span class=o>=</span><span class=s2>&#34;l1&#34;</span><span class=p>,</span> <span class=n>solver</span><span class=o>=</span><span class=s1>&#39;liblinear&#39;</span><span class=p>))),</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 定义要搜索的参数范围</span>
</span></span><span class=line><span class=cl><span class=n>param_grid</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;max_depth&#39;</span><span class=p>:</span> <span class=p>[</span><span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>7</span><span class=p>,</span> <span class=mi>8</span><span class=p>,</span> <span class=mi>9</span><span class=p>,</span> <span class=mi>10</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;criterion&#39;</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;gini&#39;</span><span class=p>,</span> <span class=s1>&#39;entropy&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;splitter&#39;</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;best&#39;</span><span class=p>,</span> <span class=s1>&#39;random&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;min_samples_split&#39;</span><span class=p>:</span> <span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;min_samples_leaf&#39;</span><span class=p>:</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 初始化决策树分类器</span>
</span></span><span class=line><span class=cl><span class=n>classifier</span> <span class=o>=</span> <span class=n>DecisionTreeClassifier</span><span class=p>(</span><span class=n>random_state</span><span class=o>=</span><span class=mi>42</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 初始化网格搜索</span>
</span></span><span class=line><span class=cl><span class=n>grid_search</span> <span class=o>=</span> <span class=n>GridSearchCV</span><span class=p>(</span><span class=n>classifier</span><span class=p>,</span> <span class=n>param_grid</span><span class=p>,</span> <span class=n>cv</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span> <span class=n>scoring</span><span class=o>=</span><span class=s1>&#39;f1_macro&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>best_score</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=n>best_selector</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl><span class=n>best_params</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 对每个特征选择方法进行迭代</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>name</span><span class=p>,</span> <span class=n>selector</span> <span class=ow>in</span> <span class=n>feature_selectors</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 执行特征选择</span>
</span></span><span class=line><span class=cl>    <span class=n>X_new</span> <span class=o>=</span> <span class=n>selector</span><span class=o>.</span><span class=n>fit_transform</span><span class=p>(</span><span class=n>X_encoded</span><span class=p>,</span> <span class=n>y_encoded</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 执行网格搜索</span>
</span></span><span class=line><span class=cl>    <span class=n>grid_search</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span><span class=n>X_new</span><span class=p>,</span> <span class=n>y_encoded</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 如果这个得分比之前的得分好，就更新最好的得分和最好的参数</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>grid_search</span><span class=o>.</span><span class=n>best_score_</span> <span class=o>&gt;</span> <span class=n>best_score</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>best_score</span> <span class=o>=</span> <span class=n>grid_search</span><span class=o>.</span><span class=n>best_score_</span>
</span></span><span class=line><span class=cl>        <span class=n>best_selector</span> <span class=o>=</span> <span class=n>name</span>
</span></span><span class=line><span class=cl>        <span class=n>best_params</span> <span class=o>=</span> <span class=n>grid_search</span><span class=o>.</span><span class=n>best_params_</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 打印最好的特征选择方法和最好的参数</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Best feature selector:&#39;</span><span class=p>,</span> <span class=n>best_selector</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Best parameters:&#39;</span><span class=p>,</span> <span class=n>best_params</span><span class=p>)</span>
</span></span></code></pre></div><h3 id=cart决策树游客满意度因素分析>CART决策树：游客满意度因素分析<a hidden class=anchor aria-hidden=true href=#cart决策树游客满意度因素分析>#</a></h3><p>数据集：df_cart_satisfaction</p><p>目标变量是&rsquo;满意度&rsquo;，分类变量：Q24|R1,Q24|R2,Q24|R3,Q24|R4,Q24|R5,Q24|R6,Q24|R7,Q24|R8,Q24|R9,Q24|R10,Q24|R11,Q24|R12,Q24|R13,Q24|R14,Q24|R18,Q24|R15,Q24|R16,Q24|R17</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pandas</span> <span class=k>as</span> <span class=nn>pd</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 从&#34;熵权满意度.xlsx&#34;中读取数据</span>
</span></span><span class=line><span class=cl><span class=n>df_cart_satisfaction</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>read_excel</span><span class=p>(</span><span class=s1>&#39;熵权满意度.xlsx&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>df_cart_satisfaction</span><span class=o>.</span><span class=n>head</span><span class=p>()</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.model_selection</span> <span class=kn>import</span> <span class=n>train_test_split</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.tree</span> <span class=kn>import</span> <span class=n>DecisionTreeRegressor</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.metrics</span> <span class=kn>import</span> <span class=n>mean_squared_error</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.tree</span> <span class=kn>import</span> <span class=n>plot_tree</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 定义特征和目标变量</span>
</span></span><span class=line><span class=cl><span class=n>feature_columns</span> <span class=o>=</span><span class=p>[</span><span class=s1>&#39;Q24|R1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R3&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R6&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R7&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R8&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R9&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R10&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R11&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R12&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R13&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R14&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R18&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R15&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R16&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R17&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>X</span> <span class=o>=</span> <span class=n>df_cart_satisfaction</span><span class=p>[</span><span class=n>feature_columns</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>y</span> <span class=o>=</span> <span class=n>df_cart_satisfaction</span><span class=p>[</span><span class=s1>&#39;满意度&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Best feature selector: mutual_info_regression</span>
</span></span><span class=line><span class=cl><span class=c1># Best parameters: {&#39;max_depth&#39;: 10, &#39;min_samples_leaf&#39;: 1, &#39;min_samples_split&#39;: 3, &#39;splitter&#39;: &#39;random&#39;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 划分训练集和测试集</span>
</span></span><span class=line><span class=cl><span class=n>X_train</span><span class=p>,</span> <span class=n>X_test</span><span class=p>,</span> <span class=n>y_train</span><span class=p>,</span> <span class=n>y_test</span> <span class=o>=</span> <span class=n>train_test_split</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>test_size</span><span class=o>=</span><span class=mf>0.1</span><span class=p>,</span> <span class=n>random_state</span><span class=o>=</span><span class=mi>42</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 初始化决策树回归器</span>
</span></span><span class=line><span class=cl><span class=n>regressor</span> <span class=o>=</span> <span class=n>DecisionTreeRegressor</span><span class=p>(</span><span class=n>random_state</span><span class=o>=</span><span class=mi>42</span><span class=p>,</span> <span class=n>max_depth</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span><span class=n>min_samples_split</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span><span class=n>min_samples_leaf</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span><span class=n>splitter</span><span class=o>=</span><span class=s1>&#39;random&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 训练模型</span>
</span></span><span class=line><span class=cl><span class=n>regressor</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span><span class=n>X_train</span><span class=p>,</span> <span class=n>y_train</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 预测测试集</span>
</span></span><span class=line><span class=cl><span class=n>y_pred</span> <span class=o>=</span> <span class=n>regressor</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>X_test</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 打印均方误差</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Mean Squared Error: &#34;</span><span class=p>,</span> <span class=n>mean_squared_error</span><span class=p>(</span><span class=n>y_test</span><span class=p>,</span> <span class=n>y_pred</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 绘制决策树</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>figure</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>80</span><span class=p>,</span><span class=mi>40</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>plot_tree</span><span class=p>(</span><span class=n>regressor</span><span class=p>,</span> <span class=n>filled</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.feature_selection</span> <span class=kn>import</span> <span class=n>SelectKBest</span><span class=p>,</span> <span class=n>f_regression</span><span class=p>,</span> <span class=n>mutual_info_regression</span><span class=p>,</span> <span class=n>SelectFromModel</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.linear_model</span> <span class=kn>import</span> <span class=n>Lasso</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.model_selection</span> <span class=kn>import</span> <span class=n>GridSearchCV</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.tree</span> <span class=kn>import</span> <span class=n>DecisionTreeRegressor</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.metrics</span> <span class=kn>import</span> <span class=n>make_scorer</span><span class=p>,</span> <span class=n>mean_squared_error</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 定义特征选择方法</span>
</span></span><span class=line><span class=cl><span class=n>feature_selectors</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=s1>&#39;SelectKBest_f_regression&#39;</span><span class=p>,</span> <span class=n>SelectKBest</span><span class=p>(</span><span class=n>f_regression</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=mi>10</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=s1>&#39;mutual_info_regression&#39;</span><span class=p>,</span> <span class=n>SelectKBest</span><span class=p>(</span><span class=n>mutual_info_regression</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=mi>10</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=s1>&#39;SelectFromModel&#39;</span><span class=p>,</span> <span class=n>SelectFromModel</span><span class=p>(</span><span class=n>Lasso</span><span class=p>(</span><span class=n>alpha</span><span class=o>=</span><span class=mf>0.1</span><span class=p>))),</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 定义要搜索的参数范围</span>
</span></span><span class=line><span class=cl><span class=n>param_grid</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;max_depth&#39;</span><span class=p>:</span> <span class=p>[</span><span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>7</span><span class=p>,</span> <span class=mi>8</span><span class=p>,</span> <span class=mi>9</span><span class=p>,</span> <span class=mi>10</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;splitter&#39;</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;best&#39;</span><span class=p>,</span> <span class=s1>&#39;random&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;min_samples_split&#39;</span><span class=p>:</span> <span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;min_samples_leaf&#39;</span><span class=p>:</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 初始化决策树回归器</span>
</span></span><span class=line><span class=cl><span class=n>regressor</span> <span class=o>=</span> <span class=n>DecisionTreeRegressor</span><span class=p>(</span><span class=n>random_state</span><span class=o>=</span><span class=mi>42</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 初始化网格搜索</span>
</span></span><span class=line><span class=cl><span class=n>grid_search</span> <span class=o>=</span> <span class=n>GridSearchCV</span><span class=p>(</span><span class=n>regressor</span><span class=p>,</span> <span class=n>param_grid</span><span class=p>,</span> <span class=n>cv</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span> <span class=n>scoring</span><span class=o>=</span><span class=n>make_scorer</span><span class=p>(</span><span class=n>mean_squared_error</span><span class=p>,</span> <span class=n>greater_is_better</span><span class=o>=</span><span class=kc>False</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>best_score</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=s1>&#39;inf&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>best_selector</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl><span class=n>best_params</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 对每个特征选择方法进行迭代</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>name</span><span class=p>,</span> <span class=n>selector</span> <span class=ow>in</span> <span class=n>feature_selectors</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 执行特征选择</span>
</span></span><span class=line><span class=cl>    <span class=n>X_new</span> <span class=o>=</span> <span class=n>selector</span><span class=o>.</span><span class=n>fit_transform</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 执行网格搜索</span>
</span></span><span class=line><span class=cl>    <span class=n>grid_search</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span><span class=n>X_new</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 如果这个得分比之前的得分好，就更新最好的得分和最好的参数</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>grid_search</span><span class=o>.</span><span class=n>best_score_</span> <span class=o>&lt;</span> <span class=n>best_score</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>best_score</span> <span class=o>=</span> <span class=n>grid_search</span><span class=o>.</span><span class=n>best_score_</span>
</span></span><span class=line><span class=cl>        <span class=n>best_selector</span> <span class=o>=</span> <span class=n>name</span>
</span></span><span class=line><span class=cl>        <span class=n>best_params</span> <span class=o>=</span> <span class=n>grid_search</span><span class=o>.</span><span class=n>best_params_</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 打印最好的特征选择方法和最好的参数</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Best feature selector:&#39;</span><span class=p>,</span> <span class=n>best_selector</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Best parameters:&#39;</span><span class=p>,</span> <span class=n>best_params</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pandas</span> <span class=k>as</span> <span class=nn>pd</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Load the dataset</span>
</span></span><span class=line><span class=cl><span class=n>df_cart_satisfaction</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>read_excel</span><span class=p>(</span><span class=s1>&#39;熵权满意度.xlsx&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.model_selection</span> <span class=kn>import</span> <span class=n>train_test_split</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.tree</span> <span class=kn>import</span> <span class=n>DecisionTreeRegressor</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.metrics</span> <span class=kn>import</span> <span class=n>mean_squared_error</span><span class=p>,</span> <span class=n>r2_score</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Feature and target columns</span>
</span></span><span class=line><span class=cl><span class=n>feature_columns</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;Q24|R1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R3&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R6&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R7&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R8&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R9&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R10&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R11&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R12&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R13&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R14&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R18&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R15&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R16&#39;</span><span class=p>,</span> <span class=s1>&#39;Q24|R17&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>X</span> <span class=o>=</span> <span class=n>df_cart_satisfaction</span><span class=p>[</span><span class=n>feature_columns</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>y</span> <span class=o>=</span> <span class=n>df_cart_satisfaction</span><span class=p>[</span><span class=s1>&#39;满意度&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Splitting data into training and testing sets</span>
</span></span><span class=line><span class=cl><span class=n>X_train</span><span class=p>,</span> <span class=n>X_test</span><span class=p>,</span> <span class=n>y_train</span><span class=p>,</span> <span class=n>y_test</span> <span class=o>=</span> <span class=n>train_test_split</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>test_size</span><span class=o>=</span><span class=mf>0.2</span><span class=p>,</span> <span class=n>random_state</span><span class=o>=</span><span class=mi>42</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Initialize and train Decision Tree Regressor</span>
</span></span><span class=line><span class=cl><span class=n>dt_regressor</span> <span class=o>=</span> <span class=n>DecisionTreeRegressor</span><span class=p>(</span><span class=n>random_state</span><span class=o>=</span><span class=mi>42</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>dt_regressor</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span><span class=n>X_train</span><span class=p>,</span> <span class=n>y_train</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Predicting the Test set results</span>
</span></span><span class=line><span class=cl><span class=n>y_pred</span> <span class=o>=</span> <span class=n>dt_regressor</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>X_test</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Evaluate the model</span>
</span></span><span class=line><span class=cl><span class=n>mse</span> <span class=o>=</span> <span class=n>mean_squared_error</span><span class=p>(</span><span class=n>y_test</span><span class=p>,</span> <span class=n>y_pred</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>r2</span> <span class=o>=</span> <span class=n>r2_score</span><span class=p>(</span><span class=n>y_test</span><span class=p>,</span> <span class=n>y_pred</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>mse</span><span class=p>,</span> <span class=n>r2</span>
</span></span><span class=line><span class=cl><span class=c1># Getting feature importances</span>
</span></span><span class=line><span class=cl><span class=n>feature_importances</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>(</span><span class=n>dt_regressor</span><span class=o>.</span><span class=n>feature_importances_</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=n>feature_columns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Sort the feature importances in descending order</span>
</span></span><span class=line><span class=cl><span class=n>feature_importances_sorted</span> <span class=o>=</span> <span class=n>feature_importances</span><span class=o>.</span><span class=n>sort_values</span><span class=p>(</span><span class=n>ascending</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>feature_importances_sorted</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.tree</span> <span class=kn>import</span> <span class=n>plot_tree</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>matplotlib.colors</span> <span class=kn>import</span> <span class=n>ListedColormap</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 为决策树的不同深度生成一个绿色渐变颜色映射</span>
</span></span><span class=line><span class=cl><span class=n>cmap</span> <span class=o>=</span> <span class=n>ListedColormap</span><span class=p>([</span><span class=s2>&#34;#e5f5e0&#34;</span><span class=p>,</span> <span class=s2>&#34;#a1d99b&#34;</span><span class=p>,</span> <span class=s2>&#34;#31a354&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Plotting the Decision Tree with green color scheme</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>figure</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>20</span><span class=p>,</span><span class=mi>10</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1># 使用colormap参数指定颜色映射</span>
</span></span><span class=line><span class=cl><span class=n>plot_tree</span><span class=p>(</span><span class=n>dt_regressor</span><span class=p>,</span> <span class=n>feature_names</span><span class=o>=</span><span class=n>feature_columns</span><span class=p>,</span> <span class=n>filled</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>max_depth</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span> <span class=n>fontsize</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span> <span class=n>cmap</span><span class=o>=</span><span class=n>cmap</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>title</span><span class=p>(</span><span class=s2>&#34;满意度影响因素决策树&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span></code></pre></div><h2 id=灰色关联>灰色关联<a hidden class=anchor aria-hidden=true href=#灰色关联>#</a></h2><p>灰色关联分析（Grey Relational Analysis, GRA）是灰色系统理论的一个重要部分，由中国学者邓聚龙在20世纪80年代初提出。灰色系统理论主要研究部分信息已知、部分信息未知的系统，而灰色关联分析则是用来分析和处理系统中因素之间的关联程度的一种方法。</p><h3 id=基础知识-3>基础知识<a hidden class=anchor aria-hidden=true href=#基础知识-3>#</a></h3><p><strong>主要用途</strong></p><ol><li><strong>关联度分析</strong>：通过计算和比较序列之间的关联度（相似度），确定各个因素对系统行为的影响程度，识别出主要影响因素和次要影响因素。</li><li><strong>预测与决策支持</strong>：在只有少量数据或系统信息不完全的情况下，灰色关联分析可以用来预测系统的未来发展趋势，为决策提供依据。</li><li><strong>模式识别和分类</strong>：根据关联度的高低，可以将系统中的因素或对象进行分类，识别出具有相似性质的群体或模式。</li></ol><p><strong>分析特点</strong></p><ul><li><strong>适用于小样本和不完全信息</strong>：与传统的统计分析方法相比，灰色关联分析不需要大量数据，适用于信息不完全和数据量少的情况。</li><li><strong>操作简便，易于理解和实施</strong>：灰色关联分析的计算过程相对简单，容易实现，计算结果直观易懂。</li><li><strong>广泛的应用领域</strong>：灰色关联分析在经济分析、社会科学、环境工程、生物医药等多个领域都有应用。</li></ul><p><strong>应用示例</strong></p><p>假设要分析某一地区经济增长与多个因素（如投资、消费、出口等）之间的关系，可以使用灰色关联分析来确定哪些因素与经济增长的关联度最高，从而为经济政策的制定提供依据。</p><p>灰色关联分析通过计算参考数列（如经济增长率）与比较数列（如投资增长率、消费增长率等）之间的关联度，来评估各因素对目标（经济增长）的影响程度。通过比较各因素的关联度大小，可以辨识出对经济增长影响最大的因素。</p><h3 id=灰色关联探究满意度的提升和打造产品的关系>灰色关联：探究满意度的提升和打造产品的关系<a hidden class=anchor aria-hidden=true href=#灰色关联探究满意度的提升和打造产品的关系>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pandas</span> <span class=k>as</span> <span class=nn>pd</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 假设 df_gone 是自变量的DataFrame，df_gone[&#39;Q26|1&#39;] 是因变量</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 数据准备</span>
</span></span><span class=line><span class=cl><span class=n>columns</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;Q2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q8&#39;</span><span class=p>,</span> <span class=s1>&#39;Q9&#39;</span><span class=p>,</span> <span class=s1>&#39;Q10&#39;</span><span class=p>,</span> <span class=s1>&#39;Q11&#39;</span><span class=p>,</span> <span class=s1>&#39;Q12&#39;</span><span class=p>,</span> <span class=s1>&#39;Q13&#39;</span><span class=p>,</span> <span class=s1>&#39;Q14&#39;</span><span class=p>,</span> <span class=s1>&#39;Q15&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 数值型列</span>
</span></span><span class=line><span class=cl><span class=n>numerical_columns</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;Q2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q5&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 类别型列</span>
</span></span><span class=line><span class=cl><span class=n>categorical_columns</span> <span class=o>=</span> <span class=p>[</span><span class=n>col</span> <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=n>columns</span> <span class=k>if</span> <span class=n>col</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>numerical_columns</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 分类变量进行独热编码</span>
</span></span><span class=line><span class=cl><span class=n>df_encoded</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>get_dummies</span><span class=p>(</span><span class=n>df_gone</span><span class=p>[</span><span class=n>categorical_columns</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 保留数值型列的原始数据</span>
</span></span><span class=line><span class=cl><span class=n>df_numerical</span> <span class=o>=</span> <span class=n>df_gone</span><span class=p>[</span><span class=n>numerical_columns</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 合并数值型数据和经过独热编码的分类数据</span>
</span></span><span class=line><span class=cl><span class=n>X_encoded</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>([</span><span class=n>df_numerical</span><span class=p>,</span> <span class=n>df_encoded</span><span class=p>],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>X</span> <span class=o>=</span> <span class=n>X_encoded</span>  <span class=c1># 自变量数据</span>
</span></span><span class=line><span class=cl><span class=n>y</span> <span class=o>=</span> <span class=n>df_gone</span><span class=p>[</span><span class=s1>&#39;Q26|1&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>  <span class=c1># 因变量数据</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 标准化（归一化）处理</span>
</span></span><span class=line><span class=cl><span class=n>X_norm</span> <span class=o>=</span> <span class=p>(</span><span class=n>X</span> <span class=o>-</span> <span class=n>X</span><span class=o>.</span><span class=n>min</span><span class=p>())</span> <span class=o>/</span> <span class=p>(</span><span class=n>X</span><span class=o>.</span><span class=n>max</span><span class=p>()</span> <span class=o>-</span> <span class=n>X</span><span class=o>.</span><span class=n>min</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=n>y_norm</span> <span class=o>=</span> <span class=p>(</span><span class=n>y</span> <span class=o>-</span> <span class=n>y</span><span class=o>.</span><span class=n>min</span><span class=p>())</span> <span class=o>/</span> <span class=p>(</span><span class=n>y</span><span class=o>.</span><span class=n>max</span><span class=p>()</span> <span class=o>-</span> <span class=n>y</span><span class=o>.</span><span class=n>min</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 计算关联系数</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>grey_relational_coefficient</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>epsilon</span> <span class=o>=</span> <span class=mf>0.5</span>  <span class=c1># 分辨系数，一般取值为(0,1)</span>
</span></span><span class=line><span class=cl>    <span class=n>delta</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>abs</span><span class=p>(</span><span class=n>x</span> <span class=o>-</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>min_delta</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>min</span><span class=p>(</span><span class=n>delta</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>max_delta</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>max</span><span class=p>(</span><span class=n>delta</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>xi</span> <span class=o>=</span> <span class=p>(</span><span class=n>min_delta</span> <span class=o>+</span> <span class=n>epsilon</span> <span class=o>*</span> <span class=n>max_delta</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=n>delta</span> <span class=o>+</span> <span class=n>epsilon</span> <span class=o>*</span> <span class=n>max_delta</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>xi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 计算每个自变量与因变量的关联系数</span>
</span></span><span class=line><span class=cl><span class=n>xi_matrix</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=n>grey_relational_coefficient</span><span class=p>(</span><span class=n>X_norm</span><span class=o>.</span><span class=n>iloc</span><span class=p>[:,</span> <span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> <span class=n>y_norm</span><span class=p>)</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>X_norm</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>])])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 计算关联度</span>
</span></span><span class=line><span class=cl><span class=n>grey_relational_grades</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>xi_matrix</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 对关联度进行降序排列，并获取排序后的索引</span>
</span></span><span class=line><span class=cl><span class=n>sorted_indices</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>argsort</span><span class=p>(</span><span class=n>grey_relational_grades</span><span class=p>)[::</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 可视化关联度</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>figure</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=mi>6</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>barh</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>sorted_indices</span><span class=p>)),</span> <span class=n>grey_relational_grades</span><span class=p>[</span><span class=n>sorted_indices</span><span class=p>],</span> <span class=n>color</span><span class=o>=</span><span class=s1>&#39;skyblue&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>yticks</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>sorted_indices</span><span class=p>)),</span> <span class=n>X_encoded</span><span class=o>.</span><span class=n>columns</span><span class=p>[</span><span class=n>sorted_indices</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>xlabel</span><span class=p>(</span><span class=s1>&#39;Grey Relational Grade&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>title</span><span class=p>(</span><span class=s1>&#39;Grey Relational Analysis (GRA) of Variables to Q26&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>gca</span><span class=p>()</span><span class=o>.</span><span class=n>invert_yaxis</span><span class=p>()</span>  <span class=c1># 使得y轴按关联度从高到低排列</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span></code></pre></div><h2 id=关联规则>关联规则<a hidden class=anchor aria-hidden=true href=#关联规则>#</a></h2><p>关联规则分析是一种在大数据集中寻找项目间的有趣关系（如频繁模式、关联、相关性）的方法，主要用于事务数据、序列数据等。它最著名的应用是市场篮分析，但也广泛应用于生物信息学、药品配对、推荐系统等领域。</p><h3 id=基础知识-4>基础知识<a hidden class=anchor aria-hidden=true href=#基础知识-4>#</a></h3><p><strong>作用</strong></p><ul><li><strong>发现数据间隐藏的关系</strong>：帮助识别数据集中不同项目之间的关联性，即用户行为或特征之间的内在联系。</li><li><strong>决策支持</strong>：为零售商提供交叉销售和产品捆绑的策略依据，通过理解产品之间的关系来优化库存管理和推广策略。</li><li><strong>推荐系统</strong>：基于用户的购买历史或行为模式，推荐他们可能感兴趣的商品或服务。</li></ul><p><strong>实现方法</strong></p><ul><li><strong>Apriori算法</strong>：最早也是最著名的关联规则挖掘算法，通过逐层搜索频繁项集的方法来发现数据之间的强规则。</li><li><strong>FP-Growth算法</strong>：比Apriori效率更高，不需要产生候选项集，直接构造FP树来挖掘频繁项集。</li><li><strong>Eclat算法</strong>：基于垂直数据格式，使用交集操作来快速得到频繁项集，效率高于Apriori。</li></ul><h3 id=关联规则分析推荐意愿分析>关联规则分析：推荐意愿分析<a hidden class=anchor aria-hidden=true href=#关联规则分析推荐意愿分析>#</a></h3><p>针对27、28进行关联规则分析</p><p>Q27|1,Q28|1,Q28|23,Q28|21,Q28|22,Q28|24,Q28|25,Q28|4,Q28|2,Q28|26,Q28|27,Q28|28,Q28|29,Q28|35,Q28|34,</p><p>排除Q28|34|open</p><hr><p>支持度（Support）：支持度可以理解为物品当前流行程度。计算方式是：</p><pre><code>支持度 = （包含物品A的记录数量） / （总的记录数量）
用上面的超市记录举例，一共有五个交易，牛奶出现在三个交易中，故而{牛奶}的支持度为3/5。{鸡蛋}的支持度是4/5。牛奶和鸡蛋同时出现的次数是2，故而{牛奶，鸡蛋}的支持度为2/5。
</code></pre><p>置信度（Confidence）：置信度是指如果购买物品A，有较大可能购买物品B。计算方式是这样：</p><pre><code>置信度( A -&gt; B) = （包含物品A和B的记录数量） / （包含 A 的记录数量）
举例：我们已经知道，(牛奶，鸡蛋)一起购买的次数是两次，鸡蛋的购买次数是4次。那么Confidence(牛奶-&gt;鸡蛋)的计算方式是Confidence(牛奶-&gt;鸡蛋)=2 / 4。
</code></pre><p>提升度（Lift）：提升度指当销售一个物品时，另一个物品销售率会增加多少。计算方式是：</p><pre><code>提升度( A -&gt; B) = 置信度( A -&gt; B) / (支持度 A)
</code></pre><p>泡泡图：support, confidence, lift</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mlxtend.frequent_patterns</span> <span class=kn>import</span> <span class=n>apriori</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mlxtend.frequent_patterns</span> <span class=kn>import</span> <span class=n>association_rules</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pandas</span> <span class=k>as</span> <span class=nn>pd</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>df_apriori</span> <span class=o>=</span> <span class=n>df_gone</span><span class=p>[[</span><span class=s1>&#39;Q28|1&#39;</span><span class=p>,</span><span class=s1>&#39;Q28|23&#39;</span><span class=p>,</span><span class=s1>&#39;Q28|21&#39;</span><span class=p>,</span><span class=s1>&#39;Q28|22&#39;</span><span class=p>,</span><span class=s1>&#39;Q28|24&#39;</span><span class=p>,</span><span class=s1>&#39;Q28|25&#39;</span><span class=p>,</span><span class=s1>&#39;Q28|4&#39;</span><span class=p>,</span><span class=s1>&#39;Q28|2&#39;</span><span class=p>,</span><span class=s1>&#39;Q28|26&#39;</span><span class=p>,</span><span class=s1>&#39;Q28|27&#39;</span><span class=p>,</span><span class=s1>&#39;Q28|28&#39;</span><span class=p>,</span><span class=s1>&#39;Q28|29&#39;</span><span class=p>,</span><span class=s1>&#39;Q28|35&#39;</span><span class=p>,</span><span class=s1>&#39;Q28|34&#39;</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>df_apriori</span> <span class=o>=</span> <span class=n>df_apriori</span><span class=o>.</span><span class=n>rename</span><span class=p>(</span><span class=n>columns</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q28|1&#39;</span><span class=p>:</span> <span class=s1>&#39;草原风光&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q28|23&#39;</span><span class=p>:</span> <span class=s1>&#39;矮杜鹃花花海&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q28|21&#39;</span><span class=p>:</span> <span class=s1>&#39;乌蒙滑雪场&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q28|22&#39;</span><span class=p>:</span> <span class=s1>&#39;七彩滑道&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q28|24&#39;</span><span class=p>:</span> <span class=s1>&#39;玻璃水滑道&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q28|25&#39;</span><span class=p>:</span> <span class=s1>&#39;观佛台观赏佛光&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q28|4&#39;</span><span class=p>:</span> <span class=s1>&#39;野炊露营&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q28|2&#39;</span><span class=p>:</span> <span class=s1>&#39;民俗风情&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q28|26&#39;</span><span class=p>:</span> <span class=s1>&#39;蒙古包酒店&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q28|27&#39;</span><span class=p>:</span> <span class=s1>&#39;精品民宿&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q28|28&#39;</span><span class=p>:</span> <span class=s1>&#39;牛肉馆&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q28|29&#39;</span><span class=p>:</span> <span class=s1>&#39;羊汤锅&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q28|35&#39;</span><span class=p>:</span> <span class=s1>&#39;旅游商品&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1># （刺梨系列商品、盘县火腿、人民小酒、茶叶、银杏系列商品等）</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q28|34&#39;</span><span class=p>:</span> <span class=s1>&#39;其他&#39;</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 将数据集中的所有值都转换为数值，忽略无法转换的值</span>
</span></span><span class=line><span class=cl><span class=n>df_apriori</span> <span class=o>=</span> <span class=n>df_apriori</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=n>pd</span><span class=o>.</span><span class=n>to_numeric</span><span class=p>,</span> <span class=n>errors</span><span class=o>=</span><span class=s1>&#39;coerce&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 然后再将数据集中的值转换为布尔值</span>
</span></span><span class=line><span class=cl><span class=n>df_encoded</span> <span class=o>=</span> <span class=n>df_apriori</span><span class=o>.</span><span class=n>applymap</span><span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=kc>False</span> <span class=k>if</span> <span class=n>x</span> <span class=o>&lt;=</span> <span class=mi>0</span> <span class=k>else</span> <span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># print(df_encoded)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用apriori找出频繁项集，将支持度阈值提高到0.5</span>
</span></span><span class=line><span class=cl><span class=n>frequent_itemsets</span> <span class=o>=</span> <span class=n>apriori</span><span class=p>(</span><span class=n>df_encoded</span><span class=p>,</span> <span class=n>min_support</span><span class=o>=</span><span class=mf>0.3</span><span class=p>,</span> <span class=n>use_colnames</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用association_rules找出关联规则，将置信度阈值提高到0.8</span>
</span></span><span class=line><span class=cl><span class=n>rules</span> <span class=o>=</span> <span class=n>association_rules</span><span class=p>(</span><span class=n>frequent_itemsets</span><span class=p>,</span> <span class=n>metric</span><span class=o>=</span><span class=s2>&#34;confidence&#34;</span><span class=p>,</span> <span class=n>min_threshold</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 打印关联规则</span>
</span></span><span class=line><span class=cl><span class=c1># print(rules)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 现在我们绘制泡泡图</span>
</span></span><span class=line><span class=cl><span class=c1># 规则的支持度决定泡泡的大小，提升度决定颜色的深浅</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>rules</span><span class=p>[</span><span class=s1>&#39;support&#39;</span><span class=p>],</span> <span class=n>rules</span><span class=p>[</span><span class=s1>&#39;confidence&#39;</span><span class=p>],</span> <span class=n>s</span><span class=o>=</span><span class=n>rules</span><span class=p>[</span><span class=s1>&#39;support&#39;</span><span class=p>]</span><span class=o>*</span><span class=mi>1000</span><span class=p>,</span> <span class=n>c</span><span class=o>=</span><span class=n>rules</span><span class=p>[</span><span class=s1>&#39;lift&#39;</span><span class=p>],</span> <span class=n>cmap</span><span class=o>=</span><span class=s1>&#39;RdYlBu&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>xlabel</span><span class=p>(</span><span class=s1>&#39;Support&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>ylabel</span><span class=p>(</span><span class=s1>&#39;Confidence&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>title</span><span class=p>(</span><span class=s1>&#39;Bubble Chart for Association Rules&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>colorbar</span><span class=p>(</span><span class=n>label</span><span class=o>=</span><span class=s1>&#39;Lift&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span></code></pre></div><p>变量可视化</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 设置字体为SimHei显示中文</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>rcParams</span><span class=p>[</span><span class=s1>&#39;font.sans-serif&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;SimHei&#39;</span><span class=p>]</span> 
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>rcParams</span><span class=p>[</span><span class=s1>&#39;axes.unicode_minus&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建一个空的矩阵，用于存放支持度和提升度</span>
</span></span><span class=line><span class=cl><span class=n>support_matrix</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=n>df_encoded</span><span class=o>.</span><span class=n>columns</span><span class=p>,</span> <span class=n>columns</span><span class=o>=</span><span class=n>df_encoded</span><span class=o>.</span><span class=n>columns</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>lift_matrix</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=n>df_encoded</span><span class=o>.</span><span class=n>columns</span><span class=p>,</span> <span class=n>columns</span><span class=o>=</span><span class=n>df_encoded</span><span class=o>.</span><span class=n>columns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 填充矩阵</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>rule</span> <span class=ow>in</span> <span class=n>rules</span><span class=o>.</span><span class=n>iterrows</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>antecedents</span> <span class=o>=</span> <span class=nb>next</span><span class=p>(</span><span class=nb>iter</span><span class=p>(</span><span class=n>rule</span><span class=p>[</span><span class=s1>&#39;antecedents&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>    <span class=n>consequents</span> <span class=o>=</span> <span class=nb>next</span><span class=p>(</span><span class=nb>iter</span><span class=p>(</span><span class=n>rule</span><span class=p>[</span><span class=s1>&#39;consequents&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>    <span class=n>support_matrix</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>antecedents</span><span class=p>,</span> <span class=n>consequents</span><span class=p>]</span> <span class=o>=</span> <span class=n>rule</span><span class=p>[</span><span class=s1>&#39;support&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>lift_matrix</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>antecedents</span><span class=p>,</span> <span class=n>consequents</span><span class=p>]</span> <span class=o>=</span> <span class=n>rule</span><span class=p>[</span><span class=s1>&#39;lift&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.colors</span> <span class=k>as</span> <span class=nn>mcolors</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 绘制泡泡图</span>
</span></span><span class=line><span class=cl><span class=n>fig</span><span class=p>,</span> <span class=n>ax</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>subplots</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>14</span><span class=p>,</span> <span class=mi>9</span><span class=p>))</span>  <span class=c1># 修改图表宽度</span>
</span></span><span class=line><span class=cl><span class=n>norm</span> <span class=o>=</span> <span class=n>mcolors</span><span class=o>.</span><span class=n>Normalize</span><span class=p>(</span><span class=n>vmin</span><span class=o>=</span><span class=n>lift_matrix</span><span class=o>.</span><span class=n>min</span><span class=p>()</span><span class=o>.</span><span class=n>min</span><span class=p>(),</span> <span class=n>vmax</span><span class=o>=</span><span class=n>lift_matrix</span><span class=o>.</span><span class=n>max</span><span class=p>()</span><span class=o>.</span><span class=n>max</span><span class=p>())</span>  <span class=c1># 创建归一化对象</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>support_matrix</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=n>support_matrix</span><span class=o>.</span><span class=n>index</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>support</span> <span class=o>=</span> <span class=n>support_matrix</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>j</span><span class=p>,</span> <span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>lift</span> <span class=o>=</span> <span class=n>lift_matrix</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>j</span><span class=p>,</span> <span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>pd</span><span class=o>.</span><span class=n>notnull</span><span class=p>(</span><span class=n>support</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>ax</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>,</span> <span class=n>s</span><span class=o>=</span><span class=n>support</span><span class=o>*</span><span class=mi>3500</span><span class=p>,</span> <span class=n>c</span><span class=o>=</span><span class=n>lift</span><span class=p>,</span> <span class=n>cmap</span><span class=o>=</span><span class=s1>&#39;RdYlBu&#39;</span><span class=p>,</span> <span class=n>norm</span><span class=o>=</span><span class=n>norm</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>)</span>  <span class=c1># 修改散点图的大小</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置图表格式</span>
</span></span><span class=line><span class=cl><span class=n>ax</span><span class=o>.</span><span class=n>set_xticks</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>support_matrix</span><span class=o>.</span><span class=n>columns</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=n>ax</span><span class=o>.</span><span class=n>set_yticks</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>support_matrix</span><span class=o>.</span><span class=n>index</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=n>ax</span><span class=o>.</span><span class=n>set_xticklabels</span><span class=p>(</span><span class=n>support_matrix</span><span class=o>.</span><span class=n>columns</span><span class=p>,</span> <span class=n>rotation</span><span class=o>=</span><span class=mi>90</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ax</span><span class=o>.</span><span class=n>set_yticklabels</span><span class=p>(</span><span class=n>support_matrix</span><span class=o>.</span><span class=n>index</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 显示背景网格</span>
</span></span><span class=line><span class=cl><span class=n>ax</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=kc>True</span><span class=p>,</span> <span class=n>linestyle</span><span class=o>=</span><span class=s1>&#39;--&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 添加颜色条</span>
</span></span><span class=line><span class=cl><span class=n>sm</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>cm</span><span class=o>.</span><span class=n>ScalarMappable</span><span class=p>(</span><span class=n>cmap</span><span class=o>=</span><span class=s1>&#39;RdYlBu&#39;</span><span class=p>,</span> <span class=n>norm</span><span class=o>=</span><span class=n>plt</span><span class=o>.</span><span class=n>Normalize</span><span class=p>(</span><span class=n>vmin</span><span class=o>=</span><span class=n>lift_matrix</span><span class=o>.</span><span class=n>min</span><span class=p>()</span><span class=o>.</span><span class=n>min</span><span class=p>(),</span> <span class=n>vmax</span><span class=o>=</span><span class=n>lift_matrix</span><span class=o>.</span><span class=n>max</span><span class=p>()</span><span class=o>.</span><span class=n>max</span><span class=p>()))</span>
</span></span><span class=line><span class=cl><span class=n>sm</span><span class=o>.</span><span class=n>_A</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=n>cbar</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>colorbar</span><span class=p>(</span><span class=n>sm</span><span class=p>,</span> <span class=n>shrink</span><span class=o>=</span><span class=mf>0.7</span><span class=p>)</span>  <span class=c1># 修改颜色条的大小</span>
</span></span><span class=line><span class=cl><span class=n>cbar</span><span class=o>.</span><span class=n>set_label</span><span class=p>(</span><span class=s1>&#39;Lift&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 显示图表</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span></code></pre></div><p>热力图</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>seaborn</span> <span class=k>as</span> <span class=nn>sns</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建一个空的DataFrame，用于存储提升度</span>
</span></span><span class=line><span class=cl><span class=n>lift_matrix</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=n>df_apriori</span><span class=o>.</span><span class=n>columns</span><span class=p>,</span> <span class=n>columns</span><span class=o>=</span><span class=n>df_apriori</span><span class=o>.</span><span class=n>columns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>rules</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>    <span class=n>antecedent</span> <span class=o>=</span> <span class=n>rules</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=s1>&#39;antecedents&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>consequent</span> <span class=o>=</span> <span class=n>rules</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=s1>&#39;consequents&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>lift</span> <span class=o>=</span> <span class=n>rules</span><span class=o>.</span><span class=n>iloc</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=s1>&#39;lift&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>antecedent</span><span class=p>)</span> <span class=o>==</span> <span class=mi>1</span> <span class=ow>and</span> <span class=nb>len</span><span class=p>(</span><span class=n>consequent</span><span class=p>)</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>antecedent</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>antecedent</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>consequent</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>consequent</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>antecedent</span><span class=p>,</span> <span class=nb>str</span><span class=p>)</span> <span class=ow>and</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>consequent</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>lift_matrix</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>antecedent</span><span class=p>,</span> <span class=n>consequent</span><span class=p>]</span> <span class=o>=</span> <span class=n>lift</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 将NaN值填充为0</span>
</span></span><span class=line><span class=cl><span class=n>lift_matrix</span> <span class=o>=</span> <span class=n>lift_matrix</span><span class=o>.</span><span class=n>fillna</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用seaborn的heatmap函数绘制热图</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>figure</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=mi>8</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>sns</span><span class=o>.</span><span class=n>heatmap</span><span class=p>(</span><span class=n>lift_matrix</span><span class=p>,</span> <span class=n>cmap</span><span class=o>=</span><span class=s1>&#39;RdYlBu_r&#39;</span><span class=p>,</span> <span class=n>annot</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>fmt</span><span class=o>=</span><span class=s2>&#34;.2f&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>title</span><span class=p>(</span><span class=s1>&#39;Lift Matrix&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span></code></pre></div><h3 id=关联规则分析旅游资源产品开发>关联规则分析：旅游资源产品开发<a hidden class=anchor aria-hidden=true href=#关联规则分析旅游资源产品开发>#</a></h3><p>针对Q30,Q31,Q32这三个题项进行分析</p><p>Q30|R1,Q30|R2,Q30|R3,Q30|R4,Q30|R5,Q30|R6,Q31|R1,Q31|R2,Q31|R8,Q31|R4,Q31|R7,Q31|R9,Q31|R6,Q31|R5,Q32|R3,Q32|R7,Q32|R4,Q32|R5,Q32|R1,Q32|R2,Q32|R6,Q33|R10,Q33|R12,Q33|R11,Q33|R4,Q33|R5,Q33|R1,Q33|R8,Q33|R7</p><p>这些题目都是量表题，关联分析需要多选题，4分及以上算作选择了；然后进行3维的关联规则分析</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 关联规则分析</span>
</span></span><span class=line><span class=cl><span class=c1># 先对把每个问卷的选项转换为布尔值，并把三个问题的选项合并到一起</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>columns_to_convert</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;Q30|R1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q30|R2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q30|R3&#39;</span><span class=p>,</span> <span class=s1>&#39;Q30|R4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q30|R5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q30|R6&#39;</span><span class=p>,</span> <span class=s1>&#39;Q31|R1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q31|R2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q31|R8&#39;</span><span class=p>,</span> <span class=s1>&#39;Q31|R4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q31|R7&#39;</span><span class=p>,</span> <span class=s1>&#39;Q31|R9&#39;</span><span class=p>,</span> <span class=s1>&#39;Q31|R6&#39;</span><span class=p>,</span> <span class=s1>&#39;Q31|R5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q32|R3&#39;</span><span class=p>,</span> <span class=s1>&#39;Q32|R7&#39;</span><span class=p>,</span> <span class=s1>&#39;Q32|R4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q32|R5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q32|R1&#39;</span><span class=p>,</span> <span class=s1>&#39;Q32|R2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q32|R6&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>convert_score</span><span class=p>(</span><span class=n>score</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>score</span> <span class=o>&gt;=</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>df_product</span> <span class=o>=</span> <span class=n>df_gone</span><span class=p>[</span><span class=n>columns_to_convert</span><span class=p>]</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=n>convert_score</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 把df_product到处为csv</span>
</span></span><span class=line><span class=cl><span class=n>df_product</span><span class=o>.</span><span class=n>to_csv</span><span class=p>(</span><span class=s1>&#39;product.csv&#39;</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>df_product</span><span class=o>.</span><span class=n>head</span><span class=p>()</span>
</span></span></code></pre></div><p>利用关联规则算法Apriori分析和可视化</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mlxtend.frequent_patterns</span> <span class=kn>import</span> <span class=n>apriori</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mlxtend.frequent_patterns</span> <span class=kn>import</span> <span class=n>association_rules</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pandas</span> <span class=k>as</span> <span class=nn>pd</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置字体为SimHei显示中文</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>rcParams</span><span class=p>[</span><span class=s1>&#39;font.sans-serif&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;SimHei&#39;</span><span class=p>]</span> 
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>rcParams</span><span class=p>[</span><span class=s1>&#39;axes.unicode_minus&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>df_encoded</span> <span class=o>=</span> <span class=n>df_product</span><span class=o>.</span><span class=n>rename</span><span class=p>(</span><span class=n>columns</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q30|R1&#39;</span><span class=p>:</span> <span class=s1>&#39;体育项目&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q30|R2&#39;</span><span class=p>:</span> <span class=s1>&#39;网红打卡点&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q30|R3&#39;</span><span class=p>:</span> <span class=s1>&#39;趣味项目&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q30|R4&#39;</span><span class=p>:</span> <span class=s1>&#39;民族服饰&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q30|R5&#39;</span><span class=p>:</span> <span class=s1>&#39;专业旅拍&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q30|R6&#39;</span><span class=p>:</span> <span class=s1>&#39;特色民宿&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q31|R1&#39;</span><span class=p>:</span> <span class=s1>&#39;盘县火腿&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q31|R2&#39;</span><span class=p>:</span> <span class=s1>&#39;刺梨系列产品&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q31|R8&#39;</span><span class=p>:</span> <span class=s1>&#39;盘州茶叶&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q31|R4&#39;</span><span class=p>:</span> <span class=s1>&#39;核桃乳&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q31|R7&#39;</span><span class=p>:</span> <span class=s1>&#39;人民小酒&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q31|R9&#39;</span><span class=p>:</span> <span class=s1>&#39;银杏系列商品&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q31|R6&#39;</span><span class=p>:</span> <span class=s1>&#39;民族手工制品&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q31|R5&#39;</span><span class=p>:</span> <span class=s1>&#39;彝族服饰&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q32|R3&#39;</span><span class=p>:</span> <span class=s1>&#39;非遗火腿工艺参观&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q32|R7&#39;</span><span class=p>:</span> <span class=s1>&#39;非遗技艺制作地方特色小吃体验&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q32|R4&#39;</span><span class=p>:</span> <span class=s1>&#39;非遗剪纸体验&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q32|R5&#39;</span><span class=p>:</span> <span class=s1>&#39;古法造纸参观&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q32|R1&#39;</span><span class=p>:</span> <span class=s1>&#39;民族刺绣体验&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q32|R2&#39;</span><span class=p>:</span> <span class=s1>&#39;民族蜡染体验&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q32|R6&#39;</span><span class=p>:</span> <span class=s1>&#39;民族歌舞表演&#39;</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用apriori找出频繁项集，将支持度阈值提高到0.5</span>
</span></span><span class=line><span class=cl><span class=n>frequent_itemsets</span> <span class=o>=</span> <span class=n>apriori</span><span class=p>(</span><span class=n>df_encoded</span><span class=p>,</span> <span class=n>min_support</span><span class=o>=</span><span class=mf>0.7</span><span class=p>,</span> <span class=n>use_colnames</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用association_rules找出关联规则，将置信度阈值提高到0.8</span>
</span></span><span class=line><span class=cl><span class=n>rules</span> <span class=o>=</span> <span class=n>association_rules</span><span class=p>(</span><span class=n>frequent_itemsets</span><span class=p>,</span> <span class=n>metric</span><span class=o>=</span><span class=s2>&#34;confidence&#34;</span><span class=p>,</span> <span class=n>min_threshold</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 规则的支持度决定泡泡的大小，提升度决定颜色的深浅</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>rules</span><span class=p>[</span><span class=s1>&#39;support&#39;</span><span class=p>],</span> <span class=n>rules</span><span class=p>[</span><span class=s1>&#39;confidence&#39;</span><span class=p>],</span> <span class=n>s</span><span class=o>=</span><span class=n>rules</span><span class=p>[</span><span class=s1>&#39;support&#39;</span><span class=p>]</span><span class=o>*</span><span class=mi>1000</span><span class=p>,</span> <span class=n>c</span><span class=o>=</span><span class=n>rules</span><span class=p>[</span><span class=s1>&#39;lift&#39;</span><span class=p>],</span> <span class=n>cmap</span><span class=o>=</span><span class=s1>&#39;viridis&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>xlabel</span><span class=p>(</span><span class=s1>&#39;支持度&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>ylabel</span><span class=p>(</span><span class=s1>&#39;值信度&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>title</span><span class=p>(</span><span class=s1>&#39;关联规则气泡图&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>colorbar</span><span class=p>(</span><span class=n>label</span><span class=o>=</span><span class=s1>&#39;提升度&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.colors</span> <span class=k>as</span> <span class=nn>mcolors</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建一个空的矩阵，用于存放支持度和提升度</span>
</span></span><span class=line><span class=cl><span class=n>support_matrix</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=n>df_encoded</span><span class=o>.</span><span class=n>columns</span><span class=p>,</span> <span class=n>columns</span><span class=o>=</span><span class=n>df_encoded</span><span class=o>.</span><span class=n>columns</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>lift_matrix</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=n>df_encoded</span><span class=o>.</span><span class=n>columns</span><span class=p>,</span> <span class=n>columns</span><span class=o>=</span><span class=n>df_encoded</span><span class=o>.</span><span class=n>columns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 填充矩阵</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>rule</span> <span class=ow>in</span> <span class=n>rules</span><span class=o>.</span><span class=n>iterrows</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>antecedents</span> <span class=o>=</span> <span class=nb>next</span><span class=p>(</span><span class=nb>iter</span><span class=p>(</span><span class=n>rule</span><span class=p>[</span><span class=s1>&#39;antecedents&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>    <span class=n>consequents</span> <span class=o>=</span> <span class=nb>next</span><span class=p>(</span><span class=nb>iter</span><span class=p>(</span><span class=n>rule</span><span class=p>[</span><span class=s1>&#39;consequents&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>    <span class=n>support_matrix</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>antecedents</span><span class=p>,</span> <span class=n>consequents</span><span class=p>]</span> <span class=o>=</span> <span class=n>rule</span><span class=p>[</span><span class=s1>&#39;support&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>lift_matrix</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>antecedents</span><span class=p>,</span> <span class=n>consequents</span><span class=p>]</span> <span class=o>=</span> <span class=n>rule</span><span class=p>[</span><span class=s1>&#39;lift&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 绘制泡泡图</span>
</span></span><span class=line><span class=cl><span class=n>fig</span><span class=p>,</span> <span class=n>ax</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>subplots</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>14</span><span class=p>,</span> <span class=mi>9</span><span class=p>))</span>  <span class=c1># 修改图表宽度</span>
</span></span><span class=line><span class=cl><span class=n>norm</span> <span class=o>=</span> <span class=n>mcolors</span><span class=o>.</span><span class=n>Normalize</span><span class=p>(</span><span class=n>vmin</span><span class=o>=</span><span class=n>lift_matrix</span><span class=o>.</span><span class=n>min</span><span class=p>()</span><span class=o>.</span><span class=n>min</span><span class=p>(),</span> <span class=n>vmax</span><span class=o>=</span><span class=n>lift_matrix</span><span class=o>.</span><span class=n>max</span><span class=p>()</span><span class=o>.</span><span class=n>max</span><span class=p>())</span>  <span class=c1># 创建归一化对象</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>support_matrix</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=n>support_matrix</span><span class=o>.</span><span class=n>index</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>support</span> <span class=o>=</span> <span class=n>support_matrix</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>j</span><span class=p>,</span> <span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>lift</span> <span class=o>=</span> <span class=n>lift_matrix</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>j</span><span class=p>,</span> <span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>pd</span><span class=o>.</span><span class=n>notnull</span><span class=p>(</span><span class=n>support</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>ax</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>,</span> <span class=n>s</span><span class=o>=</span><span class=n>support</span><span class=o>*</span><span class=mi>500</span><span class=p>,</span> <span class=n>c</span><span class=o>=</span><span class=n>lift</span><span class=p>,</span> <span class=n>cmap</span><span class=o>=</span><span class=s1>&#39;viridis&#39;</span><span class=p>,</span> <span class=n>norm</span><span class=o>=</span><span class=n>norm</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.7</span><span class=p>)</span>  <span class=c1># 修改散点图的大小</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 修改图表的 x 轴和 y 轴标签</span>
</span></span><span class=line><span class=cl><span class=n>ax</span><span class=o>.</span><span class=n>set_xticks</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>support_matrix</span><span class=o>.</span><span class=n>columns</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=n>ax</span><span class=o>.</span><span class=n>set_yticks</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>support_matrix</span><span class=o>.</span><span class=n>index</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=n>ax</span><span class=o>.</span><span class=n>set_xticklabels</span><span class=p>(</span><span class=n>support_matrix</span><span class=o>.</span><span class=n>columns</span><span class=p>,</span> <span class=n>rotation</span><span class=o>=</span><span class=mi>90</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ax</span><span class=o>.</span><span class=n>set_yticklabels</span><span class=p>(</span><span class=n>support_matrix</span><span class=o>.</span><span class=n>index</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 显示背景网格</span>
</span></span><span class=line><span class=cl><span class=n>ax</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=kc>True</span><span class=p>,</span> <span class=n>linestyle</span><span class=o>=</span><span class=s1>&#39;--&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 添加颜色条</span>
</span></span><span class=line><span class=cl><span class=n>sm</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>cm</span><span class=o>.</span><span class=n>ScalarMappable</span><span class=p>(</span><span class=n>cmap</span><span class=o>=</span><span class=s1>&#39;viridis&#39;</span><span class=p>,</span> <span class=n>norm</span><span class=o>=</span><span class=n>plt</span><span class=o>.</span><span class=n>Normalize</span><span class=p>(</span><span class=n>vmin</span><span class=o>=</span><span class=n>lift_matrix</span><span class=o>.</span><span class=n>min</span><span class=p>()</span><span class=o>.</span><span class=n>min</span><span class=p>(),</span> <span class=n>vmax</span><span class=o>=</span><span class=n>lift_matrix</span><span class=o>.</span><span class=n>max</span><span class=p>()</span><span class=o>.</span><span class=n>max</span><span class=p>()))</span>
</span></span><span class=line><span class=cl><span class=n>sm</span><span class=o>.</span><span class=n>_A</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=n>cbar</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>colorbar</span><span class=p>(</span><span class=n>sm</span><span class=p>,</span> <span class=n>shrink</span><span class=o>=</span><span class=mf>0.7</span><span class=p>)</span>  <span class=c1># 修改颜色条的大小</span>
</span></span><span class=line><span class=cl><span class=n>cbar</span><span class=o>.</span><span class=n>set_label</span><span class=p>(</span><span class=s1>&#39;Lift&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 显示图表</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pandas</span> <span class=k>as</span> <span class=nn>pd</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mpl_toolkits.mplot3d</span> <span class=kn>import</span> <span class=n>Axes3D</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.colors</span> <span class=k>as</span> <span class=nn>mcolors</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 假设 scatter_data 已经正确定义，且包含必要的列</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>question_names</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q30|R1&#39;</span><span class=p>:</span> <span class=s1>&#39;体育项目&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q30|R2&#39;</span><span class=p>:</span> <span class=s1>&#39;网红打卡点&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q30|R3&#39;</span><span class=p>:</span> <span class=s1>&#39;趣味项目&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q30|R4&#39;</span><span class=p>:</span> <span class=s1>&#39;民族服饰&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q30|R5&#39;</span><span class=p>:</span> <span class=s1>&#39;专业旅拍&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q30|R6&#39;</span><span class=p>:</span> <span class=s1>&#39;特色民宿&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q31|R1&#39;</span><span class=p>:</span> <span class=s1>&#39;盘县火腿&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q31|R2&#39;</span><span class=p>:</span> <span class=s1>&#39;刺梨系列产品&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q31|R8&#39;</span><span class=p>:</span> <span class=s1>&#39;盘州茶叶&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q31|R4&#39;</span><span class=p>:</span> <span class=s1>&#39;核桃乳&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q31|R7&#39;</span><span class=p>:</span> <span class=s1>&#39;人民小酒&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q31|R9&#39;</span><span class=p>:</span> <span class=s1>&#39;银杏系列商品&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q31|R6&#39;</span><span class=p>:</span> <span class=s1>&#39;民族手工制品&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q31|R5&#39;</span><span class=p>:</span> <span class=s1>&#39;彝族服饰&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q32|R3&#39;</span><span class=p>:</span> <span class=s1>&#39;非遗火腿工艺参观&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q32|R7&#39;</span><span class=p>:</span> <span class=s1>&#39;非遗技艺制作地方特色小吃体验&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q32|R4&#39;</span><span class=p>:</span> <span class=s1>&#39;非遗剪纸体验&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q32|R5&#39;</span><span class=p>:</span> <span class=s1>&#39;古法造纸参观&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q32|R1&#39;</span><span class=p>:</span> <span class=s1>&#39;民族刺绣体验&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q32|R2&#39;</span><span class=p>:</span> <span class=s1>&#39;民族蜡染体验&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Q32|R6&#39;</span><span class=p>:</span> <span class=s1>&#39;民族歌舞表演&#39;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建映射：从题目名称映射到索引</span>
</span></span><span class=line><span class=cl><span class=n>category_mapping</span> <span class=o>=</span> <span class=p>{</span><span class=n>name</span><span class=p>:</span> <span class=n>index</span> <span class=k>for</span> <span class=n>index</span><span class=p>,</span> <span class=n>name</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>question_names</span><span class=o>.</span><span class=n>values</span><span class=p>())}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建逆映射：从索引映射回题目名称</span>
</span></span><span class=line><span class=cl><span class=n>inverse_mapping</span> <span class=o>=</span> <span class=p>{</span><span class=n>index</span><span class=p>:</span> <span class=n>name</span> <span class=k>for</span> <span class=n>name</span><span class=p>,</span> <span class=n>index</span> <span class=ow>in</span> <span class=n>category_mapping</span><span class=o>.</span><span class=n>items</span><span class=p>()}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>scatter_data</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>columns</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;Antecedent1&#39;</span><span class=p>,</span> <span class=s1>&#39;Antecedent2&#39;</span><span class=p>,</span> <span class=s1>&#39;Consequent&#39;</span><span class=p>,</span> <span class=s1>&#39;Support&#39;</span><span class=p>,</span> <span class=s1>&#39;Lift&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>index</span><span class=p>,</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>rules</span><span class=o>.</span><span class=n>iterrows</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>antecedents</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>row</span><span class=p>[</span><span class=s1>&#39;antecedents&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>consequent</span> <span class=o>=</span> <span class=nb>next</span><span class=p>(</span><span class=nb>iter</span><span class=p>(</span><span class=n>row</span><span class=p>[</span><span class=s1>&#39;consequents&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>antecedents</span><span class=p>)</span> <span class=o>==</span> <span class=mi>2</span><span class=p>:</span>  <span class=c1># 确保前件有两个元素</span>
</span></span><span class=line><span class=cl>        <span class=n>scatter_data</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>index</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>category_mapping</span><span class=p>[</span><span class=n>antecedents</span><span class=p>[</span><span class=mi>0</span><span class=p>]],</span>
</span></span><span class=line><span class=cl>            <span class=n>category_mapping</span><span class=p>[</span><span class=n>antecedents</span><span class=p>[</span><span class=mi>1</span><span class=p>]],</span>
</span></span><span class=line><span class=cl>            <span class=n>category_mapping</span><span class=p>[</span><span class=n>consequent</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>row</span><span class=p>[</span><span class=s1>&#39;support&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>row</span><span class=p>[</span><span class=s1>&#39;lift&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 定义颜色映射和规范化实例</span>
</span></span><span class=line><span class=cl><span class=n>cmap</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>get_cmap</span><span class=p>(</span><span class=s1>&#39;viridis&#39;</span><span class=p>)</span>  <span class=c1># 使用matplotlib内置的颜色映射</span>
</span></span><span class=line><span class=cl><span class=n>norm</span> <span class=o>=</span> <span class=n>mcolors</span><span class=o>.</span><span class=n>Normalize</span><span class=p>(</span><span class=n>vmin</span><span class=o>=</span><span class=n>scatter_data</span><span class=p>[</span><span class=s1>&#39;Lift&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>min</span><span class=p>(),</span> <span class=n>vmax</span><span class=o>=</span><span class=n>scatter_data</span><span class=p>[</span><span class=s1>&#39;Lift&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>max</span><span class=p>())</span>  <span class=c1># 根据提升度的最小值和最大值创建规范化实例</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 绘制三维散点图</span>
</span></span><span class=line><span class=cl><span class=n>fig</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>figure</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>25</span><span class=p>,</span> <span class=mi>10</span><span class=p>))</span>  <span class=c1># 调整图表大小</span>
</span></span><span class=line><span class=cl><span class=n>ax</span> <span class=o>=</span> <span class=n>fig</span><span class=o>.</span><span class=n>add_subplot</span><span class=p>(</span><span class=mi>111</span><span class=p>,</span> <span class=n>projection</span><span class=o>=</span><span class=s1>&#39;3d&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 散点图绘制</span>
</span></span><span class=line><span class=cl><span class=n>points</span> <span class=o>=</span> <span class=n>ax</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>scatter_data</span><span class=p>[</span><span class=s1>&#39;Antecedent1&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>scatter_data</span><span class=p>[</span><span class=s1>&#39;Antecedent2&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>scatter_data</span><span class=p>[</span><span class=s1>&#39;Consequent&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span><span class=o>=</span><span class=n>scatter_data</span><span class=p>[</span><span class=s1>&#39;Support&#39;</span><span class=p>]</span><span class=o>*</span><span class=mi>150</span><span class=p>,</span>  <span class=c1># 泡泡大小基于支持度</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span><span class=o>=</span><span class=p>[</span><span class=n>cmap</span><span class=p>(</span><span class=n>norm</span><span class=p>(</span><span class=n>val</span><span class=p>))</span> <span class=k>for</span> <span class=n>val</span> <span class=ow>in</span> <span class=n>scatter_data</span><span class=p>[</span><span class=s1>&#39;Lift&#39;</span><span class=p>]],</span>  <span class=c1># 颜色基于提升度</span>
</span></span><span class=line><span class=cl>    <span class=n>alpha</span><span class=o>=</span><span class=mf>0.6</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 调整坐标轴标签为题目名称，并调整字体大小和旋转角度</span>
</span></span><span class=line><span class=cl><span class=n>ax</span><span class=o>.</span><span class=n>set_xticks</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=n>category_mapping</span><span class=o>.</span><span class=n>values</span><span class=p>()))</span>
</span></span><span class=line><span class=cl><span class=n>ax</span><span class=o>.</span><span class=n>set_xticklabels</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=n>category_mapping</span><span class=o>.</span><span class=n>keys</span><span class=p>()),</span> <span class=n>rotation</span><span class=o>=</span><span class=mi>45</span><span class=p>,</span> <span class=n>ha</span><span class=o>=</span><span class=s2>&#34;right&#34;</span><span class=p>,</span> <span class=n>fontsize</span><span class=o>=</span><span class=mi>8</span><span class=p>)</span>  <span class=c1># 调整X轴标签</span>
</span></span><span class=line><span class=cl><span class=n>ax</span><span class=o>.</span><span class=n>set_yticks</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=n>category_mapping</span><span class=o>.</span><span class=n>values</span><span class=p>()))</span>
</span></span><span class=line><span class=cl><span class=n>ax</span><span class=o>.</span><span class=n>set_yticklabels</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=n>category_mapping</span><span class=o>.</span><span class=n>keys</span><span class=p>()),</span> <span class=n>rotation</span><span class=o>=-</span><span class=mi>45</span><span class=p>,</span> <span class=n>ha</span><span class=o>=</span><span class=s2>&#34;left&#34;</span><span class=p>,</span> <span class=n>fontsize</span><span class=o>=</span><span class=mi>8</span><span class=p>)</span>  <span class=c1># 调整Y轴标签</span>
</span></span><span class=line><span class=cl><span class=n>ax</span><span class=o>.</span><span class=n>set_zticks</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=n>category_mapping</span><span class=o>.</span><span class=n>values</span><span class=p>()))</span>
</span></span><span class=line><span class=cl><span class=n>ax</span><span class=o>.</span><span class=n>set_zticklabels</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=n>category_mapping</span><span class=o>.</span><span class=n>keys</span><span class=p>()),</span> <span class=n>fontsize</span><span class=o>=</span><span class=mi>8</span><span class=p>)</span>  <span class=c1># 调整Z轴标签字体大小</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 调整视角</span>
</span></span><span class=line><span class=cl><span class=n>ax</span><span class=o>.</span><span class=n>view_init</span><span class=p>(</span><span class=n>elev</span><span class=o>=</span><span class=mi>20</span><span class=p>,</span> <span class=n>azim</span><span class=o>=-</span><span class=mi>45</span><span class=p>)</span>  <span class=c1># 调整视角</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 添加颜色条</span>
</span></span><span class=line><span class=cl><span class=n>sm</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>cm</span><span class=o>.</span><span class=n>ScalarMappable</span><span class=p>(</span><span class=n>cmap</span><span class=o>=</span><span class=n>cmap</span><span class=p>,</span> <span class=n>norm</span><span class=o>=</span><span class=n>norm</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sm</span><span class=o>.</span><span class=n>set_array</span><span class=p>([])</span>
</span></span><span class=line><span class=cl><span class=n>cbar</span> <span class=o>=</span> <span class=n>fig</span><span class=o>.</span><span class=n>colorbar</span><span class=p>(</span><span class=n>sm</span><span class=p>,</span> <span class=n>shrink</span><span class=o>=</span><span class=mf>0.4</span><span class=p>,</span> <span class=n>aspect</span><span class=o>=</span><span class=mi>15</span><span class=p>,</span> <span class=n>label</span><span class=o>=</span><span class=s1>&#39;提升度&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>cbar</span><span class=o>.</span><span class=n>ax</span><span class=o>.</span><span class=n>tick_params</span><span class=p>(</span><span class=n>labelsize</span><span class=o>=</span><span class=mi>8</span><span class=p>)</span>  <span class=c1># 调整颜色条刻度的字体大小</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span></code></pre></div><p>生成动态gif</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pandas</span> <span class=k>as</span> <span class=nn>pd</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mpl_toolkits.mplot3d</span> <span class=kn>import</span> <span class=n>Axes3D</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.colors</span> <span class=k>as</span> <span class=nn>mcolors</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>imageio</span>  <span class=c1># 用于生成GIF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 假设 scatter_data 已经正确定义，且包含必要的列</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 绘制三维散点图的函数</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>plot_3d</span><span class=p>(</span><span class=n>ax</span><span class=p>,</span> <span class=n>azim</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>ax</span><span class=o>.</span><span class=n>clear</span><span class=p>()</span>  <span class=c1># 清除之前的绘图</span>
</span></span><span class=line><span class=cl>    <span class=c1># 散点图绘制</span>
</span></span><span class=line><span class=cl>    <span class=n>ax</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>scatter_data</span><span class=p>[</span><span class=s1>&#39;Antecedent1&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>scatter_data</span><span class=p>[</span><span class=s1>&#39;Antecedent2&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>scatter_data</span><span class=p>[</span><span class=s1>&#39;Consequent&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>s</span><span class=o>=</span><span class=n>scatter_data</span><span class=p>[</span><span class=s1>&#39;Support&#39;</span><span class=p>]</span><span class=o>*</span><span class=mi>150</span><span class=p>,</span>  <span class=c1># 泡泡大小基于支持度</span>
</span></span><span class=line><span class=cl>        <span class=n>c</span><span class=o>=</span><span class=p>[</span><span class=n>cmap</span><span class=p>(</span><span class=n>norm</span><span class=p>(</span><span class=n>val</span><span class=p>))</span> <span class=k>for</span> <span class=n>val</span> <span class=ow>in</span> <span class=n>scatter_data</span><span class=p>[</span><span class=s1>&#39;Lift&#39;</span><span class=p>]],</span>  <span class=c1># 颜色基于提升度</span>
</span></span><span class=line><span class=cl>        <span class=n>alpha</span><span class=o>=</span><span class=mf>0.6</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 设置坐标轴标签</span>
</span></span><span class=line><span class=cl>    <span class=n>ax</span><span class=o>.</span><span class=n>set_xticks</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=n>category_mapping</span><span class=o>.</span><span class=n>values</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>    <span class=n>ax</span><span class=o>.</span><span class=n>set_xticklabels</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=n>category_mapping</span><span class=o>.</span><span class=n>keys</span><span class=p>()),</span> <span class=n>rotation</span><span class=o>=</span><span class=mi>45</span><span class=p>,</span> <span class=n>ha</span><span class=o>=</span><span class=s2>&#34;right&#34;</span><span class=p>,</span> <span class=n>fontsize</span><span class=o>=</span><span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax</span><span class=o>.</span><span class=n>set_yticks</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=n>category_mapping</span><span class=o>.</span><span class=n>values</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>    <span class=n>ax</span><span class=o>.</span><span class=n>set_yticklabels</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=n>category_mapping</span><span class=o>.</span><span class=n>keys</span><span class=p>()),</span> <span class=n>rotation</span><span class=o>=-</span><span class=mi>45</span><span class=p>,</span> <span class=n>ha</span><span class=o>=</span><span class=s2>&#34;left&#34;</span><span class=p>,</span> <span class=n>fontsize</span><span class=o>=</span><span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ax</span><span class=o>.</span><span class=n>set_zticks</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=n>category_mapping</span><span class=o>.</span><span class=n>values</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>    <span class=n>ax</span><span class=o>.</span><span class=n>set_zticklabels</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=n>category_mapping</span><span class=o>.</span><span class=n>keys</span><span class=p>()),</span> <span class=n>fontsize</span><span class=o>=</span><span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 调整视角</span>
</span></span><span class=line><span class=cl>    <span class=n>ax</span><span class=o>.</span><span class=n>view_init</span><span class=p>(</span><span class=n>elev</span><span class=o>=</span><span class=mi>20</span><span class=p>,</span> <span class=n>azim</span><span class=o>=</span><span class=n>azim</span><span class=p>)</span>  <span class=c1># 旋转视角</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 由于在函数内部调用 plt.show() 或 plt.savefig() 会阻断循环，我们在这里不调用它们</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建GIF的帧</span>
</span></span><span class=line><span class=cl><span class=n>filenames</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=n>fig</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>figure</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>25</span><span class=p>,</span> <span class=mi>10</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>ax</span> <span class=o>=</span> <span class=n>fig</span><span class=o>.</span><span class=n>add_subplot</span><span class=p>(</span><span class=mi>111</span><span class=p>,</span> <span class=n>projection</span><span class=o>=</span><span class=s1>&#39;3d&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>azim</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>90</span><span class=p>,</span> <span class=mi>2</span><span class=p>):</span>  <span class=c1># 从-45度旋转到315度，每次增加2度</span>
</span></span><span class=line><span class=cl>    <span class=n>plot_3d</span><span class=p>(</span><span class=n>ax</span><span class=p>,</span> <span class=n>azim</span><span class=p>)</span>  <span class=c1># 绘图</span>
</span></span><span class=line><span class=cl>    <span class=n>filename</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;frame_</span><span class=si>{</span><span class=n>azim</span><span class=si>}</span><span class=s1>.png&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>savefig</span><span class=p>(</span><span class=n>filename</span><span class=p>)</span>  <span class=c1># 保存帧</span>
</span></span><span class=line><span class=cl>    <span class=n>filenames</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用imageio生成GIF</span>
</span></span><span class=line><span class=cl><span class=n>images</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>filename</span> <span class=ow>in</span> <span class=n>filenames</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>images</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>imageio</span><span class=o>.</span><span class=n>imread</span><span class=p>(</span><span class=n>filename</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>imageio</span><span class=o>.</span><span class=n>mimsave</span><span class=p>(</span><span class=s1>&#39;rotation.gif&#39;</span><span class=p>,</span> <span class=n>images</span><span class=p>,</span> <span class=n>fps</span><span class=o>=</span><span class=mi>20</span><span class=p>)</span>  <span class=c1># 调整fps（每秒帧数）根据需要</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 清理临时生成的PNG文件</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>filename</span> <span class=ow>in</span> <span class=n>filenames</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>os</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>filename</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>antecedent_mapping</span> <span class=o>=</span> <span class=n>category_mapping</span>
</span></span><span class=line><span class=cl><span class=n>antecedent_mapping_reverse</span> <span class=o>=</span> <span class=n>inverse_mapping</span>
</span></span><span class=line><span class=cl><span class=n>consequent_mapping</span> <span class=o>=</span> <span class=n>category_mapping</span>
</span></span><span class=line><span class=cl><span class=n>consequent_mapping_reverse</span> <span class=o>=</span> <span class=n>inverse_mapping</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>q30_options</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;体育项目&#39;</span><span class=p>,</span> <span class=s1>&#39;网红打卡点&#39;</span><span class=p>,</span> <span class=s1>&#39;趣味项目&#39;</span><span class=p>,</span> <span class=s1>&#39;民族服饰&#39;</span><span class=p>,</span> <span class=s1>&#39;专业旅拍&#39;</span><span class=p>,</span> <span class=s1>&#39;特色民宿&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>q31_options</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;盘县火腿&#39;</span><span class=p>,</span> <span class=s1>&#39;刺梨系列产品&#39;</span><span class=p>,</span> <span class=s1>&#39;盘州茶叶&#39;</span><span class=p>,</span> <span class=s1>&#39;核桃乳&#39;</span><span class=p>,</span> <span class=s1>&#39;人民小酒&#39;</span><span class=p>,</span> <span class=s1>&#39;银杏系列商品&#39;</span><span class=p>,</span> <span class=s1>&#39;民族手工制品&#39;</span><span class=p>,</span> <span class=s1>&#39;彝族服饰&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>q32_options</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;非遗火腿工艺参观&#39;</span><span class=p>,</span> <span class=s1>&#39;非遗技艺制作地方特色小吃体验&#39;</span><span class=p>,</span> <span class=s1>&#39;非遗剪纸体验&#39;</span><span class=p>,</span> <span class=s1>&#39;古法造纸参观&#39;</span><span class=p>,</span> <span class=s1>&#39;民族刺绣体验&#39;</span><span class=p>,</span> <span class=s1>&#39;民族蜡染体验&#39;</span><span class=p>,</span> <span class=s1>&#39;民族歌舞表演&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 遍历scatter_data</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>scatter_data</span><span class=o>.</span><span class=n>iterrows</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>lift</span> <span class=o>=</span> <span class=n>row</span><span class=p>[</span><span class=s1>&#39;Lift&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=c1># 只输出提升度大于1.45的规则</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>lift</span> <span class=o>&gt;</span> <span class=mf>1.3</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>antecedent1</span> <span class=o>=</span> <span class=n>antecedent_mapping_reverse</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>row</span><span class=p>[</span><span class=s1>&#39;Antecedent1&#39;</span><span class=p>],</span> <span class=s1>&#39;Unknown&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>antecedent2</span> <span class=o>=</span> <span class=n>antecedent_mapping_reverse</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>row</span><span class=p>[</span><span class=s1>&#39;Antecedent2&#39;</span><span class=p>],</span> <span class=s1>&#39;Unknown&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>consequent</span> <span class=o>=</span> <span class=n>consequent_mapping_reverse</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>row</span><span class=p>[</span><span class=s1>&#39;Consequent&#39;</span><span class=p>],</span> <span class=s1>&#39;Unknown&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>support</span> <span class=o>=</span> <span class=n>row</span><span class=p>[</span><span class=s1>&#39;Support&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 检查前件和后件是否包含q30、q31和q32中的任意一个问题</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>((</span><span class=n>antecedent1</span> <span class=ow>in</span> <span class=n>q30_options</span> <span class=ow>and</span> <span class=n>antecedent2</span> <span class=ow>in</span> <span class=n>q31_options</span> <span class=ow>and</span> <span class=n>consequent</span> <span class=ow>in</span> <span class=n>q32_options</span><span class=p>)</span> <span class=ow>or</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=n>antecedent1</span> <span class=ow>in</span> <span class=n>q30_options</span> <span class=ow>and</span> <span class=n>antecedent2</span> <span class=ow>in</span> <span class=n>q32_options</span> <span class=ow>and</span> <span class=n>consequent</span> <span class=ow>in</span> <span class=n>q31_options</span><span class=p>)</span> <span class=ow>or</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=n>antecedent1</span> <span class=ow>in</span> <span class=n>q31_options</span> <span class=ow>and</span> <span class=n>antecedent2</span> <span class=ow>in</span> <span class=n>q30_options</span> <span class=ow>and</span> <span class=n>consequent</span> <span class=ow>in</span> <span class=n>q32_options</span><span class=p>)</span> <span class=ow>or</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=n>antecedent1</span> <span class=ow>in</span> <span class=n>q31_options</span> <span class=ow>and</span> <span class=n>antecedent2</span> <span class=ow>in</span> <span class=n>q32_options</span> <span class=ow>and</span> <span class=n>consequent</span> <span class=ow>in</span> <span class=n>q30_options</span><span class=p>)</span> <span class=ow>or</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=n>antecedent1</span> <span class=ow>in</span> <span class=n>q32_options</span> <span class=ow>and</span> <span class=n>antecedent2</span> <span class=ow>in</span> <span class=n>q30_options</span> <span class=ow>and</span> <span class=n>consequent</span> <span class=ow>in</span> <span class=n>q31_options</span><span class=p>)</span> <span class=ow>or</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=n>antecedent1</span> <span class=ow>in</span> <span class=n>q32_options</span> <span class=ow>and</span> <span class=n>antecedent2</span> <span class=ow>in</span> <span class=n>q31_options</span> <span class=ow>and</span> <span class=n>consequent</span> <span class=ow>in</span> <span class=n>q30_options</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;规则: </span><span class=si>{</span><span class=n>antecedent1</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>antecedent2</span><span class=si>}</span><span class=s2> =&gt; </span><span class=si>{</span><span class=n>consequent</span><span class=si>}</span><span class=s2>, 支持度: </span><span class=si>{</span><span class=n>support</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>, 提升度: </span><span class=si>{</span><span class=n>lift</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></div><h2 id=客户粘性分析>客户粘性分析<a hidden class=anchor aria-hidden=true href=#客户粘性分析>#</a></h2><p>游客画像作为自变量，客户粘性作为因变量进行分析</p><p>比较关心的是客户粘性打分为4/5的客户，看他们的游客画像是什么。</p><ul><li>第一个思路是，把去过的游客先进行聚类，再把聚类的结果来看哪一类人群的粘性最高；在数据处理的逻辑上思路更好。</li><li>第二个思路是，把游客的基本信息不处理，全部丢给随机森林进行处理</li></ul><p>客户粘性题号：Q26|1</p><p>游客基本信息：columns
游客画像聚类结果：</p><p>注：运行此段代码前，先运行“开始聚类”代码</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 查看Q26的打分分布</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;查看Q26的打分分布</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span><span class=n>df_gone</span><span class=p>[</span><span class=s1>&#39;Q26|1&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>value_counts</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看总的数据量</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>查看总的数据量</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span><span class=n>df_gone</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 检查游客基本信息的题号，排除开放性题号</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>检查游客基本信息的题号，排除开放性题号</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span><span class=n>columns</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 聚类结果统计</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>聚类结果统计</span><span class=se>\n</span><span class=s2> &#34;</span><span class=p>,</span><span class=n>df_gone</span><span class=p>[</span><span class=s1>&#39;k-prototypes cluster&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>value_counts</span><span class=p>())</span>
</span></span></code></pre></div><h3 id=对df_gone进行聚类>对df_gone进行聚类<a hidden class=anchor aria-hidden=true href=#对df_gone进行聚类>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 思路1   把去过的游客先进行聚类，再把聚类的结果来看哪一类人群的粘性最高</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>kmodes.kprototypes</span> <span class=kn>import</span> <span class=n>KPrototypes</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 列表中的列名</span>
</span></span><span class=line><span class=cl><span class=c1># columns = [&#39;Q1&#39;, &#39;Q2&#39;, &#39;Q3&#39;, &#39;Q4&#39;, &#39;Q5&#39;, &#39;Q7|1&#39;, &#39;Q7|4&#39;, &#39;Q7|2&#39;, &#39;Q7|3&#39;, &#39;Q7|5&#39;, &#39;Q7|6&#39;, &#39;Q8&#39;, &#39;Q9&#39;, &#39;Q10&#39;, &#39;Q11&#39;, &#39;Q12&#39;, &#39;Q13&#39;, &#39;Q14&#39;, &#39;Q15&#39;]</span>
</span></span><span class=line><span class=cl><span class=n>columns</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;Q2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q5&#39;</span><span class=p>,</span> <span class=s1>&#39;Q8&#39;</span><span class=p>,</span> <span class=s1>&#39;Q9&#39;</span><span class=p>,</span> <span class=s1>&#39;Q10&#39;</span><span class=p>,</span> <span class=s1>&#39;Q11&#39;</span><span class=p>,</span> <span class=s1>&#39;Q12&#39;</span><span class=p>,</span> <span class=s1>&#39;Q13&#39;</span><span class=p>,</span> <span class=s1>&#39;Q14&#39;</span><span class=p>,</span> <span class=s1>&#39;Q15&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 数值型列</span>
</span></span><span class=line><span class=cl><span class=n>numerical_columns</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;Q2&#39;</span><span class=p>,</span> <span class=s1>&#39;Q4&#39;</span><span class=p>,</span> <span class=s1>&#39;Q5&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 类别型列</span>
</span></span><span class=line><span class=cl><span class=n>categorical_columns</span> <span class=o>=</span> <span class=p>[</span><span class=n>col</span> <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=n>columns</span> <span class=k>if</span> <span class=n>col</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>numerical_columns</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 将类别型列的索引转换为数字</span>
</span></span><span class=line><span class=cl><span class=n>categorical_columns_indices</span> <span class=o>=</span> <span class=p>[</span><span class=n>columns</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=n>col</span><span class=p>)</span> <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=n>categorical_columns</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 初始化 K-原型聚类器</span>
</span></span><span class=line><span class=cl><span class=n>kproto</span> <span class=o>=</span> <span class=n>KPrototypes</span><span class=p>(</span><span class=n>n_clusters</span><span class=o>=</span><span class=mi>4</span><span class=p>,</span> <span class=n>init</span><span class=o>=</span><span class=s1>&#39;Cao&#39;</span><span class=p>,</span> <span class=n>verbose</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 对所有游客进行聚类</span>
</span></span><span class=line><span class=cl><span class=n>clusters</span> <span class=o>=</span> <span class=n>kproto</span><span class=o>.</span><span class=n>fit_predict</span><span class=p>(</span><span class=n>df_gone</span><span class=p>[</span><span class=n>columns</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>,</span> <span class=n>categorical</span><span class=o>=</span><span class=n>categorical_columns_indices</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 将聚类结果添加到数据集作为新的特征</span>
</span></span><span class=line><span class=cl><span class=n>df_gone</span><span class=p>[</span><span class=s1>&#39;k-prototypes cluster&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>clusters</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 想查看每个簇的中心点</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>kproto</span><span class=o>.</span><span class=n>cluster_centroids_</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看每个簇的数量</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>df_gone</span><span class=p>[</span><span class=s1>&#39;k-prototypes cluster&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>value_counts</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>df_gone</span><span class=o>.</span><span class=n>head</span><span class=p>()</span>
</span></span></code></pre></div><h3 id=可视化>可视化<a hidden class=anchor aria-hidden=true href=#可视化>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.decomposition</span> <span class=kn>import</span> <span class=n>PCA</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.manifold</span> <span class=kn>import</span> <span class=n>TSNE</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>umap</span> <span class=kn>import</span> <span class=n>UMAP</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mpl_toolkits.mplot3d</span> <span class=kn>import</span> <span class=n>Axes3D</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 数据</span>
</span></span><span class=line><span class=cl><span class=n>X</span> <span class=o>=</span> <span class=n>df_gone</span><span class=p>[</span><span class=n>columns</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建PCA，t-SNE，UMAP对象</span>
</span></span><span class=line><span class=cl><span class=n>pca</span> <span class=o>=</span> <span class=n>PCA</span><span class=p>(</span><span class=n>n_components</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>tsne</span> <span class=o>=</span> <span class=n>TSNE</span><span class=p>(</span><span class=n>n_components</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>umap</span> <span class=o>=</span> <span class=n>UMAP</span><span class=p>(</span><span class=n>n_components</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 降维</span>
</span></span><span class=line><span class=cl><span class=n>X_pca</span> <span class=o>=</span> <span class=n>pca</span><span class=o>.</span><span class=n>fit_transform</span><span class=p>(</span><span class=n>X</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>X_tsne</span> <span class=o>=</span> <span class=n>tsne</span><span class=o>.</span><span class=n>fit_transform</span><span class=p>(</span><span class=n>X</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>X_umap</span> <span class=o>=</span> <span class=n>umap</span><span class=o>.</span><span class=n>fit_transform</span><span class=p>(</span><span class=n>X</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建图形和子图</span>
</span></span><span class=line><span class=cl><span class=n>fig</span><span class=p>,</span> <span class=n>axs</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>subplots</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>15</span><span class=p>,</span> <span class=mi>20</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 绘制二维版本</span>
</span></span><span class=line><span class=cl><span class=n>axs</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>X_pca</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>],</span> <span class=n>X_pca</span><span class=p>[:,</span> <span class=mi>1</span><span class=p>],</span> <span class=n>c</span><span class=o>=</span><span class=n>clusters</span><span class=p>,</span> <span class=n>cmap</span><span class=o>=</span><span class=s1>&#39;viridis&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axs</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;PCA 2D&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fig</span><span class=o>.</span><span class=n>colorbar</span><span class=p>(</span><span class=n>sc</span><span class=p>,</span> <span class=n>ax</span><span class=o>=</span><span class=n>axs</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>],</span> <span class=n>shrink</span><span class=o>=</span><span class=mf>0.6</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>axs</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>X_tsne</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>],</span> <span class=n>X_tsne</span><span class=p>[:,</span> <span class=mi>1</span><span class=p>],</span> <span class=n>c</span><span class=o>=</span><span class=n>clusters</span><span class=p>,</span> <span class=n>cmap</span><span class=o>=</span><span class=s1>&#39;viridis&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axs</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;t-SNE 2D&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fig</span><span class=o>.</span><span class=n>colorbar</span><span class=p>(</span><span class=n>sc</span><span class=p>,</span> <span class=n>ax</span><span class=o>=</span><span class=n>axs</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>],</span> <span class=n>shrink</span><span class=o>=</span><span class=mf>0.6</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>axs</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>X_umap</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>],</span> <span class=n>X_umap</span><span class=p>[:,</span> <span class=mi>1</span><span class=p>],</span> <span class=n>c</span><span class=o>=</span><span class=n>clusters</span><span class=p>,</span> <span class=n>cmap</span><span class=o>=</span><span class=s1>&#39;viridis&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axs</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;UMAP 2D&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fig</span><span class=o>.</span><span class=n>colorbar</span><span class=p>(</span><span class=n>sc</span><span class=p>,</span> <span class=n>ax</span><span class=o>=</span><span class=n>axs</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>],</span> <span class=n>shrink</span><span class=o>=</span><span class=mf>0.6</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建PCA，t-SNE，UMAP对象</span>
</span></span><span class=line><span class=cl><span class=n>pca</span> <span class=o>=</span> <span class=n>PCA</span><span class=p>(</span><span class=n>n_components</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>tsne</span> <span class=o>=</span> <span class=n>TSNE</span><span class=p>(</span><span class=n>n_components</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>umap</span> <span class=o>=</span> <span class=n>UMAP</span><span class=p>(</span><span class=n>n_components</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 降维</span>
</span></span><span class=line><span class=cl><span class=n>X_pca</span> <span class=o>=</span> <span class=n>pca</span><span class=o>.</span><span class=n>fit_transform</span><span class=p>(</span><span class=n>X</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>X_tsne</span> <span class=o>=</span> <span class=n>tsne</span><span class=o>.</span><span class=n>fit_transform</span><span class=p>(</span><span class=n>X</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>X_umap</span> <span class=o>=</span> <span class=n>umap</span><span class=o>.</span><span class=n>fit_transform</span><span class=p>(</span><span class=n>X</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 绘制三维版本</span>
</span></span><span class=line><span class=cl><span class=n>axs</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>fig</span><span class=o>.</span><span class=n>add_subplot</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=n>projection</span><span class=o>=</span><span class=s1>&#39;3d&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axs</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>X_pca</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>],</span> <span class=n>X_pca</span><span class=p>[:,</span> <span class=mi>1</span><span class=p>],</span> <span class=n>X_pca</span><span class=p>[:,</span> <span class=mi>2</span><span class=p>],</span> <span class=n>c</span><span class=o>=</span><span class=n>clusters</span><span class=p>,</span> <span class=n>cmap</span><span class=o>=</span><span class=s1>&#39;viridis&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axs</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;PCA 3D&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fig</span><span class=o>.</span><span class=n>colorbar</span><span class=p>(</span><span class=n>sc</span><span class=p>,</span> <span class=n>ax</span><span class=o>=</span><span class=n>axs</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>],</span> <span class=n>shrink</span><span class=o>=</span><span class=mf>0.6</span><span class=p>,</span> <span class=n>pad</span><span class=o>=</span><span class=mf>0.2</span><span class=p>)</span>  <span class=c1># 修改的代码</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>axs</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>fig</span><span class=o>.</span><span class=n>add_subplot</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=n>projection</span><span class=o>=</span><span class=s1>&#39;3d&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axs</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>X_tsne</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>],</span> <span class=n>X_tsne</span><span class=p>[:,</span> <span class=mi>1</span><span class=p>],</span> <span class=n>X_tsne</span><span class=p>[:,</span> <span class=mi>2</span><span class=p>],</span> <span class=n>c</span><span class=o>=</span><span class=n>clusters</span><span class=p>,</span> <span class=n>cmap</span><span class=o>=</span><span class=s1>&#39;viridis&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axs</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;t-SNE 3D&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fig</span><span class=o>.</span><span class=n>colorbar</span><span class=p>(</span><span class=n>sc</span><span class=p>,</span> <span class=n>ax</span><span class=o>=</span><span class=n>axs</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>],</span> <span class=n>shrink</span><span class=o>=</span><span class=mf>0.6</span><span class=p>,</span> <span class=n>pad</span><span class=o>=</span><span class=mf>0.2</span><span class=p>)</span>  <span class=c1># 修改的代码</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>axs</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>fig</span><span class=o>.</span><span class=n>add_subplot</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=n>projection</span><span class=o>=</span><span class=s1>&#39;3d&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axs</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>scatter</span><span class=p>(</span><span class=n>X_umap</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>],</span> <span class=n>X_umap</span><span class=p>[:,</span> <span class=mi>1</span><span class=p>],</span> <span class=n>X_umap</span><span class=p>[:,</span> <span class=mi>2</span><span class=p>],</span> <span class=n>c</span><span class=o>=</span><span class=n>clusters</span><span class=p>,</span> <span class=n>cmap</span><span class=o>=</span><span class=s1>&#39;viridis&#39;</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>axs</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=s1>&#39;UMAP 3D&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>fig</span><span class=o>.</span><span class=n>colorbar</span><span class=p>(</span><span class=n>sc</span><span class=p>,</span> <span class=n>ax</span><span class=o>=</span><span class=n>axs</span><span class=p>[</span><span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>],</span> <span class=n>shrink</span><span class=o>=</span><span class=mf>0.6</span><span class=p>,</span> <span class=n>pad</span><span class=o>=</span><span class=mf>0.2</span><span class=p>)</span>  <span class=c1># 修改的代码</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>tight_layout</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span></code></pre></div><h3 id=描述性统计>描述性统计<a hidden class=anchor aria-hidden=true href=#描述性统计>#</a></h3><p>分析df_gone中的&rsquo;k-prototypes cluster&rsquo;和&rsquo;Q26|1&rsquo;之间的关系</p><p>卡方检验：如果p值小于0.05，那么我们可以拒绝零假设，认为&rsquo;k-prototypes cluster&rsquo;和&rsquo;Q26|1&rsquo;之间存在显著的关系。如果p值大于0.05，那么我们不能拒绝零假设，认为&rsquo;k-prototypes cluster&rsquo;和&rsquo;Q26|1&rsquo;之间不存在显著的关系。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>scipy.stats</span> <span class=kn>import</span> <span class=n>chi2_contingency</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建列联表</span>
</span></span><span class=line><span class=cl><span class=n>contingency_table</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>crosstab</span><span class=p>(</span><span class=n>df_gone</span><span class=p>[</span><span class=s1>&#39;k-prototypes cluster&#39;</span><span class=p>],</span> <span class=n>df_gone</span><span class=p>[</span><span class=s1>&#39;Q26|1&#39;</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 进行卡方检验</span>
</span></span><span class=line><span class=cl><span class=n>chi2</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>dof</span><span class=p>,</span> <span class=n>expected</span> <span class=o>=</span> <span class=n>chi2_contingency</span><span class=p>(</span><span class=n>contingency_table</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Chi-square value: </span><span class=si>{</span><span class=n>chi2</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;P-value: </span><span class=si>{</span><span class=n>p</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Degrees of freedom: </span><span class=si>{</span><span class=n>dof</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>seaborn</span> <span class=k>as</span> <span class=nn>sns</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建新的二元变量</span>
</span></span><span class=line><span class=cl><span class=n>df_gone</span><span class=p>[</span><span class=s1>&#39;Q26|1_high_score&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>df_gone</span><span class=p>[</span><span class=s1>&#39;Q26|1&#39;</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 绘制计数图</span>
</span></span><span class=line><span class=cl><span class=n>sns</span><span class=o>.</span><span class=n>countplot</span><span class=p>(</span><span class=n>x</span><span class=o>=</span><span class=s1>&#39;k-prototypes cluster&#39;</span><span class=p>,</span> <span class=n>hue</span><span class=o>=</span><span class=s1>&#39;Q26|1_high_score&#39;</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>df_gone</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span></code></pre></div><h3 id=随机森林模型>随机森林模型<a hidden class=anchor aria-hidden=true href=#随机森林模型>#</a></h3><p>自变量是聚类的结果，因变量是Q26的打分（这个不行）
方法二可以做随机森林</p><p>我想研究的是哪一类人群在Q26的打分更高，我比较关注打分在大于等于4分的人群是哪一类</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.ensemble</span> <span class=kn>import</span> <span class=n>RandomForestClassifier</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.model_selection</span> <span class=kn>import</span> <span class=n>train_test_split</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.metrics</span> <span class=kn>import</span> <span class=n>classification_report</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 定义自变量和因变量</span>
</span></span><span class=line><span class=cl><span class=n>X</span> <span class=o>=</span> <span class=n>df_gone</span><span class=p>[</span><span class=n>columns</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>y</span> <span class=o>=</span> <span class=n>df_gone</span><span class=p>[</span><span class=s1>&#39;Q26|1&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 划分训练集和测试集</span>
</span></span><span class=line><span class=cl><span class=n>X_train</span><span class=p>,</span> <span class=n>X_test</span><span class=p>,</span> <span class=n>y_train</span><span class=p>,</span> <span class=n>y_test</span> <span class=o>=</span> <span class=n>train_test_split</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>test_size</span><span class=o>=</span><span class=mf>0.2</span><span class=p>,</span> <span class=n>random_state</span><span class=o>=</span><span class=mi>42</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建随机森林模型</span>
</span></span><span class=line><span class=cl><span class=n>clf</span> <span class=o>=</span> <span class=n>RandomForestClassifier</span><span class=p>(</span><span class=n>n_estimators</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span> <span class=n>random_state</span><span class=o>=</span><span class=mi>42</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 训练模型</span>
</span></span><span class=line><span class=cl><span class=n>clf</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span><span class=n>X_train</span><span class=p>,</span> <span class=n>y_train</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 预测测试集</span>
</span></span><span class=line><span class=cl><span class=n>y_pred</span> <span class=o>=</span> <span class=n>clf</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>X_test</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 打印分类报告</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>classification_report</span><span class=p>(</span><span class=n>y_test</span><span class=p>,</span> <span class=n>y_pred</span><span class=p>))</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>shap</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建解释器</span>
</span></span><span class=line><span class=cl><span class=n>explainer</span> <span class=o>=</span> <span class=n>shap</span><span class=o>.</span><span class=n>TreeExplainer</span><span class=p>(</span><span class=n>clf</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 计算SHAP值</span>
</span></span><span class=line><span class=cl><span class=n>shap_values</span> <span class=o>=</span> <span class=n>explainer</span><span class=o>.</span><span class=n>shap_values</span><span class=p>(</span><span class=n>X_test</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建类别标签</span>
</span></span><span class=line><span class=cl><span class=n>class_labels</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;Class 1&#39;</span><span class=p>,</span> <span class=s1>&#39;Class 2&#39;</span><span class=p>,</span> <span class=s1>&#39;Class 3&#39;</span><span class=p>,</span> <span class=s1>&#39;Class 4&#39;</span><span class=p>,</span> <span class=s1>&#39;Class 5&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置图形大小</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>figure</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>40</span><span class=p>,</span> <span class=mi>10</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 绘制所有类别的SHAP值概览图（保持原始顺序）</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>subplot</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>shap</span><span class=o>.</span><span class=n>summary_plot</span><span class=p>(</span><span class=n>shap_values</span><span class=p>,</span> <span class=n>X_test</span><span class=p>,</span> <span class=n>class_names</span><span class=o>=</span><span class=n>class_labels</span><span class=p>,</span> <span class=n>plot_type</span><span class=o>=</span><span class=s2>&#34;bar&#34;</span><span class=p>,</span> <span class=n>show</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>title</span><span class=p>(</span><span class=s2>&#34;All Classes Feature Importance&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 绘制类别4的特征贡献度</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>subplot</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>shap</span><span class=o>.</span><span class=n>summary_plot</span><span class=p>(</span><span class=n>shap_values</span><span class=p>[</span><span class=mi>3</span><span class=p>][:,</span> <span class=n>sorted_indices_class_4</span><span class=p>],</span> <span class=n>X_test</span><span class=o>.</span><span class=n>iloc</span><span class=p>[:,</span> <span class=n>sorted_indices_class_4</span><span class=p>],</span> <span class=n>plot_type</span><span class=o>=</span><span class=s2>&#34;bar&#34;</span><span class=p>,</span> <span class=n>feature_names</span><span class=o>=</span><span class=n>X_test</span><span class=o>.</span><span class=n>columns</span><span class=p>[</span><span class=n>sorted_indices_class_4</span><span class=p>],</span> <span class=n>show</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>title</span><span class=p>(</span><span class=s2>&#34;Class 4 Feature Importance&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 绘制类别5的特征贡献度</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>subplot</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>shap</span><span class=o>.</span><span class=n>summary_plot</span><span class=p>(</span><span class=n>shap_values</span><span class=p>[</span><span class=mi>4</span><span class=p>][:,</span> <span class=n>sorted_indices_class_5</span><span class=p>],</span> <span class=n>X_test</span><span class=o>.</span><span class=n>iloc</span><span class=p>[:,</span> <span class=n>sorted_indices_class_5</span><span class=p>],</span> <span class=n>plot_type</span><span class=o>=</span><span class=s2>&#34;bar&#34;</span><span class=p>,</span> <span class=n>feature_names</span><span class=o>=</span><span class=n>X_test</span><span class=o>.</span><span class=n>columns</span><span class=p>[</span><span class=n>sorted_indices_class_5</span><span class=p>],</span> <span class=n>show</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>title</span><span class=p>(</span><span class=s2>&#34;Class 5 Feature Importance&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>tight_layout</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>shap</span><span class=o>.</span><span class=n>summary_plot</span><span class=p>(</span><span class=n>shap_values</span><span class=p>,</span> <span class=n>X_test</span><span class=p>,</span> <span class=n>class_names</span><span class=o>=</span><span class=n>class_labels</span><span class=p>,</span> <span class=n>plot_type</span><span class=o>=</span><span class=s2>&#34;bar&#34;</span><span class=p>,</span> <span class=n>show</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>title</span><span class=p>(</span><span class=s2>&#34;All Classes Feature Importance&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># mean(|SHAP value|)(average impact on model output magnitude)</span>
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://sirius1y.top/tags/%E8%81%9A%E7%B1%BB/>聚类</a></li><li><a href=https://sirius1y.top/tags/%E5%85%B3%E8%81%94%E8%A7%84%E5%88%99/>关联规则</a></li><li><a href=https://sirius1y.top/tags/%E5%86%B3%E7%AD%96%E6%A0%91/>决策树</a></li><li><a href=https://sirius1y.top/tags/%E5%9B%A0%E5%AD%90%E5%88%86%E6%9E%90/>因子分析</a></li><li><a href=https://sirius1y.top/tags/%E7%81%B0%E8%89%B2%E5%85%B3%E8%81%94/>灰色关联</a></li><li><a href=https://sirius1y.top/tags/%E5%AD%A4%E7%AB%8B%E6%A3%AE%E6%9E%97/>孤立森林</a></li><li><a href=https://sirius1y.top/tags/%E9%9A%8F%E6%9C%BA%E6%A3%AE%E6%9E%97/>随机森林</a></li></ul><nav class=paginav><a class=prev href=https://sirius1y.top/posts/notes/notes/regularexpressions/><span class=title>« Prev</span><br><span>知识复习：正则表达式</span>
</a><a class=next href=https://sirius1y.top/posts/notes/tools/latex_resume/><span class=title>Next »</span><br><span>使用LaTex制作中文简历</span></a></nav></footer><script>function createGiscusScript(e){const t=document.createElement("script");Object.entries(e).forEach(([e,n])=>t.setAttribute(e,n)),document.querySelector("article").appendChild(t);const n=document.querySelector('label[for="switch_default"]');n&&n.addEventListener("click",function(){const e=document.body.classList.contains("dark")?"transparent_dark":"light";t.setAttribute("data-theme",e),sendMessage({setConfig:{theme:e}})})}function sendMessage(e){const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")}document.addEventListener("DOMContentLoaded",function(){const e={src:"https://giscus.app/client.js","data-repo":"yunyit/yunyit.github.io","data-repo-id":"R_kgDOKqkPYw","data-category":"Comments","data-category-id":"DIC_kwDOKqkPY84CceDi","data-mapping":"url","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"top","data-lang":"en",crossorigin:"anonymous",async:""};e["data-theme"]=document.body.classList.contains("dark")?"transparent_dark":"light",createGiscusScript(e);const t=new MutationObserver(()=>{const e=document.body.classList.contains("dark")?"transparent_dark":"light";sendMessage({setConfig:{theme:e}})});t.observe(document.body,{attributes:!0,attributeFilter:["class"]})})</script></article></main><footer class=footer><span><a href=https://us.umami.is/websites/5e6ac0c1-e2b2-4d0f-9542-b79ac2cf89c4 rel="noopener noreferrer" target=_blank>Analysis</a>
</span>|
<script defer src=https://cloud.umami.is/script.js data-website-id=5e6ac0c1-e2b2-4d0f-9542-b79ac2cf89c4></script><span><a href=https://beian.miit.gov.cn/ target=_blank>渝ICP备2024018631号</a>
</span>|
<span>&copy; 2025 <a href=https://sirius1y.top/>Sirius' Blog</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>